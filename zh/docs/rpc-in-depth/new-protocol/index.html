<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.105.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=alternate type=application/rss+xml href=https://brpc.incubator.apache.org/zh/docs/rpc-in-depth/new-protocol/index.xml><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>支持新协议 | bRPC</title><meta property="og:title" content="支持新协议"><meta property="og:description" content="学习如何添加一个新协议到bRPC。
"><meta property="og:type" content="website"><meta property="og:url" content="https://brpc.incubator.apache.org/zh/docs/rpc-in-depth/new-protocol/"><meta property="og:site_name" content="bRPC"><meta itemprop=name content="支持新协议"><meta itemprop=description content="学习如何添加一个新协议到bRPC。
"><meta name=twitter:card content="summary"><meta name=twitter:title content="支持新协议"><meta name=twitter:description content="学习如何添加一个新协议到bRPC。
"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-93485976-3","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<link rel=preload href=/scss/main.min.fdeb960b10259a4ba01719d39b27531b8cc22fc9df6dca825590cf18ae192feb.css as=style><link href=/scss/main.min.fdeb960b10259a4ba01719d39b27531b8cc22fc9df6dca825590cf18ae192feb.css rel=stylesheet integrity><script src=/js/jquery-3.3.1.min.js></script><title>支持新协议 | bRPC</title></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/zh/><span class=navbar-logo><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/apache/incubator-brpc/ target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/docs/><span class=active>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/blogs/><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/community/community/><span>社区</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/faq/><span>FAQ</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/users/><span>用户</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a></li><ul><li class="collapse show" id=zhdocs><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsoverview href=/zh/docs/overview/>简介</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsgetting_started href=/zh/docs/getting_started/>开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsbenchmark href=/zh/docs/benchmark/>性能基准</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvar><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvarbvar></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar c++</a></li><ul><li class=collapse id=zhdocsbvarbvar-c></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/mbvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">mbvar c++</a></li><ul><li class=collapse id=zhdocsbvarmbvar-c></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthread><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthreadbthread></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread-or-not/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread or not</a></li><ul><li class=collapse id=zhdocsbthreadbthread-or-not></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/execution-queue/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Execution Queue</a></li><ul><li class=collapse id=zhdocsbthreadexecution-queue></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/thread-local/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">thread-local</a></li><ul><li class=collapse id=zhdocsbthreadthread-local></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">客户端</a></li><ul><li class=collapse id=zhdocsclient><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsclientbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/error-code/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">错误码</a></li><ul><li class=collapse id=zhdocsclienterror-code></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/combo-channels/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">组合channels</a></li><ul><li class=collapse id=zhdocsclientcombo-channels></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问http:h2</a></li><ul><li class=collapse id=zhdocsclientaccess-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问gRPC</a></li><ul><li class=collapse id=zhdocsclientaccess-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问thrift</a></li><ul><li class=collapse id=zhdocsclientaccess-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-ub/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问UB</a></li><ul><li class=collapse id=zhdocsclientaccess-ub></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-redis/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问redis</a></li><ul><li class=collapse id=zhdocsclientaccess-redis></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-memcached/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问memcached</a></li><ul><li class=collapse id=zhdocsclientaccess-memcached></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/streaming-rpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流式RPC</a></li><ul><li class=collapse id=zhdocsclientstreaming-rpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/backup-request/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Backup request</a></li><ul><li class=collapse id=zhdocsclientbackup-request></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/dummy-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dummy server</a></li><ul><li class=collapse id=zhdocsclientdummy-server></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">服务端</a></li><ul><li class=collapse id=zhdocsserver><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsserverbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建http:h2服务</a></li><ul><li class=collapse id=zhdocsserverserve-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建gRPC服务</a></li><ul><li class=collapse id=zhdocsserverserve-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建thrift服务</a></li><ul><li class=collapse id=zhdocsserverserve-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-nshead/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建Nshead服务</a></li><ul><li class=collapse id=zhdocsserverserve-nshead></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/server-push/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">推送</a></li><ul><li class=collapse id=zhdocsserverserver-push></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/debug-server-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">高效率排查server卡顿</a></li><ul><li class=collapse id=zhdocsserverdebug-server-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/avalanche/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">雪崩</a></li><ul><li class=collapse id=zhdocsserveravalanche></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/auto-concurrencylimiter/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">自适应限流</a></li><ul><li class=collapse id=zhdocsserverauto-concurrencylimiter></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/media-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流媒体服务</a></li><ul><li class=collapse id=zhdocsservermedia-server></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/json2pb/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">json2pb</a></li><ul><li class=collapse id=zhdocsserverjson2pb></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内置服务</a></li><ul><li class=collapse id=zhdocsbuiltin-services><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/buildin_services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">builtin services</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesbuildin_services></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/status/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">status</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesstatus></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/vars/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">vars</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesvars></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/connections/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">connections</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesconnections></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/flags/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">flags</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesflags></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/rpcz/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpcz</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesrpcz></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/cpu_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">cpu profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescpu_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/heap_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">heap profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesheap_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/contention_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">contention profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescontention_profiler></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">工具</a></li><ul><li class=collapse id=zhdocstools><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_press/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_press</a></li><ul><li class=collapse id=zhdocstoolsrpc_press></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_replay/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_replay</a></li><ul><li class=collapse id=zhdocstoolsrpc_replay></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_view/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_view</a></li><ul><li class=collapse id=zhdocstoolsrpc_view></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/benchmark_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">benchmark_http</a></li><ul><li class=collapse id=zhdocstoolsbenchmark_http></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/parallel_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">parallel_http</a></li><ul><li class=collapse id=zhdocstoolsparallel_http></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">C++基础</a></li><ul><li class=collapse id=zhdocsc-base><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/iobuf/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IOBuf</a></li><ul><li class=collapse id=zhdocsc-baseiobuf></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/streaming-log/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming Log</a></li><ul><li class=collapse id=zhdocsc-basestreaming-log></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/flatmap/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FlatMap</a></li><ul><li class=collapse id=zhdocsc-baseflatmap></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/brpc-training-materials/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC培训材料</a></li><ul><li class=collapse id=zhdocsc-basebrpc-training-materials></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">深入RPC</a></li><ul><li class="collapse show" id=zhdocsrpc-in-depth><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/new-protocol/ class="align-left pl-0 pr-2 collapsed active td-sidebar-link td-sidebar-link__section">支持新协议</a></li><ul><li class=collapse id=zhdocsrpc-in-depthnew-protocol></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/atomic-instructions/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">原子指令</a></li><ul><li class=collapse id=zhdocsrpc-in-depthatomic-instructions></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/io/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IO</a></li><ul><li class=collapse id=zhdocsrpc-in-depthio></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/threading-overview/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">线程模型简介</a></li><ul><li class=collapse id=zhdocsrpc-in-depththreading-overview></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/load-balancing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">负载均衡</a></li><ul><li class=collapse id=zhdocsrpc-in-depthload-balancing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/locality-aware/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Locality-aware</a></li><ul><li class=collapse id=zhdocsrpc-in-depthlocality-aware></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/consistent-hashing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">一致性哈希</a></li><ul><li class=collapse id=zhdocsrpc-in-depthconsistent-hashing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/memory-management/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内存管理</a></li><ul><li class=collapse id=zhdocsrpc-in-depthmemory-management></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/timer-keeping/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Timer keeping</a></li><ul><li class=collapse id=zhdocsrpc-in-depthtimer-keeping></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/bthread_id/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread_id</a></li><ul><li class=collapse id=zhdocsrpc-in-depthbthread_id></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC在百度内部的应用</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baidu><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case1/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">百度地图api入口</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case1></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联盟DSP</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case3/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ELF学习框架</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case3></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case4/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云平台代理服务</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case4></li></ul></ul></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsdownloadbrpc href=/zh/docs/downloadbrpc/>下载bRPC</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/community/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">社区</a></li><ul><li class=collapse id=zhdocscommunity><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommunity href=/zh/docs/community/community/>社区</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitymailing_list href=/zh/docs/community/mailing_list/>邮件列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycontributing href=/zh/docs/community/contributing/>Contribute指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitter href=/zh/docs/community/committer/>Committer指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunityrelease href=/zh/docs/community/release/>Release指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitters href=/zh/docs/community/committers/>贡献者列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitysecurity href=/zh/docs/community/security/>安全</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsfaq href=/zh/docs/faq/>FAQ</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsusers href=/zh/docs/users/>用户</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">博客</a></li><ul><li class=collapse id=zhdocsblogs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">版本发布</a></li><ul><li class=collapse id=zhdocsblogsreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases130 href=/zh/docs/blogs/releases/1.3.0/>bRPC 1.3.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases120 href=/zh/docs/blogs/releases/1.2.0/>bRPC 1.2.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases110 href=/zh/docs/blogs/releases/1.1.0/>bRPC 1.1.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases100 href=/zh/docs/blogs/releases/1.0.0/>bRPC 1.0.0</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/shares/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">分享</a></li><ul><li class=collapse id=zhdocsblogsshares><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssharesbrpc-guide-for-beginners href=/zh/docs/blogs/shares/brpc-guide-for-beginners/>brpc初学者指南</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/sourcecodes/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">源码解析</a></li><ul><li class=collapse id=zhdocsblogssourcecodes><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesbthread href=/zh/docs/blogs/sourcecodes/bthread/>bRPC源码解析·bthread机制</a></li></ul></ul></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/incubator-brpc-website/edit/master/content/zh/docs/RPC-In-Depth/New%20Protocol/_index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/incubator-brpc-website/issues/new?title=%e6%94%af%e6%8c%81%e6%96%b0%e5%8d%8f%e8%ae%ae" target=_blank><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>
<a href=https://github.com/apache/incubator-brpc/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a></div><nav id=TableOfContents><ul><li><a href=#增加protocoltype>增加ProtocolType</a></li><li><a href=#实现回调>实现回调</a><ul><li><a href=#parse>parse</a></li><li><a href=#serialize_request>serialize_request</a></li><li><a href=#pack_request>pack_request</a></li><li><a href=#process_request>process_request</a></li><li><a href=#process_response>process_response</a></li><li><a href=#verify>verify</a></li><li><a href=#parse_server_address>parse_server_address</a></li><li><a href=#get_method_name>get_method_name</a></li><li><a href=#supported_connection_type>supported_connection_type</a></li><li><a href=#name>name</a></li></ul></li><li><a href=#注册到全局>注册到全局</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/zh/zh/docs/>文档</a></li><li class=breadcrumb-item><a href=/zh/zh/docs/rpc-in-depth/>深入RPC</a></li><li class="breadcrumb-item active" aria-current=page><a href=/zh/zh/docs/rpc-in-depth/new-protocol/>支持新协议</a></li></ol></nav><div class=td-content><h1>支持新协议</h1><div class=lead>学习如何添加一个新协议到bRPC。</div><h1 id=server端多协议>server端多协议</h1><p>brpc server一个端口支持多种协议，大部分时候这对部署和运维更加方便。由于不同协议的格式大相径庭，严格地来说，一个端口很难无二义地支持所有协议。出于解耦和可扩展性的考虑，也不太可能集中式地构建一个针对所有协议的分类器。我们的做法就是把协议归三类后逐个尝试：</p><ul><li>第一类协议：标记或特殊字符在最前面，比如<a href=https://github.com/apache/incubator-brpc/blob/master/docs/cn/baidu_std.md>baidu_std</a>，hulu_pbrpc的前4个字符分别是PRPC和HULU，解析代码只需要检查前4个字节就可以知道协议是否匹配，最先尝试这类协议。这些协议在同一个连接上也可以共存。</li><li>第二类协议：有较为复杂的语法，没有固定的协议标记或特殊字符，可能在解析一段输入后才能判断是否匹配，目前此类协议只有http。</li><li>第三类协议：协议标记或特殊字符在中间，比如nshead的magic_num在第25-28字节。由于之前的字段均为二进制，难以判断正确性，在没有读取完28字节前，我们无法判定消息是不是nshead格式的，所以处理起来很麻烦，若其解析排在http之前，那么&lt;=28字节的http消息便可能无法被解析，因为程序以为是“还未完整的nshead消息”。</li></ul><p>考虑到大多数链接上只会有一种协议，我们会记录前一次的协议选择结果，下次首先尝试。对于长连接，这几乎把甄别协议的开销降到了0；虽然短连接每次都得运行这段逻辑，但由于短连接的瓶颈也往往不在于此，这套方法仍旧是足够快的。在未来如果有大量的协议加入，我们可能得考虑一些更复杂的启发式的区分方法。</p><h1 id=client端多协议>client端多协议</h1><p>不像server端必须根据连接上的数据动态地判定协议，client端作为发起端，自然清楚自己的协议格式，只要某种协议只通过连接池或短链接发送，即独占那个连接，那么它可以是任意复杂（或糟糕的）格式。因为client端发出时会记录所用的协议，等到response回来时直接调用对应的解析函数，没有任何甄别代价。像memcache，redis这类协议中基本没有magic number，在server端较难和其他协议区分开，但让client端支持却没什么问题。</p><h1 id=支持新协议>支持新协议</h1><p>brpc就是设计为可随时扩展新协议的，步骤如下：</p><blockquote><p>以nshead开头的协议有统一支持，看<a href=https://github.com/apache/incubator-brpc/blob/master/docs/cn/nshead_service.md>这里</a>。</p></blockquote><h2 id=增加protocoltype>增加ProtocolType</h2><p>在<a href=https://github.com/brpc/brpc/blob/master/src/brpc/options.proto>options.proto</a>的ProtocolType中增加新协议类型，如果你需要的话可以联系我们增加，以确保不会和其他人的需求重合。</p><p>目前的ProtocolType（18年中）:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>ProtocolType</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_UNKNOWN</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_BAIDU_STD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_STREAMING_RPC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_HULU_PBRPC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_SOFA_PBRPC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_RTMP</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_HTTP</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_PUBLIC_PBRPC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_NOVA_PBRPC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_NSHEAD_CLIENT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// implemented in brpc-ub
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_NSHEAD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_HADOOP_RPC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_HADOOP_SERVER_RPC</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_MONGO</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>;</span>               <span style=color:#8f5902;font-style:italic>// server side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_UBRPC_COMPACK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>14</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_DIDX_CLIENT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>15</span><span style=color:#000;font-weight:700>;</span>         <span style=color:#8f5902;font-style:italic>// Client side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_REDIS</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>16</span><span style=color:#000;font-weight:700>;</span>               <span style=color:#8f5902;font-style:italic>// Client side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_MEMCACHE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>17</span><span style=color:#000;font-weight:700>;</span>            <span style=color:#8f5902;font-style:italic>// Client side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_ITP</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>18</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_NSHEAD_MCPACK</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>19</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PROTOCOL_DISP_IDL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>;</span>            <span style=color:#8f5902;font-style:italic>// Client side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_ERSDA_CLIENT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>21</span><span style=color:#000;font-weight:700>;</span>        <span style=color:#8f5902;font-style:italic>// Client side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_UBRPC_MCPACK2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>22</span><span style=color:#000;font-weight:700>;</span>       <span style=color:#8f5902;font-style:italic>// Client side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Reserve special protocol for cds-agent, which depends on FIFO right now
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_CDS_AGENT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>23</span><span style=color:#000;font-weight:700>;</span>           <span style=color:#8f5902;font-style:italic>// Client side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_ESP</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>24</span><span style=color:#000;font-weight:700>;</span>                 <span style=color:#8f5902;font-style:italic>// Client side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>PROTOCOL_THRIFT</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>25</span><span style=color:#000;font-weight:700>;</span>              <span style=color:#8f5902;font-style:italic>// Server side only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=实现回调>实现回调</h2><p>均定义在struct Protocol中，该结构定义在<a href=https://github.com/brpc/brpc/blob/master/src/brpc/protocol.h>protocol.h</a>。其中的parse必须实现，除此之外server端至少要实现process_request，client端至少要实现serialize_request，pack_request，process_response。</p><p>实现协议回调还是比较困难的，这块的代码不会像供普通用户使用的那样，有较好的提示和保护，你得先靠自己搞清楚其他协议中的类似代码，然后再动手，最后发给我们做code review。</p><h3 id=parse>parse</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#000>ParseResult</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Parse</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>IOBuf</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>source</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Socket</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>socket</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>read_eof</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>arg</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>用于把消息从source上切割下来，client端和server端使用同一个parse函数。返回的消息会被递给process_request(server端)或process_response(client端)。</p><p>参数：source是读取到的二进制内容，socket是对应的连接，read_eof为true表示连接已被对端关闭，arg在server端是对应server的指针，在client端是NULL。</p><p>ParseResult可能是错误，也可能包含一个切割下来的message，可能的值有：</p><ul><li>PARSE_ERROR_TRY_OTHERS ：不是这个协议，框架会尝试下一个协议。source不能被消费。</li><li>PARSE_ERROR_NOT_ENOUGH_DATA : 到目前为止数据内容不违反协议，但不构成完整的消息。等到连接上有新数据时，新数据会被append入source并重新调用parse。如果不确定数据是否一定属于这个协议，source不应被消费，如果确定数据属于这个协议，也可以把source的内容转移到内部的状态中去。比如http协议解析中即使source不包含一个完整的http消息，它也会被http parser消费掉，以避免下一次重复解析。</li><li>PARSE_ERROR_TOO_BIG_DATA : 消息太大，拒绝掉以保护server，连接会被关闭。</li><li>PARSE_ERROR_NO_RESOURCE : 内部错误，比如资源分配失败。连接会被关闭。</li><li>PARSE_ERROR_ABSOLUTELY_WRONG : 应该是这个协议（比如magic number匹配了），但是格式不符合预期。连接会被关闭。</li></ul><h3 id=serialize_request>serialize_request</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#000>bool</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>SerializeRequest</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>IOBuf</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request_buf</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                 <span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                 <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Message</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>把request序列化进request_buf，client端必须实现。发生在pack_request之前，一次RPC中只会调用一次。cntl包含某些协议（比如http）需要的信息。成功返回true，否则false。</p><h3 id=pack_request>pack_request</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#000>int</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>PackRequest</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>IOBuf</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>msg</span><span style=color:#000;font-weight:700>,</span> 
</span></span><span style=display:flex><span>                           <span style=color:#204a87;font-weight:700>uint64_t</span> <span style=color:#000>correlation_id</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>MethodDescriptor</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>method</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>controller</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>IOBuf</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>request_buf</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>Authenticator</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>auth</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>把request_buf打包入msg，每次向server发送消息前（包括重试）都会调用。当auth不为空时，需要打包认证信息。成功返回0，否则-1。</p><h3 id=process_request>process_request</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#000>void</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ProcessRequest</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>InputMessageBase</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>msg_base</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>处理server端parse返回的消息，server端必须实现。可能会在和parse()不同的线程中运行。多个process_request可能同时运行。</p><p>在r34386后必须在处理结束时调用msg_base->Destroy()，为了防止漏调，考虑使用DestroyingPtr&lt;>。</p><h3 id=process_response>process_response</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#000>void</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ProcessResponse</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>InputMessageBase</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>msg_base</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>处理client端parse返回的消息，client端必须实现。可能会在和parse()不同的线程中运行。多个process_response可能同时运行。</p><p>在r34386后必须在处理结束时调用msg_base->Destroy()，为了防止漏调，考虑使用DestroyingPtr&lt;>。</p><h3 id=verify>verify</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#000>bool</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Verify</span><span style=color:#000;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>InputMessageBase</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>msg</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>处理连接的认证，只会对连接上的第一个消息调用，需要支持认证的server端必须实现，不需要认证或仅支持client端的协议可填NULL。成功返回true，否则false。</p><h3 id=parse_server_address>parse_server_address</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#000>bool</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ParseServerAddress</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EndPoint</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>out</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>server_addr_and_port</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>把server_addr_and_port(Channel.Init的一个参数)转化为butil::EndPoint，可选。一些协议对server地址的表达和理解可能是不同的。</p><h3 id=get_method_name>get_method_name</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>GetMethodName</span><span style=color:#000;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>MethodDescriptor</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>method</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                            <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>定制method name，可选。</p><h3 id=supported_connection_type>supported_connection_type</h3><p>标记支持的连接方式。如果支持所有连接方式，设为CONNECTION_TYPE_ALL。如果只支持连接池和短连接，设为CONNECTION_TYPE_POOLED_AND_SHORT。</p><h3 id=name>name</h3><p>协议的名称，会出现在各种配置和显示中，越简短越好，必须是字符串常量。</p><h2 id=注册到全局>注册到全局</h2><p>实现好的协议要调用RegisterProtocol<a href=https://github.com/brpc/brpc/blob/master/src/brpc/global.cpp>注册到全局</a>，以便brpc发现。就像这样：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>Protocol</span> <span style=color:#000>http_protocol</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>ParseHttpMessage</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#000>SerializeHttpRequest</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PackHttpRequest</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#000>ProcessHttpRequest</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ProcessHttpResponse</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#000>VerifyHttpRequest</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ParseHttpServerAddress</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#000>GetHttpMethodName</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#000>CONNECTION_TYPE_POOLED_AND_SHORT</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                           <span style=color:#4e9a06>&#34;http&#34;</span> <span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>RegisterProtocol</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>PROTOCOL_HTTP</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>http_protocol</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>exit</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><div class=section-index><hr class=panel-line></div><div class="text-muted mt-5 pt-3 border-top">修改于 2022年10月31日: <a href=https://github.com/apache/incubator-brpc-website/commit/039a6269b445e3975d1981f8e00f2e646642790e>update content doc community committers index.md (#110) (039a626)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none" style=display:flex;align-items:center;padding:0!important><div class="container-fluid mx-sm-5"><div class=row style=display:flex;align-items:center><div class="col-12 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/apache/incubator-brpc><i class="fab fa-github"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. 保留所有权利</small><div style=font-size:12.8px;color:#757474><a href=https://www.apache.org/ target=_blank rel=noopener>Foundation</a> |
<a href=https://www.apache.org/licenses/ target=_blank rel=noopener>License</a> |
<a href=https://www.apache.org/security/ target=_blank rel=noopener>Security</a> |
<a href=https://www.apache.org/events/current-event target=_blank rel=noopener>Events</a> |
<a href=https://www.apache.org/foundation/sponsorship.html target=_blank rel=noopener>Sponsorship</a> |
<a href=https://privacy.apache.org/policies/privacy-policy-public.html target=_blank rel=noopener>Privacy</a> |
<a href=https://www.apache.org/foundation/thanks.html target=_blank rel=noopener>Thanks</a></div></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.9d50ef1e20df1eedd2ae2eb4cada72195e39f38e910f839ca9df5402c80b9695.js integrity="sha256-nVDvHiDfHu3Sri60ytpyGV45846RD4Ocqd9UAsgLlpU=" crossorigin=anonymous></script></body></html>