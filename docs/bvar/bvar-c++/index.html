<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.86.0" />
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="alternate" type="application/rss&#43;xml" href="https://brpc.incubator.apache.org/docs/bvar/bvar-c&#43;&#43;/index.xml">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>bvar c&#43;&#43; | bRPC</title><meta property="og:title" content="bvar c&#43;&#43;" />
<meta property="og:description" content="对bvar c&#43;&#43;版本的快速介绍。
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://brpc.incubator.apache.org/docs/bvar/bvar-c&#43;&#43;/" /><meta property="og:site_name" content="bRPC" />

<meta itemprop="name" content="bvar c&#43;&#43;">
<meta itemprop="description" content="对bvar c&#43;&#43;版本的快速介绍。
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="bvar c&#43;&#43;"/>
<meta name="twitter:description" content="对bvar c&#43;&#43;版本的快速介绍。
"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-93485976-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




<link rel="preload" href="/scss/main.min.3ec220ee970bc505bab687924141abfe4d5e51807105a3b107b0cad6e3c0efc6.css" as="style">
<link href="/scss/main.min.3ec220ee970bc505bab687924141abfe4d5e51807105a3b107b0cad6e3c0efc6.css" rel="stylesheet" integrity="">


<script src="/js/jquery-3.3.1.min.js"></script>





    <title>bvar c&#43;&#43; | bRPC</title>
  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span>
        
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://github.com/apache/incubator-brpc/" target="_blank" ><span>GitHub</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/community/" ><span>社区</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/faq/" ><span>FAQ</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/docs/users/" ><span>用户</span></a>
			</li>
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/docs/bvar/bvar-c&#43;&#43;/">English</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    <div class="nav-item dropdown d-block d-lg-none">
      

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/docs/bvar/bvar-c&#43;&#43;/">English</a>
	
</div>
    </div>
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a>
  </li>
  <ul>
    <li class="collapse show" id="docs">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsoverview" href="/docs/overview/">简介</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsgetting_started" href="/docs/getting_started/">开始</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsbenchmark" href="/docs/benchmark/">性能基准</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/bvar/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">bvar</a>
  </li>
  <ul>
    <li class="collapse show" id="docsbvar">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/bvar/bvar/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a>
  </li>
  <ul>
    <li class="collapse " id="docsbvarbvar">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/bvar/bvar-c&#43;&#43;/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">bvar c&#43;&#43;</a>
  </li>
  <ul>
    <li class="collapse show" id="docsbvarbvar-c">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/bthread/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a>
  </li>
  <ul>
    <li class="collapse " id="docsbthread">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/bthread/bthread/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a>
  </li>
  <ul>
    <li class="collapse " id="docsbthreadbthread">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/bthread/bthread-or-not/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread or not</a>
  </li>
  <ul>
    <li class="collapse " id="docsbthreadbthread-or-not">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/bthread/execution-queue/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Execution Queue</a>
  </li>
  <ul>
    <li class="collapse " id="docsbthreadexecution-queue">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/bthread/thread-local/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">thread-local</a>
  </li>
  <ul>
    <li class="collapse " id="docsbthreadthread-local">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">客户端</a>
  </li>
  <ul>
    <li class="collapse " id="docsclient">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/basics/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientbasics">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/error-code/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">错误码</a>
  </li>
  <ul>
    <li class="collapse " id="docsclienterror-code">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/combo-channels/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">组合channels</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientcombo-channels">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/access-httph2/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问http:h2</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientaccess-httph2">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/access-grpc/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问gRPC</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientaccess-grpc">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/access-thrift/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问thrift</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientaccess-thrift">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/access-ub/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问UB</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientaccess-ub">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/access-redis/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问redis</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientaccess-redis">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/access-memcached/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问memcached</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientaccess-memcached">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/streaming-rpc/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流式RPC</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientstreaming-rpc">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/backup-request/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Backup request</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientbackup-request">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/client/dummy-server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dummy server</a>
  </li>
  <ul>
    <li class="collapse " id="docsclientdummy-server">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">服务端</a>
  </li>
  <ul>
    <li class="collapse " id="docsserver">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/basics/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a>
  </li>
  <ul>
    <li class="collapse " id="docsserverbasics">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/serve-httph2/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建http:h2服务</a>
  </li>
  <ul>
    <li class="collapse " id="docsserverserve-httph2">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/serve-grpc/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建gRPC服务</a>
  </li>
  <ul>
    <li class="collapse " id="docsserverserve-grpc">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/serve-thrift/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建thrift服务</a>
  </li>
  <ul>
    <li class="collapse " id="docsserverserve-thrift">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/serve-nshead/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建Nshead服务</a>
  </li>
  <ul>
    <li class="collapse " id="docsserverserve-nshead">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/server-push/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">推送</a>
  </li>
  <ul>
    <li class="collapse " id="docsserverserver-push">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/avalanche/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">雪崩</a>
  </li>
  <ul>
    <li class="collapse " id="docsserveravalanche">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/debug-server-issues/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">高效率排查server卡顿</a>
  </li>
  <ul>
    <li class="collapse " id="docsserverdebug-server-issues">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/auto-concurrencylimiter/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">自适应限流</a>
  </li>
  <ul>
    <li class="collapse " id="docsserverauto-concurrencylimiter">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/media-server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流媒体服务</a>
  </li>
  <ul>
    <li class="collapse " id="docsservermedia-server">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/server/json2pb/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">json2pb</a>
  </li>
  <ul>
    <li class="collapse " id="docsserverjson2pb">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内置服务</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-services">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/buildin_services/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">builtin services</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-servicesbuildin_services">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/status/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">status</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-servicesstatus">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/vars/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">vars</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-servicesvars">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/connections/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">connections</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-servicesconnections">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/flags/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">flags</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-servicesflags">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/rpcz/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpcz</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-servicesrpcz">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/cpu_profiler/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">cpu profiler</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-servicescpu_profiler">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/heap_profiler/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">heap profiler</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-servicesheap_profiler">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/builtin-services/contention_profiler/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">contention profiler</a>
  </li>
  <ul>
    <li class="collapse " id="docsbuiltin-servicescontention_profiler">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/tools/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">工具</a>
  </li>
  <ul>
    <li class="collapse " id="docstools">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/tools/rpc_press/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_press</a>
  </li>
  <ul>
    <li class="collapse " id="docstoolsrpc_press">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/tools/rpc_replay/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_replay</a>
  </li>
  <ul>
    <li class="collapse " id="docstoolsrpc_replay">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/tools/rpc_view/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_view</a>
  </li>
  <ul>
    <li class="collapse " id="docstoolsrpc_view">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/tools/benchmark_http/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">benchmark_http</a>
  </li>
  <ul>
    <li class="collapse " id="docstoolsbenchmark_http">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/tools/parallel_http/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">parallel_http</a>
  </li>
  <ul>
    <li class="collapse " id="docstoolsparallel_http">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/c&#43;&#43;-base/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">C&#43;&#43;基础</a>
  </li>
  <ul>
    <li class="collapse " id="docsc-base">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/c&#43;&#43;-base/iobuf/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IOBuf</a>
  </li>
  <ul>
    <li class="collapse " id="docsc-baseiobuf">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/c&#43;&#43;-base/streaming-log/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming Log</a>
  </li>
  <ul>
    <li class="collapse " id="docsc-basestreaming-log">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/c&#43;&#43;-base/flatmap/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FlatMap</a>
  </li>
  <ul>
    <li class="collapse " id="docsc-baseflatmap">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/c&#43;&#43;-base/brpc-training-materials/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC培训材料</a>
  </li>
  <ul>
    <li class="collapse " id="docsc-basebrpc-training-materials">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">深入RPC</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depth">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/new-protocol/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">支持新协议</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depthnew-protocol">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/atomic-instructions/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">原子指令</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depthatomic-instructions">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/io/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IO</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depthio">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/threading-overview/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">线程模型简介</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depththreading-overview">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/load-balancing/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">负载均衡</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depthload-balancing">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/locality-aware/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Locality-aware</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depthlocality-aware">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/consistent-hashing/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">一致性哈希</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depthconsistent-hashing">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/memory-management/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内存管理</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depthmemory-management">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/timer-keeping/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Timer keeping</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depthtimer-keeping">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/rpc-in-depth/bthread_id/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread_id</a>
  </li>
  <ul>
    <li class="collapse " id="docsrpc-in-depthbthread_id">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/use-cases-inside-baidu/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC在百度内部的应用</a>
  </li>
  <ul>
    <li class="collapse " id="docsuse-cases-inside-baidu">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/use-cases-inside-baidu/use-case1/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">百度地图api入口</a>
  </li>
  <ul>
    <li class="collapse " id="docsuse-cases-inside-baiduuse-case1">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/use-cases-inside-baidu/use-case2/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联盟DSP</a>
  </li>
  <ul>
    <li class="collapse " id="docsuse-cases-inside-baiduuse-case2">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/use-cases-inside-baidu/use-case3/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ELF学习框架</a>
  </li>
  <ul>
    <li class="collapse " id="docsuse-cases-inside-baiduuse-case3">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/use-cases-inside-baidu/use-case4/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云平台代理服务</a>
  </li>
  <ul>
    <li class="collapse " id="docsuse-cases-inside-baiduuse-case4">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsdownloadbrpc" href="/docs/downloadbrpc/">下载bRPC</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsfaq" href="/docs/faq/">FAQ</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docsusers" href="/docs/users/">用户</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docscommunity" href="/docs/community/">社区</a>
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">





<a href="https://github.com/apache/incubator-brpc-website/edit/master/content/zh/docs/bvar/bvar-c&#43;&#43;/_index.md" target="_blank"><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/incubator-brpc-website/issues/new?title=bvar%20c&#43;&#43;" target="_blank"><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>


<a href="https://github.com/apache/incubator-brpc/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#bvaradder">bvar::Adder</a></li>
    <li><a href="#bvarmaxer">bvar::Maxer</a></li>
    <li><a href="#bvarminer">bvar::Miner</a></li>
  </ul>

  <ul>
    <li><a href="#和window的差别">和Window的差别</a></li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="/docs/">文档</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/bvar/">bvar</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/bvar/bvar-c&#43;&#43;/">bvar c&#43;&#43;</a>
</li>

	</ol>
</nav	>


            
<div class="td-content">
	<h1>bvar c&#43;&#43;</h1>
	<div class="lead">对bvar c++版本的快速介绍。</div>
	<h1 id="quick-introduction">Quick introduction</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;bvar/bvar.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">namespace</span> <span style="color:#000">foo</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">namespace</span> <span style="color:#000">bar</span> <span style="color:#000;font-weight:bold">{</span>

<span style="color:#8f5902;font-style:italic">// bvar::Adder&lt;T&gt;用于累加，下面定义了一个统计read error总数的Adder。
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">g_read_error</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// 把bvar::Window套在其他bvar上就可以获得时间窗口内的值。
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Window</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">g_read_error_minute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo_bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;read_error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">g_read_error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">//                                                     ^          ^                         ^
</span><span style="color:#8f5902;font-style:italic">//                                                    前缀       监控项名称                  60秒,忽略则为10秒
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// bvar::LatencyRecorder是一个复合变量，可以统计：总量、qps、平均延时，延时分位值，最大延时。
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">LatencyRecorder</span> <span style="color:#000">g_write_latency</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo_bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;write&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">//                                      ^          ^
</span><span style="color:#8f5902;font-style:italic">//                                     前缀       监控项，别加latency！LatencyRecorder包含多个bvar，它们会加上各自的后缀，比如write_qps, write_latency等等。
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// 定义一个统计“已推入task”个数的变量。
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">g_task_pushed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo_bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;task_pushed&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// 把bvar::PerSecond套在其他bvar上可以获得时间窗口内*平均每秒*的值，这里是每秒内推入task的个数。
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">PerSecond</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">g_task_pushed_second</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo_bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;task_pushed_second&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">g_task_pushed</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">//       ^                                                                                             ^
</span><span style="color:#8f5902;font-style:italic">//    和Window不同，PerSecond会除以时间窗口的大小.                                   时间窗口是最后一个参数，这里没填，就是默认10秒。
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000;font-weight:bold">}</span>  <span style="color:#8f5902;font-style:italic">// bar
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>  <span style="color:#8f5902;font-style:italic">// foo
</span></code></pre></div><p>在应用的地方：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// 碰到read error
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">g_read_error</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// write_latency是23ms
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">g_write_latency</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// 推入了1个task
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">g_task_pushed</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>注意Window&lt;&gt;和PerSecond&lt;&gt;都是衍生变量，会自动更新，你不用给它们推值。你当然也可以把bvar作为成员变量或局部变量。</p>
<p>常用的bvar有：</p>
<ul>
<li><code>bvar::Adder&lt;T&gt;</code> : 计数器，默认0，varname &laquo; N相当于varname += N。</li>
<li><code>bvar::Maxer&lt;T&gt;</code> : 求最大值，默认std::numeric_limits<T>::min()，varname &laquo; N相当于varname = max(varname, N)。</li>
<li><code>bvar::Miner&lt;T&gt;</code> : 求最小值，默认std::numeric_limits<T>::max()，varname &laquo; N相当于varname = min(varname, N)。</li>
<li><code>bvar::IntRecorder</code> : 求自使用以来的平均值。注意这里的定语不是“一段时间内”。一般要通过Window衍生出时间窗口内的平均值。</li>
<li><code>bvar::Window&lt;VAR&gt;</code> : 获得某个bvar在一段时间内的累加值。Window衍生于已存在的bvar，会自动更新。</li>
<li><code>bvar::PerSecond&lt;VAR&gt;</code> : 获得某个bvar在一段时间内平均每秒的累加值。PerSecond也是会自动更新的衍生变量。</li>
<li><code>bvar::LatencyRecorder</code> : 专用于记录延时和qps的变量。输入延时，平均延时/最大延时/qps/总次数 都有了。</li>
</ul>
<p>**确认变量名是全局唯一的！**否则会曝光失败，如果-bvar_abort_on_same_name为true，程序会直接abort。</p>
<p>程序中有来自各种模块不同的bvar，为避免重名，建议如此命名：<strong>模块_类名_指标</strong></p>
<ul>
<li><strong>模块</strong>一般是程序名，可以加上产品线的缩写，比如inf_ds，ecom_retrbs等等。</li>
<li><strong>类名</strong>一般是类名或函数名，比如storage_manager, file_transfer, rank_stage1等等。</li>
<li><strong>指标</strong>一般是count，qps，latency这类。</li>
</ul>
<p>一些正确的命名如下：</p>
<pre><code>iobuf_block_count : 29                          # 模块=iobuf   类名=block  指标=count
iobuf_block_memory : 237568                     # 模块=iobuf   类名=block  指标=memory
process_memory_resident : 34709504              # 模块=process 类名=memory 指标=resident
process_memory_shared : 6844416                 # 模块=process 类名=memory 指标=shared
rpc_channel_connection_count : 0                # 模块=rpc     类名=channel_connection  指标=count
rpc_controller_count : 1                        # 模块=rpc     类名=controller 指标=count
rpc_socket_count : 6                            # 模块=rpc     类名=socket     指标=count
</code></pre><p>目前bvar会做名字归一化，不管你打入的是foo::BarNum, foo.bar.num, foo bar num , foo-bar-num，最后都是foo_bar_num。</p>
<p>关于指标：</p>
<ul>
<li>个数以_count为后缀，比如request_count, error_count。</li>
<li>每秒的个数以_second为后缀，比如request_second, process_inblocks_second，已经足够明确，不用写成_count_second或_per_second。</li>
<li>每分钟的个数以_minute为后缀，比如request_minute, process_inblocks_minute</li>
</ul>
<p>如果需要使用定义在另一个文件中的计数器，需要在头文件中声明对应的变量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">namespace</span> <span style="color:#000">foo</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">namespace</span> <span style="color:#000">bar</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#8f5902;font-style:italic">// 注意g_read_error_minute和g_task_pushed_per_second都是衍生的bvar，会自动更新，不要声明。
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">g_read_error</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">LatencyRecorder</span> <span style="color:#000">g_write_latency</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">g_task_pushed</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>  <span style="color:#8f5902;font-style:italic">// bar
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>  <span style="color:#8f5902;font-style:italic">// foo
</span></code></pre></div><p><strong>不要跨文件定义全局Window或PerSecond</strong>。不同编译单元中全局变量的初始化顺序是<a href="https://isocpp.org/wiki/faq/ctors#static-init-order">未定义的</a>。在foo.cpp中定义<code>Adder&lt;int&gt; foo_count</code>，在foo_qps.cpp中定义<code>PerSecond&lt;Adder&lt;int&gt; &gt; foo_qps(&amp;foo_count);</code>是<strong>错误</strong>的做法。</p>
<p>About thread-safety:</p>
<ul>
<li>bvar是线程兼容的。你可以在不同的线程里操作不同的bvar。比如你可以在多个线程中同时expose或hide<strong>不同的</strong>bvar，它们会合理地操作需要共享的全局数据，是安全的。</li>
<li><strong>除了读写接口</strong>，bvar的其他函数都是线程不安全的：比如说你不能在多个线程中同时expose或hide<strong>同一个</strong>bvar，这很可能会导致程序crash。一般来说，读写之外的其他接口也没有必要在多个线程中同时操作。</li>
</ul>
<p>计时可以使用butil::Timer，接口如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;butil/time.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">namespace</span> <span style="color:#000">butil</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Timer</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">public</span><span style="color:#ce5c00;font-weight:bold">:</span>
    <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">TimerType</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">STARTED</span> <span style="color:#000;font-weight:bold">};</span>

    <span style="color:#000">Timer</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#8f5902;font-style:italic">// butil::Timer tm(butil::Timer::STARTED);  // tm is already started after creation.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">explicit</span> <span style="color:#000">Timer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TimerType</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">// Start this timer
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#8f5902;font-style:italic">// Stop this timer
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#8f5902;font-style:italic">// Get the elapse from start() to stop().
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#000">n_elapsed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// in nanoseconds
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#000">u_elapsed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// in microseconds
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#000">m_elapsed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// in milliseconds
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#000">s_elapsed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// in seconds
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>  <span style="color:#8f5902;font-style:italic">// namespace butil
</span></code></pre></div><h1 id="bvarvariable">bvar::Variable</h1>
<p>Variable是所有bvar的基类，主要提供全局注册，列举，查询等功能。</p>
<p>用户以默认参数建立一个bvar时，这个bvar并未注册到任何全局结构中，在这种情况下，bvar纯粹是一个更快的计数器。我们称把一个bvar注册到全局表中的行为为“曝光”，可通过<code>expose</code>函数曝光：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// Expose this variable globally so that it&#39;s counted in following functions:
</span><span style="color:#8f5902;font-style:italic">//   list_exposed
</span><span style="color:#8f5902;font-style:italic">//   count_exposed
</span><span style="color:#8f5902;font-style:italic">//   describe_exposed
</span><span style="color:#8f5902;font-style:italic">//   find_exposed
</span><span style="color:#8f5902;font-style:italic">// Return 0 on success, -1 otherwise.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">expose</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">butil</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">StringPiece</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">expose_as</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">butil</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">StringPiece</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">butil</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">StringPiece</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>全局曝光后的bvar名字便为name或prefix + name，可通过以_exposed为后缀的static函数查询。比如Variable::describe_exposed(name)会返回名为name的bvar的描述。</p>
<p>当相同名字的bvar已存在时，expose会打印FATAL日志并返回-1。如果选项**&ndash;bvar_abort_on_same_name**设为true (默认是false)，程序会直接abort。</p>
<p>下面是一些曝光bvar的例子：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">count1</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">count1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">20</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">30</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// values add up to 60.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">count1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expose</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count1&#34;</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// expose the variable globally
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">CHECK_EQ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;60&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Variable</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">describe_exposed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count1&#34;</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000">count1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expose</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;another_name_for_count1&#34;</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// expose the variable with another name
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">CHECK_EQ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Variable</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">describe_exposed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count1&#34;</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000">CHECK_EQ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;60&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Variable</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">describe_exposed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;another_name_for_count1&#34;</span><span style="color:#000;font-weight:bold">));</span>

<span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">count2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count2&#34;</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// exposed in constructor directly
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">CHECK_EQ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;0&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Variable</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">describe_exposed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count2&#34;</span><span style="color:#000;font-weight:bold">));</span>  <span style="color:#8f5902;font-style:italic">// default value of Adder&lt;int&gt; is 0
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Status</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">status1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// the name conflicts. if -bvar_abort_on_same_name is true,
</span><span style="color:#8f5902;font-style:italic"></span>                                                       <span style="color:#8f5902;font-style:italic">// program aborts, otherwise a fatal log is printed.
</span></code></pre></div><p>为避免重名，bvar的名字应加上前缀，建议为<code>&lt;namespace&gt;_&lt;module&gt;_&lt;name&gt;</code>。为了方便使用，我们提供了<strong>expose_as</strong>函数，接收一个前缀。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// Expose this variable with a prefix.
</span><span style="color:#8f5902;font-style:italic">// Example:
</span><span style="color:#8f5902;font-style:italic">//   namespace foo {
</span><span style="color:#8f5902;font-style:italic">//   namespace bar {
</span><span style="color:#8f5902;font-style:italic">//   class ApplePie {
</span><span style="color:#8f5902;font-style:italic">//       ApplePie() {
</span><span style="color:#8f5902;font-style:italic">//           // foo_bar_apple_pie_error
</span><span style="color:#8f5902;font-style:italic">//           _error.expose_as(&#34;foo_bar_apple_pie&#34;, &#34;error&#34;);
</span><span style="color:#8f5902;font-style:italic">//       }
</span><span style="color:#8f5902;font-style:italic">//   private:
</span><span style="color:#8f5902;font-style:italic">//       bvar::Adder&lt;int&gt; _error;
</span><span style="color:#8f5902;font-style:italic">//   };
</span><span style="color:#8f5902;font-style:italic">//   }  // foo
</span><span style="color:#8f5902;font-style:italic">//   }  // bar
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">expose_as</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">butil</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">StringPiece</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">prefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">butil</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">StringPiece</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h1 id="export-all-variables">Export all variables</h1>
<p>最常见的导出需求是通过HTTP接口查询和写入本地文件。前者在brpc中通过<a href="../../builtin-services/vars/">/vars</a>服务提供，后者则已实现在bvar中，默认不打开。有几种方法打开这个功能：</p>
<ul>
<li>用<a href="../../builtin-services/flags/">gflags</a>解析输入参数，在程序启动时加入-bvar_dump，或在brpc中也可通过<a href="../../builtin-services/flags/">/flags</a>服务在启动后动态修改。gflags的解析方法如下，在main函数处添加如下代码:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">  <span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;gflags/gflags.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">...</span>
  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">google</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">ParseCommandLineFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">true</span><span style="color:#8f5902;font-style:italic">/*表示把识别的参数从argc/argv中删除*/</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">...</span>
  <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ul>
<li>不想用gflags解析参数，希望直接在程序中默认打开，在main函数处添加如下代码：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;gflags/gflags.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">google</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">SetCommandLineOption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bvar_dump&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">FATAL</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;Fail to enable bvar dump&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>dump功能由如下gflags控制：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>默认值</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>bvar_dump</td>
<td>false</td>
<td>Create a background thread dumping all bvar periodically, all bvar_dump_* flags are not effective when this flag is off</td>
</tr>
<tr>
<td>bvar_dump_exclude</td>
<td>&quot;&quot;</td>
<td>Dump bvar excluded from these wildcards(separated by comma), empty means no exclusion</td>
</tr>
<tr>
<td>bvar_dump_file</td>
<td>monitor/bvar.<app>.data</td>
<td>Dump bvar into this file</td>
</tr>
<tr>
<td>bvar_dump_include</td>
<td>&quot;&quot;</td>
<td>Dump bvar matching these wildcards(separated by comma), empty means including all</td>
</tr>
<tr>
<td>bvar_dump_interval</td>
<td>10</td>
<td>Seconds between consecutive dump</td>
</tr>
<tr>
<td>bvar_dump_prefix</td>
<td>&lt;app&gt;</td>
<td>Every dumped name starts with this prefix</td>
</tr>
<tr>
<td>bvar_dump_tabs</td>
<td>&lt;check the code&gt;</td>
<td>Dump bvar into different tabs according to the filters (seperated by semicolon), format: *(tab_name=wildcards)</td>
</tr>
</tbody>
</table>
<p>当bvar_dump_file不为空时，程序会启动一个后台导出线程以bvar_dump_interval指定的间隔更新bvar_dump_file，其中包含了被bvar_dump_include匹配且不被bvar_dump_exclude匹配的所有bvar。</p>
<p>比如我们把所有的gflags修改为下图：</p>
<p><img src="/images/docs/bvar_dump_flags_2.png" alt="img"></p>
<p>导出文件为：</p>
<pre><code>$ cat bvar.echo_server.data
rpc_server_8002_builtin_service_count : 20
rpc_server_8002_connection_count : 1
rpc_server_8002_nshead_service_adaptor : brpc::policy::NovaServiceAdaptor
rpc_server_8002_service_count : 1
rpc_server_8002_start_time : 2015/07/24-21:08:03
rpc_server_8002_uptime_ms : 14740954
</code></pre><p>像”<code>iobuf_block_count : 8</code>”被bvar_dump_include过滤了，“<code>rpc_server_8002_error : 0</code>”则被bvar_dump_exclude排除了。</p>
<p>如果你的程序没有使用brpc，仍需要动态修改gflag（一般不需要），可以调用google::SetCommandLineOption()，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;gflags/gflags.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">google</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">SetCommandLineOption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bvar_dump_include&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;*service*&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ERROR</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;Fail to set bvar_dump_include&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;Successfully set bvar_dump_include to *service*&#34;</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>请勿直接设置FLAGS_bvar_dump_file / FLAGS_bvar_dump_include / FLAGS_bvar_dump_exclude。
一方面这些gflag类型都是std::string，直接覆盖是线程不安全的；另一方面不会触发validator（检查正确性的回调），所以也不会启动后台导出线程。</p>
<p>用户也可以使用dump_exposed函数自定义如何导出进程中的所有已曝光的bvar：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// Implement this class to write variables into different places.
</span><span style="color:#8f5902;font-style:italic">// If dump() returns false, Variable::dump_exposed() stops and returns -1.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Dumper</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">public</span><span style="color:#ce5c00;font-weight:bold">:</span>
    <span style="color:#204a87;font-weight:bold">virtual</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">dump</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">butil</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">StringPiece</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">description</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#8f5902;font-style:italic">// Options for Variable::dump_exposed().
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">DumpOptions</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Contructed with default options.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">DumpOptions</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#8f5902;font-style:italic">// If this is true, string-type values will be quoted.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">quote_string</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#8f5902;font-style:italic">// The ? in wildcards. Wildcards in URL need to use another character
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// because ? is reserved.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">question_mark</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#8f5902;font-style:italic">// Separator for white_wildcards and black_wildcards.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">wildcard_separator</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#8f5902;font-style:italic">// Name matched by these wildcards (or exact names) are kept.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">white_wildcards</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#8f5902;font-style:italic">// Name matched by these wildcards (or exact names) are skipped.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">black_wildcards</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Variable</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#8f5902;font-style:italic">// Find all exposed variables matching `white_wildcards&#39; but
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// `black_wildcards&#39; and send them to `dumper&#39;.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Use default options when `options&#39; is NULL.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Return number of dumped variables, -1 on error.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">dump_exposed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Dumper</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">dumper</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">DumpOptions</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><h1 id="bvarreducer">bvar::Reducer</h1>
<p>Reducer用二元运算符把多个值合并为一个值，运算符需满足结合律，交换律，没有副作用。只有满足这三点，我们才能确保合并的结果不受线程私有数据如何分布的影响。像减法就不满足结合律和交换律，它无法作为此处的运算符。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// Reduce multiple values into one with `Op&#39;: e1 Op e2 Op e3 ...
</span><span style="color:#8f5902;font-style:italic">// `Op&#39; shall satisfy:
</span><span style="color:#8f5902;font-style:italic">//   - associative:     a Op (b Op c) == (a Op b) Op c
</span><span style="color:#8f5902;font-style:italic">//   - commutative:     a Op b == b Op a;
</span><span style="color:#8f5902;font-style:italic">//   - no side effects: a Op b never changes if a and b are fixed.
</span><span style="color:#8f5902;font-style:italic">// otherwise the result is undefined.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">template</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">Op</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Reducer</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Variable</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>reducer &laquo; e1 &laquo; e2 &laquo; e3的作用等价于reducer = e1 op e2 op e3。</p>
<p>常见的Redcuer子类有bvar::Adder, bvar::Maxer, bvar::Miner。</p>
<h2 id="bvaradder">bvar::Adder</h2>
<p>顾名思义，用于累加，Op为+。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">CHECK_EQ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get_value</span><span style="color:#000;font-weight:bold">());</span>

<span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">fp_value</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 可能有warning
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fp_value</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1.0</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">2.0</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">3.0</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4.0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">CHECK_DOUBLE_EQ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fp_value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get_value</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><p>Adder&lt;&gt;可用于非基本类型，对应的类型至少要重载<code>T operator+(T, T)</code>。一个已经存在的例子是std::string，下面的代码会把string拼接起来：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// This is just proof-of-concept, don&#39;t use it for production code because it makes a
</span><span style="color:#8f5902;font-style:italic">// bunch of temporary strings which is not efficient, use std::ostringstream instead.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">concater</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">str1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;world&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">concater</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;hello &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">str1</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">CHECK_EQ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello world&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">concater</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get_value</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><h2 id="bvarmaxer">bvar::Maxer</h2>
<p>用于取最大值，运算符为std::max。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Maxer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">CHECK_EQ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get_value</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><p>Since Maxer&lt;&gt; use std::numeric_limits<T>::min() as the identity, it cannot be applied to generic types unless you specialized std::numeric_limits&lt;&gt; (and overloaded operator&lt;, yes, not operator&gt;).</p>
<h2 id="bvarminer">bvar::Miner</h2>
<p>用于取最小值，运算符为std::min。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Maxer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">CHECK_EQ</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get_value</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><p>Since Miner&lt;&gt; use std::numeric_limits<T>::max() as the identity, it cannot be applied to generic types unless you specialized std::numeric_limits&lt;&gt; (and overloaded operator&lt;).</p>
<h1 id="bvarintrecorder">bvar::IntRecorder</h1>
<p>用于计算平均值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// For calculating average of numbers.
</span><span style="color:#8f5902;font-style:italic">// Example:
</span><span style="color:#8f5902;font-style:italic">//   IntRecorder latency;
</span><span style="color:#8f5902;font-style:italic">//   latency &lt;&lt; 1 &lt;&lt; 3 &lt;&lt; 5;
</span><span style="color:#8f5902;font-style:italic">//   CHECK_EQ(3, latency.average());
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">IntRecorder</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Variable</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h1 id="bvarlatencyrecorder">bvar::LatencyRecorder</h1>
<p>专用于计算latency和qps的计数器。只需填入latency数据，就能获得latency / max_latency / qps / count。统计窗口是最后一个参数，不填为bvar_dump_interval（这里没填）。</p>
<p>注意：LatencyRecorder没有继承Variable，而是多个bvar的组合。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">LatencyRecorder</span> <span style="color:#000">write_latency</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;table2_my_table_write&#34;</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// produces 4 variables:
</span><span style="color:#8f5902;font-style:italic"></span>                                                         <span style="color:#8f5902;font-style:italic">//   table2_my_table_write_latency
</span><span style="color:#8f5902;font-style:italic"></span>                                                         <span style="color:#8f5902;font-style:italic">//   table2_my_table_write_max_latency
</span><span style="color:#8f5902;font-style:italic"></span>                                                         <span style="color:#8f5902;font-style:italic">//   table2_my_table_write_qps
</span><span style="color:#8f5902;font-style:italic"></span>                                                         <span style="color:#8f5902;font-style:italic">//   table2_my_table_write_count
</span><span style="color:#8f5902;font-style:italic">// In your write function
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">write_latency</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">the_latency_of_write</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h1 id="bvarwindow">bvar::Window</h1>
<p>获得之前一段时间内的统计值。Window不能独立存在，必须依赖于一个已有的计数器。Window会自动更新，不用给它发送数据。出于性能考虑，Window的数据来自于每秒一次对原计数器的采样，在最差情况下，Window的返回值有1秒的延时。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// Get data within a time window.
</span><span style="color:#8f5902;font-style:italic">// The time unit is 1 second fixed.
</span><span style="color:#8f5902;font-style:italic">// Window relies on other bvar which should be constructed before this window and destructs after this window.
</span><span style="color:#8f5902;font-style:italic">// R must:
</span><span style="color:#8f5902;font-style:italic">// - have get_sampler() (not require thread-safe)
</span><span style="color:#8f5902;font-style:italic">// - defined value_type and sampler_type
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">template</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">R</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Window</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Variable</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h1 id="bvarpersecond">bvar::PerSecond</h1>
<p>获得之前一段时间内平均每秒的统计值。它和Window基本相同，除了返回值会除以时间窗口之外。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// sum_per_second.get_value()是sum在之前60秒内*平均每秒*的累加值，省略最后一个时间窗口的话默认为bvar_dump_interval。
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">PerSecond</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Adder</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">sum_per_second</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">sum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><strong>PerSecond并不总是有意义</strong></p>
<p>上面的代码中没有Maxer，因为一段时间内的最大值除以时间窗口是没有意义的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Maxer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">max_value</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// 错误！最大值除以时间是没有意义的
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">PerSecond</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Maxer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">max_value_per_second_wrong</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">max_value</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// 正确，把Window的时间窗口设为1秒才是正确的做法
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Window</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Maxer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">max_value_per_second</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">max_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="和window的差别">和Window的差别</h2>
<p>比如要统计内存在上一分钟内的变化，用Window&lt;&gt;的话，返回值的含义是”上一分钟内存增加了18M”，用PerSecond&lt;&gt;的话，返回值的含义是“上一分钟平均每秒增加了0.3M”。</p>
<p>Window的优点是精确值，适合一些比较小的量，比如“上一分钟的错误数“，如果这用PerSecond的话，得到可能是”上一分钟平均每秒产生了0.0167个错误&quot;，这相比于”上一分钟有1个错误“显然不够清晰。另外一些和时间无关的量也要用Window，比如统计上一分钟cpu占用率的方法是用一个Adder同时累加cpu时间和真实时间，然后用Window获得上一分钟的cpu时间和真实时间，两者相除就得到了上一分钟的cpu占用率，这和时间无关，用PerSecond会产生错误的结果。</p>
<h1 id="bvarstatus">bvar::Status</h1>
<p>记录和显示一个值，拥有额外的set_value函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">
<span style="color:#8f5902;font-style:italic">// Display a rarely or periodically updated value.
</span><span style="color:#8f5902;font-style:italic">// Usage:
</span><span style="color:#8f5902;font-style:italic">//   bvar::Status&lt;int&gt; foo_count1(17);
</span><span style="color:#8f5902;font-style:italic">//   foo_count1.expose(&#34;my_value&#34;);
</span><span style="color:#8f5902;font-style:italic">//
</span><span style="color:#8f5902;font-style:italic">//   bvar::Status&lt;int&gt; foo_count2;
</span><span style="color:#8f5902;font-style:italic">//   foo_count2.set_value(17);
</span><span style="color:#8f5902;font-style:italic">//
</span><span style="color:#8f5902;font-style:italic">//   bvar::Status&lt;int&gt; foo_count3(&#34;my_value&#34;, 17);
</span><span style="color:#8f5902;font-style:italic">//
</span><span style="color:#8f5902;font-style:italic">// Notice that Tp needs to be std::string or acceptable by boost::atomic&lt;Tp&gt;.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">template</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">Tp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Status</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Variable</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h1 id="bvarpassivestatus">bvar::PassiveStatus</h1>
<p>按需显示值。在一些场合中，我们无法set_value或不知道以何种频率set_value，更适合的方式也许是当需要显示时才打印。用户传入打印回调函数实现这个目的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// Display a updated-by-need value. This is done by passing in an user callback
</span><span style="color:#8f5902;font-style:italic">// which is called to produce the value.
</span><span style="color:#8f5902;font-style:italic">// Example:
</span><span style="color:#8f5902;font-style:italic">//   int print_number(void* arg) {
</span><span style="color:#8f5902;font-style:italic">//      ...
</span><span style="color:#8f5902;font-style:italic">//      return 5;
</span><span style="color:#8f5902;font-style:italic">//   }
</span><span style="color:#8f5902;font-style:italic">//
</span><span style="color:#8f5902;font-style:italic">//   // number1 : 5
</span><span style="color:#8f5902;font-style:italic">//   bvar::PassiveStatus status1(&#34;number1&#34;, print_number, arg);
</span><span style="color:#8f5902;font-style:italic">//
</span><span style="color:#8f5902;font-style:italic">//   // foo_number2 : 5
</span><span style="color:#8f5902;font-style:italic">//   bvar::PassiveStatus status2(typeid(Foo), &#34;number2&#34;, print_number, arg);
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">template</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">Tp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">PassiveStatus</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">Variable</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>虽然很简单，但PassiveStatus是最有用的bvar之一，因为很多统计量已经存在，我们不需要再次存储它们，而只要按需获取。比如下面的代码声明了一个在linux下显示进程用户名的bvar：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">get_username</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">ostream</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">];</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">getlogin_r</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000">os</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">os</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;unknown&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000">PassiveStatus</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">g_username</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;process_username&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">get_username</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h1 id="bvargflag">bvar::GFlag</h1>
<p>Expose important gflags as bvar so that they&rsquo;re monitored (in noah).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">DEFINE_int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">my_flag_that_matters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Expose the gflag as *same-named* bvar so that it&#39;s monitored (in noah).
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">GFlag</span> <span style="color:#000">s_gflag_my_flag_that_matters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my_flag_that_matters&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">//                                                ^
</span><span style="color:#8f5902;font-style:italic">//                                            the gflag name
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// Expose the gflag as a bvar named &#34;foo_bar_my_flag_that_matters&#34;.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">bvar</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">GFlag</span> <span style="color:#000">s_gflag_my_flag_that_matters_with_prefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo_bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;my_flag_that_matters&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div>
        <div class="section-index">
    
    
    
    
    <hr class="panel-line">
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
</div>

	
	
	<div class="text-muted mt-5 pt-3 border-top">修改于 2022年2月26日: <a  href="https://github.com/apache/incubator-brpc-website/commit/14eec1ac1805c1dde9f10d0353984bde2127294c">brpc website 1.0 fix links jump problem in overview page (14eec1a)</a>
</div>
</div>

          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none" style="display: flex; align-items: center; padding: 0 !important;">
  <div class="container-fluid mx-sm-5">
    <div class="row" style="display: flex; align-items: center;">
      <div class="col-12 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/apache/incubator-brpc">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. 保留所有权利</small>
        
	
        <div style="font-size: 12.8px; color: rgb(117, 116, 116);">
          <a href="https://www.apache.org/foundation/how-it-works.html" target="_blank" rel="noopener">Foundation</a> |
          <a href="https://www.apache.org/licenses/" target="_blank" rel="noopener">License</a> |
          <a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener">Sponsorship</a> |
          <a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener">Thanks</a>
        </div>
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>






<script src="/js/main.min.170adf90fd476d5f9243ed2e727149abe8d9fe364587fe943765d47375bbd1ad.js" integrity="sha256-FwrfkP1HbV&#43;SQ&#43;0ucnFJq&#43;jZ/jZFh/6UN2XUc3W70a0=" crossorigin="anonymous"></script>





  </body>
</html>