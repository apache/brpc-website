<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.86.0" />
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="alternate" type="application/rss&#43;xml" href="https://brpc.incubator.apache.org/en/docs/client/basics/index.xml">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Basics | bRPC</title><meta property="og:title" content="Basics" />
<meta property="og:description" content="Learn how to use bRPC client.
" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://brpc.incubator.apache.org/en/docs/client/basics/" /><meta property="og:site_name" content="bRPC" />

<meta itemprop="name" content="Basics">
<meta itemprop="description" content="Learn how to use bRPC client.
"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Basics"/>
<meta name="twitter:description" content="Learn how to use bRPC client.
"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-93485976-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




<link rel="preload" href="/scss/main.min.3ec220ee970bc505bab687924141abfe4d5e51807105a3b107b0cad6e3c0efc6.css" as="style">
<link href="/scss/main.min.3ec220ee970bc505bab687924141abfe4d5e51807105a3b107b0cad6e3c0efc6.css" rel="stylesheet" integrity="">


<script src="/js/jquery-3.3.1.min.js"></script>





    <title>Basics | bRPC</title>
  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/en/">
		<span class="navbar-logo"><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span>
        
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="https://github.com/apache/incubator-brpc/" target="_blank" ><span>GitHub</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/en/docs/" ><span class="active">Docs</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/docs/community/" ><span>Community</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/docs/faq/" ><span>FAQ</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/en/docs/users/" ><span>Users</span></a>
			</li>
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	English
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/docs/client/basics/">中文</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    
<input type="search" class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    <div class="nav-item dropdown d-block d-lg-none">
      

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	English
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/docs/client/basics/">中文</a>
	
</div>
    </div>
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Docs</a>
  </li>
  <ul>
    <li class="collapse show" id="endocs">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-endocsoverview" href="/en/docs/overview/">Overview</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-endocsgetting_started" href="/en/docs/getting_started/">Getting started</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-endocsbenchmark" href="/en/docs/benchmark/">Performance benchmark</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/bvar/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbvar">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/bvar/bvar/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbvarbvar">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/bvar/bvar-c&#43;&#43;/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar c&#43;&#43;</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbvarbvar-c">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/bthread/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbthread">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/bthread/bthread/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbthreadbthread">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/bthread/bthread-or-not/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread or not</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbthreadbthread-or-not">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/bthread/execution-queue/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Execution Queue</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbthreadexecution-queue">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/bthread/thread-local/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">thread-local</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbthreadthread-local">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Client</a>
  </li>
  <ul>
    <li class="collapse show" id="endocsclient">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/basics/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Basics</a>
  </li>
  <ul>
    <li class="collapse show" id="endocsclientbasics">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/error-code/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Error code</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclienterror-code">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/combo-channels/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Combo channels</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientcombo-channels">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/access-httph2/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access http:h2</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientaccess-httph2">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/access-grpc/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access gRPC</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientaccess-grpc">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/access-thrift/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access thrift</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientaccess-thrift">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/access-ub/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access UB</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientaccess-ub">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/access-redis/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access redis</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientaccess-redis">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/access-memcached/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access memcached</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientaccess-memcached">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/streaming-rpc/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming RPC</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientstreaming-rpc">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/backup-request/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Backup request</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientbackup-request">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/client/dummy-server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dummy server</a>
  </li>
  <ul>
    <li class="collapse " id="endocsclientdummy-server">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Server</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserver">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/basics/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Basics</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserverbasics">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/serve-httph2/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Serve http:h2</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserverserve-httph2">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/serve-grpc/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Serve gRPC</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserverserve-grpc">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/serve-thrift/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Serve thrift</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserverserve-thrift">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/serve-nshead/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Serve Nshead</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserverserve-nshead">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/server-push/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Server push</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserverserver-push">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/avalanche/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Avalanche</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserveravalanche">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/debug-server-issues/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Debug server issues</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserverdebug-server-issues">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/auto-concurrencylimiter/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Auto ConcurrencyLimiter</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserverauto-concurrencylimiter">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/media-server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Media Server</a>
  </li>
  <ul>
    <li class="collapse " id="endocsservermedia-server">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/server/json2pb/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">json2pb</a>
  </li>
  <ul>
    <li class="collapse " id="endocsserverjson2pb">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Builtin Services</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-services">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/buildin_services/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">builtin services</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-servicesbuildin_services">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/status/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">status</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-servicesstatus">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/vars/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">vars</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-servicesvars">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/connections/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">connections</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-servicesconnections">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/flags/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">flags</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-servicesflags">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/rpcz/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpcz</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-servicesrpcz">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/cpu_profiler/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">cpu profiler</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-servicescpu_profiler">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/heap_profiler/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">heap profiler</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-servicesheap_profiler">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/builtin-services/contention_profiler/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">contention profiler</a>
  </li>
  <ul>
    <li class="collapse " id="endocsbuiltin-servicescontention_profiler">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/tools/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Tools</a>
  </li>
  <ul>
    <li class="collapse " id="endocstools">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/tools/rpc_press/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_press</a>
  </li>
  <ul>
    <li class="collapse " id="endocstoolsrpc_press">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/tools/rpc_replay/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_replay</a>
  </li>
  <ul>
    <li class="collapse " id="endocstoolsrpc_replay">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/tools/rpc_view/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_view</a>
  </li>
  <ul>
    <li class="collapse " id="endocstoolsrpc_view">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/tools/benchmark_http/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">benchmark_http</a>
  </li>
  <ul>
    <li class="collapse " id="endocstoolsbenchmark_http">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/tools/parallel_http/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">parallel_http</a>
  </li>
  <ul>
    <li class="collapse " id="endocstoolsparallel_http">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/c&#43;&#43;-base/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">C&#43;&#43; Base</a>
  </li>
  <ul>
    <li class="collapse " id="endocsc-base">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/c&#43;&#43;-base/iobuf/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IOBuf</a>
  </li>
  <ul>
    <li class="collapse " id="endocsc-baseiobuf">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/c&#43;&#43;-base/streaming-log/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming Log</a>
  </li>
  <ul>
    <li class="collapse " id="endocsc-basestreaming-log">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/c&#43;&#43;-base/flatmap/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FlatMap</a>
  </li>
  <ul>
    <li class="collapse " id="endocsc-baseflatmap">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/c&#43;&#43;-base/brpc-training-materials/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC Training Materials</a>
  </li>
  <ul>
    <li class="collapse " id="endocsc-basebrpc-training-materials">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">RPC in depth</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depth">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/new-protocol/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">New Protocol</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depthnew-protocol">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/atomic-instructions/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Atomic instructions</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depthatomic-instructions">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/io/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IO</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depthio">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/threading-overview/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Threading Overview</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depththreading-overview">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/load-balancing/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Load Balancing</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depthload-balancing">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/locality-aware/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Locality-aware</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depthlocality-aware">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/consistent-hashing/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Consistent Hashing</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depthconsistent-hashing">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/memory-management/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Memory Management</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depthmemory-management">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/timer-keeping/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Timer keeping</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depthtimer-keeping">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/rpc-in-depth/bthread_id/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread_id</a>
  </li>
  <ul>
    <li class="collapse " id="endocsrpc-in-depthbthread_id">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/use-cases-inside-baidu/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Use cases inside Baidu</a>
  </li>
  <ul>
    <li class="collapse " id="endocsuse-cases-inside-baidu">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/use-cases-inside-baidu/use-case1/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">百度地图api入口</a>
  </li>
  <ul>
    <li class="collapse " id="endocsuse-cases-inside-baiduuse-case1">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/use-cases-inside-baidu/use-case2/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联盟DSP</a>
  </li>
  <ul>
    <li class="collapse " id="endocsuse-cases-inside-baiduuse-case2">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/use-cases-inside-baidu/use-case3/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ELF学习框架</a>
  </li>
  <ul>
    <li class="collapse " id="endocsuse-cases-inside-baiduuse-case3">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/en/docs/use-cases-inside-baidu/use-case4/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云平台代理服务</a>
  </li>
  <ul>
    <li class="collapse " id="endocsuse-cases-inside-baiduuse-case4">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-endocsdownloadbrpc" href="/en/docs/downloadbrpc/">Download bRPC</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-endocsfaq" href="/en/docs/faq/">FAQ</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-endocsusers" href="/en/docs/users/">Users</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-endocscommunity" href="/en/docs/community/">Community</a>
      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">





<a href="https://github.com/apache/incubator-brpc-website/edit/master/content/en/docs/Client/Basics/_index.md" target="_blank"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/apache/incubator-brpc-website/issues/new?title=Basics" target="_blank"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>


<a href="https://github.com/apache/incubator-brpc/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> Create project issue</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#naming-service">Naming Service</a>
      <ul>
        <li><a href="#bnsbns-name">bns://&lt;bns-name&gt;</a></li>
        <li><a href="#filepath">file://&lt;path&gt;</a></li>
        <li><a href="#listaddr1addr2">list://&lt;addr1&gt;,&lt;addr2&gt;&hellip;</a></li>
        <li><a href="#httpurl">http://&lt;url&gt;</a></li>
        <li><a href="#httpsurl">https://&lt;url&gt;</a></li>
        <li><a href="#consulservice-name">consul://&lt;service-name&gt;</a></li>
        <li><a href="#more-naming-services">More naming services</a></li>
        <li><a href="#the-tag-in-naming-service">The tag in naming service</a></li>
        <li><a href="#vip-related-issues">VIP related issues</a></li>
        <li><a href="#naming-service-filter">Naming Service Filter</a></li>
      </ul>
    </li>
    <li><a href="#load-balancer">Load Balancer</a>
      <ul>
        <li><a href="#rr">rr</a></li>
        <li><a href="#wrr">wrr</a></li>
        <li><a href="#random">random</a></li>
        <li><a href="#wr">wr</a></li>
        <li><a href="#la">la</a></li>
        <li><a href="#c_murmurhash-or-c_md5">c_murmurhash or c_md5</a></li>
        <li><a href="#client-side-throttling-for-recovery-from-cluster-downtime">Client-side throttling for recovery from cluster downtime</a></li>
      </ul>
    </li>
    <li><a href="#health-checking">Health checking</a></li>
  </ul>

  <ul>
    <li><a href="#synchronous-call">Synchronous call</a></li>
    <li><a href="#asynchronous-call">Asynchronous call</a>
      <ul>
        <li><a href="#use-newcallback">Use NewCallback</a></li>
        <li><a href="#inherit-googleprotobufclosure">Inherit google::protobuf::Closure</a></li>
        <li><a href="#what-will-happen-when-the-callback-is-very-complicated">What will happen when the callback is very complicated?</a></li>
        <li><a href="#does-the-callback-run-in-the-same-thread-that-callmethod-runs">Does the callback run in the same thread that CallMethod runs?</a></li>
      </ul>
    </li>
    <li><a href="#wait-for-completion-of-rpc">Wait for completion of RPC</a></li>
    <li><a href="#semi-synchronous-call">Semi-synchronous call</a></li>
    <li><a href="#cancel-rpc">Cancel RPC</a></li>
    <li><a href="#get-server-side-address-and-port">Get server-side address and port</a></li>
    <li><a href="#get-client-side-address-and-port">Get client-side address and port</a></li>
    <li><a href="#should-brpccontroller-be-reused">Should brpc::Controller be reused?</a></li>
  </ul>

  <ul>
    <li><a href="#number-of-worker-pthreads">Number of worker pthreads</a></li>
    <li><a href="#timeout">Timeout</a></li>
    <li><a href="#retry">Retry</a>
      <ul>
        <li><a href="#broken-connection">Broken connection</a></li>
        <li><a href="#timeout-is-not-reached">Timeout is not reached</a></li>
        <li><a href="#has-retrying-quota">Has retrying quota</a></li>
        <li><a href="#the-retry-makes-sense">The retry makes sense</a></li>
        <li><a href="#retrying-should-be-conservative">Retrying should be conservative</a></li>
      </ul>
    </li>
    <li><a href="#circuit-breaker">Circuit breaker</a></li>
    <li><a href="#protocols">Protocols</a></li>
    <li><a href="#connection-type">Connection Type</a></li>
    <li><a href="#close-idle-connections-in-pools">Close idle connections in pools</a></li>
    <li><a href="#defer-connection-close">Defer connection close</a></li>
    <li><a href="#buffer-size-of-connections">Buffer size of connections</a></li>
    <li><a href="#log_id">log_id</a></li>
    <li><a href="#attachment">Attachment</a></li>
    <li><a href="#turn-on-ssl">Turn on SSL</a></li>
    <li><a href="#authentication">Authentication</a></li>
    <li><a href="#reset">Reset</a></li>
    <li><a href="#compression">Compression</a></li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#q-does-brpc-support-unix-domain-socket">Q: Does brpc support unix domain socket?</a></li>
        <li><a href="#q-fail-to-connect-to-xxxxxxxxxxxx-connection-refused">Q: Fail to connect to xx.xx.xx.xx:xxxx, Connection refused</a></li>
        <li><a href="#q-often-met-connection-timedout-to-another-idc">Q: often met Connection timedout to another IDC</a></li>
        <li><a href="#q-synchronous-call-is-good-asynchronous-call-crashes">Q: synchronous call is good, asynchronous call crashes</a></li>
        <li><a href="#q-how-to-make-requests-be-processed-once-and-only-once">Q: How to make requests be processed once and only once</a></li>
        <li><a href="#q-invalid-addressbnsgroupuser-personaduminj03">Q: Invalid address=`bns://group.user-persona.dumi.nj03'</a></li>
        <li><a href="#q-both-sides-use-protobuf-why-cant-they-communicate-with-each-other">Q: Both sides use protobuf, why can&rsquo;t they communicate with each other</a></li>
        <li><a href="#q-why-c-clientserver-may-fail-to-talk-to-clientserver-in-other-languages">Q: Why C++ client/server may fail to talk to client/server in other languages</a></li>
      </ul>
    </li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="/en/en/docs/">Docs</a>
</li>




<li class="breadcrumb-item" >
	<a href="/en/en/docs/client/">Client</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/en/en/docs/client/basics/">Basics</a>
</li>

	</ol>
</nav	>


            
<div class="td-content">
	<h1>Basics</h1>
	<div class="lead">Learn how to use bRPC client.</div>
	<h1 id="example">Example</h1>
<p><a href="https://github.com/brpc/brpc/blob/master/example/echo_c++/client.cpp">client-side code</a> of echo.</p>
<h1 id="quick-facts">Quick facts</h1>
<ul>
<li>Channel.Init() is not thread-safe.</li>
<li>Channel.CallMethod() is thread-safe and a Channel can be used by multiple threads simultaneously.</li>
<li>Channel can be put on stack.</li>
<li>Channel can be destructed just after sending asynchronous request.</li>
<li>No class named brpc::Client.</li>
</ul>
<h1 id="channel">Channel</h1>
<p>Client-side of RPC sends requests. It&rsquo;s called <a href="https://github.com/brpc/brpc/blob/master/src/brpc/channel.h">Channel</a> rather than &ldquo;Client&rdquo; in brpc. A channel represents a communication line to one server or multiple servers, which can be used for calling services.</p>
<p>A Channel can be <strong>shared by all threads</strong> in the process. Yon don&rsquo;t need to create separate Channels for each thread, and you don&rsquo;t need to synchronize Channel.CallMethod with lock. However creation and destroying of Channel is <strong>not</strong> thread-safe,  make sure the channel is initialized and destroyed only by one thread.</p>
<p>Some RPC implementations have so-called &ldquo;ClientManager&rdquo;, including configurations and resource management at the client-side, which is not needed by brpc. &ldquo;thread-num&rdquo;, &ldquo;connection-type&rdquo; such parameters are either in brpc::ChannelOptions or global gflags. Advantages of doing so:</p>
<ol>
<li>Convenience. You don&rsquo;t have to pass a &ldquo;ClientManager&rdquo; when the Channel is created, and you don&rsquo;t have to store the &ldquo;ClientManager&rdquo;. Otherwise code has to pass &ldquo;ClientManager&rdquo; layer by layer, which is troublesome. gflags makes configurations of global behaviors easier.</li>
<li>Share resources. For example, servers and channels in brpc share background workers (of bthread).</li>
<li>Better management of Lifetime. Destructing a &ldquo;ClientManager&rdquo; is very error-prone, which is managed by brpc right now.</li>
</ol>
<p>Like most classes, Channel must be <strong>Init()</strong>-ed before usage. Parameters take default values when <code>options</code> is NULL. If you want non-default values, code as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">ChannelOptions</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// including default values
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">xxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yyy</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">...</span>
<span style="color:#000">channel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Init</span><span style="color:#000;font-weight:bold">(...,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Note that Channel neither modifies <code>options</code> nor accesses <code>options</code> after completion of Init(), thus options can be put on stack safely as in above code. Channel.options() gets options being used by the Channel.</p>
<p>Init() can connect one server or a cluster(multiple servers).</p>
<h1 id="connect-to-a-server">Connect to a server</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// Take default values when options is NULL.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">Init</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EndPoint</span> <span style="color:#000">server_addr_and_port</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ChannelOptions</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">Init</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">server_addr_and_port</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ChannelOptions</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">Init</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">server_addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">port</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ChannelOptions</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The server connected by these Init() has fixed address genrally. The creation does not need NamingService or LoadBalancer, being relatively light-weight.  The address could be a hostname, but don&rsquo;t frequently create Channels connecting to a hostname, which requires a DNS lookup taking at most 10 seconds. (default timeout of DNS lookup). Reuse them.</p>
<p>Valid &ldquo;server_addr_and_port&rdquo;:</p>
<ul>
<li>127.0.0.1:80</li>
<li><a href="http://www.foo.com">www.foo.com</a>:8765</li>
<li>localhost:9000</li>
</ul>
<p>Invalid &ldquo;server_addr_and_port&rdquo;:</p>
<ul>
<li>127.0.0.1:90000     # too large port</li>
<li>10.39.2.300:8000   # invalid IP</li>
</ul>
<h1 id="connect-to-a-cluster">Connect to a cluster</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">Init</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">naming_service_url</span><span style="color:#000;font-weight:bold">,</span>
         <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">load_balancer_name</span><span style="color:#000;font-weight:bold">,</span>
         <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ChannelOptions</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Channels created by above Init() get server list from the NamingService specified by <code>naming_service_url</code> periodically or driven-by-events, and send request to one server chosen from the list according to the algorithm specified by <code>load_balancer_name</code> .</p>
<p>You <strong>should not</strong> create such channels ad-hocly each time before a RPC, because creation and destroying of such channels relate to many resources, say NamingService needs to be accessed once at creation otherwise server candidates are unknown. On the other hand, channels are able to be shared by multiple threads safely and has no need to be created frequently.</p>
<p>If <code>load_balancer_name</code> is NULL or empty, this Init() is just the one for connecting single server and <code>naming_service_url</code> should be &ldquo;ip:port&rdquo; or &ldquo;host:port&rdquo; of the server. Thus you can unify initialization of all channels with this Init(). For example, you can put values of <code>naming_service_url</code> and <code>load_balancer_name</code> in configuration file, and set <code>load_balancer_name</code> to empty for single server and a valid algorithm for a cluster.</p>
<h2 id="naming-service">Naming Service</h2>
<p>Naming service maps a name to a modifiable list of servers. It&rsquo;s positioned as follows at client-side:</p>
<p><img src="/images/docs/ns.png" alt="img"></p>
<p>With the help of naming service, the client remembers a name instead of every concrete server. When the servers are added or removed, only mapping in the naming service is changed, rather than telling every client that may access the cluster. This process is called &ldquo;decoupling up and downstreams&rdquo;. Back to implementation details, the client does remember every server and will access NamingService periodically or be pushed with latest server list. The impl. has minimal impact on RPC latencies and very small pressure on the system providing naming service.</p>
<p>General form of <code>naming_service_url</code>  is &ldquo;<strong>protocol://service_name</strong>&rdquo;.</p>
<h3 id="bnsbns-name">bns://&lt;bns-name&gt;</h3>
<p>BNS is the most common naming service inside Baidu. In &ldquo;bns://rdev.matrix.all&rdquo;, &ldquo;bns&rdquo; is protocol and &ldquo;rdev.matrix.all&rdquo; is service-name. A related gflag is -ns_access_interval: <img src="/images/docs/ns_access_interval.png" alt="img"></p>
<p>If the list in BNS is non-empty, but Channel says &ldquo;no servers&rdquo;, the status bit of the machine in BNS is probably non-zero, which means the machine is unavailable and as a correspondence not added as server candidates of the Channel. Status bits can be checked by:</p>
<p><code>get_instance_by_service [bns_node_name] -s</code></p>
<h3 id="filepath">file://&lt;path&gt;</h3>
<p>Servers are put in the file specified by <code>path</code>. For example, in &ldquo;file://conf/machine_list&rdquo;, &ldquo;conf/machine_list&rdquo; is the file:</p>
<ul>
<li>in which each line is address of a server.</li>
<li>contents after # are comments and ignored.</li>
<li>non-comment contents after addresses are tags, which are separated from addresses by one or more spaces, same address + different tags are treated as different instances.</li>
<li>brpc reloads the file when it&rsquo;s updated.</li>
</ul>
<pre><code># This line is ignored
10.24.234.17:8080 tag1  # a comment
10.24.234.17:8090 tag2  # an instance different from the instance on last line
10.24.234.18:8080
10.24.234.19:8080
</code></pre><p>Pros: easy to modify, convenient for unittests.</p>
<p>Cons: need to update every client when the list changes, not suitable for online deployment.</p>
<h3 id="listaddr1addr2">list://&lt;addr1&gt;,&lt;addr2&gt;&hellip;</h3>
<p>Servers are directly written after list://, separated by comma. For example: &ldquo;list://db-bce-81-3-186.db01:7000,m1-bce-44-67-72.m1:7000,cp01-rd-cos-006.cp01:7000&rdquo; has 3 addresses.</p>
<p>Tags can be appended to addresses, separated with one or more spaces. Same address + different tags are treated as different instances.</p>
<p>Pros: directly configurable in CLI, convenient for unittests.</p>
<p>Cons: cannot be updated at runtime, not suitable for online deployment at all.</p>
<h3 id="httpurl">http://&lt;url&gt;</h3>
<p>Connect all servers under the domain, for example: <a href="http://www.baidu.com:80">http://www.baidu.com:80</a>.</p>
<p>Note: although Init() for connecting single server(2 parameters) accepts hostname as well, it only connects one server under the domain.</p>
<p>Pros: Versatility of DNS, useable both in private or public network.</p>
<p>Cons: limited by transmission formats of DNS, unable to implement notification mechanisms.</p>
<h3 id="httpsurl">https://&lt;url&gt;</h3>
<p>Similar with &ldquo;http&rdquo; prefix besides that the connections will be encrypted with SSL.</p>
<h3 id="consulservice-name">consul://&lt;service-name&gt;</h3>
<p>Get a list of servers with the specified service-name through consul. The default address of consul is localhost:8500, which can be modified by setting -consul_agent_addr in gflags. The connection timeout of consul is 200ms by default, which can be modified by -consul_connect_timeout_ms.</p>
<p>By default, <a href="https://www.consul.io/api/index.html#consistency-modes">stale</a> and passing(only servers with passing in statuses are returned) are added to <a href="(https://www.consul.io/api/health.html#parameters-2)">parameters of the consul request</a>, which can be modified by -consul_url_parameter in gflags.</p>
<p>Except the first request to consul, the follow-up requests use the <a href="https://www.consul.io/api/index.html#blocking-queries">long polling</a> feature. That is, the consul responds only when the server list is updated or the request times out. The timeout defaults to 60 seconds, which can be modified by -consul_blocking_query_wait_secs.</p>
<p>If the server list returned by the consul does not follow <a href="https://www.consul.io/api/health.html#sample-response-2">response format</a>, or all servers in the list are filtered because the key fields such as the address and port are missing or cannot be parsed, the server list will not be updated and the consul service will be revisited after a period of time(default 500ms, can be modified by -consul_retry_interval_ms）.</p>
<p>If consul is not accessible, the naming service can be automatically downgraded to file naming service. This feature is turned off by default and can be turned on by setting -consul_enable_degrade_to_file_naming_service. After downgrading, in the directory specified by -consul_file_naming_service_dir, the file whose name is the service-name will be used. This file can be generated by the consul-template, which holds the latest server list before the consul is unavailable. The consul naming service is automatically restored when consul is restored.</p>
<h3 id="more-naming-services">More naming services</h3>
<p>User can extend to more naming services by implementing brpc::NamingService, check <a href="https://github.com/brpc/brpc/blob/master/docs/cn/load_balancing.md#%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1">this link</a> for details.</p>
<h3 id="the-tag-in-naming-service">The tag in naming service</h3>
<p>Every address can be attached with a tag. The common implementation is that if there&rsquo;re spaces after the address, the content after the spaces is the tag.
Same address with different tag are treated as different instances which are interacted with separate connections. Users can use this feature to establish connections with remote servers in a more flexible way.
If you need weighted round-robin, you should consider using <a href="#wrr">wrr algorithm</a> first rather than emulate &ldquo;a coarse-grained version&rdquo; with tags.</p>
<h3 id="vip-related-issues">VIP related issues</h3>
<p>VIP is often the public IP of layer-4 load balancer, which proxies traffic to RS behide. When a client connects to the VIP, a connection is established to a chosen RS. When the client connection is broken, the connection to the RS is reset as well.</p>
<p>If one client establishes only one connection to the VIP(&ldquo;single&rdquo; connection type in brpc), all traffic from the client lands on one RS. If number of clients are large enough, each RS should gets many connections and roughly balanced, at least from the cluster perspective. However, if clients are not large enough or workload from clients are very different, some RS may be overloaded. Another issue is that when multiple VIP are listed together, the traffic to them may not be proportional to the number of RS behide them.</p>
<p>One solution to these issues is to use &ldquo;pooled&rdquo; connection type, so that one client may create multiple connections to one VIP (roughly the max concurrency recently) to make traffic land on different RS. If more than one VIP are present, consider using <a href="#wrr">wrr load balancing</a> to assign weights to different VIP, or add different tags to VIP to form more instances.</p>
<p>If higher performance is demanded, or number of connections is limited (in a large cluster), consider using single connection and attach same VIP with different tags to create different connections. Comparing to pooled connections, number of connections and overhead of syscalls are often lower, but if tags are not enough, RS hotspots may still present.</p>
<h3 id="naming-service-filter">Naming Service Filter</h3>
<p>Users can filter servers got from the NamingService before pushing to LoadBalancer.</p>
<p><img src="/images/docs/ns_filter.jpg" alt="img"></p>
<p>Interface of the filter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// naming_service_filter.h
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">NamingServiceFilter</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">public</span><span style="color:#ce5c00;font-weight:bold">:</span>
    <span style="color:#8f5902;font-style:italic">// Return true to take this `server&#39; as a candidate to issue RPC
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Return false to filter it out
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">virtual</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Accept</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ServerNode</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#8f5902;font-style:italic">// naming_service.h
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ServerNode</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">butil</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">EndPoint</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">tag</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>The most common usage is filtering by server tags.</p>
<p>Customized filter is set to ChannelOptions to take effects. NULL by default means not filter.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MyNamingServiceFilter</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">NamingServiceFilter</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">public</span><span style="color:#ce5c00;font-weight:bold">:</span>
    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Accept</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">ServerNode</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tag</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;main&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000">MyNamingServiceFilter</span> <span style="color:#000">my_filter</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">ChannelOptions</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ns_filter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">my_filter</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="load-balancer">Load Balancer</h2>
<p>When there&rsquo;re more than one server to access, we need to divide the traffic. The process is called load balancing, which is positioned as follows at client-side.</p>
<p><img src="/images/docs/lb.png" alt="img"></p>
<p>The ideal algorithm is to make every request being processed in-time, and crash of any server makes minimal impact. However clients are not able to know delays or congestions happened at servers in realtime, and load balancing algorithms should be light-weight generally, users need to choose proper algorithms for their use cases. Algorithms provided by brpc (specified by <code>load_balancer_name</code>):</p>
<h3 id="rr">rr</h3>
<p>which is round robin. Always choose next server inside the list, next of the last server is the first one. No other settings. For example there&rsquo;re 3 servers: a,b,c, brpc will send requests to a, b, c, a, b, c, … and so on. Note that presumption of using this algorithm is the machine specs, network latencies, server loads are similar.</p>
<h3 id="wrr">wrr</h3>
<p>which is weighted round robin. Choose the next server according to the configured weight. The chances a server is selected is consistent with its weight, and the algorithm can make each server selection scattered.</p>
<p>The instance tag must be an int32 number representing the weight, eg. tag=&ldquo;50&rdquo;.</p>
<h3 id="random">random</h3>
<p>Randomly choose one server from the list, no other settings. Similarly with round robin, the algorithm assumes that servers to access are similar.</p>
<h3 id="wr">wr</h3>
<p>which is weighted random. Choose the next server according to the configured weight. The chances a server is selected is consistent with its weight.</p>
<p>Requirements of instance tag is the same as wrr.</p>
<h3 id="la">la</h3>
<p>which is locality-aware. Perfer servers with lower latencies, until the latency is higher than others, no other settings. Check out <a href="../../rpc-in-depth/locality-aware/">Locality-aware load balancing</a> for more details.</p>
<h3 id="c_murmurhash-or-c_md5">c_murmurhash or c_md5</h3>
<p>which is consistent hashing. Adding or removing servers does not make destinations of requests change as dramatically as in simple hashing. It&rsquo;s especially suitable for caching services.</p>
<p>Need to set Controller.set_request_code() before RPC otherwise the RPC will fail. request_code is often a 32-bit hash code of &ldquo;key part&rdquo; of the request, and the hashing algorithm does not need to be same with the one used by load balancer. Say <code>c_murmurhash</code>  can use md5 to compute request_code of the request as well.</p>
<p><a href="https://github.com/brpc/brpc/blob/master/src/brpc/policy/hasher.h">src/brpc/policy/hasher.h</a> includes common hash functions. If <code>std::string key</code> stands for key part of the request, controller.set_request_code(brpc::policy::MurmurHash32(key.data(), key.size())) sets request_code correctly.</p>
<p>Do distinguish &ldquo;key&rdquo; and &ldquo;attributes&rdquo; of the request. Don&rsquo;t compute request_code by full content of the request just for quick. Minor change in attributes may result in totally different hash code and change destination dramatically. Another cause is padding, for example: <code>struct Foo { int32_t a; int64_t b; }</code> has a 4-byte undefined gap between <code>a</code> and <code>b</code> on 64-bit machines, result of <code>hash(&amp;foo, sizeof(foo))</code> is undefined. Fields need to be packed or serialized before hashing.</p>
<p>Check out <a href="consistent_hashing.md">Consistent Hashing</a> for more details.</p>
<p>Other kind of lb does not need to set Controller.set_request_code(). If request code is set, it will not be used by lb. For example, lb=rr, and call Controller.set_request_code(), even if request_code is the same for every request, lb will balance the requests using the rr policy.</p>
<h3 id="client-side-throttling-for-recovery-from-cluster-downtime">Client-side throttling for recovery from cluster downtime</h3>
<p>Cluster downtime refers to the state in which all servers in the cluster are unavailable. Due to the health check mechanism, when the cluster returns to normal, server will go online one by one. When a server is online, all traffic will be sent to it, which may cause the service to be overloaded again. If circuit breaker is enabled, server may be offline again before the other servers go online, and the cluster can never be recovered. As a solution, brpc provides a client-side throttling mechanism for recovery after cluster downtime. When no server is available in the cluster, the cluster enters recovery state. Assuming that the minimum number of servers that can serve all requests is min_working_instances, current number of servers available in the cluster is q, then in recovery state, the probability of client accepting the request is q/min_working_instances, otherwise it is discarded. If q remains unchanged for a period of time(hold_seconds), the traffic is resent to all available servers and leaves recovery state. Whether the request is rejected in recovery state is indicated by whether controller.ErrorCode() is equal to brpc::ERJECT, and the rejected request will not be retried by the framework.</p>
<p>This recovery mechanism requires the capabilities of downstream servers to be similar, so it is currently only valid for rr and random. The way to enable it is to add the values of min_working_instances and hold_seconds parameters after <em>load_balancer_name</em>, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Init</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://...&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;random:min_working_instances=6 hold_seconds=10&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="health-checking">Health checking</h2>
<p>Servers whose connections are lost are isolated temporarily to prevent them from being selected by LoadBalancer. brpc connects isolated servers periodically to test if they&rsquo;re healthy again. The interval is controlled by gflag -health_check_interval:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
<th>Defined At</th>
</tr>
</thead>
<tbody>
<tr>
<td>health_check_interval (R)</td>
<td>3</td>
<td>seconds between consecutive health-checkings</td>
<td>src/brpc/socket_map.cpp</td>
</tr>
</tbody>
</table>
<p>Once a server is connected, it resumes as a server candidate inside LoadBalancer. If a server is removed from NamingService during health-checking, brpc removes it from health-checking as well.</p>
<h1 id="launch-rpc">Launch RPC</h1>
<p>Generally, we don&rsquo;t use Channel.CallMethod directly, instead we call XXX_Stub generated by protobuf, which feels more like a &ldquo;method call&rdquo;. The stub has few member fields, being suitable(and recommended) to be put on stack instead of new(). Surely the stub can be saved and re-used as well. Channel.CallMethod and stub are both <strong>thread-safe</strong> and accessible by multiple threads simultaneously. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">XXX_Stub</span> <span style="color:#000">stub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">some_method</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Or even:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">XXX_Stub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">some_method</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>A exception is http/h2 client, which is not related to protobuf much. Call CallMethod directly to make a http call, setting all parameters to NULL except for <code>Controller</code> and <code>done</code>, check <a href="../access-httph2/">Access http/h2</a> for details.</p>
<h2 id="synchronous-call">Synchronous call</h2>
<p>CallMethod blocks until response from server is received or error occurred (including timedout).</p>
<p>response/controller in synchronous call will not be used by brpc again after CallMethod, they can be put on stack safely. Note: if request/response has many fields and being large on size, they&rsquo;d better be allocated on heap.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">MyRequest</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">MyResponse</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span> <span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">XXX_Stub</span> <span style="color:#000">stub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set_foo</span><span style="color:#000;font-weight:bold">(...);</span>
<span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set_timeout_ms</span><span style="color:#000;font-weight:bold">(...);</span>
<span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">some_method</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Failed</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// RPC failed. fields in response are undefined, don&#39;t use.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// RPC succeeded, response has what we want.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>WARNING: Do NOT use synchronous call when you are holding a pthread lock! Otherwise it is easy to cause deadlock.</p>
<p>Solution (choose one of the two):</p>
<ol>
<li>Replace pthread lock with bthread lock (bthread_mutex_t)</li>
<li>Release the lock before CallMethod</li>
</ol>
</blockquote>
<h2 id="asynchronous-call">Asynchronous call</h2>
<p>Pass a callback <code>done</code> to CallMethod, which resumes after sending request, rather than completion of RPC. When the response from server is received  or error occurred(including timedout), done-&gt;Run() is called. Post-processing code of the RPC should be put in done-&gt;Run() instead of after CallMethod.</p>
<p>Because end of CallMethod does not mean completion of RPC, response/controller may still be used by brpc or done-&gt;Run(). Generally they should be allocated on heap and deleted in done-&gt;Run(). If they&rsquo;re deleted too early, done-&gt;Run() may access invalid memory.</p>
<p>You can new these objects individually and create done by <a href="#use-newcallback">NewCallback</a>, or make response/controller be member of done and <a href="#Inherit-google::protobuf::Closure">new them together</a>. Former one is recommended.</p>
<p>Request can be destroyed immediately after asynchronous CallMethod. (SelectiveChannel is an exception, in the case of SelectiveChannel, the request object must be released after rpc finish)</p>
<p>Channel can be destroyed immediately after asynchronous CallMethod.</p>
<p>Note that &ldquo;immediately&rdquo; means destruction of Request/Channel can happen <strong>after</strong> CallMethod, not during CallMethod. Deleting a Channel just being used by another thread results in undefined behavior (crash at best).</p>
<h3 id="use-newcallback">Use NewCallback</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">OnRPCDone</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MyResponse</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// unique_ptr helps us to delete response/cntl automatically. unique_ptr in gcc 3.4 is an emulated version.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">unique_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">MyResponse</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">response_guard</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">unique_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">cntl_guard</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">Failed</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// RPC failed. fields in response are undefined, don&#39;t use.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// RPC succeeded, response has what we want. Continue the post-processing.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#8f5902;font-style:italic">// Closure created by NewCallback deletes itself at the end of Run.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">MyResponse</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MyResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">cntl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">MyService_Stub</span> <span style="color:#000">stub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">MyRequest</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// you don&#39;t have to new request, even in an asynchronous call.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set_foo</span><span style="color:#000;font-weight:bold">(...);</span>
<span style="color:#000">cntl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">set_timeout_ms</span><span style="color:#000;font-weight:bold">(...);</span>
<span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">some_method</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">NewCallback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">OnRPCDone</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div><p>Since protobuf 3 changes NewCallback to private, brpc puts NewCallback in <a href="https://github.com/brpc/brpc/blob/master/src/brpc/callback.h">src/brpc/callback.h</a> after r32035 (and adds more overloads). If your program has compilation issues with NewCallback, replace google::protobuf::NewCallback with brpc::NewCallback.</p>
<h3 id="inherit-googleprotobufclosure">Inherit google::protobuf::Closure</h3>
<p>Drawback of using NewCallback is that you have to allocate memory on heap at least 3 times: response, controller, done. If profiler shows that the memory allocation is a hotspot, you can consider inheriting Closure by your own, and enclose response/controller as member fields. Doing so combines 3 new into one, but the code will be worse to read. Don&rsquo;t do this if memory allocation is not an issue.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">OnRPCDone</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">google</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">protobuf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Closure</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">public</span><span style="color:#ce5c00;font-weight:bold">:</span>
    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// unique_ptr helps us to delete response/cntl automatically. unique_ptr in gcc 3.4 is an emulated version.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">unique_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">OnRPCDone</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">self_guard</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">Failed</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// RPC failed. fields in response are undefined, don&#39;t use.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// RPC succeeded, response has what we want. Continue the post-processing.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000">MyResponse</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span> <span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">OnRPCDone</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">done</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">OnRPCDone</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">MyService_Stub</span> <span style="color:#000">stub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">MyRequest</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// you don&#39;t have to new request, even in an asynchronous call.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set_foo</span><span style="color:#000;font-weight:bold">(...);</span>
<span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set_timeout_ms</span><span style="color:#000;font-weight:bold">(...);</span>
<span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">some_method</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="what-will-happen-when-the-callback-is-very-complicated">What will happen when the callback is very complicated?</h3>
<p>No special impact, the callback will run in separate bthread, without blocking other sessions. You can do all sorts of things in the callback.</p>
<h3 id="does-the-callback-run-in-the-same-thread-that-callmethod-runs">Does the callback run in the same thread that CallMethod runs?</h3>
<p>The callback runs in a different bthread, even the RPC fails just after entering CallMethod. This avoids deadlock when the RPC is ongoing inside a lock(not recommended).</p>
<h2 id="wait-for-completion-of-rpc">Wait for completion of RPC</h2>
<p>NOTE: <a href="combo_channel.md#parallelchannel">ParallelChannel</a> is probably more convenient to  launch multiple RPCs in parallel.</p>
<p>Following code starts 2 asynchronous RPC and waits them to complete.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">CallId</span> <span style="color:#000">cid1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">controller1</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">call_id</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">CallId</span> <span style="color:#000">cid2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">controller2</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">call_id</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">...</span>
<span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done1</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">done2</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">...</span>
<span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cid1</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cid2</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Call <code>Controller.call_id()</code> to get an id <strong>before launching RPC</strong>, join the id after the RPC.</p>
<p>Join() blocks until completion of RPC <strong>and end of done-&gt;Run()</strong>,  properties of Join:</p>
<ul>
<li>If the RPC is complete, Join() returns immediately.</li>
<li>Multiple threads can Join() one id, all of them will be woken up.</li>
<li>Synchronous RPC can be Join()-ed in another thread, although we rarely do this.</li>
</ul>
<p>Join() was called JoinResponse() before, if you meet deprecated issues during compilation, rename to Join().</p>
<p>Calling <code>Join(controller-&gt;call_id())</code> after completion of RPC is <strong>wrong</strong>, do save call_id before RPC, otherwise the controller may be deleted by done at any time. The Join in following code is <strong>wrong</strong>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">on_rpc_done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Controller</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MyResponse</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">...</span> <span style="color:#000">Handle</span> <span style="color:#000">response</span> <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#204a87;font-weight:bold">delete</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">delete</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">Controller</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">controller1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">Controller</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">controller2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">MyResponse</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">response1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MyResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">MyResponse</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">response2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">MyResponse</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">...</span>
<span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">request1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">google</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">protobuf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">NewCallback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">on_rpc_done</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response1</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">request2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">google</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">protobuf</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">NewCallback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">on_rpc_done</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response2</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000;font-weight:bold">...</span>
<span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller1</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">call_id</span><span style="color:#000;font-weight:bold">());</span>   <span style="color:#8f5902;font-style:italic">// WRONG, controller1 may be deleted by on_rpc_done
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller2</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">call_id</span><span style="color:#000;font-weight:bold">());</span>   <span style="color:#8f5902;font-style:italic">// WRONG, controller2 may be deleted by on_rpc_done
</span></code></pre></div><h2 id="semi-synchronous-call">Semi-synchronous call</h2>
<p>Join can be used for implementing &ldquo;Semi-synchronous&rdquo; call: blocks until multiple asynchronous calls to complete. Since the callsite blocks until completion of all RPC, controller/response can be put on stack safely.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span> <span style="color:#000">cntl1</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span> <span style="color:#000">cntl2</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">MyResponse</span> <span style="color:#000">response1</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">MyResponse</span> <span style="color:#000">response2</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">...</span>
<span style="color:#000">stub1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cntl1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">request1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">response1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">DoNothing</span><span style="color:#000;font-weight:bold">());</span>
<span style="color:#000">stub2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">method2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cntl2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">request2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">response2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">DoNothing</span><span style="color:#000;font-weight:bold">());</span>
<span style="color:#000;font-weight:bold">...</span>
<span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">call_id</span><span style="color:#000;font-weight:bold">());</span>
<span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">call_id</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><p>brpc::DoNothing() gets a closure doing nothing, specifically for semi-synchronous calls. Its lifetime is managed by brpc.</p>
<p>Note that in above example, we access <code>controller.call_id()</code> after completion of RPC, which is safe right here, because DoNothing does not delete controller as in <code>on_rpc_done</code> in previous example.</p>
<h2 id="cancel-rpc">Cancel RPC</h2>
<p><code>brpc::StartCancel(call_id)</code> cancels corresponding RPC, call_id must be got from Controller.call_id() <strong>before launching RPC</strong>, race conditions may occur at any other time.</p>
<p>NOTE: it is <code>brpc::StartCancel(call_id)</code>, not <code>controller-&gt;StartCancel()</code>, which is forbidden and useless. The latter one is provided by protobuf by default and has serious race conditions on lifetime of controller.</p>
<p>As the name implies, RPC may not complete yet after calling StartCancel, you should not touch any field in Controller or delete any associated resources, they should be handled inside done-&gt;Run(). If you have to wait for completion of RPC in-place(not recommended), call Join(call_id).</p>
<p>Facts about StartCancel:</p>
<ul>
<li>call_id can be cancelled before CallMethod, the RPC will end immediately(and done will be called).</li>
<li>call_id can be cancelled in another thread.</li>
<li>Cancel an already-cancelled call_id has no effect. Inference: One call_id can be cancelled by multiple threads simultaneously, but only one of them takes effect.</li>
<li>Cancel here is a client-only feature, <strong>the server-side may not cancel the operation necessarily</strong>, server cancelation is a separate feature.</li>
</ul>
<h2 id="get-server-side-address-and-port">Get server-side address and port</h2>
<p>remote_side() tells where request was sent to, the return type is <a href="https://github.com/brpc/brpc/blob/master/src/butil/endpoint.h">butil::EndPoint</a>, which includes an ipv4 address and port. Calling this method before completion of RPC is undefined.</p>
<p>How to print:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;remote_side=&#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">cntl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">remote_side</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;remote_side=%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">butil</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">endpoint2str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">remote_side</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#000">c_str</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><h2 id="get-client-side-address-and-port">Get client-side address and port</h2>
<p>local_side() gets address and port of the client-side sending RPC after r31384</p>
<p>How to print:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#000">LOG</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">INFO</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;local_side=&#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">cntl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">local_side</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;local_side=%s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">butil</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">endpoint2str</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">local_side</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#000">c_str</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><h2 id="should-brpccontroller-be-reused">Should brpc::Controller be reused?</h2>
<p>Not necessary to reuse deliberately.</p>
<p>Controller has miscellaneous fields, some of them are buffers that can be re-used by calling Reset().</p>
<p>In most use cases, constructing a Controller(snippet1) and re-using a Controller(snippet2) perform similarily.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// snippet1
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CallSomething</span><span style="color:#000;font-weight:bold">(...,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// snippet2
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reset</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000">stub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CallSomething</span><span style="color:#000;font-weight:bold">(...,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>If the Controller in snippet1 is new-ed on heap, snippet1 has extra cost of &ldquo;heap allcation&rdquo; and may be a little slower in some cases.</p>
<h1 id="settings">Settings</h1>
<p>Client-side settings has 3 parts:</p>
<ul>
<li>brpc::ChannelOptions: defined in <a href="https://github.com/brpc/brpc/blob/master/src/brpc/channel.h">src/brpc/channel.h</a>, for initializing Channel, becoming immutable once the initialization is done.</li>
<li>brpc::Controller: defined in <a href="https://github.com/brpc/brpc/blob/master/src/brpc/controller.h">src/brpc/controller.h</a>, for overriding fields in brpc::ChannelOptions for some RPC according to contexts.</li>
<li>global gflags: for tuning global behaviors, being unchanged generally. Read comments in <a href="flags.md">/flags</a> before setting.</li>
</ul>
<p>Controller contains data and options that request may not have. server and client share the same Controller class, but they may set different fields. Read comments in Controller carefully before using.</p>
<p>A Controller corresponds to a RPC. A Controller can be re-used by another RPC after Reset(), but a Controller can&rsquo;t be used by multiple RPC simultaneously, no matter the RPCs are started from one thread or not.</p>
<p>Properties of Controller:</p>
<ol>
<li>A Controller can only have one user. Without explicit statement, methods in Controller are <strong>not</strong> thread-safe by default.</li>
<li>Due to the fact that Controller is not shared generally, there&rsquo;s no need to manage Controller by shared_ptr. If you do, something might goes wrong.</li>
<li>Controller is constructed before RPC and destructed after RPC, some common patterns:</li>
</ol>
<ul>
<li>Put Controller on stack before synchronous RPC, be destructed when out of scope. Note that Controller of asynchronous RPC <strong>must not</strong> be put on stack, otherwise the RPC may still run when the Controller is being destructed and result in undefined behavior.</li>
<li>new Controller before asynchronous RPC, delete in done.</li>
</ul>
<h2 id="number-of-worker-pthreads">Number of worker pthreads</h2>
<p>There&rsquo;s <strong>no</strong> independent thread pool for client in brpc. All Channels and Servers share the same backing threads via <a href="bthread.md">bthread</a>.  Setting number of worker pthreads in Server works for Client as well if Server is in used. Or just specify the <a href="flags.md">gflag</a> <a href="brpc.baidu.com:8765/flags/bthread_concurrency">-bthread_concurrency</a> to set the global number of worker pthreads.</p>
<h2 id="timeout">Timeout</h2>
<p><strong>ChannelOptions.timeout_ms</strong> is timeout in milliseconds for all RPCs via the Channel, Controller.set_timeout_ms() overrides value for one RPC. Default value is 1 second, Maximum value is 2^31 (about 24 days), -1 means wait indefinitely for response or connection error.</p>
<p><strong>ChannelOptions.connect_timeout_ms</strong> is the timeout in milliseconds for establishing connections of RPCs over the Channel, and -1 means no deadline. This value is limited to be not greater than timeout_ms. Note that this connection timeout is different from the one in TCP, generally this one is smaller.</p>
<p>NOTE1: timeout_ms in brpc is <strong>deadline</strong>, which means once it&rsquo;s reached, the RPC ends without more retries. As a comparison, other implementations may have session timeouts and deadline timeouts. Do distinguish them before porting to brpc.</p>
<p>NOTE2: error code of RPC timeout is **ERPCTIMEDOUT (1008) **, ETIMEDOUT is connection timeout and retriable.</p>
<h2 id="retry">Retry</h2>
<p>ChannelOptions.max_retry is maximum retrying count for all RPC via the channel, Default value is 3, 0 means no retries. Controller.set_max_retry() overrides value for one RPC.</p>
<p>Controller.retried_count() returns number of retries.</p>
<p>Controller.has_backup_request() tells if backup_request was sent.</p>
<p><strong>Servers tried before are not retried by best efforts</strong></p>
<p>Conditions for retrying (AND relations):</p>
<ul>
<li>Broken connection.</li>
<li>Timeout is not reached.</li>
<li>Has retrying quota. Controller.set_max_retry(0) or ChannelOptions.max_retry = 0 disables retries.</li>
<li>The retry makes sense. If the RPC fails due to request(EREQUEST), no retry will be done because server is very likely to reject the request again, retrying makes no sense here.</li>
</ul>
<h3 id="broken-connection">Broken connection</h3>
<p>If the server does not respond and connection is good, retry is not triggered. If you need to send another request after some timeout, use backup request.</p>
<p>How it works: If response does not return within the timeout specified by backup_request_ms, send another request, take whatever the first returned. New request will be sent to a different server that never tried before by best efforts. NOTE: If backup_request_ms is greater than timeout_ms, backup request will never be sent. backup request consumes one retry. backup request does not imply a server-side cancellation.</p>
<p>ChannelOptions.backup_request_ms affects all RPC via the Channel, unit is milliseconds, Default value is -1(disabled), Controller.set_backup_request_ms() overrides value for one RPC.</p>
<h3 id="timeout-is-not-reached">Timeout is not reached</h3>
<p>RPC will be ended soon after the timeout.</p>
<h3 id="has-retrying-quota">Has retrying quota</h3>
<p>Controller.set_max_retry(0) or ChannelOptions.max_retry = 0 disables retries.</p>
<h3 id="the-retry-makes-sense">The retry makes sense</h3>
<p>If the RPC fails due to request(EREQUEST), no retry will be done because server is very likely to reject the request again, retrying makes no sense here.</p>
<p>Users can inherit <a href="https://github.com/brpc/brpc/blob/master/src/brpc/retry_policy.h">brpc::RetryPolicy</a> to customize conditions of retrying. For example brpc does not retry for http/h2 related errors by default. If you want to retry for HTTP_STATUS_FORBIDDEN(403) in your app, you can do as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;brpc/retry_policy.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">MyRetryPolicy</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">RetryPolicy</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">public</span><span style="color:#ce5c00;font-weight:bold">:</span>
    <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">DoRetry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">Controller</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ErrorCode</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">EHTTP</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#8f5902;font-style:italic">// http/h2 error
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">cntl</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">http_response</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">status_code</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">HTTP_STATUS_FORBIDDEN</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#8f5902;font-style:italic">// Leave other cases to brpc.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">DefaultRetryPolicy</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">DoRetry</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cntl</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">...</span>

<span style="color:#8f5902;font-style:italic">// Assign the instance to ChannelOptions.retry_policy.
</span><span style="color:#8f5902;font-style:italic">// NOTE: retry_policy must be kept valid during lifetime of Channel, and Channel does not retry_policy, so in most cases RetryPolicy should be created by singleton..
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">brpc</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">ChannelOptions</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">MyRetryPolicy</span> <span style="color:#000">g_my_retry_policy</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">retry_policy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">g_my_retry_policy</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">...</span>
</code></pre></div><p>Some tips：</p>
<ul>
<li>Get response of the RPC by cntl-&gt;response().</li>
<li>RPC deadline represented by ERPCTIMEDOUT is never retried, even it&rsquo;s allowed by your derived RetryPolicy.</li>
</ul>
<h3 id="retrying-should-be-conservative">Retrying should be conservative</h3>
<p>Due to maintaining costs, even very large scale clusters are deployed with &ldquo;just enough&rdquo; instances to survive major defects, namely offline of one IDC, which is at most 1/2 of all machines. However aggressive retries may easily make pressures from all clients double or even tripple against servers, and make the whole cluster down: More and more requests stuck in buffers, because servers can&rsquo;t process them in-time. All requests have to wait for a very long time to be processed and finally gets timed out, as if the whole cluster is crashed. The default retrying policy is safe generally: unless the connection is broken, retries are rarely sent. However users are able to customize starting conditions for retries by inheriting RetryPolicy, which may turn retries to be &ldquo;a storm&rdquo;. When you customized RetryPolicy, you need to carefully consider how clients and servers interact and design corresponding tests to verify that retries work as expected.</p>
<h2 id="circuit-breaker">Circuit breaker</h2>
<p>Check out <a href="../cn/circuit_breaker.md">circuit_breaker</a> for more details.</p>
<h2 id="protocols">Protocols</h2>
<p>The default protocol used by Channel is baidu_std, which is changeable by setting ChannelOptions.protocol. The field accepts both enum and string.</p>
<p>Supported protocols:</p>
<ul>
<li>PROTOCOL_BAIDU_STD or &ldquo;baidu_std&rdquo;, which is <a href="baidu_std.md">the standard binary protocol inside Baidu</a>, using single connection by default.</li>
<li>PROTOCOL_HTTP or &ldquo;http&rdquo;, which is http/1.0 or http/1.1, using pooled connection by default (Keep-Alive).
<ul>
<li>Methods for accessing ordinary http services are listed in <a href="../access-httph2/">Access http/h2</a>.</li>
<li>Methods for accessing pb services by using http:json or http:proto are listed in <a href="http_derivatives.md">http/h2 derivatives</a></li>
</ul>
</li>
<li>PROTOCOL_H2 or ”h2&quot;, which is http/2, using single connection by default.
<ul>
<li>Methods for accessing ordinary h2 services are listed in <a href="../access-httph2/">Access http/h2</a>.</li>
<li>Methods for accessing pb services by using h2:json or h2:proto are listed in <a href="http_derivatives.md">http/h2 derivatives</a></li>
</ul>
</li>
<li>&ldquo;h2:grpc&rdquo;, which is the protocol of <a href="https://grpc.io">gRPC</a> and based on h2, using single connection by default, check out <a href="http_derivatives.md#h2grpc">h2:grpc</a> for details.</li>
<li>PROTOCOL_THRIFT or &ldquo;thrift&rdquo;, which is the protocol of <a href="https://thrift.apache.org">apache thrift</a>, using pooled connection by default, check out <a href="thrift.md">Access thrift</a> for details.</li>
<li>PROTOCOL_MEMCACHE or &ldquo;memcache&rdquo;, which is binary protocol of memcached, using <strong>single connection</strong> by default. Check out <a href="memcache_client.md">Access memcached</a> for details.</li>
<li>PROTOCOL_REDIS or &ldquo;redis&rdquo;, which is protocol of redis 1.2+ (the one supported by hiredis), using <strong>single connection</strong> by default. Check out <a href="redis_client.md">Access Redis</a> for details.</li>
<li>PROTOCOL_HULU_PBRPC or &ldquo;hulu_pbrpc&rdquo;, which is protocol of hulu-pbrpc, using single connection by default.</li>
<li>PROTOCOL_NOVA_PBRPC or &ldquo;nova_pbrpc&rdquo;,  which is protocol of Baidu ads union, using pooled connection by default.</li>
<li>PROTOCOL_SOFA_PBRPC or &ldquo;sofa_pbrpc&rdquo;, which is protocol of sofa-pbrpc, using single connection by default.</li>
<li>PROTOCOL_PUBLIC_PBRPC or &ldquo;public_pbrpc&rdquo;, which is protocol of public_pbrpc, using pooled connection by default.</li>
<li>PROTOCOL_UBRPC_COMPACK or &ldquo;ubrpc_compack&rdquo;, which is protocol of public/ubrpc, packing with compack, using pooled connection by default. check out <a href="ub_client.md">ubrpc (by protobuf)</a> for details. A related protocol is PROTOCOL_UBRPC_MCPACK2 or ubrpc_mcpack2, packing with mcpack2.</li>
<li>PROTOCOL_NSHEAD_CLIENT or &ldquo;nshead_client&rdquo;, which is required by UBXXXRequest in baidu-rpc-ub, using pooled connection by default. Check out <a href="ub_client.md">Access UB</a> for details.</li>
<li>PROTOCOL_NSHEAD or &ldquo;nshead&rdquo;, which is required by sending NsheadMessage, using pooled connection by default. Check out <a href="ub_client.md#nshead-blob">nshead+blob</a> for details.</li>
<li>PROTOCOL_NSHEAD_MCPACK or &ldquo;nshead_mcpack&rdquo;, which is as the name implies, nshead + mcpack (parsed by protobuf via mcpack2pb), using pooled connection by default.</li>
<li>PROTOCOL_ESP or &ldquo;esp&rdquo;, for accessing services with esp protocol, using pooled connection by default.</li>
</ul>
<h2 id="connection-type">Connection Type</h2>
<p>brpc supports following connection types:</p>
<ul>
<li>short connection: Established before each RPC, closed after completion. Since each RPC has to pay the overhead of establishing connection, this type is used for occasionally launched RPC, not frequently launched ones. No protocol use this type by default. Connections in http/1.0 are handled similarly as short connections.</li>
<li>pooled connection: Pick an unused connection from a pool before each RPC, return after completion. One connection carries at most one request at the same time. One client may have multiple connections to one server. http/1.1 and the protocols using nshead use this type by default.</li>
<li>single connection: all clients in one process has at most one connection to one server, one connection may carry multiple requests at the same time. The sequence of received responses does not need to be same as sending requests. This type is used by baidu_std, hulu_pbrpc, sofa_pbrpc by default.</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>short connection</th>
<th>pooled connection</th>
<th>single connection</th>
</tr>
</thead>
<tbody>
<tr>
<td>long connection</td>
<td>no</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>#connection at server-side (from a client)</td>
<td>qps*latency (<a href="https://en.wikipedia.org/wiki/Little%27s_law">little&rsquo;s law</a>)</td>
<td>qps*latency</td>
<td>1</td>
</tr>
<tr>
<td>peak qps</td>
<td>bad, and limited by max number of ports</td>
<td>medium</td>
<td>high</td>
</tr>
<tr>
<td>latency</td>
<td>1.5RTT(connect) + 1RTT + processing time</td>
<td>1RTT + processing time</td>
<td>1RTT + processing time</td>
</tr>
<tr>
<td>cpu usage</td>
<td>high, tcp connect for each RPC</td>
<td>medium, every request needs a sys write</td>
<td>low, writes can be combined to reduce overhead.</td>
</tr>
</tbody>
</table>
<p>brpc chooses best connection type for the protocol by default, users generally have no need to change it. If you do, set ChannelOptions.connection_type to:</p>
<ul>
<li>
<p>CONNECTION_TYPE_SINGLE or &ldquo;single&rdquo; : single connection</p>
</li>
<li>
<p>CONNECTION_TYPE_POOLED or &ldquo;pooled&rdquo;: pooled connection. Max number of pooled connections from one client to one server is limited by -max_connection_pool_size. Note the number is not same as &ldquo;max number of connections&rdquo;. New connections are always created when there&rsquo;s no idle ones in the pool; the returned connections are closed immediately when the pool already has max_connection_pool_size connections. Value of max_connection_pool_size should respect the concurrency, otherwise the connnections that can&rsquo;t be pooled are created and closed frequently which behaves similarly as short connections. If max_connection_pool_size is 0, the pool behaves just like fully short connections.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
<th>Defined At</th>
</tr>
</thead>
<tbody>
<tr>
<td>max_connection_pool_size (R)</td>
<td>100</td>
<td>Max number of pooled connections to a single endpoint</td>
<td>src/brpc/socket.cpp</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>CONNECTION_TYPE_SHORT or &ldquo;short&rdquo; : short connection</p>
</li>
<li>
<p>&quot;&quot; (empty string) makes brpc chooses the default one.</p>
</li>
</ul>
<p>brpc also supports <a href="streaming_rpc.md">Streaming RPC</a> which is an application-level connection for transferring streaming data.</p>
<h2 id="close-idle-connections-in-pools">Close idle connections in pools</h2>
<p>If a connection has no read or write within the seconds specified by -idle_timeout_second, it&rsquo;s tagged as &ldquo;idle&rdquo;, and will be closed automatically. Default value is 10 seconds. This feature is only effective to pooled connections. If -log_idle_connection_close is true, a log is printed before closing.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
<th>Defined At</th>
</tr>
</thead>
<tbody>
<tr>
<td>idle_timeout_second</td>
<td>10</td>
<td>Pooled connections without data transmission for so many seconds will be closed. No effect for non-positive values</td>
<td>src/brpc/socket_map.cpp</td>
</tr>
<tr>
<td>log_idle_connection_close</td>
<td>false</td>
<td>Print log when an idle connection is closed</td>
<td>src/brpc/socket.cpp</td>
</tr>
</tbody>
</table>
<h2 id="defer-connection-close">Defer connection close</h2>
<p>Multiple channels may share a connection via referential counting. When a channel releases last reference of the connection, the connection will be closed. But in some scenarios, channels are created just before sending RPC and destroyed after completion, in which case connections are probably closed and re-open again frequently, as costly as short connections.</p>
<p>One solution is to cache channels commonly used by user, which avoids frequent creation and destroying of channels.  However brpc does not offer an utility for doing this right now, and it&rsquo;s not trivial for users to implement it correctly.</p>
<p>Another solution is setting gflag -defer_close_second</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
<th>Defined At</th>
</tr>
</thead>
<tbody>
<tr>
<td>defer_close_second</td>
<td>0</td>
<td>Defer close of connections for so many seconds even if the connection is not used by anyone. Close immediately for non-positive values</td>
<td>src/brpc/socket_map.cpp</td>
</tr>
</tbody>
</table>
<p>After setting, connection is not closed immediately after last referential count, instead it will be closed after so many seconds. If a channel references the connection again during the wait, the connection resumes to normal. No matter how frequent channels are created, this flag limits the frequency of closing connections. Side effect of the flag is that file descriptors are not closed immediately after destroying of channels, if the flag is wrongly set to be large, number of active file descriptors in the process may be large as well.</p>
<h2 id="buffer-size-of-connections">Buffer size of connections</h2>
<p>-socket_recv_buffer_size sets receiving buffer size of all connections, -1 by default (not modified)</p>
<p>-socket_send_buffer_size sets sending buffer size of all connections, -1 by default (not modified)</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
<th>Defined At</th>
</tr>
</thead>
<tbody>
<tr>
<td>socket_recv_buffer_size</td>
<td>-1</td>
<td>Set the recv buffer size of socket if this value is positive</td>
<td>src/brpc/socket.cpp</td>
</tr>
<tr>
<td>socket_send_buffer_size</td>
<td>-1</td>
<td>Set send buffer size of sockets if this value is positive</td>
<td>src/brpc/socket.cpp</td>
</tr>
</tbody>
</table>
<h2 id="log_id">log_id</h2>
<p>set_log_id() sets a 64-bit integral log_id, which is sent to the server-side along with the request, and often printed in server logs to associate different services accessed in a session. String-type log-id must be converted to 64-bit integer before setting.</p>
<h2 id="attachment">Attachment</h2>
<p>baidu_std and hulu_pbrpc supports attachments which are sent along with messages and set by users to bypass serialization of protobuf. As a client, data set in Controller::request_attachment() will be received by server and response_attachment() contains attachment sent back by the server.</p>
<p>Attachment is not compressed by framework.</p>
<p>In http/h2, attachment corresponds to <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html">message body</a>, namely the data to post to server is stored in request_attachment().</p>
<h2 id="turn-on-ssl">Turn on SSL</h2>
<p>Update openssl to the latest version before turning on SSL, since older versions of openssl may have severe security problems and support less encryption algorithms, which is against with the purpose of using SSL.
Set ChannelOptions.mutable_ssl_options() to enable SSL. Refer to <a href="https://github.com/brpc/brpc/blob/master/src/brpc/ssl_options.h">ssl_options.h</a> for the detailed options. ChannelOptions.has_ssl_options() checks if ssl_options was set; ChannelOptions.ssl_options() returns const reference to the ssl_options.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#8f5902;font-style:italic">// Enable client-side SSL and use default values.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mutable_ssl_options</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// Enable client-side SSL and customize values.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mutable_ssl_options</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">ciphers_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mutable_ssl_options</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">sni_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><ul>
<li>Channels connecting to a single server or a cluster both support SSL (the initial implementation does not support cluster)</li>
<li>After turning on SSL, all requests through this Channel will be encrypted. Users should create another Channel for non-SSL requests if needed.</li>
<li>Accessibility improvements for HTTPS: Channel.Init recognizes https:// prefix and turns on SSL automatically; -http_verbose prints certificate information when SSL is on.</li>
</ul>
<h2 id="authentication">Authentication</h2>
<p>Generally there are 2 ways of authentication at the client side:</p>
<ol>
<li>Request-based authentication: Each request carries authentication information. It&rsquo;s more flexible since the authentication information can contain fields based on this particular request. However, this leads to a performance loss due to the extra payload in each request.</li>
<li>Connection-based authentication: Once a TCP connection has been established, the client sends an authentication packet. After it has been verfied by the server, subsequent requests on this connection no longer needs authentication. Compared with the former, this method can only carry some static information such as local IP in the authentication packet. However, it has better performance especially under single connection / connection pool scenario.</li>
</ol>
<p>It&rsquo;s very simple to implement the first method by just adding authentication data format into the request proto definition. Then send it as normal RPC in each request. To achieve the second one, brpc provides an interface for users to implement:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Authenticator</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">public</span><span style="color:#ce5c00;font-weight:bold">:</span>
    <span style="color:#204a87;font-weight:bold">virtual</span> <span style="color:#ce5c00;font-weight:bold">~</span><span style="color:#000">Authenticator</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{}</span>

    <span style="color:#8f5902;font-style:italic">// Implement this method to generate credential information
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// into `auth_str&#39; which will be sent to `VerifyCredential&#39;
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// at server side. This method will be called on client side.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Returns 0 on success, error code otherwise
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">virtual</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">GenerateCredential</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">auth_str</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>When the user calls the RPC interface with a single connection to the same server, the framework guarantee that once the TCP connection has been established, the first request on the connection will contain the authentication string generated by <code>GenerateCredential</code>. Subsequent requests will not carried that string. The entire sending process is still highly concurrent since it won&rsquo;t wait for the authentication result. If the verification succeeds, all requests return without error. Otherwise, if the verification fails, generally the server will close the connection and those requests will receive the corresponding error.</p>
<p>Currently only those protocols support client authentication: <a href="../cn/baidu_std.md">baidu_std</a> (default protocol), HTTP, hulu_pbrpc, ESP. For customized protocols, generally speaking, users could call the <code>Authenticator</code>&rsquo;s interface to generate authentication string during the request packing process in order to support authentication.</p>
<h2 id="reset">Reset</h2>
<p>This method makes Controller back to the state as if it&rsquo;s just created.</p>
<p>Don&rsquo;t call Reset() during a RPC, which is undefined.</p>
<h2 id="compression">Compression</h2>
<p>set_request_compress_type() sets compress-type of the request, no compression by default.</p>
<p>NOTE: Attachment is not compressed by brpc.</p>
<p>Check out <a href="../access-httph2/#compress-request-body">compress request body</a> to compress http/h2 body.</p>
<p>Supported compressions:</p>
<ul>
<li>brpc::CompressTypeSnappy : <a href="http://google.github.io/snappy/">snanpy</a>, compression and decompression are very fast, but compression ratio is low.</li>
<li>brpc::CompressTypeGzip : <a href="http://en.wikipedia.org/wiki/Gzip">gzip</a>, significantly slower than snappy, with a higher compression ratio.</li>
<li>brpc::CompressTypeZlib : <a href="http://en.wikipedia.org/wiki/Zlib">zlib</a>, 10%~20% faster than gzip but still significantly slower than snappy, with slightly better compression ratio than gzip.</li>
</ul>
<p>Following table lists performance of different methods compressing and decompressing <strong>data with a lot of duplications</strong>, just for reference.</p>
<table>
<thead>
<tr>
<th>Compress method</th>
<th>Compress size(B)</th>
<th>Compress time(us)</th>
<th>Decompress time(us)</th>
<th>Compress throughput(MB/s)</th>
<th>Decompress throughput(MB/s)</th>
<th>Compress ratio</th>
</tr>
</thead>
<tbody>
<tr>
<td>Snappy</td>
<td>128</td>
<td>0.753114</td>
<td>0.890815</td>
<td>162.0875</td>
<td>137.0322</td>
<td>37.50%</td>
</tr>
<tr>
<td>Gzip</td>
<td>10.85185</td>
<td>1.849199</td>
<td>11.2488</td>
<td>66.01252</td>
<td>47.66%</td>
<td></td>
</tr>
<tr>
<td>Zlib</td>
<td>10.71955</td>
<td>1.66522</td>
<td>11.38763</td>
<td>73.30581</td>
<td>38.28%</td>
<td></td>
</tr>
<tr>
<td>Snappy</td>
<td>1024</td>
<td>1.404812</td>
<td>1.374915</td>
<td>695.1555</td>
<td>710.2713</td>
<td>8.79%</td>
</tr>
<tr>
<td>Gzip</td>
<td>16.97748</td>
<td>3.950946</td>
<td>57.52106</td>
<td>247.1718</td>
<td>6.64%</td>
<td></td>
</tr>
<tr>
<td>Zlib</td>
<td>15.98913</td>
<td>3.06195</td>
<td>61.07665</td>
<td>318.9348</td>
<td>5.47%</td>
<td></td>
</tr>
<tr>
<td>Snappy</td>
<td>16384</td>
<td>8.822967</td>
<td>9.865008</td>
<td>1770.946</td>
<td>1583.881</td>
<td>4.96%</td>
</tr>
<tr>
<td>Gzip</td>
<td>160.8642</td>
<td>43.85911</td>
<td>97.13162</td>
<td>356.2544</td>
<td>0.78%</td>
<td></td>
</tr>
<tr>
<td>Zlib</td>
<td>147.6828</td>
<td>29.06039</td>
<td>105.8011</td>
<td>537.6734</td>
<td>0.71%</td>
<td></td>
</tr>
<tr>
<td>Snappy</td>
<td>32768</td>
<td>16.16362</td>
<td>19.43596</td>
<td>1933.354</td>
<td>1607.844</td>
<td>4.82%</td>
</tr>
<tr>
<td>Gzip</td>
<td>229.7803</td>
<td>82.71903</td>
<td>135.9995</td>
<td>377.7849</td>
<td>0.54%</td>
<td></td>
</tr>
<tr>
<td>Zlib</td>
<td>240.7464</td>
<td>54.44099</td>
<td>129.8046</td>
<td>574.0161</td>
<td>0.50%</td>
<td></td>
</tr>
</tbody>
</table>
<p>Following table lists performance of different methods compressing and decompressing <strong>data with very few duplications</strong>, just for reference.</p>
<table>
<thead>
<tr>
<th>Compress method</th>
<th>Compress size(B)</th>
<th>Compress time(us)</th>
<th>Decompress time(us)</th>
<th>Compress throughput(MB/s)</th>
<th>Decompress throughput(MB/s)</th>
<th>Compress ratio</th>
</tr>
</thead>
<tbody>
<tr>
<td>Snappy</td>
<td>128</td>
<td>0.866002</td>
<td>0.718052</td>
<td>140.9584</td>
<td>170.0021</td>
<td>105.47%</td>
</tr>
<tr>
<td>Gzip</td>
<td>15.89855</td>
<td>4.936242</td>
<td>7.678077</td>
<td>24.7294</td>
<td>116.41%</td>
<td></td>
</tr>
<tr>
<td>Zlib</td>
<td>15.88757</td>
<td>4.793953</td>
<td>7.683384</td>
<td>25.46339</td>
<td>107.03%</td>
<td></td>
</tr>
<tr>
<td>Snappy</td>
<td>1024</td>
<td>2.087972</td>
<td>1.06572</td>
<td>467.7087</td>
<td>916.3403</td>
<td>100.78%</td>
</tr>
<tr>
<td>Gzip</td>
<td>32.54279</td>
<td>12.27744</td>
<td>30.00857</td>
<td>79.5412</td>
<td>79.79%</td>
<td></td>
</tr>
<tr>
<td>Zlib</td>
<td>31.51397</td>
<td>11.2374</td>
<td>30.98824</td>
<td>86.90288</td>
<td>78.61%</td>
<td></td>
</tr>
<tr>
<td>Snappy</td>
<td>16384</td>
<td>12.598</td>
<td>6.306592</td>
<td>1240.276</td>
<td>2477.566</td>
<td>100.06%</td>
</tr>
<tr>
<td>Gzip</td>
<td>537.1803</td>
<td>129.7558</td>
<td>29.08707</td>
<td>120.4185</td>
<td>75.32%</td>
<td></td>
</tr>
<tr>
<td>Zlib</td>
<td>519.5705</td>
<td>115.1463</td>
<td>30.07291</td>
<td>135.697</td>
<td>75.24%</td>
<td></td>
</tr>
<tr>
<td>Snappy</td>
<td>32768</td>
<td>22.68531</td>
<td>12.39793</td>
<td>1377.543</td>
<td>2520.582</td>
<td>100.03%</td>
</tr>
<tr>
<td>Gzip</td>
<td>1403.974</td>
<td>258.9239</td>
<td>22.25825</td>
<td>120.6919</td>
<td>75.25%</td>
<td></td>
</tr>
<tr>
<td>Zlib</td>
<td>1370.201</td>
<td>230.3683</td>
<td>22.80687</td>
<td>135.6524</td>
<td>75.21%</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="faq">FAQ</h1>
<h3 id="q-does-brpc-support-unix-domain-socket">Q: Does brpc support unix domain socket?</h3>
<p>No. Local TCP sockets performs just a little slower than unix domain socket since traffic over local TCP sockets bypasses network. Some scenarios where TCP sockets can&rsquo;t be used may require unix domain sockets. We may consider the capability in future.</p>
<h3 id="q-fail-to-connect-to-xxxxxxxxxxxx-connection-refused">Q: Fail to connect to xx.xx.xx.xx:xxxx, Connection refused</h3>
<p>The remote server does not serve any more (probably crashed).</p>
<h3 id="q-often-met-connection-timedout-to-another-idc">Q: often met Connection timedout to another IDC</h3>
<p><img src="/images/docs/connection_timedout.png" alt="img"></p>
<p>The TCP connection is not established within connection_timeout_ms, you have to tweak options:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ChannelOptions</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#8f5902;font-style:italic">// Issue error when a connection is not established after so many
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// milliseconds. -1 means wait indefinitely.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Default: 200 (milliseconds)
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Maximum: 0x7fffffff (roughly 30 days)
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int32_t</span> <span style="color:#000">connect_timeout_ms</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">// Max duration of RPC over this Channel. -1 means wait indefinitely.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Overridable by Controller.set_timeout_ms().
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Default: 500 (milliseconds)
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Maximum: 0x7fffffff (roughly 30 days)
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int32_t</span> <span style="color:#000">timeout_ms</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>NOTE: Connection timeout is not RPC timeout, which is printed as &ldquo;Reached timeout=&hellip;&rdquo;.</p>
<h3 id="q-synchronous-call-is-good-asynchronous-call-crashes">Q: synchronous call is good, asynchronous call crashes</h3>
<p>Check lifetime of Controller, Response and done. In asynchronous call, finish of CallMethod is not completion of RPC which is entering of done-&gt;Run(). So the objects should not deleted just after CallMethod, instead they should be delete in done-&gt;Run(). Generally you should allocate the objects on heap instead of putting them on stack. Check out <a href="client.md#asynchronous-call">Asynchronous call</a> for details.</p>
<h3 id="q-how-to-make-requests-be-processed-once-and-only-once">Q: How to make requests be processed once and only once</h3>
<p>This issue is not solved on RPC layer. When response returns and being successful, we know the RPC is processed at server-side. When response returns and being rejected, we know the RPC is not processed at server-side. But when response is not returned, server may or may not process the RPC. If we retry, same request may be processed twice at server-side. Generally RPC services with side effects must consider <a href="http://en.wikipedia.org/wiki/Idempotence">idempotence</a> of the service, otherwise retries may make side effects be done more than once and result in unexpected behavior. Search services with only read often have no side effects (during a search), being idempotent natually. But storage services that need to write have to design versioning or serial-number mechanisms to reject side effects that already happen, to keep idempoent.</p>
<h3 id="q-invalid-addressbnsgroupuser-personaduminj03">Q: Invalid address=`bns://group.user-persona.dumi.nj03'</h3>
<pre><code>FATAL 04-07 20:00:03 7778 src/brpc/channel.cpp:123] Invalid address=`bns://group.user-persona.dumi.nj03'. You should use Init(naming_service_name, load_balancer_name, options) to access multiple servers.
</code></pre><p>Accessing servers under naming service needs the Init() with 3 parameters(the second param is <code>load_balancer_name</code>). The Init() here is with 2 parameters and treated by brpc as accessing single server, producing the error.</p>
<h3 id="q-both-sides-use-protobuf-why-cant-they-communicate-with-each-other">Q: Both sides use protobuf, why can&rsquo;t they communicate with each other</h3>
<p><strong>protocol != protobuf</strong>. protobuf serializes one package and a message of a protocol may contain multiple packages along with extra lengths, checksums, magic numbers. The capability offered by brpc that &ldquo;write code once and serve multiple protocols&rdquo; is implemented by converting data from different protocols to unified API, not on protobuf layer.</p>
<h3 id="q-why-c-clientserver-may-fail-to-talk-to-clientserver-in-other-languages">Q: Why C++ client/server may fail to talk to client/server in other languages</h3>
<p>Check if the C++ version turns on compression (Controller::set_compress_type), Currently RPC impl. in other languages do not support compression yet.</p>
<h1 id="ps-workflow-at-client-side">PS: Workflow at Client-side</h1>
<p><img src="/images/docs/client_side.png" alt="img"></p>
<p>Steps:</p>
<ol>
<li>Create a <a href="https://github.com/brpc/brpc/blob/master/src/bthread/id.h">bthread_id</a> as correlation_id of current RPC.</li>
<li>According to how the Channel is initialized, choose a server from global <a href="https://github.com/brpc/brpc/blob/master/src/brpc/socket_map.h">SocketMap</a> or <a href="https://github.com/brpc/brpc/blob/master/src/brpc/load_balancer.h">LoadBalancer</a> as  destination of the request.</li>
<li>Choose a <a href="https://github.com/brpc/brpc/blob/master/src/brpc/socket.h">Socket</a> according to connection type (single, pooled, short)</li>
<li>If authentication is turned on and the Socket is not authenticated yet, first request enters authenticating branch, other requests block until the branch writes authenticating information into the Socket. Server-side only verifies the first request.</li>
<li>According to protocol of the Channel, choose corresponding serialization callback to serialize request into <a href="https://github.com/brpc/brpc/blob/master/src/butil/iobuf.h">IOBuf</a>.</li>
<li>If timeout is set, setup timer. From this point on, avoid using Controller, since the timer may be triggered at anytime and calls user&rsquo;s callback for timeout, which may delete Controller.</li>
<li>Sending phase is completed. If error occurs at any step, Channel::HandleSendFailed is called.</li>
<li>Write IOBuf with serialized data into the Socket and add Channel::HandleSocketFailed into id_wait_list of the Socket. The callback will be called when the write is failed or connection is broken before completion of RPC.</li>
<li>In synchronous call, Join correlation_id; otherwise CallMethod() returns.</li>
<li>Send/receive messages to/from network.</li>
<li>After receiving response, get the correlation_id inside, find out associated Controller within O(1) time. The lookup does not need to lock a global hashmap, and scales well.</li>
<li>Parse response according to the protocol</li>
<li>Call Controller::OnRPCReturned, which may retry errorous RPC, or complete the RPC. Call user&rsquo;s done in asynchronous call. Destroy correlation_id and wakeup joining threads.</li>
</ol>

        <div class="section-index">
    
    
    
    
    <hr class="panel-line">
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
    
</div>

	
	
	<div class="text-muted mt-5 pt-3 border-top">Last modified February 26, 2022: <a  href="https://github.com/apache/incubator-brpc-website/commit/14eec1ac1805c1dde9f10d0353984bde2127294c">brpc website 1.0 fix links jump problem in overview page (14eec1a)</a>
</div>
</div>

          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none" style="display: flex; align-items: center; padding: 0 !important;">
  <div class="container-fluid mx-sm-5">
    <div class="row" style="display: flex; align-items: center;">
      <div class="col-12 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/apache/incubator-brpc">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. All Rights Reserved</small>
        
	
        <div style="font-size: 12.8px; color: rgb(117, 116, 116);">
          <a href="https://www.apache.org/foundation/how-it-works.html" target="_blank" rel="noopener">Foundation</a> |
          <a href="https://www.apache.org/licenses/" target="_blank" rel="noopener">License</a> |
          <a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener">Sponsorship</a> |
          <a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener">Thanks</a>
        </div>
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>






<script src="/js/main.min.170adf90fd476d5f9243ed2e727149abe8d9fe364587fe943765d47375bbd1ad.js" integrity="sha256-FwrfkP1HbV&#43;SQ&#43;0ucnFJq&#43;jZ/jZFh/6UN2XUc3W70a0=" crossorigin="anonymous"></script>





  </body>
</html>