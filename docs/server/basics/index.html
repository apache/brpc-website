<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.105.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=alternate type=application/rss+xml href=https://brpc.incubator.apache.org/docs/server/basics/index.xml><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Basics | bRPC</title><meta property="og:title" content="Basics"><meta property="og:description" content="Learn how to use bRPC server.
"><meta property="og:type" content="website"><meta property="og:url" content="https://brpc.incubator.apache.org/docs/server/basics/"><meta property="og:site_name" content="bRPC"><meta itemprop=name content="Basics"><meta itemprop=description content="Learn how to use bRPC server.
"><meta name=twitter:card content="summary"><meta name=twitter:title content="Basics"><meta name=twitter:description content="Learn how to use bRPC server.
"><link rel=preload href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css as=style><link href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css rel=stylesheet integrity><script src=/js/jquery-3.3.1.min.js></script><title>Basics | bRPC</title></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/apache/incubator-brpc/ target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Docs</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/blogs/><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/community/community/><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/faq/><span>FAQ</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/users/><span>Users</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/server/basics/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/server/basics/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Docs</a></li><ul><li class="collapse show" id=docs><a class="td-sidebar-link td-sidebar-link__page" id=m-docsoverview href=/docs/overview/>Overview</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsgetting_started href=/docs/getting_started/>Getting started</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsbenchmark href=/docs/benchmark/>Performance benchmark</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=docsbvar><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/bvar/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=docsbvarbvar></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/bvar/bvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar c++</a></li><ul><li class=collapse id=docsbvarbvar-c></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=docsbthread><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/bthread/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=docsbthreadbthread></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/bthread/bthread-or-not/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread or not</a></li><ul><li class=collapse id=docsbthreadbthread-or-not></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/bthread/execution-queue/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Execution Queue</a></li><ul><li class=collapse id=docsbthreadexecution-queue></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/bthread/thread-local/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">thread-local</a></li><ul><li class=collapse id=docsbthreadthread-local></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Client</a></li><ul><li class=collapse id=docsclient><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Basics</a></li><ul><li class=collapse id=docsclientbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/error-code/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Error code</a></li><ul><li class=collapse id=docsclienterror-code></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/combo-channels/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Combo channels</a></li><ul><li class=collapse id=docsclientcombo-channels></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/access-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access http:h2</a></li><ul><li class=collapse id=docsclientaccess-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/access-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access gRPC</a></li><ul><li class=collapse id=docsclientaccess-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/access-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access thrift</a></li><ul><li class=collapse id=docsclientaccess-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/access-ub/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access UB</a></li><ul><li class=collapse id=docsclientaccess-ub></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/access-redis/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access redis</a></li><ul><li class=collapse id=docsclientaccess-redis></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/access-memcached/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Access memcached</a></li><ul><li class=collapse id=docsclientaccess-memcached></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/streaming-rpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming RPC</a></li><ul><li class=collapse id=docsclientstreaming-rpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/backup-request/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Backup request</a></li><ul><li class=collapse id=docsclientbackup-request></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/client/dummy-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dummy server</a></li><ul><li class=collapse id=docsclientdummy-server></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Server</a></li><ul><li class="collapse show" id=docsserver><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/basics/ class="align-left pl-0 pr-2 collapsed active td-sidebar-link td-sidebar-link__section">Basics</a></li><ul><li class=collapse id=docsserverbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/serve-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Serve http:h2</a></li><ul><li class=collapse id=docsserverserve-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/serve-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Serve gRPC</a></li><ul><li class=collapse id=docsserverserve-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/serve-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Serve thrift</a></li><ul><li class=collapse id=docsserverserve-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/serve-nshead/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Serve Nshead</a></li><ul><li class=collapse id=docsserverserve-nshead></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/server-push/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Server push</a></li><ul><li class=collapse id=docsserverserver-push></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/avalanche/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Avalanche</a></li><ul><li class=collapse id=docsserveravalanche></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/debug-server-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Debug server issues</a></li><ul><li class=collapse id=docsserverdebug-server-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/auto-concurrencylimiter/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Auto ConcurrencyLimiter</a></li><ul><li class=collapse id=docsserverauto-concurrencylimiter></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/media-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Media Server</a></li><ul><li class=collapse id=docsservermedia-server></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/server/json2pb/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">json2pb</a></li><ul><li class=collapse id=docsserverjson2pb></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Builtin Services</a></li><ul><li class=collapse id=docsbuiltin-services><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/buildin_services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">builtin services</a></li><ul><li class=collapse id=docsbuiltin-servicesbuildin_services></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/status/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">status</a></li><ul><li class=collapse id=docsbuiltin-servicesstatus></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/vars/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">vars</a></li><ul><li class=collapse id=docsbuiltin-servicesvars></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/connections/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">connections</a></li><ul><li class=collapse id=docsbuiltin-servicesconnections></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/flags/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">flags</a></li><ul><li class=collapse id=docsbuiltin-servicesflags></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/rpcz/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpcz</a></li><ul><li class=collapse id=docsbuiltin-servicesrpcz></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/cpu_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">cpu profiler</a></li><ul><li class=collapse id=docsbuiltin-servicescpu_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/heap_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">heap profiler</a></li><ul><li class=collapse id=docsbuiltin-servicesheap_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/builtin-services/contention_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">contention profiler</a></li><ul><li class=collapse id=docsbuiltin-servicescontention_profiler></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/tools/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Tools</a></li><ul><li class=collapse id=docstools><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/tools/rpc_press/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_press</a></li><ul><li class=collapse id=docstoolsrpc_press></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/tools/rpc_replay/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_replay</a></li><ul><li class=collapse id=docstoolsrpc_replay></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/tools/rpc_view/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_view</a></li><ul><li class=collapse id=docstoolsrpc_view></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/tools/benchmark_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">benchmark_http</a></li><ul><li class=collapse id=docstoolsbenchmark_http></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/tools/parallel_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">parallel_http</a></li><ul><li class=collapse id=docstoolsparallel_http></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/c++-base/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">C++ Base</a></li><ul><li class=collapse id=docsc-base><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/c++-base/iobuf/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IOBuf</a></li><ul><li class=collapse id=docsc-baseiobuf></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/c++-base/streaming-log/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming Log</a></li><ul><li class=collapse id=docsc-basestreaming-log></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/c++-base/flatmap/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FlatMap</a></li><ul><li class=collapse id=docsc-baseflatmap></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/c++-base/brpc-training-materials/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC Training Materials</a></li><ul><li class=collapse id=docsc-basebrpc-training-materials></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">RPC in depth</a></li><ul><li class=collapse id=docsrpc-in-depth><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/new-protocol/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">New Protocol</a></li><ul><li class=collapse id=docsrpc-in-depthnew-protocol></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/atomic-instructions/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Atomic instructions</a></li><ul><li class=collapse id=docsrpc-in-depthatomic-instructions></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/io/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IO</a></li><ul><li class=collapse id=docsrpc-in-depthio></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/threading-overview/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Threading Overview</a></li><ul><li class=collapse id=docsrpc-in-depththreading-overview></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/load-balancing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Load Balancing</a></li><ul><li class=collapse id=docsrpc-in-depthload-balancing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/locality-aware/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Locality-aware</a></li><ul><li class=collapse id=docsrpc-in-depthlocality-aware></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/consistent-hashing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Consistent Hashing</a></li><ul><li class=collapse id=docsrpc-in-depthconsistent-hashing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/memory-management/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Memory Management</a></li><ul><li class=collapse id=docsrpc-in-depthmemory-management></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/timer-keeping/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Timer keeping</a></li><ul><li class=collapse id=docsrpc-in-depthtimer-keeping></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/rpc-in-depth/bthread_id/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread_id</a></li><ul><li class=collapse id=docsrpc-in-depthbthread_id></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/use-cases-inside-baidu/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Use cases inside Baidu</a></li><ul><li class=collapse id=docsuse-cases-inside-baidu><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/use-cases-inside-baidu/use-case1/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">百度地图api入口</a></li><ul><li class=collapse id=docsuse-cases-inside-baiduuse-case1></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/use-cases-inside-baidu/use-case2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联盟DSP</a></li><ul><li class=collapse id=docsuse-cases-inside-baiduuse-case2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/use-cases-inside-baidu/use-case3/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ELF学习框架</a></li><ul><li class=collapse id=docsuse-cases-inside-baiduuse-case3></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/use-cases-inside-baidu/use-case4/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云平台代理服务</a></li><ul><li class=collapse id=docsuse-cases-inside-baiduuse-case4></li></ul></ul></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docsdownloadbrpc href=/docs/downloadbrpc/>Download bRPC</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/community/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Community</a></li><ul><li class=collapse id=docscommunity><a class="td-sidebar-link td-sidebar-link__page" id=m-docscommunitycommunity href=/docs/community/community/>Community</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscommunitymailing_list href=/docs/community/mailing_list/>Mailing List</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscommunitycontributing href=/docs/community/contributing/>Contribute Guide</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscommunitycommitter href=/docs/community/committer/>Committer Guide</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscommunityrelease href=/docs/community/release/>Release Guide</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscommunitycommitters href=/docs/community/committers/>Committers</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscommunitysecurity href=/docs/community/security/>Security</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docsfaq href=/docs/faq/>FAQ</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsusers href=/docs/users/>Users</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/blogs/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Blog</a></li><ul><li class=collapse id=docsblogs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/blogs/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Release</a></li><ul><li class=collapse id=docsblogsreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-docsblogsreleases130 href=/docs/blogs/releases/1.3.0/>bRPC 1.3.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblogsreleases120 href=/docs/blogs/releases/1.2.0/>bRPC 1.2.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblogsreleases110 href=/docs/blogs/releases/1.1.0/>bRPC 1.1.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblogsreleases100 href=/docs/blogs/releases/1.0.0/>bRPC 1.0.0</a></li></ul></ul></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/incubator-brpc-website/edit/master/content/en/docs/Server/Basics/_index.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/apache/incubator-brpc-website/issues/new?title=Basics" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/apache/incubator-brpc/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#set-rpc-to-be-failed>Set RPC to be failed</a></li><li><a href=#get-address-of-client>Get address of client</a></li><li><a href=#get-address-of-server>Get address of server</a></li><li><a href=#asynchronous-service>Asynchronous Service</a></li></ul><ul><li><a href=#listen-to-multiple-ports>Listen to multiple ports</a></li><li><a href=#multi-process-listening-to-one-port>Multi-process listening to one port</a></li></ul><ul><li><a href=#jsonpb>json&lt;=>pb</a></li><li><a href=#adapt-old-clients>Adapt old clients</a></li></ul><ul><li><a href=#version>Version</a></li><li><a href=#close-idle-connections>Close idle connections</a></li><li><a href=#pid_file>pid_file</a></li><li><a href=#print-hostname-in-each-line-of-log>Print hostname in each line of log</a></li><li><a href=#crash-after-printing-fatal-log>Crash after printing FATAL log</a></li><li><a href=#minimum-log-level>Minimum log level</a></li><li><a href=#return-free-memory-to-system>Return free memory to system</a></li><li><a href=#log-error-to-clients>Log error to clients</a></li><li><a href=#customize-percentiles-of-latency>Customize percentiles of latency</a></li><li><a href=#change-stacksize>Change stacksize</a></li><li><a href=#limit-sizes-of-messages>Limit sizes of messages</a></li><li><a href=#compression>Compression</a></li><li><a href=#attachment>Attachment</a></li><li><a href=#turn-on-ssl>Turn on SSL</a></li><li><a href=#verify-identities-of-clients>Verify identities of clients</a></li><li><a href=#number-of-worker-pthreads>Number of worker pthreads</a></li><li><a href=#limit-concurrency>Limit concurrency</a><ul><li><a href=#why-issue-error-to-the-client-instead-of-queuing-the-request-when-the-concurrency-hits-limit>Why issue error to the client instead of queuing the request when the concurrency hits limit?</a></li><li><a href=#why-not-limit-qps>Why not limit QPS?</a></li><li><a href=#calculate-max-concurrency>Calculate max concurrency</a></li><li><a href=#limit-server-level-concurrency>Limit server-level concurrency</a></li><li><a href=#limit-method-level-concurrency>Limit method-level concurrency</a></li><li><a href=#autoconcurrencylimiter>AutoConcurrencyLimiter</a></li></ul></li><li><a href=#pthread-mode>pthread mode</a></li><li><a href=#security-mode>Security mode</a><ul><li><a href=#hide-builtin-services-from-public>Hide builtin services from public</a></li><li><a href=#disable-built-in-services-completely>Disable built-in services completely</a></li><li><a href=#escape-urls-controllable-from-public>Escape URLs controllable from public</a></li><li><a href=#not-return-addresses-of-internal-servers>Not return addresses of internal servers</a></li></ul></li><li><a href=#customize-health>Customize /health</a></li><li><a href=#thread-local-variables>thread-local variables</a><ul><li><a href=#session-local>session-local</a></li><li><a href=#server-thread-local>server-thread-local</a></li><li><a href=#bthread-local>bthread-local</a></li></ul></li></ul><ul><li><ul><li><a href=#q-fail-to-write-into-fd1865-socketid89051020824543547428230-got-eof>Q: Fail to write into fd=1865 <a href="mailto:SocketId=8905@10.208.245.43">SocketId=8905@10.208.245.43</a>:54742@8230: Got EOF</a></li><li><a href=#q-remote-side-of-fd9-socketid2109466558000-was-closed>Q: Remote side of fd=9 <a href="mailto:SocketId=2@10.94.66.55">SocketId=2@10.94.66.55</a>:8000 was closed</a></li><li><a href=#q-why-does-setting-number-of-threads-at-server-side-not-work>Q: Why does setting number of threads at server-side not work</a></li><li><a href=#q-why-do-client-side-latencies-much-larger-than-the-server-side-ones>Q: Why do client-side latencies much larger than the server-side ones</a></li><li><a href=#q-fail-to-open-procselfio>Q: Fail to open /proc/self/io</a></li><li><a href=#q-json-string-123-cant-be-converted-to-protobuf-message>Q: json string &ldquo;[1,2,3]&rdquo; can&rsquo;t be converted to protobuf message</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Docs</a></li><li class=breadcrumb-item><a href=/docs/server/>Server</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/server/basics/>Basics</a></li></ol></nav><div class=td-content><h1>Basics</h1><div class=lead>Learn how to use bRPC server.</div><h1 id=example>Example</h1><p><a href=https://github.com/brpc/brpc/blob/master/example/echo_c++/server.cpp>server-side code</a> of Echo.</p><h1 id=fill-the-proto>Fill the .proto</h1><p>Interfaces of requests, responses, services are defined in proto files.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Tell protoc to generate base classes for C++ Service. modify to java_generic_services or py_generic_services for java or python. 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>option</span> <span style=color:#000>cc_generic_services</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>message</span> <span style=color:#000>EchoRequest</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>required</span> <span style=color:#000>string</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span> <span style=color:#000>EchoResponse</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>required</span> <span style=color:#000>string</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>service</span> <span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>rpc</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>EchoRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>EchoResponse</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>Read <a href=https://developers.google.com/protocol-buffers/docs/proto#options>official documents on protobuf</a> for more details about protobuf.</p><h1 id=implement-generated-interface>Implement generated interface</h1><p>protoc generates echo.pb.cc and echo.pb.h. Include echo.pb.h and implement EchoService inside:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;echo.pb.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyEchoService</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>EchoService</span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>const</span> <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// This RAII object calls done-&gt;Run() automatically at exit.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>         
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// fill response
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_message</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>Service is not available before insertion into <a href=https://github.com/brpc/brpc/blob/master/src/brpc/server.h>brpc.Server</a>.</p><p>When client sends request, Echo() is called.</p><p>Explain parameters:</p><p><strong>controller</strong></p><p>Statically convertible to brpc::Controller (provided that the code runs in brpc.Server). Contains parameters that can&rsquo;t be included by request and response, check out <a href=https://github.com/brpc/brpc/blob/master/src/brpc/controller.h>src/brpc/controller.h</a> for details.</p><p><strong>request</strong></p><p>read-only message from a client.</p><p><strong>response</strong></p><p>Filled by user. If any <strong>required</strong> field is not set, the RPC will fail.</p><p><strong>done</strong></p><p>Created by brpc and passed to service&rsquo;s CallMethod(), including all actions after leaving CallMethod(): validating response, serialization, sending back to client etc.</p><p><strong>No matter the RPC is successful or not, done->Run() must be called by user once and only once when the RPC is done.</strong></p><p>Why does brpc not call done->Run() automatically? Because users are able to store done somewhere and call done->Run() in some event handlers after leaving CallMethod(), which is an <strong>asynchronous service</strong>.</p><p>We strongly recommend using <strong>ClosureGuard</strong> to make done->Run() always be called. Look at the beginning statement in above code snippet:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>Not matter the callback is exited from middle or end, done_guard will be destructed, in which done->Run() is called. The mechanism is called <a href=https://en.wikipedia.org/wiki/Resource_Acquisition_Is_Initialization>RAII</a>. Without done_guard, you have to remember to add done->Run() before each <code>return</code>, <strong>which is very error-prone</strong>.</p><p>In asynchronous service, request is not processed completely when CallMethod() returns, thus done->Run() should not be called, instead it should be preserved somewhere and called later. At first glance, we don&rsquo;t need ClosureGuard here. However in real applications, asynchronous service may fail in the middle and exit CallMethod() as well. Without ClosureGuard, error branches may forget to call done->Run() before <code>return</code>. Thus done_guard is still recommended in asynchronous services. Different from synchronous services, to prevent done->Run() from being called at successful return of CallMethod, you should call done_guard.release() to remove done from the object.</p><p>How synchronous and asynchronous services handle done generally:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyFooService</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FooService</span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Synchronous
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>SyncFoo</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>const</span> <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                 <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                 <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Aynchronous
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AsyncFoo</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>         <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>release</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>Interface of ClosureGuard:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// RAII: Call Run() of the closure on destruction.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ClosureGuard</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClosureGuard</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Constructed with a closure which will be Run() inside dtor.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>explicit</span> <span style=color:#000>ClosureGuard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Call Run() of internal closure if it&#39;s not NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>ClosureGuard</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Call Run() of internal closure if it&#39;s not NULL and set it to `done&#39;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Set internal closure to NULL and return the one before set.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>release</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><h2 id=set-rpc-to-be-failed>Set RPC to be failed</h2><p>Call Controller.SetFailed() to set the RPC to be failed. If error occurs during sending response, framework calls the method as well. Users often call the method in services&rsquo; CallMethod(), For example if a stage of processing fails, user calls SetFailed() and call done->Run(), then quit CallMethod (If ClosureGuard is used, done->Run() is called automatically). The server-side done is created by framework and contains code sending response back to client. If SetFailed() is called, error information is sent to client instead of normal content. When client receives the response, its controller will be SetFailed() as well and Controller::Failed() will be true. In addition, Controller::ErrorCode() and Controller::ErrorText() are error code and error information respectively.</p><p>User may set <a href=http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html>status-code</a> for http calls by calling <code>controller.http_response().set_status_code()</code> at server-side. Standard status-code are defined in <a href=https://github.com/brpc/brpc/blob/master/src/brpc/http_status_code.h>http_status_code.h</a>. Controller.SetFailed() sets status-code as well with the value closest to the error-code in semantics. brpc::HTTP_STATUS_INTERNAL_SERVER_ERROR(500) is chosen when there&rsquo;s no proper value.</p><h2 id=get-address-of-client>Get address of client</h2><p>controller->remote_side() gets address of the client which sent the request. The return type is butil::EndPoint. If client is nginx, remote_side() is address of nginx. To get address of the &ldquo;real&rdquo; client before nginx, set <code>proxy_header ClientIp $remote_addr;</code> in nginx and call <code>controller->http_request().GetHeader("ClientIp")</code> in RPC to get the address.</p><p>Printing method:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>INFO</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;remote_side=&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>remote_side</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;remote_side=%s</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>endpoint2str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>remote_side</span><span style=color:#000;font-weight:700>()).</span><span style=color:#000>c_str</span><span style=color:#000;font-weight:700>());</span>
</span></span></code></pre></div><h2 id=get-address-of-server>Get address of server</h2><p>controller->local_side() gets server-side address of the RPC connection, return type is butil::EndPoint.</p><p>Printing method:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>INFO</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;local_side=&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>local_side</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;local_side=%s</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>endpoint2str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>local_side</span><span style=color:#000;font-weight:700>()).</span><span style=color:#000>c_str</span><span style=color:#000;font-weight:700>());</span>
</span></span></code></pre></div><h2 id=asynchronous-service>Asynchronous Service</h2><p>In which done->Run() is called after leaving service&rsquo;s CallMethod().</p><p>Some server proxies requests to back-end servers and waits for responses that may come back after a long time. To make better use of threads, save done in corresponding event handlers which are triggered after CallMethod() and call done->Run() inside. This kind of service is <strong>asynchronous</strong>.</p><p>Last line of asynchronous service is often <code>done_guard.release()</code> to prevent done->Run() from being called at successful exit from CallMethod(). Check out <a href=https://github.com/brpc/brpc/tree/master/example/session_data_and_thread_local/>example/session_data_and_thread_local</a> for a example.</p><p>Server-side and client-side both use done to represent the continuation code after leaving CallMethod, but they&rsquo;re <strong>totally different</strong>:</p><ul><li>server-side done is created by framework, called by user after processing of the request to send back response to client.</li><li>client-side done is created by user, called by framework to run post-processing code written by user after completion of RPC.</li></ul><p>In an asynchronous service that may access other services, user probably manipulates both kinds of done, be careful.</p><h1 id=add-service>Add Service</h1><p>A just default-constructed Server neither contains service nor serves requests, merely an object.</p><p>Add a service with following method:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>AddService</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Service</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>service</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ServiceOwnership</span> <span style=color:#000>ownership</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>If <code>ownership</code> is SERVER_OWNS_SERVICE, server deletes the service at destruction. To prevent the deletion, set <code>ownership</code> to SERVER_DOESNT_OWN_SERVICE.</p><p>Following code adds MyEchoService:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Server</span> <span style=color:#000>server</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>MyEchoService</span> <span style=color:#000>my_echo_service</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddService</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>my_echo_service</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SERVER_DOESNT_OWN_SERVICE</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>FATAL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Fail to add my_echo_service&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>You cannot add or remove services after the server is started.</p><h1 id=start-server>Start server</h1><p>Call following methods of <a href=https://github.com/brpc/brpc/blob/master/src/brpc/server.h>Server</a> to start serving.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ip_and_port_str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>ServerOptions</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>opt</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>EndPoint</span> <span style=color:#000>ip_and_port</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>ServerOptions</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>opt</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>ServerOptions</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>opt</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ip_str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PortRange</span> <span style=color:#000>port_range</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>ServerOptions</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>opt</span><span style=color:#000;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// r32009后增加
</span></span></span></code></pre></div><p>&ldquo;localhost:9000&rdquo;, &ldquo;cq01-cos-dev00.cq01:8000&rdquo;, &ldquo;127.0.0.1:7000&rdquo; are valid <code>ip_and_port_str</code>.</p><p>All parameters take default values if <code>options</code> is NULL. If you need non-default values, code as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// with default values
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>xxx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>yyy</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Start</span><span style=color:#000;font-weight:700>(...,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>options</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><h2 id=listen-to-multiple-ports>Listen to multiple ports</h2><p>One server can only listen to one port (not counting ServerOptions.internal_port). To listen to N ports, start N servers .</p><h2 id=multi-process-listening-to-one-port>Multi-process listening to one port</h2><p>When the <code>reuse_port</code> flag is turned on at startup, multiple processes can listen to one port (use SO_REUSEPORT internal).</p><h1 id=stop-server>Stop server</h1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stop</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>closewait_ms</span><span style=color:#000;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// closewait_ms is useless actually, not deleted due to compatibility
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Join</span><span style=color:#000;font-weight:700>();</span>
</span></span></code></pre></div><p>Stop() does not block but Join() does. The reason for dividing them into two methods is: When multiple servers quit, users may Stop() all servers first, then Join() them together. Otherwise servers can only be Stop()+Join() one-by-one and the total waiting time may add up to number-of-servers times at worst.</p><p>Regardless of the value of closewait_ms, server waits for all requests being processed before exiting and returns ELOGOFF errors to new requests immediately to prevent them from entering the service. The reason for the wait is that as long as the server is still processing requests, risk of accessing invalid(released) memory exists. If a Join() to a server &ldquo;stucks&rdquo;, some thread must be blocked on a request or done->Run() is not called.</p><p>When a client sees ELOGOFF, it skips the corresponding server and retry the request on another server. As a result, restarting a cluster with brpc clients/servers gradually should not lose traffic by default.</p><p>RunUntilAskedToQuit() simplifies the code to run and stop servers in most cases. Following code runs the server until Ctrl-C is pressed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Wait until Ctrl-C is pressed, then Stop() and Join() the server.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunUntilAskedToQuit</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// server is stopped, write the code for releasing resources.
</span></span></span></code></pre></div><p>Services can be added or removed after Join() returns and server can be Start() again.</p><h1 id=accessed-by-httph2>Accessed by http/h2</h1><p>Services using protobuf can be accessed via http/h2+json generally. The json string stored in body is convertible to/from corresponding protobuf message.</p><p><a href=https://github.com/brpc/brpc/blob/master/example/echo_c%2B%2B/server.cpp>echo server</a> as an example, is accessible from <a href=https://curl.haxx.se/>curl</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># -H &#39;Content-Type: application/json&#39; is optional</span>
</span></span><span style=display:flex><span>$ curl -d <span style=color:#4e9a06>&#39;{&#34;message&#34;:&#34;hello&#34;}&#39;</span> http://brpc.baidu.com:8765/EchoService/Echo
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;message&#34;</span>:<span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Note: Set <code>Content-Type: application/proto</code> to access services with http/h2 + protobuf-serialized-data, which performs better at serialization.</p><h2 id=jsonpb>json&lt;=>pb</h2><p>Json fields correspond to pb fields by matched names and message structures. The json must contain required fields in pb, otherwise conversion will fail and corresponding request will be rejected. The json may include undefined fields in pb, but they will be dropped rather than being stored in pb as unknown fields. Check out <a href=../json2pb/>json &lt;=> protobuf</a> for conversion rules.</p><p>When -pb_enum_as_number is turned on, enums in pb are converted to values instead of names. For example in <code>enum MyEnum { Foo = 1; Bar = 2; };</code>, fields typed <code>MyEnum</code> are converted to &ldquo;Foo&rdquo; or &ldquo;Bar&rdquo; when the flag is off, 1 or 2 otherwise. This flag affects requests sent by clients and responses returned by servers both. Since &ldquo;enum as name&rdquo; has better forward and backward compatibilities, this flag should only be turned on to adapt legacy code that are unable to parse enumerations from names.</p><h2 id=adapt-old-clients>Adapt old clients</h2><p>Early-version brpc allows pb service being accessed via http without filling the pb request, even if there&rsquo;re required fields. This kind of service often parses http requests and sets http responses by itself, and does not touch the pb request. However this behavior is still very dangerous: a service with an undefined request.</p><p>This kind of services may meet issues after upgrading to latest brpc, which already deprecated the behavior for a long time. To help these services to upgrade, brpc allows bypassing the conversion from http body to pb request (so that users can parse http requests differently), the setting is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServiceOptions</span> <span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ownership</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>...;</span>
</span></span><span style=display:flex><span><span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>restful_mappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>...;</span>
</span></span><span style=display:flex><span><span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>allow_http_body_to_pb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>false</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>// turn off conversion from http/h2 body to pb request
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddService</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>After the setting, service does not convert the body to pb request after receiving http/h2 request, which also makes the pb request undefined. Users have to parse the body by themselves when <code>cntl->request_protocol() == brpc::PROTOCOL_HTTP || cntl->request_protocol() == brpc::PROTOCOL_H2</code> is true which indicates the request is from http/h2.</p><p>As a correspondence, if cntl->response_attachment() is not empty and pb response is set as well, brpc does not report the ambiguous anymore, instead cntl->response_attachment() will be used as body of the http/h2 response. This behavior is unaffected by setting allow_http_body_to_pb or not. If the relaxation results in more users&rsquo; errors, we may restrict it in future.</p><h1 id=protocols>Protocols</h1><p>Server detects supported protocols automatically, without assignment from users. <code>cntl->protocol()</code> gets the protocol being used. Server is able to accept connections with different protocols from one port, users don&rsquo;t need to assign different ports for different protocols. Even one connection may transport messages in multiple protocols, although we rarely do this (and not recommend). Supported protocols:</p><ul><li><p><a href=https://github.com/apache/incubator-brpc/blob/master/docs/cn/baidu_std.md>The standard protocol used in Baidu</a>, shown as &ldquo;baidu_std&rdquo;, enabled by default.</p></li><li><p><a href=../../client/streaming-rpc/>Streaming RPC</a>, shown as &ldquo;streaming_rpc&rdquo;, enabled by default.</p></li><li><p>http/1.0 and http/1.1, shown as &ldquo;http&rdquo;, enabled by default.</p></li><li><p>http/2 and gRPC, shown as &ldquo;h2c&rdquo;(unencrypted) or &ldquo;h2&rdquo;(encrypted), enabled by default.</p></li><li><p>Protocol of RTMP, shown as &ldquo;rtmp&rdquo;, enabled by default.</p></li><li><p>Protocol of hulu-pbrpc, shown as &ldquo;hulu_pbrpc&rdquo;, enabled by default.</p></li><li><p>Protocol of sofa-pbrpc, shown as &ldquo;sofa_pbrpc&rdquo;, enabled by default.</p></li><li><p>Protocol of Baidu ads union, shown as &ldquo;nova_pbrpc&rdquo;, disabled by default. Enabling method:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;brpc/policy/nova_pbrpc_protocol.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nshead_service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>policy</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>NovaServiceAdaptor</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div></li><li><p>Protocol of public_pbrpc, shown as &ldquo;public_pbrpc&rdquo;, disabled by default. Enabling method:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;brpc/policy/public_pbrpc_protocol.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nshead_service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>policy</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>PublicPbrpcServiceAdaptor</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div></li><li><p>Protocol of nshead+mcpack, shown as &ldquo;nshead_mcpack&rdquo;, disabled by default. Enabling method:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;brpc/policy/nshead_mcpack_protocol.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nshead_service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>policy</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>NsheadMcpackAdaptor</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>As the name implies, messages in this protocol are composed by nshead+mcpack, the mcpack does not include special fields. Different from implementations based on NsheadService by users, this protocol uses mcpack2pb which makes the service capable of handling both mcpack and pb with one piece of code. Due to lack of fields to carry ErrorText, server can only close connections when errors occur.</p></li><li><p>Read <a href=https://github.com/apache/incubator-brpc/blob/master/docs/cn/nshead_service.md>Implement NsheadService</a> for UB related protocols.</p></li></ul><p>If you need more protocols, contact us.</p><h1 id=fork-without-exec>fork without exec</h1><p>In general, <a href=https://linux.die.net/man/3/fork>forked</a> subprocess should call <a href=https://linux.die.net/man/3/exec>exec</a> ASAP, before which only async-signal-safe functions should be called. brpc programs using fork like this should work correctly even in previous versions.</p><p>But in some scenarios, users continue the subprocess without exec. Since fork only copies its caller&rsquo;s thread, which causes other threads to disappear after fork. In the case of brpc, bvar depends on a sampling_thread to sample various information, which disappears after fork and causes many bvars to be zeros.</p><p>Latest brpc re-creates the thread after fork(when necessary) to make bvar work correctly, and can be forked again. A known problem is that the cpu profiler does not work after fork. However users still can&rsquo;t call fork at any time, since brpc and its applications create threads extensively, which are not re-created after fork:</p><ul><li>most fork continues with exec, which wastes re-creations</li><li>bring too many troubles and complexities to the code</li></ul><p>brpc&rsquo;s strategy is to create these threads on demand and fork without exec should happen before all code that may create the threads. Specifically, <strong>fork without exec should happen before initializing all Servers/Channels/Applications, earlier is better</strong>. fork not obeying this causes the program dysfunctional. BTW, fork without exec better be avoided because many libraries do not support it.</p><h1 id=settings>Settings</h1><h2 id=version>Version</h2><p>Server.set_version(…) sets name+version for the server, accessible from the builtin service <code>/version</code>. Although it&rsquo;s called &ldquo;version&rdquo;, the string set is recommended to include the service name rather than just a numeric version.</p><h2 id=close-idle-connections>Close idle connections</h2><p>If a connection does not read or write within the seconds specified by ServerOptions.idle_timeout_sec, it&rsquo;s treated as &ldquo;idle&rdquo; and will be closed by server soon. Default value is -1 which disables the feature.</p><p>If <a href=http://brpc.baidu.com:8765/flags/log_idle_connection_close>-log_idle_connection_close</a> is turned on, a log will be printed before closing.</p><table><thead><tr><th>Name</th><th>Value</th><th>Description</th><th>Defined At</th></tr></thead><tbody><tr><td>log_idle_connection_close</td><td>false</td><td>Print log when an idle connection is closed</td><td>src/brpc/socket.cpp</td></tr></tbody></table><h2 id=pid_file>pid_file</h2><p>If this field is non-empty, Server creates a file named so at start-up, with pid as the content. Empty by default.</p><h2 id=print-hostname-in-each-line-of-log>Print hostname in each line of log</h2><p>This feature only affects logging macros in <a href=https://github.com/brpc/brpc/blob/master/src/butil/logging.h>butil/logging.h</a>.</p><p>If <a href=http://brpc.baidu.com:8765/flags/log_hostname>-log_hostname</a> is turned on, each line of log contains the hostname so that users know machines at where each line is generated from aggregated logs.</p><h2 id=crash-after-printing-fatal-log>Crash after printing FATAL log</h2><p>This feature only affects logging macros in <a href=https://github.com/brpc/brpc/blob/master/src/butil/logging.h>butil/logging.h</a>, glog crashes for FATAL log by default.</p><p>If <a href=http://brpc.baidu.com:8765/flags/crash_on_fatal_log>-crash_on_fatal_log</a> is turned on, program crashes after printing LOG(FATAL) or failed assertions by CHECK*(), and generates coredump (with proper environmental settings). Default value is false. This flag can be turned on in tests to make sure the program never hit critical errors.</p><blockquote><p>A common convention: use ERROR for tolerable errors, FATAL for unacceptable and permanent errors.</p></blockquote><h2 id=minimum-log-level>Minimum log level</h2><p>This feature is implemented by <a href=https://github.com/brpc/brpc/blob/master/src/butil/logging.h>butil/logging.h</a> and glog separately, as a same-named gflag.</p><p>Only logs with levels <strong>not less than</strong> the level specified by -minloglevel are printed. This flag can be modified at run-time. Correspondence between values and log levels: 0=INFO 1=NOTICE 2=WARNING 3=ERROR 4=FATAL, default value is 0.</p><p>Overhead of unprinted logs is just a &ldquo;if&rdquo; test and parameters are not evaluated (For example a parameter calls a function, if the log is not printed, the function is not called). Logs printed to LogSink may be filtered by the sink as well.</p><h2 id=return-free-memory-to-system>Return free memory to system</h2><p>Set gflag -free_memory_to_system_interval to make the program try to return free memory to system every so many seconds, values &lt;= 0 disable the feature. Default value is 0. To turn it on, values >= 10 are recommended. This feature supports tcmalloc, thus <code>MallocExtension::instance()->ReleaseFreeMemory()</code> periodically called in your program can be replaced by setting this flag.</p><h2 id=log-error-to-clients>Log error to clients</h2><p>Framework does not print logs for specific client generally, because a lot of errors caused by clients may slow down server significantly due to frequent printing of logs. If you need to debug or just want the server to log all errors, turn on <a href=http://brpc.baidu.com:8765/flags/log_error_text>-log_error_text</a>.</p><h2 id=customize-percentiles-of-latency>Customize percentiles of latency</h2><p>Latency percentiles showed are <strong>80</strong> (was 50 before), 90, 99, 99.9, 99.99 by default. The first 3 ones can be changed by gflags -bvar_latency_p1, -bvar_latency_p2, -bvar_latency_p3 respectively。</p><p>Following are correct settings:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-bvar_latency_p3<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>97</span>   <span style=color:#8f5902;font-style:italic># p3 is changed from default 99 to 97</span>
</span></span><span style=display:flex><span>-bvar_latency_p1<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60</span> -bvar_latency_p2<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>80</span> -bvar_latency_p3<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>95</span>
</span></span></code></pre></div><p>Following are wrong settings:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-bvar_latency_p3<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100</span>   <span style=color:#8f5902;font-style:italic># the value must be inside [1,99] inclusive，otherwise gflags fails to parse</span>
</span></span><span style=display:flex><span>-bvar_latency_p1<span style=color:#ce5c00;font-weight:700>=</span>-1    <span style=color:#8f5902;font-style:italic># ^</span>
</span></span></code></pre></div><h2 id=change-stacksize>Change stacksize</h2><p>brpc server runs code in bthreads with stacksize=1MB by default, while stacksize of pthreads is 10MB. It&rsquo;s possible that programs running normally on pthreads may meet stack overflow on bthreads.</p><p>Set following gflags to enlarge the stacksize.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>--stack_size_normal<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10000000</span>  <span style=color:#8f5902;font-style:italic># sets stacksize to roughly 10MB</span>
</span></span><span style=display:flex><span>--tc_stack_normal<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>           <span style=color:#8f5902;font-style:italic># sets number of stacks cached by each worker pthread to prevent reusing from global pool each time, default value is 8</span>
</span></span></code></pre></div><p>NOTE: It does mean that coredump of programs is likely to be caused by &ldquo;stack overflow&rdquo; on bthreads. We&rsquo;re talking about this simply because it&rsquo;s easy and quick to verify this factor and exclude the possibility.</p><h2 id=limit-sizes-of-messages>Limit sizes of messages</h2><p>To protect servers and clients, when a request received by a server or a response received by a client is too large, the server or client rejects the message and closes the connection. The limit is controlled by <a href=http://brpc.baidu.com:8765/flags/max_body_size>-max_body_size</a>, in bytes.</p><p>An error log is printed when a message is too large and rejected:</p><pre tabindex=0><code>FATAL: 05-10 14:40:05: * 0 src/brpc/input_messenger.cpp:89] A message from 127.0.0.1:35217(protocol=baidu_std) is bigger than 67108864 bytes, the connection will be closed. Set max_body_size to allow bigger messages
</code></pre><p>protobuf has <a href=https://github.com/google/protobuf/blob/master/src/google/protobuf/io/coded_stream.h#L364>similar limits</a> and the error log is as follows:</p><pre tabindex=0><code>FATAL: 05-10 13:35:02: * 0 google/protobuf/io/coded_stream.cc:156] A protocol message was rejected because it was too big (more than 67108864 bytes). To increase the limit (or to disable these warnings), see CodedInputStream::SetTotalBytesLimit() in google/protobuf/io/coded_stream.h.
</code></pre><p>brpc removes the restriction from protobuf and controls the limit by -max_body_size solely: as long as the flag is large enough, messages will not be rejected and error logs will not be printed. This feature works for all versions of protobuf.</p><h2 id=compression>Compression</h2><p><code>set_response_compress_type()</code> sets compression method for the response, no compression by default.</p><p>Attachment is not compressed. Check <a href=../serve-httph2/#compress-the-response-body>here</a> for compression of HTTP body.</p><p>Supported compressions:</p><ul><li>brpc::CompressTypeSnappy : <a href=http://google.github.io/snappy/>snanpy</a>, compression and decompression are very fast, but compression ratio is low.</li><li>brpc::CompressTypeGzip : <a href=http://en.wikipedia.org/wiki/Gzip>gzip</a>, significantly slower than snappy, with a higher compression ratio.</li><li>brpc::CompressTypeZlib : <a href=http://en.wikipedia.org/wiki/Zlib>zlib</a>, 10%~20% faster than gzip but still significantly slower than snappy, with slightly better compression ratio than gzip.</li></ul><p>Read <a href=../../client/basics/#compression>Client-Compression</a> for more comparisons.</p><h2 id=attachment>Attachment</h2><p>baidu_std and hulu_pbrpc supports attachments which are sent along with messages and set by users to bypass serialization of protobuf. From a server&rsquo;s perspective, data set in Controller.response_attachment() will be received by the client while Controller.request_attachment() contains attachment sent from the client.</p><p>Attachment is not compressed by framework.</p><p>In http, attachment corresponds to <a href=http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html>message body</a>, namely the data to post to client is stored in response_attachment().</p><h2 id=turn-on-ssl>Turn on SSL</h2><p>Update openssl to the latest version before turning on SSL, since older versions of openssl may have severe security problems and support less encryption algorithms, which is against with the purpose of using SSL. Setup <code>ServerOptions.ssl_options</code> to turn on SSL. Refer to <a href=https://github.com/brpc/brpc/blob/master/src/brpc/ssl_options.h>ssl_options.h</a> for more details.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Certificate structure
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>CertInfo</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Certificate in PEM format.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Note that CN and alt subjects will be extracted from the certificate,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// and will be used as hostnames. Requests to this hostname (provided SNI
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// extension supported) will be encrypted using this certifcate.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Supported both file path and raw string
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span> <span style=color:#000>certificate</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Private key in PEM format.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Supported both file path and raw string based on prefix:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span> <span style=color:#000>private_key</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Additional hostnames besides those inside the certificate. Wildcards
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// are supported but it can only appear once at the beginning (i.e. *.xxx.com).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sni_filters</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// SSL options at server side
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ServerSSLOptions</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Default certificate which will be loaded into server. Requests
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// without hostname or whose hostname doesn&#39;t have a corresponding
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// certificate will use this certificate. MUST be set to enable SSL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>CertInfo</span> <span style=color:#000>default_cert</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Additional certificates which will be loaded into server. These
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// provide extra bindings between hostnames and certificates so that
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// we can choose different certificates according to different hostnames.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// See `CertInfo&#39; for detail.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CertInfo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>certs</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// When set, requests without hostname or whose hostname can&#39;t be found in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// any of the cerficates above will be dropped. Otherwise, `default_cert&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// will be used.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: false
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>strict_sni</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ... Other options
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><ul><li><p>To turn on SSL, users <strong>MUST</strong> provide a <code>default_cert</code>. For dynamic certificate selection (i.e. based on request hostname, a.k.a <a href=https://en.wikipedia.org/wiki/Server_Name_Indication>SNI</a>), <code>certs</code> should be used to store those dynamic certificates. Finally, users can add/remove those certificates when server&rsquo;s running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>AddCertificate</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>CertInfo</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>cert</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>RemoveCertificate</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>CertInfo</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>cert</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ResetCertificates</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CertInfo</span><span style=color:#ce5c00;font-weight:700>&gt;&amp;</span> <span style=color:#000>certs</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div></li><li><p>Other options include: cipher suites (recommend using <code>ECDHE-RSA-AES256-GCM-SHA384</code> which is the default suite used by chrome, and one of the safest suites. The drawback is more CPU cost), session reuse and so on.</p></li><li><p>SSL layer works under protocol layer. As a result, all protocols (such as HTTP) can provide SSL access when it&rsquo;s turned on. Server will decrypt the data first and then pass it into each protocol.</p></li><li><p>After turning on SSL, non-SSL access is still available for the same port. Server can automatically distinguish SSL from non-SSL requests. SSL-only mode can be implemented using <code>Controller::is_ssl()</code> in service&rsquo;s callback and <code>SetFailed</code> if it returns false. In the meanwhile, the builtin-service <a href=../../builtin-services/connections/>connections</a> also shows the SSL information for each connection.</p></li></ul><h2 id=verify-identities-of-clients>Verify identities of clients</h2><p>The server needs to implement <code>Authenticator</code> to enable verifications:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Authenticator</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Implement this method to verify credential information `auth_str&#39; from
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// `client_addr&#39;. You can fill credential context (result) into `*out_ctx&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// and later fetch this pointer from `Controller&#39;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Returns 0 on success, error code otherwise
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>virtual</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>VerifyCredential</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>auth_str</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                 <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>base</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EndPoint</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>client_addr</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                 <span style=color:#000>AuthContext</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>out_ctx</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>};</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AuthContext</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>user</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>group</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>roles</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>starter</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>is_service</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>The authentication is connection-specific. When server receives the first request from a connection, it tries to parse related information inside (such as auth field in baidu_std, Authorization header in HTTP), and call <code>VerifyCredential</code> along with address of the client. If the method returns 0, which indicates success, user can put verified information into <code>AuthContext</code> and access it via <code>controller->auth_context()</code> later, whose lifetime is managed by framework. Otherwise the authentication is failed and the connection will be closed, which makes the client-side fail as well.</p><p>Subsequent requests are treated as already verified without authenticating overhead.</p><p>Assigning an instance of implemented <code>Authenticator</code> to <code>ServerOptions.auth</code> enables authentication. The instance must be valid during lifetime of the server.</p><h2 id=number-of-worker-pthreads>Number of worker pthreads</h2><p>Controlled by <code>ServerOptions.num_threads</code> , number of cpu cores by default(including HT).</p><p>NOTE: ServerOptions.num_threads is just a <strong>hint</strong>.</p><p>Don&rsquo;t think that Server uses exactly so many workers because all servers and channels in one process share worker pthreads. Total number of threads is the maximum of all ServerOptions.num_threads and bthread_concurrency. For example, a program has 2 servers with num_threads=24 and 36 respectively, and bthread_concurrency is 16. Then the number of worker pthreads is max (24, 36, 16) = 36, which is different from other RPC implementations which do summations generally.</p><p>Channel does not have a corresponding option, but user can change number of worker pthreads at client-side by setting gflag -bthread_concurrency.</p><p>In addition, brpc <strong>does not separate &ldquo;IO&rdquo; and &ldquo;processing&rdquo; threads</strong>. brpc knows how to assemble IO and processing code together to achieve better concurrency and efficiency.</p><h2 id=limit-concurrency>Limit concurrency</h2><p>&ldquo;Concurrency&rdquo; may have 2 meanings: one is number of connections, another is number of requests processed simultaneously. Here we&rsquo;re talking about the latter one.</p><p>In traditional synchronous servers, max concurreny is limited by number of worker pthreads. Setting number of workers also limits concurrency. But brpc processes new requests in bthreads and M bthreads are mapped to N workers (M > N generally), synchronous server may have a concurrency higher than number of workers. On the other hand, although concurrency of asynchronous server is not limited by number of workers in principle, we need to limit it by other factors sometimes.</p><p>brpc can limit concurrency at server-level and method-level. When number of requests processed by the server or method simultaneously would exceed the limit, server responds the client with <strong>brpc::ELIMIT</strong> directly instead of invoking the service. A client seeing ELIMIT should retry another server (by best efforts). This options avoids over-queuing of requests at server-side and limits related resources.</p><p>Disabled by default.</p><h3 id=why-issue-error-to-the-client-instead-of-queuing-the-request-when-the-concurrency-hits-limit>Why issue error to the client instead of queuing the request when the concurrency hits limit?</h3><p>A server reaching max concurrency does not mean that other servers in the same cluster reach the limit as well. Let client be aware of the error ASAP and try another server is a better strategy from a cluster view.</p><h3 id=why-not-limit-qps>Why not limit QPS?</h3><p>QPS is a second-level metric, which is not good at limiting sudden request bursts. Max concurrency is closely related to availability of critical resources: number of &ldquo;workers&rdquo; or &ldquo;slots&rdquo; etc, thus better at preventing over-queuing.</p><p>In addition, when a server has stable latencies, limiting concurrency has similar effect as limiting QPS due to little&rsquo;s law. But the former one is much easier to implement: simple additions and minuses from a counter representing the concurrency. This is also the reason than most flow control is implemented by limiting concurrency rather than QPS. For example the window in TCP is a kind of concurrency.</p><h3 id=calculate-max-concurrency>Calculate max concurrency</h3><p>max_concurrency = peak_qps * noload_latency (<a href=https://en.wikipedia.org/wiki/Little%27s_law>little&rsquo;s law</a>)</p><p>peak_qps is the maximum of Queries-Per-Second.
noload_latency is the average latency measured in a server without pushing to its limit(with an acceptable latency).
peak_qps and nolaod_latency can be measured in pre-online performance tests and multiplied to calculate the max_concurrency.</p><h3 id=limit-server-level-concurrency>Limit server-level concurrency</h3><p>Set ServerOptions.max_concurrency. Default value is 0 which means not limited. Accesses to builtin services are not limited by this option.</p><p>Call Server.ResetMaxConcurrency() to modify max_concurrency of the server after starting.</p><h3 id=limit-method-level-concurrency>Limit method-level concurrency</h3><p>server.MaxConcurrencyOf("&mldr;") = … sets max_concurrency of the method. Possible settings:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxConcurrencyOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;example.EchoService.Echo&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxConcurrencyOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;example.EchoService&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Echo&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxConcurrencyOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>service</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Echo&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>The code is generally put <strong>after AddService, before Start() of the server</strong>. When a setting fails(namely the method does not exist), server will fail to start and notify user to fix settings on MaxConcurrencyOf.</p><p>When method-level and server-level max_concurrency are both set, framework checks server-level first, then the method-level one.</p><p>NOTE: No service-level max_concurrency.</p><h3 id=autoconcurrencylimiter>AutoConcurrencyLimiter</h3><p>max_concurrency may change over time and measuring and setting max_concurrency for all services before each deployment are probably very troublesome and impractical.</p><p>AutoConcurrencyLimiter addresses on this issue by limiting concurrency for methods. To use the algorithm, set max_concurrency of the method to &ldquo;auto&rdquo;.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Set auto concurrency limiter for all methods
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>method_max_concurrency</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;auto&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Set auto concurrency limiter for specific method
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxConcurrencyOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;example.EchoService.Echo&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;auto&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>Read <a href=../auto-concurrencylimiter/>this</a> to know more about the algorithm.</p><h2 id=pthread-mode>pthread mode</h2><p>User code(client-side done, server-side CallMethod) runs in bthreads with 1MB stacksize by default. But some of them cannot run in bthreads:</p><ul><li>JNI code checks stack layout and cannot be run in bthreads.</li><li>The user code extensively use pthread-local to pass session-level data across functions. If there&rsquo;s a synchronous RPC call or function calls that may block bthread, the resumed bthread may land on a different pthread which does not have the pthread-local data that users expect to have. As a contrast, although tcmalloc uses pthread(or LWP)-local as well, the code inside has nothing to do with bthread, which is safe.</li></ul><p>brpc offers pthread mode to solve the issues. When <strong>-usercode_in_pthread</strong> is turned on, user code will be run in pthreads. Functions that would block bthreads block pthreads.</p><p>Note: With -usercode_in_pthread on, brpc::thread_local_data() does not guarantee to return valid value.</p><p>Performance issues when pthread mode is on:</p><ul><li>Since synchronous RPCs block worker pthreads, server often needs more workers (ServerOptions.num_threads), and scheduling efficiencies will be slightly lower.</li><li>User code still runs in special bthreads actually, which use stacks of pthread workers. These special bthreads are scheduled same with normal bthreads and performance differences are negligible.</li><li>bthread supports an unique feature: yield pthread worker to a newly created bthread to reduce a context switch. brpc client uses this feature to reduce number of context switches in one RPC from 3 to 2. In a performance-demanding system, reducing context-switches improves performance. However pthread-mode is not capable of doing this.</li><li>Number of threads in pthread-mode is a hard limit. Once all threads are occupied, requests will be queued rapidly and many of them will be timed-out finally. An example: When many requests to downstream servers are timedout, the upstream services may also be severely affected by a lot of blocking threads waiting for responses(within timeout). Consider setting ServerOptions.max_concurrency to protect the server when pthread-mode is on. As a contrast, number of bthreads in bthread mode is a soft limit and reacts more smoothly to such kind of issues.</li></ul><p>pthread-mode lets legacy code to try brpc more easily, but we still recommend refactoring the code with bthread-local or even remove TLS gradually, to turn off the option in future.</p><h2 id=security-mode>Security mode</h2><p>If requests are from public(including being proxied by nginx etc), you have to be aware of some security issues.</p><h3 id=hide-builtin-services-from-public>Hide builtin services from public</h3><p>Builtin services are useful, on the other hand include a lot of internal information and shouldn&rsquo;t be exposed to public. There&rsquo;re multiple methods to hide builtin services from public:</p><ul><li><p>Set internal port. Set ServerOptions.internal_port to a port which can <strong>only be accessible from internal</strong>. You can view builtin services via internal_port, while accesses from the public port (the one passed to Server.Start) should see following error:</p><pre tabindex=0><code>[a27eda84bcdeef529a76f22872b78305] Not allowed to access builtin services, try ServerOptions.internal_port=... instead if you&#39;re inside internal network
</code></pre></li><li><p>http proxies only proxy specified URLs. nginx etc is able to configure how to map different URLs to back-end servers. For example the configure below maps public traffic to /MyAPI to <code>/ServiceName/MethodName</code> of <code>target-server</code>. If builtin services like /status are accessed from public, nginx rejects the attempts directly.</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>location</span> <span style=color:#4e9a06>/MyAPI</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>...</span>
</span></span><span style=display:flex><span>      <span style=color:#4e9a06>proxy_pass</span> <span style=color:#4e9a06>http://&lt;target-server&gt;/ServiceName/MethodName</span><span style=color:#000>$query_string</span>   <span style=color:#8f5902;font-style:italic># $query_string is a nginx varible, check out http://nginx.org/en/docs/http/ngx_http_core_module.html for more.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#4e9a06>...</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>}</span>
</span></span></code></pre></div><p><strong>Don&rsquo;t turn on</strong> -enable_dir_service and -enable_threads_service on public services. Although they&rsquo;re convenient for debugging, they also expose too many information on the server. The script to check if the public service has enabled the options:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s -m <span style=color:#0000cf;font-weight:700>1</span> &lt;HOSTNAME&gt;:&lt;PORT&gt;/flags/enable_dir_service,enable_threads_service <span style=color:#000;font-weight:700>|</span> awk <span style=color:#4e9a06>&#39;{if($3==&#34;false&#34;){++falsecnt}else if($3==&#34;Value&#34;){isrpc=1}}END{if(isrpc!=1||falsecnt==2){print &#34;SAFE&#34;}else{print &#34;NOT SAFE&#34;}}&#39;</span>
</span></span></code></pre></div><h3 id=disable-built-in-services-completely>Disable built-in services completely</h3><p>Set ServerOptions.has_builtin_services = false, you can completely disable the built-in services.</p><h3 id=escape-urls-controllable-from-public>Escape URLs controllable from public</h3><p>brpc::WebEscape() escapes url to prevent injection attacks with malice.</p><h3 id=not-return-addresses-of-internal-servers>Not return addresses of internal servers</h3><p>Consider returning signatures of the addresses. For example after setting ServerOptions.internal_port, addresses in error information returned by server is replaced by their MD5 signatures.</p><h2 id=customize-health>Customize /health</h2><p>/health returns &ldquo;OK&rdquo; by default. If the content on /health needs to be customized: inherit <a href=https://github.com/brpc/brpc/blob/master/src/brpc/health_reporter.h>HealthReporter</a> and implement code to generate the page (like implementing other http services). Assign an instance to ServerOptions.health_reporter, which is not owned by server and must be valid during lifetime of the server. Users may return richer healthy information according to application requirements.</p><h2 id=thread-local-variables>thread-local variables</h2><p>Searching services inside Baidu use <a href=https://en.wikipedia.org/wiki/Thread-local_storage>thread-local storage</a> (TLS) extensively. Some of them cache frequently used objects to reduce repeated creations, some of them pass contexts to global functions implicitly. You should avoid the latter usage as much as possible. Such functions cannot even run without TLS, being hard to test. brpc provides 3 mechanisms to solve issues related to thread-local storage.</p><h3 id=session-local>session-local</h3><p>A session-local data is bound to a <strong>server-side RPC</strong>: from entering CallMethod of the service, to calling the server-side done->Run(), no matter the service is synchronous or asynchronous. All session-local data are reused as much as possible and not deleted before stopping the server.</p><p>After setting ServerOptions.session_local_data_factory, call Controller.session_local_data() to get a session-local data. If ServerOptions.session_local_data_factory is unset, Controller.session_local_data() always returns NULL.</p><p>If ServerOptions.reserved_session_local_data is greater than 0, Server creates so many data before serving.</p><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>MySessionLocalData</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MySessionLocalData</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>123</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EchoServiceImpl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Get the session-local data which is created by ServerOptions.session_local_data_factory
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// and reused between different RPC.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MySessionLocalData</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>sd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MySessionLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>session_local_data</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>sd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>SetFailed</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Require ServerOptions.session_local_data_factory to be set with a correctly implemented instance&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ServerOptions</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// The factory to create/destroy data attached to each RPC session.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// If this field is NULL, Controller::session_local_data() is always NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// NOT owned by Server and must be valid when Server is running.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: NULL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>DataFactory</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>session_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Prepare so many session-local data before server starts, so that calls
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// to Controller::session_local_data() get data directly rather than
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// calling session_local_data_factory-&gt;Create() at first time. Useful when
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Create() is slow, otherwise the RPC session may be blocked by the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// creation of data and not served within timeout.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: 0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>size_t</span> <span style=color:#000>reserved_session_local_data</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>session_local_data_factory is typed <a href=https://github.com/brpc/brpc/blob/master/src/brpc/data_factory.h>DataFactory</a>. You have to implement CreateData and DestroyData inside.</p><p>NOTE: CreateData and DestroyData may be called by multiple threads simultaneously. Thread-safety is a must.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MySessionLocalDataFactory</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>DataFactory</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>CreateData</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MySessionLocalData</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>DestroyData</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>d</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MySessionLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>MySessionLocalDataFactory</span> <span style=color:#000>g_session_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>argc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>argv</span><span style=color:#000;font-weight:700>[])</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Server</span> <span style=color:#000>server</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>session_local_data_factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>g_session_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><h3 id=server-thread-local>server-thread-local</h3><p>A server-thread-local is bound to <strong>a call to service&rsquo;s CallMethod</strong>, from entering service&rsquo;s CallMethod, to leaving the method. All server-thread-local data are reused as much as possible and will not be deleted before stopping the server. server-thread-local is implemented as a special bthread-local.</p><p>After setting ServerOptions.thread_local_data_factory, call brpc::thread_local_data() to get a thread-local. If ServerOptions.thread_local_data_factory is unset, brpc::thread_local_data() always returns NULL.</p><p>If ServerOptions.reserved_thread_local_data is greater than 0, Server creates so many data before serving.</p><p><strong>Differences with session-local</strong></p><p>session-local data is got from server-side Controller, server-thread-local can be got globally from any function running directly or indirectly inside a thread created by the server.</p><p>session-local and server-thread-local are similar in a synchronous service, except that the former one has to be created from a Controller. If the service is asynchronous and the data needs to be accessed from done->Run(), session-local is the only option, because server-thread-local is already invalid after leaving service&rsquo;s CallMethod.</p><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>MyThreadLocalData</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MyThreadLocalData</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>y</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>y</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EchoServiceImpl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Get the thread-local data which is created by ServerOptions.thread_local_data_factory
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// and reused between different threads.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// &#34;tls&#34; is short for &#34;thread local storage&#34;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>thread_local_data</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>SetFailed</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Require ServerOptions.thread_local_data_factory &#34;</span>
</span></span><span style=display:flex><span>                            <span style=color:#4e9a06>&#34;to be set with a correctly implemented instance&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ServerOptions</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// The factory to create/destroy data attached to each searching thread
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// in server.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// If this field is NULL, brpc::thread_local_data() is always NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// NOT owned by Server and must be valid when Server is running.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: NULL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>DataFactory</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>thread_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Prepare so many thread-local data before server starts, so that calls
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// to brpc::thread_local_data() get data directly rather than calling
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// thread_local_data_factory-&gt;Create() at first time. Useful when Create()
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// is slow, otherwise the RPC session may be blocked by the creation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// of data and not served within timeout.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: 0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>size_t</span> <span style=color:#000>reserved_thread_local_data</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>thread_local_data_factory is typed <a href=https://github.com/brpc/brpc/blob/master/src/brpc/data_factory.h>DataFactory</a>. You need to implement CreateData and DestroyData inside.</p><p>NOTE: CreateData and DestroyData may be called by multiple threads simultaneously. Thread-safety is a must.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThreadLocalDataFactory</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>DataFactory</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>CreateData</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThreadLocalData</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>DestroyData</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>d</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>MyThreadLocalDataFactory</span> <span style=color:#000>g_thread_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>argc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>argv</span><span style=color:#000;font-weight:700>[])</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Server</span> <span style=color:#000>server</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>thread_local_data_factory</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>g_thread_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><h3 id=bthread-local>bthread-local</h3><p>Session-local and server-thread-local are enough for most servers. However, in some cases, we need a more general thread-local solution. In which case, you can use bthread_key_create, bthread_key_destroy, bthread_getspecific, bthread_setspecific etc, which are similar to <a href=http://linux.die.net/man/3/pthread_key_create>pthread equivalence</a>.</p><p>These functions support both bthread and pthread. When they are called in bthread, bthread private variables are returned; When they are called in pthread, pthread private variables are returned. Note that the &ldquo;pthread private&rdquo; here is not created by pthread_key_create, pthread-local created by pthread_key_create cannot be got by bthread_getspecific. __thread in GCC and thread_local in c++11 etc cannot be got by bthread_getspecific as well.</p><p>Since brpc creates a bthread for each request, the bthread-local in the server behaves specially: a bthread created by server does not delete bthread-local data at exit, instead it returns the data to a pool in the server for later reuse. This prevents bthread-local from constructing and destructing frequently along with creation and destroying of bthreads. This mechanism is transparent to users.</p><p><strong>Main interfaces</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Create a key value identifying a slot in a thread-specific data area.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Each thread maintains a distinct thread-specific data area.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// `destructor&#39;, if non-NULL, is called with the value associated to that key
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// when the key is destroyed. `destructor&#39; is not called if the value
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// associated is NULL when the key is destroyed.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Returns 0 on success, error code otherwise.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>extern</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bthread_key_create</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_t</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>destructor</span><span style=color:#000;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Delete a key previously returned by bthread_key_create().
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// It is the responsibility of the application to free the data related to
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// the deleted key in any running thread. No destructor is invoked by
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// this function. Any destructor that may have been associated with key
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// will no longer be called upon thread exit.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Returns 0 on success, error code otherwise.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>extern</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bthread_key_delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_t</span> <span style=color:#000>key</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Store `data&#39; in the thread-specific slot identified by `key&#39;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// bthread_setspecific() is callable from within destructor. If the application
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// does so, destructors will be repeatedly called for at most
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// PTHREAD_DESTRUCTOR_ITERATIONS times to clear the slots.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// NOTE: If the thread is not created by brpc server and lifetime is
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// very short(doing a little thing and exit), avoid using bthread-local. The
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// reason is that bthread-local always allocate keytable on first call to
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// bthread_setspecific, the overhead is negligible in long-lived threads,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// but noticeable in shortly-lived threads. Threads in brpc server
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// are special since they reuse keytables from a bthread_keytable_pool_t
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in the server.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Returns 0 on success, error code otherwise.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// If the key is invalid or deleted, return EINVAL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>extern</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bthread_setspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_t</span> <span style=color:#000>key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Return current value of the thread-specific slot identified by `key&#39;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// If bthread_setspecific() had not been called in the thread, return NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// If the key is invalid or deleted, return NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>extern</span> <span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>bthread_getspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_t</span> <span style=color:#000>key</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p><strong>How to use</strong></p><p>Create a bthread_key_t which represents a kind of bthread-local variable.</p><p>Use bthread_[get|set]specific to get and set bthread-local variables. First-time access to a bthread-local variable from a bthread returns NULL.</p><p>Delete a bthread_key_t after no thread is using bthread-local associated with the key. If a bthread_key_t is deleted during usage, related bthread-local data are leaked.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>my_data_destructor</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>bthread_key_t</span> <span style=color:#000>tls_key</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_create</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>tls_key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>my_data_destructor</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ERROR</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Fail to create tls_key&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in some thread ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_getspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tls_key</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// First call to bthread_getspecific (and before any bthread_setspecific) returns NULL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThreadLocalData</span><span style=color:#000;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>// Create thread-local data on demand.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>CHECK_EQ</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bthread_setspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tls_key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>tls</span><span style=color:#000;font-weight:700>));</span>  <span style=color:#8f5902;font-style:italic>// set the data so that next time bthread_getspecific in the thread returns the data.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>Example</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>my_thread_local_data_deleter</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>d</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EchoServiceImpl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>EchoServiceImpl</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>CHECK_EQ</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bthread_key_create</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>my_thread_local_data_deleter</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>EchoServiceImpl</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>CHECK_EQ</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bthread_key_delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bthread_key_t</span> <span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EchoServiceImpl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// You can create bthread-local data for your own.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// The interfaces are similar with pthread equivalence:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   pthread_key_create  -&gt; bthread_key_create
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   pthread_key_delete  -&gt; bthread_key_delete
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   pthread_getspecific -&gt; bthread_getspecific
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   pthread_setspecific -&gt; bthread_setspecific
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>tls2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_getspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>tls2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>tls2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThreadLocalData</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>CHECK_EQ</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bthread_setspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>tls2</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><h1 id=faq>FAQ</h1><h3 id=q-fail-to-write-into-fd1865-socketid89051020824543547428230-got-eof>Q: Fail to write into fd=1865 <a href="mailto:SocketId=8905@10.208.245.43">SocketId=8905@10.208.245.43</a>:54742@8230: Got EOF</h3><p>A: The client-side probably uses pooled or short connections, and closes the connection after RPC timedout, when server writes back response, it finds that the connection has been closed and reports this error. &ldquo;Got EOF&rdquo; just means the server has received EOF (remote side closes the connection normally). If the client side uses single connection, server rarely reports this error.</p><h3 id=q-remote-side-of-fd9-socketid2109466558000-was-closed>Q: Remote side of fd=9 <a href="mailto:SocketId=2@10.94.66.55">SocketId=2@10.94.66.55</a>:8000 was closed</h3><p>It&rsquo;s not an error, it&rsquo;s a common warning representing that remote side has closed the connection(EOF). This log might be useful for debugging problems.</p><p>Disabled by default. Set gflag -log_connection_close to true to enable it. (<a href=../../builtin-services/flags/#change-gflag-on-the-fly>modify at run-time</a> is supported)</p><h3 id=q-why-does-setting-number-of-threads-at-server-side-not-work>Q: Why does setting number of threads at server-side not work</h3><p>All brpc servers in one process <a href=#Number-of-worker-pthreads>share worker pthreads</a>, If multiple servers are created, number of worker pthreads is probably the maxmium of their ServerOptions.num_threads.</p><h3 id=q-why-do-client-side-latencies-much-larger-than-the-server-side-ones>Q: Why do client-side latencies much larger than the server-side ones</h3><p>server-side worker pthreads may not be enough and requests are significantly delayed. Read <a href=../debug-server-issues/>Server debugging</a> for steps on debugging server-side issues quickly.</p><h3 id=q-fail-to-open-procselfio>Q: Fail to open /proc/self/io</h3><p>Some kernels do not provide this file. Correctness of the service is unaffected, but following bvars are not updated:</p><pre tabindex=0><code>process_io_read_bytes_second
process_io_write_bytes_second
process_io_read_second
process_io_write_second
</code></pre><h3 id=q-json-string-123-cant-be-converted-to-protobuf-message>Q: json string &ldquo;[1,2,3]&rdquo; can&rsquo;t be converted to protobuf message</h3><p>This is not a valid json string, which must be a json object enclosed with braces {}.</p><h1 id=psworkflow-at-server-side>PS:Workflow at server-side</h1><p><img src=/images/docs/server_side.png alt=img></p><div class=section-index><hr class=panel-line></div><div class="text-muted mt-5 pt-3 border-top">Last modified November 4, 2022: <a href=https://github.com/apache/incubator-brpc-website/commit/63dca03ff6606494a3a7b349a80ad90235ccf921>Update _index.md (63dca03)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none" style=display:flex;align-items:center;padding:0!important><div class="container-fluid mx-sm-5"><div class=row style=display:flex;align-items:center><div class="col-12 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/apache/incubator-brpc><i class="fab fa-github"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. All Rights Reserved</small><div style=font-size:12.8px;color:#757474><a href=https://www.apache.org/ target=_blank rel=noopener>Foundation</a> |
<a href=https://www.apache.org/licenses/ target=_blank rel=noopener>License</a> |
<a href=https://www.apache.org/security/ target=_blank rel=noopener>Security</a> |
<a href=https://www.apache.org/events/current-event target=_blank rel=noopener>Events</a> |
<a href=https://www.apache.org/foundation/sponsorship.html target=_blank rel=noopener>Sponsorship</a> |
<a href=https://privacy.apache.org/policies/privacy-policy-public.html target=_blank rel=noopener>Privacy</a> |
<a href=https://www.apache.org/foundation/thanks.html target=_blank rel=noopener>Thanks</a></div></div></div></div></footer></div><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.9d50ef1e20df1eedd2ae2eb4cada72195e39f38e910f839ca9df5402c80b9695.js integrity="sha256-nVDvHiDfHu3Sri60ytpyGV45846RD4Ocqd9UAsgLlpU=" crossorigin=anonymous></script></body></html>