<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>bRPC源码解析·bthread机制 | bRPC</title><meta property="og:title" content="bRPC源码解析·bthread机制"><meta property="og:description" content="bthread简介 官方文档：https://brpc.apache.org/zh/docs/bthread/bthread/
bthread是bRPC使用的M:N线程库，类似协程，即用户态线程，也因此bthread的切换不会陷入内核，不会进行一系列内存同步等耗时操作，从bthread_benchmark中可以看到bthread的创建时间和调度时间相较pthread有着数量级的提升，将大量的bthread映射至少量的内核线程pthread上执行，降低内核上下文切换开销，在充分利用多核的同时，具有更好的cache locality。
为了实现协程需要协程栈、协程的初始化，以及协程间的切换，接下来逐一分析一下这几个过程。在分析之前需要首先补充一点汇编知识以方便我们阅读其中的汇编代码。
基础汇编知识 首先语法习惯，代码中的是AT&T风格的汇编语言，gdb看反汇编默认的风格也是AT&T。
AT&T风格的汇编语言 立即数：$ 开头 寄存器：% 开头 取地址里面的值：偏移量(%寄存器） 整形操作通用后缀：[B] Byte、[W] Word 2Byte、[L] Long 4Byte、[Q] QuadWord 8Byte 浮点操作通用后缀：[S] Singled 4、[D] Double 8、[T] Extended 16（修饰精度: precision） 函数的调用约定 整型参数依次存放在 %rdi、%rsi、%rdx、%rcx、%8、%9 浮点参数依次存放在%xmm0 - %xmm7中 寄存器不够用时，参数放到栈中 被调用的函数可以使用任何寄存器，但它必须保证%rbx、%rbp、%rsp和%12-%15恢复到原来的值 返回值存放在%rax中 调用函数前 调用方要将参数放到寄存器中 然后把%10、%11的值保存到栈中 然后调用call 跳转到函数执行 返回后，恢复%10、%11 从%eax中取出返回值 x86_64含有16个64为整数寄存器 %rsi、%rdi 用于字符串处理 %rsp、%rbp 栈相关，栈从高地址到低地址 %rsp&ndash;>栈顶，push和pop会改变 %rbp&ndash;>栈基址 %8 ~ %15 寄存器 解释 // 创建部分 %rax 临时寄存器；参数可变时传递关于 SSE 寄存器用量的信息；第 1 个返回值寄存器 %rdi 用来给函数传递第 1 个参数 %rsi 用来给函数传递第 2 个参数 %rdx 用来给函数传递第 3 个整数参数 %rcx 用来给函数传递第 4个整数参数 %rsp 堆栈顶指针 %rbp 堆栈基指针 %rip 指令寄存器 // 切换部分 %rbx 被调者保存的寄存器；或用作基指针 %r12-%r15 被调者保存的寄存器 协程栈的结构 协程栈 首先看下协程栈的结构：context指向协程栈顶，stacktype表示栈的类型(大小)，storage为栈空间。"><meta property="og:type" content="article"><meta property="og:url" content="https://brpc.apache.org/zh/docs/blogs/sourcecodes/bthread/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2022-06-16T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-01T19:21:37+08:00"><meta property="og:site_name" content="bRPC"><meta itemprop=name content="bRPC源码解析·bthread机制"><meta itemprop=description content="bthread简介 官方文档：https://brpc.apache.org/zh/docs/bthread/bthread/
bthread是bRPC使用的M:N线程库，类似协程，即用户态线程，也因此bthread的切换不会陷入内核，不会进行一系列内存同步等耗时操作，从bthread_benchmark中可以看到bthread的创建时间和调度时间相较pthread有着数量级的提升，将大量的bthread映射至少量的内核线程pthread上执行，降低内核上下文切换开销，在充分利用多核的同时，具有更好的cache locality。
为了实现协程需要协程栈、协程的初始化，以及协程间的切换，接下来逐一分析一下这几个过程。在分析之前需要首先补充一点汇编知识以方便我们阅读其中的汇编代码。
基础汇编知识 首先语法习惯，代码中的是AT&T风格的汇编语言，gdb看反汇编默认的风格也是AT&T。
AT&T风格的汇编语言 立即数：$ 开头 寄存器：% 开头 取地址里面的值：偏移量(%寄存器） 整形操作通用后缀：[B] Byte、[W] Word 2Byte、[L] Long 4Byte、[Q] QuadWord 8Byte 浮点操作通用后缀：[S] Singled 4、[D] Double 8、[T] Extended 16（修饰精度: precision） 函数的调用约定 整型参数依次存放在 %rdi、%rsi、%rdx、%rcx、%8、%9 浮点参数依次存放在%xmm0 - %xmm7中 寄存器不够用时，参数放到栈中 被调用的函数可以使用任何寄存器，但它必须保证%rbx、%rbp、%rsp和%12-%15恢复到原来的值 返回值存放在%rax中 调用函数前 调用方要将参数放到寄存器中 然后把%10、%11的值保存到栈中 然后调用call 跳转到函数执行 返回后，恢复%10、%11 从%eax中取出返回值 x86_64含有16个64为整数寄存器 %rsi、%rdi 用于字符串处理 %rsp、%rbp 栈相关，栈从高地址到低地址 %rsp&ndash;>栈顶，push和pop会改变 %rbp&ndash;>栈基址 %8 ~ %15 寄存器 解释 // 创建部分 %rax 临时寄存器；参数可变时传递关于 SSE 寄存器用量的信息；第 1 个返回值寄存器 %rdi 用来给函数传递第 1 个参数 %rsi 用来给函数传递第 2 个参数 %rdx 用来给函数传递第 3 个整数参数 %rcx 用来给函数传递第 4个整数参数 %rsp 堆栈顶指针 %rbp 堆栈基指针 %rip 指令寄存器 // 切换部分 %rbx 被调者保存的寄存器；或用作基指针 %r12-%r15 被调者保存的寄存器 协程栈的结构 协程栈 首先看下协程栈的结构：context指向协程栈顶，stacktype表示栈的类型(大小)，storage为栈空间。"><meta itemprop=datePublished content="2022-06-16T00:00:00+00:00"><meta itemprop=dateModified content="2023-02-01T19:21:37+08:00"><meta itemprop=wordCount content="634"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="bRPC源码解析·bthread机制"><meta name=twitter:description content="bthread简介 官方文档：https://brpc.apache.org/zh/docs/bthread/bthread/
bthread是bRPC使用的M:N线程库，类似协程，即用户态线程，也因此bthread的切换不会陷入内核，不会进行一系列内存同步等耗时操作，从bthread_benchmark中可以看到bthread的创建时间和调度时间相较pthread有着数量级的提升，将大量的bthread映射至少量的内核线程pthread上执行，降低内核上下文切换开销，在充分利用多核的同时，具有更好的cache locality。
为了实现协程需要协程栈、协程的初始化，以及协程间的切换，接下来逐一分析一下这几个过程。在分析之前需要首先补充一点汇编知识以方便我们阅读其中的汇编代码。
基础汇编知识 首先语法习惯，代码中的是AT&T风格的汇编语言，gdb看反汇编默认的风格也是AT&T。
AT&T风格的汇编语言 立即数：$ 开头 寄存器：% 开头 取地址里面的值：偏移量(%寄存器） 整形操作通用后缀：[B] Byte、[W] Word 2Byte、[L] Long 4Byte、[Q] QuadWord 8Byte 浮点操作通用后缀：[S] Singled 4、[D] Double 8、[T] Extended 16（修饰精度: precision） 函数的调用约定 整型参数依次存放在 %rdi、%rsi、%rdx、%rcx、%8、%9 浮点参数依次存放在%xmm0 - %xmm7中 寄存器不够用时，参数放到栈中 被调用的函数可以使用任何寄存器，但它必须保证%rbx、%rbp、%rsp和%12-%15恢复到原来的值 返回值存放在%rax中 调用函数前 调用方要将参数放到寄存器中 然后把%10、%11的值保存到栈中 然后调用call 跳转到函数执行 返回后，恢复%10、%11 从%eax中取出返回值 x86_64含有16个64为整数寄存器 %rsi、%rdi 用于字符串处理 %rsp、%rbp 栈相关，栈从高地址到低地址 %rsp&ndash;>栈顶，push和pop会改变 %rbp&ndash;>栈基址 %8 ~ %15 寄存器 解释 // 创建部分 %rax 临时寄存器；参数可变时传递关于 SSE 寄存器用量的信息；第 1 个返回值寄存器 %rdi 用来给函数传递第 1 个参数 %rsi 用来给函数传递第 2 个参数 %rdx 用来给函数传递第 3 个整数参数 %rcx 用来给函数传递第 4个整数参数 %rsp 堆栈顶指针 %rbp 堆栈基指针 %rip 指令寄存器 // 切换部分 %rbx 被调者保存的寄存器；或用作基指针 %r12-%r15 被调者保存的寄存器 协程栈的结构 协程栈 首先看下协程栈的结构：context指向协程栈顶，stacktype表示栈的类型(大小)，storage为栈空间。"><link rel=preload href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css as=style><link href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css rel=stylesheet integrity><script src=/js/jquery-3.3.1.min.js></script><title>bRPC源码解析·bthread机制 | bRPC</title></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/zh/><span class=navbar-logo><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/apache/brpc/ target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/downloadbrpc/><span>下载</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/docs/><span class=active>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/community/community/><span>社区</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/asf/><span>ASF</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/docs/blogs/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/users/><span>用户</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a></li><ul><li class="collapse show" id=zhdocs><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsoverview href=/zh/docs/overview/>简介</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsdownloadbrpc href=/zh/docs/downloadbrpc/>下载</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsgetting_started href=/zh/docs/getting_started/>开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsbenchmark href=/zh/docs/benchmark/>性能基准</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvar><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvarbvar></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar c++</a></li><ul><li class=collapse id=zhdocsbvarbvar-c></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/mbvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">mbvar c++</a></li><ul><li class=collapse id=zhdocsbvarmbvar-c></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthread><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthreadbthread></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread-or-not/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread or not</a></li><ul><li class=collapse id=zhdocsbthreadbthread-or-not></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/execution-queue/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Execution Queue</a></li><ul><li class=collapse id=zhdocsbthreadexecution-queue></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/thread-local/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">thread-local</a></li><ul><li class=collapse id=zhdocsbthreadthread-local></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">C++基础</a></li><ul><li class=collapse id=zhdocsc-base><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/iobuf/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IOBuf</a></li><ul><li class=collapse id=zhdocsc-baseiobuf></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/streaming-log/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming Log</a></li><ul><li class=collapse id=zhdocsc-basestreaming-log></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/flatmap/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FlatMap</a></li><ul><li class=collapse id=zhdocsc-baseflatmap></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/brpc-training-materials/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC培训材料</a></li><ul><li class=collapse id=zhdocsc-basebrpc-training-materials></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">客户端</a></li><ul><li class=collapse id=zhdocsclient><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsclientbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/error-code/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">错误码</a></li><ul><li class=collapse id=zhdocsclienterror-code></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/combo-channels/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">组合channels</a></li><ul><li class=collapse id=zhdocsclientcombo-channels></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问http:h2</a></li><ul><li class=collapse id=zhdocsclientaccess-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问gRPC</a></li><ul><li class=collapse id=zhdocsclientaccess-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问thrift</a></li><ul><li class=collapse id=zhdocsclientaccess-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-ub/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问UB</a></li><ul><li class=collapse id=zhdocsclientaccess-ub></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-redis/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问redis</a></li><ul><li class=collapse id=zhdocsclientaccess-redis></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-memcached/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问memcached</a></li><ul><li class=collapse id=zhdocsclientaccess-memcached></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/streaming-rpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流式RPC</a></li><ul><li class=collapse id=zhdocsclientstreaming-rpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/backup-request/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Backup request</a></li><ul><li class=collapse id=zhdocsclientbackup-request></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/dummy-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dummy server</a></li><ul><li class=collapse id=zhdocsclientdummy-server></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">服务端</a></li><ul><li class=collapse id=zhdocsserver><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsserverbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建http:h2服务</a></li><ul><li class=collapse id=zhdocsserverserve-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建gRPC服务</a></li><ul><li class=collapse id=zhdocsserverserve-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建thrift服务</a></li><ul><li class=collapse id=zhdocsserverserve-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-nshead/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建Nshead服务</a></li><ul><li class=collapse id=zhdocsserverserve-nshead></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/server-push/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">推送</a></li><ul><li class=collapse id=zhdocsserverserver-push></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/debug-server-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">高效率排查server卡顿</a></li><ul><li class=collapse id=zhdocsserverdebug-server-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/avalanche/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">雪崩</a></li><ul><li class=collapse id=zhdocsserveravalanche></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/auto-concurrencylimiter/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">自适应限流</a></li><ul><li class=collapse id=zhdocsserverauto-concurrencylimiter></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/media-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流媒体服务</a></li><ul><li class=collapse id=zhdocsservermedia-server></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/json2pb/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">json2pb</a></li><ul><li class=collapse id=zhdocsserverjson2pb></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内置服务</a></li><ul><li class=collapse id=zhdocsbuiltin-services><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/buildin_services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">builtin services</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesbuildin_services></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/status/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">status</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesstatus></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/vars/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">vars</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesvars></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/connections/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">connections</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesconnections></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/flags/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">flags</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesflags></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/rpcz/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpcz</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesrpcz></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/cpu_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">cpu profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescpu_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/heap_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">heap profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesheap_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/contention_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">contention profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescontention_profiler></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">工具</a></li><ul><li class=collapse id=zhdocstools><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_press/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_press</a></li><ul><li class=collapse id=zhdocstoolsrpc_press></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_replay/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_replay</a></li><ul><li class=collapse id=zhdocstoolsrpc_replay></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_view/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_view</a></li><ul><li class=collapse id=zhdocstoolsrpc_view></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/benchmark_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">benchmark_http</a></li><ul><li class=collapse id=zhdocstoolsbenchmark_http></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/parallel_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">parallel_http</a></li><ul><li class=collapse id=zhdocstoolsparallel_http></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">深入RPC</a></li><ul><li class=collapse id=zhdocsrpc-in-depth><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/new-protocol/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">支持新协议</a></li><ul><li class=collapse id=zhdocsrpc-in-depthnew-protocol></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/atomic-instructions/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">原子指令</a></li><ul><li class=collapse id=zhdocsrpc-in-depthatomic-instructions></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/io/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IO</a></li><ul><li class=collapse id=zhdocsrpc-in-depthio></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/threading-overview/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">线程模型简介</a></li><ul><li class=collapse id=zhdocsrpc-in-depththreading-overview></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/load-balancing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">负载均衡</a></li><ul><li class=collapse id=zhdocsrpc-in-depthload-balancing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/locality-aware/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Locality-aware</a></li><ul><li class=collapse id=zhdocsrpc-in-depthlocality-aware></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/consistent-hashing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">一致性哈希</a></li><ul><li class=collapse id=zhdocsrpc-in-depthconsistent-hashing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/memory-management/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内存管理</a></li><ul><li class=collapse id=zhdocsrpc-in-depthmemory-management></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/timer-keeping/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Timer keeping</a></li><ul><li class=collapse id=zhdocsrpc-in-depthtimer-keeping></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/bthread_id/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread_id</a></li><ul><li class=collapse id=zhdocsrpc-in-depthbthread_id></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/community/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">社区</a></li><ul><li class=collapse id=zhdocscommunity><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommunity href=/zh/docs/community/community/>社区</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitymailing_list href=/zh/docs/community/mailing_list/>邮件列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycontributing href=/zh/docs/community/contributing/>Contribute指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitter href=/zh/docs/community/committer/>Committer指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunityrelease href=/zh/docs/community/release/>Release指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitters href=/zh/docs/community/committers/>贡献者列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitysecurity href=/zh/docs/community/security/>安全</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsasf href=/zh/docs/asf/>ASF</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsusers href=/zh/docs/users/>用户</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC在百度内部的应用</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baidu><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case1/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">百度地图api入口</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case1></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联盟DSP</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case3/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ELF学习框架</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case3></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case4/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云平台代理服务</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case4></li></ul></ul></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsfaq href=/zh/docs/faq/>FAQ</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">博客</a></li><ul><li class="collapse show" id=zhdocsblogs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">版本发布</a></li><ul><li class=collapse id=zhdocsblogsreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases130 href=/zh/docs/blogs/releases/1.3.0/>bRPC 1.3.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases120 href=/zh/docs/blogs/releases/1.2.0/>bRPC 1.2.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases110 href=/zh/docs/blogs/releases/1.1.0/>bRPC 1.1.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases100 href=/zh/docs/blogs/releases/1.0.0/>bRPC 1.0.0</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/shares/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">分享</a></li><ul><li class=collapse id=zhdocsblogsshares><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssharesbrpc-guide-for-beginners href=/zh/docs/blogs/shares/brpc-guide-for-beginners/>brpc初学者指南</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/sourcecodes/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">源码解析</a></li><ul><li class="collapse show" id=zhdocsblogssourcecodes><a class="td-sidebar-link td-sidebar-link__page active" id=m-zhdocsblogssourcecodesbthread href=/zh/docs/blogs/sourcecodes/bthread/>bRPC源码解析·bthread机制</a></li></ul></ul></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/brpc-website/edit/master/content/zh/docs/blogs/sourcecodes/bthread/index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/brpc-website/issues/new?title=bRPC%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90%c2%b7bthread%e6%9c%ba%e5%88%b6" target=_blank><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>
<a href=https://github.com/apache/brpc/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a></div><nav id=TableOfContents><ul><li><a href=#bthread简介>bthread简介</a></li><li><a href=#基础汇编知识>基础汇编知识</a><ul><li><a href=#att风格的汇编语言>AT&T风格的汇编语言</a></li><li><a href=#函数的调用约定>函数的调用约定</a></li><li><a href=#调用函数前>调用函数前</a></li><li><a href=#x86_64含有16个64为整数寄存器>x86_64含有16个64为整数寄存器</a></li></ul></li><li><a href=#协程栈的结构>协程栈的结构</a><ul><li><a href=#协程栈>协程栈</a></li><li><a href=#协程的初始化>协程的初始化</a></li><li><a href=#协程的切换部分>协程的切换部分</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/zh/zh/docs/>文档</a></li><li class=breadcrumb-item><a href=/zh/zh/docs/blogs/>博客</a></li><li class=breadcrumb-item><a href=/zh/zh/docs/blogs/sourcecodes/>源码解析</a></li><li class="breadcrumb-item active" aria-current=page><a href=/zh/zh/docs/blogs/sourcecodes/bthread/>bRPC源码解析·bthread机制</a></li></ol></nav><div class=td-content><h1>bRPC源码解析·bthread机制</h1><h2 id=bthread简介>bthread简介</h2><p>官方文档：https://brpc.apache.org/zh/docs/bthread/bthread/</p><p>bthread是bRPC使用的M:N线程库，类似协程，即用户态线程，也因此bthread的切换不会陷入内核，不会进行一系列内存同步等耗时操作，从bthread_benchmark中可以看到bthread的创建时间和调度时间相较pthread有着数量级的提升，将大量的bthread映射至少量的内核线程pthread上执行，降低内核上下文切换开销，在充分利用多核的同时，具有更好的cache locality。</p><p>为了实现协程需要协程栈、协程的初始化，以及协程间的切换，接下来逐一分析一下这几个过程。在分析之前需要首先补充一点汇编知识以方便我们阅读其中的汇编代码。</p><h2 id=基础汇编知识>基础汇编知识</h2><p>首先语法习惯，代码中的是AT&T风格的汇编语言，gdb看反汇编默认的风格也是AT&T。</p><h3 id=att风格的汇编语言>AT&T风格的汇编语言</h3><ul><li>立即数：$ 开头</li><li>寄存器：% 开头</li><li>取地址里面的值：偏移量(%寄存器）</li><li>整形操作通用后缀：[B] Byte、[W] Word 2Byte、[L] Long 4Byte、[Q] QuadWord 8Byte</li><li>浮点操作通用后缀：[S] Singled 4、[D] Double 8、[T] Extended 16（修饰精度: precision）</li></ul><h3 id=函数的调用约定>函数的调用约定</h3><ul><li>整型参数依次存放在 %rdi、%rsi、%rdx、%rcx、%8、%9</li><li>浮点参数依次存放在%xmm0 - %xmm7中</li><li>寄存器不够用时，参数放到栈中</li><li>被调用的函数可以使用任何寄存器，但它必须保证%rbx、%rbp、%rsp和%12-%15恢复到原来的值</li><li>返回值存放在%rax中</li></ul><h3 id=调用函数前>调用函数前</h3><ul><li>调用方要将参数放到寄存器中</li><li>然后把%10、%11的值保存到栈中</li><li>然后调用call 跳转到函数执行</li><li>返回后，恢复%10、%11</li><li>从%eax中取出返回值</li></ul><h3 id=x86_64含有16个64为整数寄存器>x86_64含有16个64为整数寄存器</h3><ul><li>%rsi、%rdi 用于字符串处理</li><li>%rsp、%rbp 栈相关，栈从高地址到低地址 %rsp&ndash;>栈顶，push和pop会改变 %rbp&ndash;>栈基址</li><li>%8 ~ %15</li></ul><table><thead><tr><th style=text-align:left>寄存器</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>// 创建部分</td><td></td></tr><tr><td style=text-align:left>%rax</td><td style=text-align:left>临时寄存器；参数可变时传递关于 SSE 寄存器用量的信息；第 1 个返回值寄存器</td></tr><tr><td style=text-align:left>%rdi</td><td style=text-align:left>用来给函数传递第 1 个参数</td></tr><tr><td style=text-align:left>%rsi</td><td style=text-align:left>用来给函数传递第 2 个参数</td></tr><tr><td style=text-align:left>%rdx</td><td style=text-align:left>用来给函数传递第 3 个整数参数</td></tr><tr><td style=text-align:left>%rcx</td><td style=text-align:left>用来给函数传递第 4个整数参数</td></tr><tr><td style=text-align:left>%rsp</td><td style=text-align:left>堆栈顶指针</td></tr><tr><td style=text-align:left>%rbp</td><td style=text-align:left>堆栈基指针</td></tr><tr><td style=text-align:left>%rip</td><td style=text-align:left>指令寄存器</td></tr><tr><td style=text-align:left>// 切换部分</td><td></td></tr><tr><td style=text-align:left>%rbx</td><td style=text-align:left>被调者保存的寄存器；或用作基指针</td></tr><tr><td style=text-align:left>%r12-%r15</td><td style=text-align:left>被调者保存的寄存器</td></tr></tbody></table><h2 id=协程栈的结构>协程栈的结构</h2><h3 id=协程栈>协程栈</h3><p>首先看下协程栈的结构：context指向协程栈顶，stacktype表示栈的类型(大小)，storage为栈空间。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/* bthread/bthread/stack.h */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ContextualStack</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bthread_fcontext_t</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>StackType</span> <span style=color:#000>stacktype</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>StackStorage</span> <span style=color:#000>storage</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>StackType</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STACK_TYPE_MAIN</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STACK_TYPE_PTHREAD</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BTHREAD_STACKTYPE_PTHREAD</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STACK_TYPE_SMALL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BTHREAD_STACKTYPE_SMALL</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STACK_TYPE_NORMAL</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BTHREAD_STACKTYPE_NORMAL</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>STACK_TYPE_LARGE</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>BTHREAD_STACKTYPE_LARGE</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>StackStorage</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>stacksize</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>guardsize</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Assume stack grows upwards.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// http://www.boost.org/doc/libs/1_55_0/libs/context/doc/html/context/stack.html
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>bottom</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#000>valgrind_stack_id</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Clears all members.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>zeroize</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>stacksize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>guardsize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>bottom</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>valgrind_stack_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><h3 id=协程的初始化>协程的初始化</h3><p>栈分配时（allocate_stack_storage(StackStorage* s, int stacksize_in, int guardsize_in)）会通过mmap匿名映射一段空间，然后将高地址位赋值给bottom。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/* bthread/bthread/stack_inl.h */</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>template</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>typename</span> <span style=color:#000>StackClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>StackFactory</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Wrapper</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ContextualStack</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>explicit</span> <span style=color:#000>Wrapper</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>entry</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>intptr_t</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>allocate_stack_storage</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>storage</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>StackClass</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>stack_size_flag</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                       <span style=color:#000>FLAGS_guard_page_size</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>storage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>zeroize</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>                <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>然后创建bthread协程栈，返回值为协程栈顶context，函数入参分别为协程栈底，栈大小，以及这个bthread要执行的函数entry。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>            <span style=color:#000>context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bthread_make_fcontext</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>storage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>bottom</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>storage</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>stacksize</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>entry</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>stacktype</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>StackType</span><span style=color:#000;font-weight:700>)</span><span style=color:#000>StackClass</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>stacktype</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#if defined(BTHREAD_CONTEXT_PLATFORM_linux_x86_64) &amp;&amp; defined(BTHREAD_CONTEXT_COMPILER_gcc)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>__asm</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.text</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.globl bthread_make_fcontext</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.type bthread_make_fcontext,@function</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.align 16</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;bthread_make_fcontext:</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    movq  %rdi, %rax</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    andq  $-16, %rax</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    leaq  -0x48(%rax), %rax</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    movq  %rdx, 0x38(%rax)</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    stmxcsr  (%rax)</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    fnstcw   0x4(%rax)</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    leaq  finish(%rip), %rcx</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    movq  %rcx, 0x40(%rax)</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    ret </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;finish:</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    xorq  %rdi, %rdi</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    call  _exit@PLT</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    hlt</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.size bthread_make_fcontext,.-bthread_make_fcontext</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.section .note.GNU-stack,</span><span style=color:#4e9a06>\&#34;\&#34;</span><span style=color:#4e9a06>,%progbits</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#endif
</span></span></span></code></pre></div><h4 id=代码中的汇编指令解释>代码中的汇编指令解释</h4><p>MXCSR状态管理指令（State Management Instructions），LDMXCSR与STMXCSR，用于控制MXCSR寄存器状态。</p><ul><li>LDMXCSR指令从存储器中加载MXCSR寄存器状态</li><li>STMXCSR指令将MXCSR寄存器状态保存到存储器中</li></ul><table><thead><tr><th style=text-align:left>汇编指令</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>movq %rdi, %rax</td><td style=text-align:left>&ldquo;movq&rdquo; is a move of a quadword (64-bit value)，copy %src %dst，将第一个参数‘storage.bottom’拷贝到%rax寄存器</td></tr><tr><td style=text-align:left>andq $-16, %rax</td><td style=text-align:left>与&操作，将%rax的值，即高位地址‘bottom’ & -16（补码:0xfffffff0），将地址取为16的整数倍，进行16字节对齐。</td></tr><tr><td style=text-align:left>leaq -0x48(%rax), %rax</td><td style=text-align:left>leaq 取64位地址指令，将%rax中保存的高位地址向下偏移72个字节后，再保存到%rax寄存器，即留出 0x48 个字节用于存放上下文 Context Data</td></tr><tr><td style=text-align:left>movq %rdx, 0x38(%rax)</td><td style=text-align:left>将rdx保存至rax + 56，rdx为第三个参数，即函数fn的入口地址entry</td></tr><tr><td style=text-align:left>stmxcsr (%rax)</td><td style=text-align:left>存储 MMX 控制字和状态字，将MXCSR寄存器状态保存到rax所在位置</td></tr><tr><td style=text-align:left>fnstcw 0x4(%rax)</td><td style=text-align:left>存储 x87 控制字，将 FPU 控制字的当前值存储到%rax + 4</td></tr><tr><td style=text-align:left>leaq finish(%rip), %rcx</td><td style=text-align:left>计算finish标志的绝对地址，将其保存至%rcx寄存器中</td></tr><tr><td style=text-align:left>movq %rcx, 0x40(%rax)</td><td style=text-align:left>将rcx保存到rax + 64，finish刚好位于启动函数上方 &mdash;> 启动函数执行完以后就会执行finish处的代码，而finish会call _exit结束进程。</td></tr><tr><td style=text-align:left>ret</td><td style=text-align:left>rax就是上述的基点（栈顶），返回的类型为fcontext_t</td></tr><tr><td style=text-align:left>finish:</td><td></td></tr><tr><td style=text-align:left>xorq %rdi, %rdi</td><td style=text-align:left>退出码是0</td></tr><tr><td style=text-align:left>call _exit@PLT</td><td style=text-align:left>call _exit结束进程</td></tr></tbody></table><p>初始化过程可由下图直观表示：
<img src=/images/docs/bthread_make_fcontext.png alt=bthread_make_fcontext></p><h3 id=协程的切换部分>协程的切换部分</h3><p>实现协程上下文切换有很多种方法，本质要做的都是保存和恢复寄存器和栈信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>inline</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>jump_stack</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ContextualStack</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>from</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ContextualStack</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>to</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bthread_jump_fcontext</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>from</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>to</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#8f5902;font-style:italic>/*not skip remained*/</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>调用时会将当前的上下文保存到ofc中，并切换到目标上下文nfc进行执行</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>intptr_t</span> <span style=color:#000>BTHREAD_CONTEXT_CALL_CONVENTION</span>
</span></span><span style=display:flex><span><span style=color:#000>bthread_jump_fcontext</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_fcontext_t</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ofc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bthread_fcontext_t</span> <span style=color:#000>nfc</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#000>intptr_t</span> <span style=color:#000>vp</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>preserve_fpu</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>false</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#if defined(BTHREAD_CONTEXT_PLATFORM_linux_x86_64) &amp;&amp; defined(BTHREAD_CONTEXT_COMPILER_gcc)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>__asm</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.text</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.globl bthread_jump_fcontext</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.type bthread_jump_fcontext,@function</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.align 16</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;bthread_jump_fcontext:</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    pushq  %rbp  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    pushq  %rbx  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    pushq  %r15  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    pushq  %r14  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    pushq  %r13  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    pushq  %r12  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    leaq  -0x8(%rsp), %rsp</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    cmp  $0, %rcx</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    je  1f</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    stmxcsr  (%rsp)</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    fnstcw   0x4(%rsp)</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;1:</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    movq  %rsp, (%rdi)</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    movq  %rsi, %rsp</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    cmp  $0, %rcx</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    je  2f</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    ldmxcsr  (%rsp)</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    fldcw  0x4(%rsp)</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;2:</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    leaq  0x8(%rsp), %rsp</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    popq  %r12  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    popq  %r13  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    popq  %r14  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    popq  %r15  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    popq  %rbx  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    popq  %rbp  </span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    popq  %r8</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    movq  %rdx, %rax</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    movq  %rdx, %rdi</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;    jmp  *%r8</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.size bthread_jump_fcontext,.-bthread_jump_fcontext</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>&#34;.section .note.GNU-stack,</span><span style=color:#4e9a06>\&#34;\&#34;</span><span style=color:#4e9a06>,%progbits</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#endif
</span></span></span></code></pre></div><h4 id=代码中的汇编指令解释-1>代码中的汇编指令解释</h4><table><thead><tr><th style=text-align:left>汇编指令</th><th style=text-align:left>解释</th></tr></thead><tbody><tr><td style=text-align:left>pushq %rbp</td><td style=text-align:left>将寄存器rbp-r12依此push到当前协程栈中保存</td></tr><tr><td style=text-align:left>pushq %rbx</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>pushq %r15</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>pushq %r14</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>pushq %r13</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>pushq %r12</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>leaq -0x8(%rsp), %rsp</td><td style=text-align:left>rsp栈顶下移8字节 &mdash;>prepare stack for FPU 浮点运算寄存器</td></tr><tr><td style=text-align:left>cmp $0, %rcx</td><td style=text-align:left>比较rcx和0，因为rcx为0，所以zf为1，rcx：第四个参数 preserve_fpu</td></tr><tr><td style=text-align:left>je 1f</td><td style=text-align:left>因为zf为1，所以跳转</td></tr><tr><td style=text-align:left>stmxcsr (%rsp)</td><td style=text-align:left>存储 MMX 控制字和状态字，将MXCSR寄存器状态保存到rsp所在位置</td></tr><tr><td style=text-align:left>fnstcw 0x4(%rsp)</td><td style=text-align:left>存储 x87 控制字，将 FPU 控制字的当前值存储到rsp + 4</td></tr><tr><td style=text-align:left>1f:</td><td></td></tr><tr><td style=text-align:left>movq %rsp, (%rdi)</td><td style=text-align:left>将rsp保存至rdi中，rsp指向当前协程栈栈顶（原上下文），rdi为第一个入参，即ofc</td></tr><tr><td style=text-align:left>movq %rsi, %rsp</td><td style=text-align:left>将rsi保存到rsp中，rsi为第二个参数，即nfc（目标上下文），此时栈顶指针rsp指向了新的协程栈</td></tr><tr><td style=text-align:left>cmp $0, %rcx</td><td style=text-align:left>比较rcx和0，因为rcx为0，所以zf为1</td></tr><tr><td style=text-align:left>je 2f</td><td style=text-align:left>因为zf为1，所以跳转</td></tr><tr><td style=text-align:left>ldmxcsr (%rsp)</td><td></td></tr><tr><td style=text-align:left>fldcw 0x4(%rsp)</td><td></td></tr><tr><td style=text-align:left>2f:</td><td></td></tr><tr><td style=text-align:left>leaq 0x8(%rsp), %rsp\n"</td><td style=text-align:left>将rsp上移8字节</td></tr><tr><td style=text-align:left>popq %r12</td><td style=text-align:left>将协程栈中r12-rbp依次pop到对应寄存器</td></tr><tr><td style=text-align:left>popq %r13</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>popq %r14</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>popq %r15</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>popq %rbx</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>popq %rbp</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>popq %r8</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>movq %rdx, %rax</td><td style=text-align:left>将rdx保存到rax，rdx为第三个参数，rax为返回值</td></tr><tr><td style=text-align:left>movq %rdx, %rdi</td><td style=text-align:left>将rdx保存到rdi，rdi为第一个入参，因此将作为新协程运行的入参</td></tr><tr><td style=text-align:left>jmp *%r8</td><td style=text-align:left>跳转到r8对应的寄存器运行</td></tr></tbody></table><p>在协程切换过程中有两种情况，第一种为新协程是通过bthread_make_fcontext函数刚刚创建的栈，另一种是已经运行过的栈，这两种过程分别如下图所示：
<img src=/images/docs/bthread_jump_fcontext.png alt=bthread_jump_fcontext></p><p>参考资料</p><ol><li><a href=https://zhuanlan.zhihu.com/p/148314164>https://zhuanlan.zhihu.com/p/148314164</a></li><li><a href=http://jinke.me/2018-09-14-coroutine-context-switch/>http://jinke.me/2018-09-14-coroutine-context-switch/</a></li><li><a href=http://cons.mit.edu/fa18/x86-64-architecture-guide.html>http://cons.mit.edu/fa18/x86-64-architecture-guide.html</a></li><li><a href=https://blog.csdn.net/thisinnocence/article/details/50936470>https://blog.csdn.net/thisinnocence/article/details/50936470</a></li></ol><div class="text-muted mt-5 pt-3 border-top">修改于 2023年2月1日: <a href=https://github.com/apache/brpc-website/commit/1ef55ec51f01406f450a4b37acdcd9924be1f250>add eyou case (#130) (1ef55ec)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none" style=display:flex;align-items:center;padding:0!important><div class="container-fluid mx-sm-5"><div class=row style=display:flex;align-items:center><div class="col-12 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/apache/brpc><i class="fab fa-github"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. 保留所有权利</small><div style=font-size:12.8px;color:#757474><a href=https://www.apache.org/ target=_blank rel=noopener>Foundation</a> |
<a href=https://www.apache.org/licenses/ target=_blank rel=noopener>License</a> |
<a href=https://www.apache.org/security/ target=_blank rel=noopener>Security</a> |
<a href=https://www.apache.org/events/current-event target=_blank rel=noopener>Events</a> |
<a href=https://www.apache.org/foundation/sponsorship.html target=_blank rel=noopener>Sponsorship</a> |
<a href=https://privacy.apache.org/policies/privacy-policy-public.html target=_blank rel=noopener>Privacy</a> |
<a href=https://www.apache.org/foundation/thanks.html target=_blank rel=noopener>Thanks</a></div></div></div></div></footer></div><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.17eb741170760e55f21de7c8e3570aa65d5fafd190c4b2798a7322a493948738.js integrity="sha256-F+t0EXB2DlXyHefI41cKpl1fr9GQxLJ5inMipJOUhzg=" crossorigin=anonymous></script></body></html>