<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>bRPC源码解析·butex机制 | bRPC</title><meta property="og:title" content="bRPC源码解析·butex机制"><meta property="og:description" content="(作者简介：KIDGINBROOK，在昆仑芯参与训练框架开发工作)
背景 由于brpc中引入了bthread，如果在bthread中使用了mutex等pthread同步原语，那么将会挂起当前pthread，导致该bthread_worker（pthread）将无法执行其他bthread，因此类似pthread和futex的关系，brpc引入butex来实现bthread粒度的挂起和唤醒以提高性能。
实现思路 类比futex，futex主要由两部分组成，一个是用户态中的标记（是一个int），另一个是内核态中的等待队列，当执行futex_wait的时候，首先尝试原子修改标记，如果没有竞争的话，整个流程将不会进入内核态；如果有其他线程占用了futex，那么会将当前线程加入到内核等待队列。
实现细节 主要数据结构 Butex struct BAIDU_CACHELINE_ALIGNMENT Butex { Butex() {} ~Butex() {} butil::atomic<int> value; ButexWaiterList waiters; internal::FastPthreadMutex waiter_lock; }; Butex的实现类似futex。value即上述的标记，表示当前Butex的状态，ButexWaiterList是一个链表，保存了在该butex上挂起的bthread或pthread。 waiter_lock即上述的锁。因为butex_wait时会比较atomic是否为expect_value，如果相等，那么将会挂起当前bthread至等待队列。如果判断是否相等和挂起这两个操作不在同一个临界区，那么有可能在判断之后但是挂起前已经执行过了butex_wake，将出现信号丢失问题，因此这里需要使用互斥锁。
ButexWaiter struct ButexWaiter : public butil::LinkNode<ButexWaiter> { // tids of pthreads are 0 bthread_t tid; // Erasing node from middle of LinkedList is thread-unsafe, we need // to hold its container's lock. butil::atomic<Butex*> container; }; typedef butil::LinkedList<ButexWaiter> ButexWaiterList; struct ButexBthreadWaiter : public ButexWaiter { TaskMeta* task_meta; TimerThread::TaskId sleep_id; WaiterState waiter_state; int expected_value; Butex* initial_butex; TaskControl* control; const timespec* abstime; }; // pthread_task or main_task allocates this structure on stack and queue it // in Butex::waiters."><meta property="og:type" content="article"><meta property="og:url" content="https://brpc.apache.org/zh/docs/blogs/sourcecodes/butex/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2023-03-14T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-06T23:12:46+08:00"><meta property="og:site_name" content="bRPC"><meta itemprop=name content="bRPC源码解析·butex机制"><meta itemprop=description content="(作者简介：KIDGINBROOK，在昆仑芯参与训练框架开发工作)
背景 由于brpc中引入了bthread，如果在bthread中使用了mutex等pthread同步原语，那么将会挂起当前pthread，导致该bthread_worker（pthread）将无法执行其他bthread，因此类似pthread和futex的关系，brpc引入butex来实现bthread粒度的挂起和唤醒以提高性能。
实现思路 类比futex，futex主要由两部分组成，一个是用户态中的标记（是一个int），另一个是内核态中的等待队列，当执行futex_wait的时候，首先尝试原子修改标记，如果没有竞争的话，整个流程将不会进入内核态；如果有其他线程占用了futex，那么会将当前线程加入到内核等待队列。
实现细节 主要数据结构 Butex struct BAIDU_CACHELINE_ALIGNMENT Butex { Butex() {} ~Butex() {} butil::atomic<int> value; ButexWaiterList waiters; internal::FastPthreadMutex waiter_lock; }; Butex的实现类似futex。value即上述的标记，表示当前Butex的状态，ButexWaiterList是一个链表，保存了在该butex上挂起的bthread或pthread。 waiter_lock即上述的锁。因为butex_wait时会比较atomic是否为expect_value，如果相等，那么将会挂起当前bthread至等待队列。如果判断是否相等和挂起这两个操作不在同一个临界区，那么有可能在判断之后但是挂起前已经执行过了butex_wake，将出现信号丢失问题，因此这里需要使用互斥锁。
ButexWaiter struct ButexWaiter : public butil::LinkNode<ButexWaiter> { // tids of pthreads are 0 bthread_t tid; // Erasing node from middle of LinkedList is thread-unsafe, we need // to hold its container's lock. butil::atomic<Butex*> container; }; typedef butil::LinkedList<ButexWaiter> ButexWaiterList; struct ButexBthreadWaiter : public ButexWaiter { TaskMeta* task_meta; TimerThread::TaskId sleep_id; WaiterState waiter_state; int expected_value; Butex* initial_butex; TaskControl* control; const timespec* abstime; }; // pthread_task or main_task allocates this structure on stack and queue it // in Butex::waiters."><meta itemprop=datePublished content="2023-03-14T00:00:00+00:00"><meta itemprop=dateModified content="2023-04-06T23:12:46+08:00"><meta itemprop=wordCount content="575"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="bRPC源码解析·butex机制"><meta name=twitter:description content="(作者简介：KIDGINBROOK，在昆仑芯参与训练框架开发工作)
背景 由于brpc中引入了bthread，如果在bthread中使用了mutex等pthread同步原语，那么将会挂起当前pthread，导致该bthread_worker（pthread）将无法执行其他bthread，因此类似pthread和futex的关系，brpc引入butex来实现bthread粒度的挂起和唤醒以提高性能。
实现思路 类比futex，futex主要由两部分组成，一个是用户态中的标记（是一个int），另一个是内核态中的等待队列，当执行futex_wait的时候，首先尝试原子修改标记，如果没有竞争的话，整个流程将不会进入内核态；如果有其他线程占用了futex，那么会将当前线程加入到内核等待队列。
实现细节 主要数据结构 Butex struct BAIDU_CACHELINE_ALIGNMENT Butex { Butex() {} ~Butex() {} butil::atomic<int> value; ButexWaiterList waiters; internal::FastPthreadMutex waiter_lock; }; Butex的实现类似futex。value即上述的标记，表示当前Butex的状态，ButexWaiterList是一个链表，保存了在该butex上挂起的bthread或pthread。 waiter_lock即上述的锁。因为butex_wait时会比较atomic是否为expect_value，如果相等，那么将会挂起当前bthread至等待队列。如果判断是否相等和挂起这两个操作不在同一个临界区，那么有可能在判断之后但是挂起前已经执行过了butex_wake，将出现信号丢失问题，因此这里需要使用互斥锁。
ButexWaiter struct ButexWaiter : public butil::LinkNode<ButexWaiter> { // tids of pthreads are 0 bthread_t tid; // Erasing node from middle of LinkedList is thread-unsafe, we need // to hold its container's lock. butil::atomic<Butex*> container; }; typedef butil::LinkedList<ButexWaiter> ButexWaiterList; struct ButexBthreadWaiter : public ButexWaiter { TaskMeta* task_meta; TimerThread::TaskId sleep_id; WaiterState waiter_state; int expected_value; Butex* initial_butex; TaskControl* control; const timespec* abstime; }; // pthread_task or main_task allocates this structure on stack and queue it // in Butex::waiters."><link rel=preload href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css as=style><link href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css rel=stylesheet integrity><script src=/js/jquery-3.3.1.min.js></script><title>bRPC源码解析·butex机制 | bRPC</title></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/zh/><span class=navbar-logo><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/apache/brpc/ target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/downloadbrpc/><span>下载</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/docs/><span class=active>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/community/community/><span>社区</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/asf/><span>ASF</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/docs/blogs/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/users/><span>用户</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a></li><ul><li class="collapse show" id=zhdocs><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsoverview href=/zh/docs/overview/>简介</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsdownloadbrpc href=/zh/docs/downloadbrpc/>下载</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsgetting_started href=/zh/docs/getting_started/>开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsbenchmark href=/zh/docs/benchmark/>性能基准</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvar><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvarbvar></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar c++</a></li><ul><li class=collapse id=zhdocsbvarbvar-c></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/mbvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">mbvar c++</a></li><ul><li class=collapse id=zhdocsbvarmbvar-c></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthread><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthreadbthread></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread-or-not/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread or not</a></li><ul><li class=collapse id=zhdocsbthreadbthread-or-not></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/execution-queue/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Execution Queue</a></li><ul><li class=collapse id=zhdocsbthreadexecution-queue></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/thread-local/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">thread-local</a></li><ul><li class=collapse id=zhdocsbthreadthread-local></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">C++基础</a></li><ul><li class=collapse id=zhdocsc-base><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/iobuf/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IOBuf</a></li><ul><li class=collapse id=zhdocsc-baseiobuf></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/streaming-log/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming Log</a></li><ul><li class=collapse id=zhdocsc-basestreaming-log></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/flatmap/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FlatMap</a></li><ul><li class=collapse id=zhdocsc-baseflatmap></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/brpc-training-materials/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC培训材料</a></li><ul><li class=collapse id=zhdocsc-basebrpc-training-materials></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">客户端</a></li><ul><li class=collapse id=zhdocsclient><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsclientbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/error-code/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">错误码</a></li><ul><li class=collapse id=zhdocsclienterror-code></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/combo-channels/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">组合channels</a></li><ul><li class=collapse id=zhdocsclientcombo-channels></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问http:h2</a></li><ul><li class=collapse id=zhdocsclientaccess-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问gRPC</a></li><ul><li class=collapse id=zhdocsclientaccess-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问thrift</a></li><ul><li class=collapse id=zhdocsclientaccess-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-ub/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问UB</a></li><ul><li class=collapse id=zhdocsclientaccess-ub></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-redis/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问redis</a></li><ul><li class=collapse id=zhdocsclientaccess-redis></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-memcached/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问memcached</a></li><ul><li class=collapse id=zhdocsclientaccess-memcached></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/streaming-rpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流式RPC</a></li><ul><li class=collapse id=zhdocsclientstreaming-rpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/backup-request/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Backup request</a></li><ul><li class=collapse id=zhdocsclientbackup-request></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/dummy-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dummy server</a></li><ul><li class=collapse id=zhdocsclientdummy-server></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">服务端</a></li><ul><li class=collapse id=zhdocsserver><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsserverbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建http:h2服务</a></li><ul><li class=collapse id=zhdocsserverserve-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建gRPC服务</a></li><ul><li class=collapse id=zhdocsserverserve-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建thrift服务</a></li><ul><li class=collapse id=zhdocsserverserve-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-nshead/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建Nshead服务</a></li><ul><li class=collapse id=zhdocsserverserve-nshead></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/server-push/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">推送</a></li><ul><li class=collapse id=zhdocsserverserver-push></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/debug-server-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">高效率排查server卡顿</a></li><ul><li class=collapse id=zhdocsserverdebug-server-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/avalanche/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">雪崩</a></li><ul><li class=collapse id=zhdocsserveravalanche></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/auto-concurrencylimiter/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">自适应限流</a></li><ul><li class=collapse id=zhdocsserverauto-concurrencylimiter></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/media-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流媒体服务</a></li><ul><li class=collapse id=zhdocsservermedia-server></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/json2pb/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">json2pb</a></li><ul><li class=collapse id=zhdocsserverjson2pb></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内置服务</a></li><ul><li class=collapse id=zhdocsbuiltin-services><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/buildin_services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">builtin services</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesbuildin_services></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/status/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">status</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesstatus></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/vars/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">vars</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesvars></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/connections/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">connections</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesconnections></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/flags/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">flags</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesflags></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/rpcz/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpcz</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesrpcz></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/cpu_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">cpu profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescpu_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/heap_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">heap profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesheap_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/contention_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">contention profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescontention_profiler></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">工具</a></li><ul><li class=collapse id=zhdocstools><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_press/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_press</a></li><ul><li class=collapse id=zhdocstoolsrpc_press></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_replay/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_replay</a></li><ul><li class=collapse id=zhdocstoolsrpc_replay></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_view/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_view</a></li><ul><li class=collapse id=zhdocstoolsrpc_view></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/benchmark_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">benchmark_http</a></li><ul><li class=collapse id=zhdocstoolsbenchmark_http></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/parallel_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">parallel_http</a></li><ul><li class=collapse id=zhdocstoolsparallel_http></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">深入RPC</a></li><ul><li class=collapse id=zhdocsrpc-in-depth><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/new-protocol/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">支持新协议</a></li><ul><li class=collapse id=zhdocsrpc-in-depthnew-protocol></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/atomic-instructions/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">原子指令</a></li><ul><li class=collapse id=zhdocsrpc-in-depthatomic-instructions></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/io/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IO</a></li><ul><li class=collapse id=zhdocsrpc-in-depthio></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/threading-overview/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">线程模型简介</a></li><ul><li class=collapse id=zhdocsrpc-in-depththreading-overview></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/load-balancing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">负载均衡</a></li><ul><li class=collapse id=zhdocsrpc-in-depthload-balancing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/locality-aware/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Locality-aware</a></li><ul><li class=collapse id=zhdocsrpc-in-depthlocality-aware></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/consistent-hashing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">一致性哈希</a></li><ul><li class=collapse id=zhdocsrpc-in-depthconsistent-hashing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/memory-management/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内存管理</a></li><ul><li class=collapse id=zhdocsrpc-in-depthmemory-management></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/timer-keeping/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Timer keeping</a></li><ul><li class=collapse id=zhdocsrpc-in-depthtimer-keeping></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/bthread_id/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread_id</a></li><ul><li class=collapse id=zhdocsrpc-in-depthbthread_id></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/community/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">社区</a></li><ul><li class=collapse id=zhdocscommunity><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommunity href=/zh/docs/community/community/>社区</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitymailing_list href=/zh/docs/community/mailing_list/>邮件列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycontributing href=/zh/docs/community/contributing/>Contribute指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitter href=/zh/docs/community/committer/>Committer指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunityrelease href=/zh/docs/community/release/>Release指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitters href=/zh/docs/community/committers/>贡献者列表</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/community/security/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">安全</a></li><ul><li class=collapse id=zhdocscommunitysecurity><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitysecuritycve-2023-31039-bugfix href=/zh/docs/community/security/cve-2023-31039-bugfix/>CVE-2023-31039漏洞修复</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitymonthly-meeting href=/zh/docs/community/monthly-meeting/>月度会</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunityon-call href=/zh/docs/community/on-call/>值班表</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsasf href=/zh/docs/asf/>ASF</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsusers href=/zh/docs/users/>用户</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC在百度内部的应用</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baidu><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case1/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">百度地图api入口</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case1></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联盟DSP</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case3/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ELF学习框架</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case3></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case4/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云平台代理服务</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case4></li></ul></ul></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsfaq href=/zh/docs/faq/>FAQ</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">博客</a></li><ul><li class="collapse show" id=zhdocsblogs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">版本发布</a></li><ul><li class=collapse id=zhdocsblogsreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases150 href=/zh/docs/blogs/releases/1.5.0/>bRPC 1.5.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases140 href=/zh/docs/blogs/releases/1.4.0/>bRPC 1.4.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases130 href=/zh/docs/blogs/releases/1.3.0/>bRPC 1.3.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases120 href=/zh/docs/blogs/releases/1.2.0/>bRPC 1.2.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases110 href=/zh/docs/blogs/releases/1.1.0/>bRPC 1.1.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases100 href=/zh/docs/blogs/releases/1.0.0/>bRPC 1.0.0</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/shares/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">分享</a></li><ul><li class=collapse id=zhdocsblogsshares><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssharesbrpc-guide-for-beginners href=/zh/docs/blogs/shares/brpc-guide-for-beginners/>brpc初学者指南</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/sourcecodes/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">源码解析</a></li><ul><li class="collapse show" id=zhdocsblogssourcecodes><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesbthread href=/zh/docs/blogs/sourcecodes/bthread/>bRPC源码解析·bthread机制</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesexecution_queue href=/zh/docs/blogs/sourcecodes/execution_queue/>bRPC源码解析·ExecutionQueue</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesiobuf href=/zh/docs/blogs/sourcecodes/iobuf/>bRPC源码解析·IOBuf</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesbthread_schedule href=/zh/docs/blogs/sourcecodes/bthread_schedule/>bRPC源码解析·bthread调度执行流程</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodeswork_stealing_queue href=/zh/docs/blogs/sourcecodes/work_stealing_queue/>bRPC源码解析·work_stealing_queue</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-zhdocsblogssourcecodesbutex href=/zh/docs/blogs/sourcecodes/butex/>bRPC源码解析·butex机制</a></li></ul></ul></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/brpc-website/edit/master/content/zh/docs/blogs/sourcecodes/butex/index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/brpc-website/issues/new?title=bRPC%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90%c2%b7butex%e6%9c%ba%e5%88%b6" target=_blank><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>
<a href=https://github.com/apache/brpc/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a></div><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#实现思路>实现思路</a></li><li><a href=#实现细节>实现细节</a><ul><li><a href=#主要数据结构>主要数据结构</a></li><li><a href=#主要接口>主要接口</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/zh/zh/docs/>文档</a></li><li class=breadcrumb-item><a href=/zh/zh/docs/blogs/>博客</a></li><li class=breadcrumb-item><a href=/zh/zh/docs/blogs/sourcecodes/>源码解析</a></li><li class="breadcrumb-item active" aria-current=page><a href=/zh/zh/docs/blogs/sourcecodes/butex/>bRPC源码解析·butex机制</a></li></ol></nav><div class=td-content><h1>bRPC源码解析·butex机制</h1><p>(作者简介：KIDGINBROOK，在昆仑芯参与训练框架开发工作)</p><h2 id=背景>背景</h2><p>由于brpc中引入了bthread，如果在bthread中使用了mutex等pthread同步原语，那么将会挂起当前pthread，导致该bthread_worker（pthread）将无法执行其他bthread，因此类似pthread和futex的关系，brpc引入butex来实现bthread粒度的挂起和唤醒以提高性能。</p><h2 id=实现思路>实现思路</h2><p>类比futex，futex主要由两部分组成，一个是用户态中的标记（是一个int），另一个是内核态中的等待队列，当执行futex_wait的时候，首先尝试原子修改标记，如果没有竞争的话，整个流程将不会进入内核态；如果有其他线程占用了futex，那么会将当前线程加入到内核等待队列。</p><h2 id=实现细节>实现细节</h2><h3 id=主要数据结构>主要数据结构</h3><h4 id=butex>Butex</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>BAIDU_CACHELINE_ALIGNMENT</span> <span style=color:#000>Butex</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Butex</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>Butex</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ButexWaiterList</span> <span style=color:#000>waiters</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>internal</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>FastPthreadMutex</span> <span style=color:#000>waiter_lock</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>Butex的实现类似futex。value即上述的标记，表示当前Butex的状态，ButexWaiterList是一个链表，保存了在该butex上挂起的bthread或pthread。
waiter_lock即上述的锁。因为butex_wait时会比较atomic是否为expect_value，如果相等，那么将会挂起当前bthread至等待队列。如果判断是否相等和挂起这两个操作不在同一个临界区，那么有可能在判断之后但是挂起前已经执行过了butex_wake，将出现信号丢失问题，因此这里需要使用互斥锁。</p><h4 id=butexwaiter>ButexWaiter</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ButexWaiter</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>LinkNode</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ButexWaiter</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// tids of pthreads are 0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bthread_t</span> <span style=color:#000>tid</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Erasing node from middle of LinkedList is thread-unsafe, we need
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// to hold its container&#39;s lock.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Butex</span><span style=color:#ce5c00;font-weight:700>*&gt;</span> <span style=color:#000>container</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>typedef</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>LinkedList</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ButexWaiter</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>ButexWaiterList</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ButexBthreadWaiter</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ButexWaiter</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TaskMeta</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>task_meta</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimerThread</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>TaskId</span> <span style=color:#000>sleep_id</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>WaiterState</span> <span style=color:#000>waiter_state</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>expected_value</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Butex</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>initial_butex</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TaskControl</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>control</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>timespec</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>abstime</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// pthread_task or main_task allocates this structure on stack and queue it
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in Butex::waiters.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ButexPthreadWaiter</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>ButexWaiter</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sig</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>Butex的等待队列为一个链表，链表的元素为ButexWaiter，由于Butex需要兼容pthread，因此有ButexBthreadWaiter和ButexPthreadWaiter两种waiter，后续通过bthread的逻辑介绍Butex。</p><h4 id=fastpthreadmutex>FastPthreadMutex</h4><p>如果不开启编译选项BTHREAD_USE_FAST_PTHREAD_MUTEX，那么FastPthreadMutex就是pthread_mutex_t，否则为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FastPthreadMutex</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>FastPthreadMutex</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>_futex</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>FastPthreadMutex</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>lock</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>unlock</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>try_lock</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>DISALLOW_COPY_AND_ASSIGN</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>FastPthreadMutex</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>lock_contended</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#000>_futex</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>这里基于futex实现了互斥锁，_futex表示锁的状态，从这里可以看到futex的用法，通过Butex实现bthread_mutex也是类似的逻辑。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>MutexInternal</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>static_atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>locked</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>static_atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>contended</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#204a87;font-weight:700>short</span> <span style=color:#000>padding</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>MutexInternal</span> <span style=color:#000>MUTEX_CONTENDED_RAW</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>},{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>},</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>MutexInternal</span> <span style=color:#000>MUTEX_LOCKED_RAW</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>},{</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>},</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Define as macros rather than constants which can&#39;t be put in read-only
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// section and affected by initialization-order fiasco.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic>#define BTHREAD_MUTEX_CONTENDED (*(const unsigned*)&amp;bthread::MUTEX_CONTENDED_RAW)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#define BTHREAD_MUTEX_LOCKED (*(const unsigned*)&amp;bthread::MUTEX_LOCKED_RAW)
</span></span></span></code></pre></div><p>FastPthreadMutex用MutexInternal表示一个锁的状态，如果锁没有人占用，那么locked和contended均为0，如果有一个线程占用了这个锁，那么locked为1，contended为0，如果这个时候又有线程来尝试占用锁，那么locked为1，contended为1，后边来的线程都会在这个锁上wait。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>FastPthreadMutex</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>lock</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bthread</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>MutexInternal</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>split</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>MutexInternal</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>_futex</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>split</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>locked</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>exchange</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_acquire</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#000;font-weight:700>)</span><span style=color:#000>lock_contended</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>lock的过程首先尝试首先尝试修改locked这个atomic，如果发现锁没被占用（locked为0），那么直接返回，否则调用lock_contended方法。注意这里使用了memory_order_acquire的memory order，和unlock中的release形成syncwith关系，保证了当前线程获得锁之后能看到上个线程在释放锁之前对内存的修改。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>FastPthreadMutex</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>lock_contended</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>unsigned</span><span style=color:#ce5c00;font-weight:700>&gt;*</span> <span style=color:#000>whole</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>unsigned</span><span style=color:#ce5c00;font-weight:700>&gt;*</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>_futex</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>whole</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>exchange</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>BTHREAD_MUTEX_CONTENDED</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>BTHREAD_MUTEX_LOCKED</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>futex_wait_private</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>whole</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>BTHREAD_MUTEX_CONTENDED</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>            <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>errno</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>EWOULDBLOCK</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>errno</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>这里将锁的状态MutexInternal原子修改为BTHREAD_MUTEX_CONTENDED，如果锁仍被占用着，那么通过系统调用futex_wait_private将当前线程挂起到whole这个atomic对应的队列中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>FastPthreadMutex</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>unlock</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>unsigned</span><span style=color:#ce5c00;font-weight:700>&gt;*</span> <span style=color:#000>whole</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>unsigned</span><span style=color:#ce5c00;font-weight:700>&gt;*</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>_futex</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>unsigned</span> <span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>whole</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>exchange</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_release</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// CAUTION: the mutex may be destroyed, check comments before butex_create
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>prev</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>BTHREAD_MUTEX_LOCKED</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>futex_wake_private</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>whole</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>unlock方法将锁的状态原子改为0，如果之前的状态不是BTHREAD_MUTEX_LOCKED，那说明有线程阻塞在了这个锁上，因此需要通过futex_wake_private唤醒whole对应等待队列中的一个pthread，如上所述，这里使用release保证当前线程对内存的修改能被后续竞争到锁的线程看到。</p><h3 id=主要接口>主要接口</h3><h4 id=butex_create_checked>butex_create_checked</h4><p>template <typename t>T* butex_create_checked() {
BAIDU_CASSERT(sizeof(T) == sizeof(int), sizeof_T_must_equal_int);
return static_cast&lt;T*>(butex_create());
}</p><p>void* butex_create() {
Butex* b = butil::get_object<butex>();
if (b) {
return &b->value;
}<br>return NULL;
}
butex_create_checked通过get_object拿到了一个Butex，然后将Butex中的value返回给用户，用户通过value进行操作</p><h4 id=butex_wait>butex_wait</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>butex_wait</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>arg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>expected_value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>timespec</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>abstime</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Butex</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>container_of</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>&gt;*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>Butex</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>load</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_relaxed</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>expected_value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>errno</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>EWOULDBLOCK</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Sometimes we may take actions immediately after unmatched butex,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// this fence makes sure that we see changes before changing butex.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic_thread_fence</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_acquire</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>arg即butex_create_checked中返回的Butex中的value，通过value获取到对应的Butex，判断value是否等于expected_value，如果不等于则直接返回。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>butex_wait</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>arg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>expected_value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>timespec</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>abstime</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TaskGroup</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>tls_task_group</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87>NULL</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>||</span> <span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>is_current_pthread_task</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>butex_wait_from_pthread</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>g</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>expected_value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>abstime</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ButexBthreadWaiter</span> <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// tid is 0 iff the thread is non-bthread
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tid</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>current_tid</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>container</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>store</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_relaxed</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>task_meta</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>current_task</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sleep_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>waiter_state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WAITER_STATE_READY</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>expected_value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>expected_value</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>initial_butex</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>control</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>control</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bbw</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>abstime</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>abstime</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>如果value和expected_value，则尝试挂起当前bthread或者pthread，bthread是由bthread_worker进行调度执行的，bthread_worker所在的pthread有设置线程局部变量tls_task_group，所以如果tls_task_group为NULL，则当前是bthread，否则为pthread，假设当前是bthread，那么创建一个ButexBthreadWaiter，设置其中的变量，tid为当前bthread的id，initial_butex为当前Butex。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>butex_wait</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>arg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>expected_value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>timespec</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>abstime</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_remained</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>wait_for_butex</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>bbw</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TaskGroup</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>sched</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>g</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>然后通过set_reamined设置remain，remain即bthread_worker执行下一个bthread之前需要做的事情，设置完成后执行sched切换到其他bthread上继续执行。然后看下remain，即wait_for_butex中做的工作。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>wait_for_butex</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>arg</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ButexBthreadWaiter</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>bw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ButexBthreadWaiter</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Butex</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>initial_butex</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>BAIDU_SCOPED_LOCK</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>waiter_lock</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>load</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_relaxed</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>expected_value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>waiter_state</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>WAITER_STATE_UNMATCHEDVALUE</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>waiter_state</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>WAITER_STATE_READY</span><span style=color:#8f5902;font-style:italic>/*1*/</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span>
</span></span><span style=display:flex><span>                   <span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>task_meta</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>interrupted</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>waiters</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>container</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>store</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_relaxed</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>abstime</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>sleep_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>get_global_timer_thread</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>schedule</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>erase_from_butex_and_wakeup</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bw</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>abstime</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>sleep_id</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// TimerThread stopped.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>                    <span style=color:#000>errno</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>ESTOP</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#000>erase_from_butex_and_wakeup</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#000>tls_task_group</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>ready_to_run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>tid</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>获取到Butex，由于判断是否相等和挂起这两个操作需要在同一个临界区，所以需要上锁，如果Butex中的value不等于expected_value，那么通过ready_to_run将执行butex_wait的bthread重新假如到执行队列等待调度。否则将bw加入到Butex的等待队列中。</p><h4 id=butex_wake>butex_wake</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>butex_wake</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>arg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>nosignal</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Butex</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>container_of</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>atomic</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#ce5c00;font-weight:700>&gt;*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arg</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>Butex</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>value</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ButexWaiter</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>front</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>BAIDU_SCOPED_LOCK</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>waiter_lock</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>waiters</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>empty</span><span style=color:#000;font-weight:700>())</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>front</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>b</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>waiters</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>head</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>value</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>front</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>RemoveFromList</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>        <span style=color:#000>front</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>container</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>store</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_relaxed</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>front</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>tid</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>wakeup_pthread</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ButexPthreadWaiter</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>front</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ButexBthreadWaiter</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>bbw</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ButexBthreadWaiter</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>front</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000>unsleep_if_necessary</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bbw</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>get_global_timer_thread</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TaskGroup</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>get_task_group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bbw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>control</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>nosignal</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>g</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>tls_task_group</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>run_in_local_task_group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>g</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bbw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>tid</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>nosignal</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>g</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>ready_to_run_remote</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bbw</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>tid</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>nosignal</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>在该butex的等待队列中唤醒第一个ButexWaiter front，将front从waiters链表里删除，如果front是pthread（tid == 0的位pthread），那么调用wakeup_pthread。
如果front为bthread，如果执行butex_wake的是bthread_worker，即另一个bthread执行的，那么直接让出当前bthread，直接执行被唤醒的bthread，如果执行butex_wake的pthread不是bthread_worker，那么就把当前bthread加入到某个task_group的remote_rq中等待调度执行。</p><div class="text-muted mt-5 pt-3 border-top">修改于 2023年4月6日: <a href=https://github.com/apache/brpc-website/commit/c133db19af667e498e655c7e3f7c7dfb69238978>add work_stealing_queue (#136) (c133db19a)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none" style=display:flex;align-items:center;padding:0!important><div class="container-fluid mx-sm-5"><div class=row style=display:flex;align-items:center><div class="col-12 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/apache/brpc><i class="fab fa-github"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2024 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. 保留所有权利</small><div style=font-size:12.8px;color:#757474><a href=https://www.apache.org/ target=_blank rel=noopener>Foundation</a> |
<a href=https://www.apache.org/licenses/ target=_blank rel=noopener>License</a> |
<a href=https://www.apache.org/security/ target=_blank rel=noopener>Security</a> |
<a href=https://www.apache.org/events/current-event target=_blank rel=noopener>Events</a> |
<a href=https://www.apache.org/foundation/sponsorship.html target=_blank rel=noopener>Sponsorship</a> |
<a href=https://privacy.apache.org/policies/privacy-policy-public.html target=_blank rel=noopener>Privacy</a> |
<a href=https://www.apache.org/foundation/thanks.html target=_blank rel=noopener>Thanks</a></div></div></div></div></footer></div><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.17eb741170760e55f21de7c8e3570aa65d5fafd190c4b2798a7322a493948738.js integrity="sha256-F+t0EXB2DlXyHefI41cKpl1fr9GQxLJ5inMipJOUhzg=" crossorigin=anonymous></script></body></html>