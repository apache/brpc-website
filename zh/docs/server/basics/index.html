<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=alternate type=application/rss+xml href=https://brpc.apache.org/zh/docs/server/basics/index.xml><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>基础功能 | bRPC</title><meta property="og:title" content="基础功能"><meta property="og:description" content="学习如何使用bRPC Server。
"><meta property="og:type" content="website"><meta property="og:url" content="https://brpc.apache.org/zh/docs/server/basics/"><meta property="og:site_name" content="bRPC"><meta itemprop=name content="基础功能"><meta itemprop=description content="学习如何使用bRPC Server。
"><meta name=twitter:card content="summary"><meta name=twitter:title content="基础功能"><meta name=twitter:description content="学习如何使用bRPC Server。
"><link rel=preload href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css as=style><link href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css rel=stylesheet integrity><script src=/js/jquery-3.3.1.min.js></script><title>基础功能 | bRPC</title></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/zh/><span class=navbar-logo><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/apache/brpc/ target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/downloadbrpc/><span>下载</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/docs/><span class=active>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/community/community/><span>社区</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/asf/><span>ASF</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/blogs/><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/users/><span>用户</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/server/basics/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/server/basics/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a></li><ul><li class="collapse show" id=zhdocs><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsoverview href=/zh/docs/overview/>简介</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsdownloadbrpc href=/zh/docs/downloadbrpc/>下载</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsgetting_started href=/zh/docs/getting_started/>开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsbenchmark href=/zh/docs/benchmark/>性能基准</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvar><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvarbvar></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar c++</a></li><ul><li class=collapse id=zhdocsbvarbvar-c></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/mbvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">mbvar c++</a></li><ul><li class=collapse id=zhdocsbvarmbvar-c></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthread><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthreadbthread></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread-or-not/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread or not</a></li><ul><li class=collapse id=zhdocsbthreadbthread-or-not></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/execution-queue/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Execution Queue</a></li><ul><li class=collapse id=zhdocsbthreadexecution-queue></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/thread-local/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">thread-local</a></li><ul><li class=collapse id=zhdocsbthreadthread-local></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">C++基础</a></li><ul><li class=collapse id=zhdocsc-base><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/iobuf/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IOBuf</a></li><ul><li class=collapse id=zhdocsc-baseiobuf></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/streaming-log/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming Log</a></li><ul><li class=collapse id=zhdocsc-basestreaming-log></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/flatmap/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FlatMap</a></li><ul><li class=collapse id=zhdocsc-baseflatmap></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/brpc-training-materials/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC培训材料</a></li><ul><li class=collapse id=zhdocsc-basebrpc-training-materials></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">客户端</a></li><ul><li class=collapse id=zhdocsclient><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsclientbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/error-code/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">错误码</a></li><ul><li class=collapse id=zhdocsclienterror-code></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/combo-channels/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">组合channels</a></li><ul><li class=collapse id=zhdocsclientcombo-channels></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问http:h2</a></li><ul><li class=collapse id=zhdocsclientaccess-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问gRPC</a></li><ul><li class=collapse id=zhdocsclientaccess-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问thrift</a></li><ul><li class=collapse id=zhdocsclientaccess-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-ub/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问UB</a></li><ul><li class=collapse id=zhdocsclientaccess-ub></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-redis/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问redis</a></li><ul><li class=collapse id=zhdocsclientaccess-redis></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-memcached/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问memcached</a></li><ul><li class=collapse id=zhdocsclientaccess-memcached></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/streaming-rpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流式RPC</a></li><ul><li class=collapse id=zhdocsclientstreaming-rpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/backup-request/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Backup request</a></li><ul><li class=collapse id=zhdocsclientbackup-request></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/dummy-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dummy server</a></li><ul><li class=collapse id=zhdocsclientdummy-server></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">服务端</a></li><ul><li class="collapse show" id=zhdocsserver><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/basics/ class="align-left pl-0 pr-2 collapsed active td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsserverbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建http:h2服务</a></li><ul><li class=collapse id=zhdocsserverserve-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建gRPC服务</a></li><ul><li class=collapse id=zhdocsserverserve-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建thrift服务</a></li><ul><li class=collapse id=zhdocsserverserve-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-nshead/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建Nshead服务</a></li><ul><li class=collapse id=zhdocsserverserve-nshead></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/server-push/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">推送</a></li><ul><li class=collapse id=zhdocsserverserver-push></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/debug-server-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">高效率排查server卡顿</a></li><ul><li class=collapse id=zhdocsserverdebug-server-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/avalanche/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">雪崩</a></li><ul><li class=collapse id=zhdocsserveravalanche></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/auto-concurrencylimiter/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">自适应限流</a></li><ul><li class=collapse id=zhdocsserverauto-concurrencylimiter></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/media-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流媒体服务</a></li><ul><li class=collapse id=zhdocsservermedia-server></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/json2pb/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">json2pb</a></li><ul><li class=collapse id=zhdocsserverjson2pb></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内置服务</a></li><ul><li class=collapse id=zhdocsbuiltin-services><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/buildin_services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">builtin services</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesbuildin_services></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/status/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">status</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesstatus></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/vars/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">vars</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesvars></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/connections/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">connections</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesconnections></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/flags/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">flags</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesflags></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/rpcz/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpcz</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesrpcz></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/cpu_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">cpu profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescpu_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/heap_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">heap profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesheap_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/contention_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">contention profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescontention_profiler></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">工具</a></li><ul><li class=collapse id=zhdocstools><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_press/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_press</a></li><ul><li class=collapse id=zhdocstoolsrpc_press></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_replay/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_replay</a></li><ul><li class=collapse id=zhdocstoolsrpc_replay></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_view/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_view</a></li><ul><li class=collapse id=zhdocstoolsrpc_view></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/benchmark_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">benchmark_http</a></li><ul><li class=collapse id=zhdocstoolsbenchmark_http></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/parallel_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">parallel_http</a></li><ul><li class=collapse id=zhdocstoolsparallel_http></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">深入RPC</a></li><ul><li class=collapse id=zhdocsrpc-in-depth><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/new-protocol/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">支持新协议</a></li><ul><li class=collapse id=zhdocsrpc-in-depthnew-protocol></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/atomic-instructions/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">原子指令</a></li><ul><li class=collapse id=zhdocsrpc-in-depthatomic-instructions></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/io/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IO</a></li><ul><li class=collapse id=zhdocsrpc-in-depthio></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/threading-overview/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">线程模型简介</a></li><ul><li class=collapse id=zhdocsrpc-in-depththreading-overview></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/load-balancing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">负载均衡</a></li><ul><li class=collapse id=zhdocsrpc-in-depthload-balancing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/locality-aware/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Locality-aware</a></li><ul><li class=collapse id=zhdocsrpc-in-depthlocality-aware></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/consistent-hashing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">一致性哈希</a></li><ul><li class=collapse id=zhdocsrpc-in-depthconsistent-hashing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/memory-management/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内存管理</a></li><ul><li class=collapse id=zhdocsrpc-in-depthmemory-management></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/timer-keeping/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Timer keeping</a></li><ul><li class=collapse id=zhdocsrpc-in-depthtimer-keeping></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/bthread_id/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread_id</a></li><ul><li class=collapse id=zhdocsrpc-in-depthbthread_id></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/community/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">社区</a></li><ul><li class=collapse id=zhdocscommunity><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommunity href=/zh/docs/community/community/>社区</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitymailing_list href=/zh/docs/community/mailing_list/>邮件列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycontributing href=/zh/docs/community/contributing/>Contribute指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitter href=/zh/docs/community/committer/>Committer指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunityrelease href=/zh/docs/community/release/>Release指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitters href=/zh/docs/community/committers/>贡献者列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitysecurity href=/zh/docs/community/security/>安全</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitymonthly-meeting href=/zh/docs/community/monthly-meeting/>月度会</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunityon-call href=/zh/docs/community/on-call/>值班表</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsasf href=/zh/docs/asf/>ASF</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsusers href=/zh/docs/users/>用户</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC在百度内部的应用</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baidu><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case1/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">百度地图api入口</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case1></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联盟DSP</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case3/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ELF学习框架</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case3></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case4/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云平台代理服务</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case4></li></ul></ul></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsfaq href=/zh/docs/faq/>FAQ</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">博客</a></li><ul><li class=collapse id=zhdocsblogs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">版本发布</a></li><ul><li class=collapse id=zhdocsblogsreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases140 href=/zh/docs/blogs/releases/1.4.0/>bRPC 1.4.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases130 href=/zh/docs/blogs/releases/1.3.0/>bRPC 1.3.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases120 href=/zh/docs/blogs/releases/1.2.0/>bRPC 1.2.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases110 href=/zh/docs/blogs/releases/1.1.0/>bRPC 1.1.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases100 href=/zh/docs/blogs/releases/1.0.0/>bRPC 1.0.0</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/shares/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">分享</a></li><ul><li class=collapse id=zhdocsblogsshares><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssharesbrpc-guide-for-beginners href=/zh/docs/blogs/shares/brpc-guide-for-beginners/>brpc初学者指南</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/sourcecodes/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">源码解析</a></li><ul><li class=collapse id=zhdocsblogssourcecodes><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesbthread href=/zh/docs/blogs/sourcecodes/bthread/>bRPC源码解析·bthread机制</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodeswork_stealing_queue href=/zh/docs/blogs/sourcecodes/work_stealing_queue/>bRPC源码解析·work_stealing_queue</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesbutex href=/zh/docs/blogs/sourcecodes/butex/>bRPC源码解析·butex机制</a></li></ul></ul></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/brpc-website/edit/master/content/zh/docs/Server/Basics/_index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/brpc-website/issues/new?title=%e5%9f%ba%e7%a1%80%e5%8a%9f%e8%83%bd" target=_blank><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>
<a href=https://github.com/apache/brpc/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a></div><nav id=TableOfContents><ul><li><a href=#标记当前调用为失败>标记当前调用为失败</a></li><li><a href=#获取client的地址>获取Client的地址</a></li><li><a href=#获取server的地址>获取Server的地址</a></li><li><a href=#异步service>异步Service</a></li></ul><ul><li><a href=#监听多个端口>监听多个端口</a></li><li><a href=#多进程监听一个端口>多进程监听一个端口</a></li></ul><ul><li><a href=#jsonpb>json&lt;=>pb</a></li><li><a href=#兼容早期版本client>兼容早期版本client</a></li></ul><ul><li><a href=#版本>版本</a></li><li><a href=#关闭闲置连接>关闭闲置连接</a></li><li><a href=#pid_file>pid_file</a></li><li><a href=#在每条日志后打印hostname>在每条日志后打印hostname</a></li><li><a href=#打印fatal日志后退出程序>打印FATAL日志后退出程序</a></li><li><a href=#最低日志级别>最低日志级别</a></li><li><a href=#归还空闲内存至系统>归还空闲内存至系统</a></li><li><a href=#打印发送给client的错误>打印发送给client的错误</a></li><li><a href=#定制延时的分位值>定制延时的分位值</a></li><li><a href=#设置栈大小>设置栈大小</a></li><li><a href=#限制最大消息>限制最大消息</a></li><li><a href=#压缩>压缩</a></li><li><a href=#附件>附件</a></li><li><a href=#开启ssl>开启SSL</a></li><li><a href=#验证client身份>验证client身份</a></li><li><a href=#worker线程数>worker线程数</a></li><li><a href=#限制最大并发>限制最大并发</a><ul><li><a href=#为什么超过最大并发要立刻给client返回错误而不是排队>为什么超过最大并发要立刻给client返回错误而不是排队？</a></li><li><a href=#为什么不限制qps>为什么不限制QPS?</a></li><li><a href=#计算最大并发数>计算最大并发数</a></li><li><a href=#限制server级别并发度>限制server级别并发度</a></li><li><a href=#限制method级别并发度>限制method级别并发度</a></li><li><a href=#使用自适应限流算法>使用自适应限流算法</a></li></ul></li><li><a href=#pthread模式>pthread模式</a></li><li><a href=#安全模式>安全模式</a><ul><li><a href=#对外隐藏内置服务>对外隐藏内置服务</a></li><li><a href=#完全禁用内置服务>完全禁用内置服务</a></li><li><a href=#转义外部可控的url>转义外部可控的URL</a></li><li><a href=#不返回内部server地址>不返回内部server地址</a></li></ul></li><li><a href=#定制health页面>定制/health页面</a></li><li><a href=#线程私有变量>线程私有变量</a><ul><li><a href=#session-local>session-local</a></li><li><a href=#server-thread-local>server-thread-local</a></li><li><a href=#bthread-local>bthread-local</a></li></ul></li></ul><ul><li><ul><li><a href=#q-fail-to-write-into-fd1865-socketid89051020824543547428230-got-eof是什么意思>Q: Fail to write into fd=1865 <a href="mailto:SocketId=8905@10.208.245.43">SocketId=8905@10.208.245.43</a>:54742@8230: Got EOF是什么意思</a></li><li><a href=#q-remote-side-of-fd9-socketid2109466558000-was-closed是什么意思>Q: Remote side of fd=9 <a href="mailto:SocketId=2@10.94.66.55">SocketId=2@10.94.66.55</a>:8000 was closed是什么意思</a></li><li><a href=#q-为什么server端线程数设了没用>Q: 为什么server端线程数设了没用</a></li><li><a href=#q-为什么client端的延时远大于server端的延时>Q: 为什么client端的延时远大于server端的延时</a></li><li><a href=#q-fail-to-open-procselfio>Q: Fail to open /proc/self/io</a></li><li><a href=#q-json串123没法直接转为protobuf-message>Q: json串"[1,2,3]&ldquo;没法直接转为protobuf message</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/zh/zh/docs/>文档</a></li><li class=breadcrumb-item><a href=/zh/zh/docs/server/>服务端</a></li><li class="breadcrumb-item active" aria-current=page><a href=/zh/zh/docs/server/basics/>基础功能</a></li></ol></nav><div class=td-content><h1>基础功能</h1><div class=lead>学习如何使用bRPC Server。</div><h1 id=示例程序>示例程序</h1><p>Echo的<a href=https://github.com/brpc/brpc/blob/master/example/echo_c++/server.cpp>server端代码</a>。</p><h1 id=填写proto文件>填写proto文件</h1><p>请求、回复、服务的接口均定义在proto文件中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 告诉protoc要生成C++ Service基类，如果是java或python，则应分别修改为java_generic_services和py_generic_services
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>option</span> <span style=color:#000>cc_generic_services</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#000>message</span> <span style=color:#000>EchoRequest</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>required</span> <span style=color:#000>string</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span><span style=color:#000>message</span> <span style=color:#000>EchoResponse</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>required</span> <span style=color:#000>string</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#000>service</span> <span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>rpc</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>EchoRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>EchoResponse</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>protobuf的更多用法请阅读<a href=https://developers.google.com/protocol-buffers/docs/proto#options>protobuf官方文档</a>。</p><h1 id=实现生成的service接口>实现生成的Service接口</h1><p>protoc运行后会生成echo.pb.cc和echo.pb.h文件，你得include echo.pb.h，实现其中的EchoService基类：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&#34;echo.pb.h&#34;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyEchoService</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>EchoService</span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>const</span> <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 这个对象确保在return时自动调用done-&gt;Run()
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>         
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 填写response
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>response</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_message</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>Service在插入<a href=https://github.com/brpc/brpc/blob/master/src/brpc/server.h>brpc.Server</a>后才可能提供服务。</p><p>当客户端发来请求时，Echo()会被调用。参数的含义分别是：</p><p><strong>controller</strong></p><p>在brpc中可以静态转为brpc::Controller（前提是代码运行brpc.Server中），包含了所有request和response之外的参数集合，具体接口查阅<a href=https://github.com/brpc/brpc/blob/master/src/brpc/controller.h>controller.h</a></p><p><strong>request</strong></p><p>请求，只读的，来自client端的数据包。</p><p><strong>response</strong></p><p>回复。需要用户填充，如果存在<strong>required</strong>字段没有被设置，该次调用会失败。</p><p><strong>done</strong></p><p>done由框架创建，递给服务回调，包含了调用服务回调后的后续动作，包括检查response正确性，序列化，打包，发送等逻辑。</p><p><strong>不管成功失败，done->Run()必须在请求处理完成后被用户调用一次。</strong></p><p>为什么框架不自己调用done->Run()？这是为了允许用户把done保存下来，在服务回调之后的某事件发生时再调用，即实现<strong>异步Service</strong>。</p><p>强烈建议使用<strong>ClosureGuard</strong>确保done->Run()被调用，即在服务回调开头的那句：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>不管在中间还是末尾脱离服务回调，都会使done_guard析构，其中会调用done->Run()。这个机制称为<a href=https://en.wikipedia.org/wiki/Resource_Acquisition_Is_Initialization>RAII</a>。没有这个的话你得在每次return前都加上done->Run()，<strong>极易忘记</strong>。</p><p>在异步Service中，退出服务回调时请求未处理完成，done->Run()不应被调用，done应被保存下来供以后调用，乍看起来，这里并不需要用ClosureGuard。但在实践中，异步Service照样会因各种原因跳出回调，如果不使用ClosureGuard，一些分支很可能会在return前忘记done->Run()，所以我们也建议在异步service中使用done_guard，与同步Service不同的是，为了避免正常脱离函数时done->Run()也被调用，你可以调用done_guard.release()来释放其中的done。</p><p>一般来说，同步Service和异步Service分别按如下代码处理done：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyFooService</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FooService</span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 同步服务
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>SyncFoo</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                 <span style=color:#204a87;font-weight:700>const</span> <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                 <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                 <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// 异步服务
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>AsyncFoo</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#204a87;font-weight:700>const</span> <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                  <span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>         <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>         <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>release</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>ClosureGuard的接口如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// RAII: Call Run() of the closure on destruction.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>ClosureGuard</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>ClosureGuard</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Constructed with a closure which will be Run() inside dtor.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>explicit</span> <span style=color:#000>ClosureGuard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Call Run() of internal closure if it&#39;s not NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>ClosureGuard</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Call Run() of internal closure if it&#39;s not NULL and set it to `done&#39;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>reset</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Set internal closure to NULL and return the one before set.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>release</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><h2 id=标记当前调用为失败>标记当前调用为失败</h2><p>调用Controller.SetFailed()可以把当前调用设置为失败，当发送过程出现错误时，框架也会调用这个函数。用户一般是在服务的CallMethod里调用这个函数，比如某个处理环节出错，SetFailed()后确认done->Run()被调用了就可以跳出函数了(若使用了ClosureGuard，跳出函数时会自动调用done，不用手动)。Server端的done的逻辑主要是发送response回client，当其发现用户调用了SetFailed()后，会把错误信息送回client。client收到后，它的Controller::Failed()会为true（成功时为false），Controller::ErrorCode()和Controller::ErrorText()则分别是错误码和错误信息。</p><p>用户可以为http访问设置<a href=http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html>status-code</a>，在server端一般是调用<code>controller.http_response().set_status_code()</code>，标准的status-code定义在<a href=https://github.com/brpc/brpc/blob/master/src/brpc/http_status_code.h>http_status_code.h</a>中。Controller.SetFailed也会设置status-code，值是与错误码含义最接近的status-code，没有相关的则填500错误(brpc::HTTP_STATUS_INTERNAL_SERVER_ERROR)。如果你要覆盖status_code，设置代码一定要放在SetFailed()后，而不是之前。</p><h2 id=获取client的地址>获取Client的地址</h2><p><code>controller->remote_side()</code>可获得发送该请求的client地址和端口，类型是butil::EndPoint。如果client是nginx，remote_side()是nginx的地址。要获取真实client的地址，可以在nginx里设置<code>proxy_header ClientIp $remote_addr;</code>, 在rpc中通过<code>controller->http_request().GetHeader("ClientIp")</code>获得对应的值。</p><p>打印方式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>INFO</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;remote_side=&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>remote_side</span><span style=color:#000;font-weight:700>();</span> 
</span></span><span style=display:flex><span><span style=color:#000>printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;remote_side=%s</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>endpoint2str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>remote_side</span><span style=color:#000;font-weight:700>()).</span><span style=color:#000>c_str</span><span style=color:#000;font-weight:700>());</span>
</span></span></code></pre></div><h2 id=获取server的地址>获取Server的地址</h2><p>controller->local_side()获得server端的地址，类型是butil::EndPoint。</p><p>打印方式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>INFO</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;local_side=&#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>local_side</span><span style=color:#000;font-weight:700>();</span> 
</span></span><span style=display:flex><span><span style=color:#000>printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;local_side=%s</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>endpoint2str</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>local_side</span><span style=color:#000;font-weight:700>()).</span><span style=color:#000>c_str</span><span style=color:#000;font-weight:700>());</span>
</span></span></code></pre></div><h2 id=异步service>异步Service</h2><p>即done->Run()在Service回调之外被调用。</p><p>有些server以等待后端服务返回结果为主，且处理时间特别长，为了及时地释放出线程资源，更好的办法是把done注册到被等待事件的回调中，等到事件发生后再调用done->Run()。</p><p>异步service的最后一行一般是done_guard.release()以确保正常退出CallMethod时不会调用done->Run()。例子请看<a href=https://github.com/brpc/brpc/tree/master/example/session_data_and_thread_local/>example/session_data_and_thread_local</a>。</p><p>Service和Channel都可以使用done来表达后续的操作，但它们是<strong>完全不同</strong>的，请勿混淆：</p><ul><li>Service的done由框架创建，用户处理请求后调用done把response发回给client。</li><li>Channel的done由用户创建，待RPC结束后被框架调用以执行用户的后续代码。</li></ul><p>在一个会访问下游服务的异步服务中会同时接触两者，容易搞混，请注意区分。</p><h1 id=加入service>加入Service</h1><p>默认构造后的Server不包含任何服务，也不会对外提供服务，仅仅是一个对象。</p><p>通过如下方法插入你的Service实例。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>AddService</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Service</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>service</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ServiceOwnership</span> <span style=color:#000>ownership</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>若ownership参数为SERVER_OWNS_SERVICE，Server在析构时会一并删除Service，否则应设为SERVER_DOESNT_OWN_SERVICE。</p><p>插入MyEchoService代码如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Server</span> <span style=color:#000>server</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>MyEchoService</span> <span style=color:#000>my_echo_service</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddService</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>my_echo_service</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SERVER_DOESNT_OWN_SERVICE</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>FATAL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Fail to add my_echo_service&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Server启动后你无法再修改其中的Service。</p><h1 id=启动>启动</h1><p>调用以下<a href=https://github.com/brpc/brpc/blob/master/src/brpc/server.h>Server</a>的接口启动服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>ip_and_port_str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>ServerOptions</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>opt</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>EndPoint</span> <span style=color:#000>ip_and_port</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>ServerOptions</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>opt</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>port</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>ServerOptions</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>opt</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#204a87;font-weight:700>char</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ip_str</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>PortRange</span> <span style=color:#000>port_range</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>ServerOptions</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>opt</span><span style=color:#000;font-weight:700>);</span>  <span style=color:#8f5902;font-style:italic>// r32009后增加
</span></span></span></code></pre></div><p>&ldquo;localhost:9000&rdquo;, &ldquo;cq01-cos-dev00.cq01:8000&rdquo;, “127.0.0.1:7000"都是合法的<code>ip_and_port_str</code>。</p><p><code>options</code>为NULL时所有参数取默认值，如果你要使用非默认值，这么做就行了：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// 包含了默认值
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>xxx</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>yyy</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Start</span><span style=color:#000;font-weight:700>(...,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>options</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><h2 id=监听多个端口>监听多个端口</h2><p>一个server只能监听一个端口（不考虑ServerOptions.internal_port），需要监听N个端口就起N个Server。</p><h2 id=多进程监听一个端口>多进程监听一个端口</h2><p>启动时开启<code>reuse_port</code>这个flag，就可以多进程共同监听一个端口（底层是SO_REUSEPORT）。</p><h1 id=停止>停止</h1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stop</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>closewait_ms</span><span style=color:#000;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// closewait_ms实际无效，出于历史原因未删
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Join</span><span style=color:#000;font-weight:700>();</span>
</span></span></code></pre></div><p>Stop()不会阻塞，Join()会。分成两个函数的原因在于当多个Server需要退出时，可以先全部Stop再一起Join，如果一个个Stop/Join，可能得花费Server个数倍的等待时间。</p><p>不管closewait_ms是什么值，server在退出时会等待所有正在被处理的请求完成，同时对新请求立刻回复ELOGOFF错误以防止新请求加入。这么做的原因在于只要server退出时仍有处理线程运行，就有访问到已释放内存的风险。如果你的server“退不掉”，很有可能是由于某个检索线程没结束或忘记调用done了。</p><p>当client看到ELOGOFF时，会跳过对应的server，并在其他server上重试对应的请求。所以在一般情况下brpc总是“优雅退出”的，重启或上线时几乎不会或只会丢失很少量的流量。</p><p>RunUntilAskedToQuit()函数可以在大部分情况下简化server的运转和停止代码。在server.Start后，只需如下代码即会让server运行直到按到Ctrl-C。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Wait until Ctrl-C is pressed, then Stop() and Join() the server.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunUntilAskedToQuit</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// server已经停止了，这里可以写释放资源的代码。
</span></span></span></code></pre></div><p>Join()完成后可以修改其中的Service，并重新Start。</p><h1 id=被httph2访问>被http/h2访问</h1><p>使用Protobuf的服务通常可以通过http/h2+json访问，存于body的json串可与对应protobuf消息相互自动转化。</p><p>以<a href=https://github.com/brpc/brpc/blob/master/example/echo_c%2B%2B/server.cpp>echo server</a>为例，你可以用<a href=https://curl.haxx.se/>curl</a>访问这个服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#8f5902;font-style:italic># -H &#39;Content-Type: application/json&#39; is optional</span>
</span></span><span style=display:flex><span>$ curl -d <span style=color:#4e9a06>&#39;{&#34;message&#34;:&#34;hello&#34;}&#39;</span> http://brpc.baidu.com:8765/EchoService/Echo
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;message&#34;</span>:<span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>注意：也可以指定<code>Content-Type: application/proto</code>用http/h2+protobuf二进制串访问服务，序列化性能更好。</p><h2 id=jsonpb>json&lt;=>pb</h2><p>json字段通过匹配的名字和结构与pb字段一一对应。json中一定要包含pb的required字段，否则转化会失败，对应请求会被拒绝。json中可以包含pb中没有定义的字段，但它们会被丢弃而不会存入pb的unknown字段。转化规则详见<a href=../json2pb/>json &lt;=> protobuf</a>。</p><p>开启选项-pb_enum_as_number后，pb中的enum会转化为它的数值而不是名字，比如在<code>enum MyEnum { Foo = 1; Bar = 2; };</code>中不开启此选项时MyEnum类型的字段会转化为"Foo"或"Bar"，开启后为1或2。此选项同时影响client发出的请求和server返回的回复。由于转化为名字相比数值有更好的前后兼容性，此选项只应用于兼容无法处理enum为名字的老代码。</p><h2 id=兼容早期版本client>兼容早期版本client</h2><p>早期的brpc允许一个pb service被http协议访问时不填充pb请求，即使里面有required字段。一般来说这种service会自行解析http请求和设置http回复，并不会访问pb请求。但这也是非常危险的行为，毕竟这是pb service，但pb请求却是未定义的。</p><p>这种服务在升级到新版本rpc时会遇到障碍，因为brpc已不允许这种行为。为了帮助这种服务升级，brpc允许经过一些设置后不把http body自动转化为pb request(从而可自行处理），方法如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServiceOptions</span> <span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ownership</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>...;</span>
</span></span><span style=display:flex><span><span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>restful_mappings</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>...;</span>
</span></span><span style=display:flex><span><span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>allow_http_body_to_pb</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>false</span><span style=color:#000;font-weight:700>;</span> <span style=color:#8f5902;font-style:italic>//关闭http/h2 body至pb request的自动转化
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddService</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>service</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>svc_opt</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>如此设置后service收到http/h2请求后不会尝试把body转化为pb请求，所以pb请求总是未定义状态，用户得在<code>cntl->request_protocol() == brpc::PROTOCOL_HTTP || cntl->request_protocol() == brpc::PROTOCOL_H2</code>成立时自行解析body。</p><p>相应地，当cntl->response_attachment()不为空且pb回复不为空时，框架不再报错，而是直接把cntl->response_attachment()作为回复的body。这个功能和设置allow_http_body_to_pb与否无关。如果放开自由度导致过多的用户犯错，可能会有进一步的调整。</p><h1 id=协议支持>协议支持</h1><p>server端会自动尝试其支持的协议，无需用户指定。<code>cntl->protocol()</code>可获得当前协议。server能从一个listen端口建立不同协议的连接，不需要为不同的协议使用不同的listen端口，一个连接上也可以传输多种协议的数据包, 但一般不会这么做(也不建议)，支持的协议有：</p><ul><li><p><a href=baidu_std.md>百度标准协议</a>，显示为"baidu_std"，默认启用。</p></li><li><p><a href=../../client/streaming-rpc/>流式RPC协议</a>，显示为"streaming_rpc", 默认启用。</p></li><li><p>http/1.0和http/1.1协议，显示为”http“，默认启用。</p></li><li><p>http/2和gRPC协议，显示为"h2c"(未加密)或"h2"(加密)，默认启用。</p></li><li><p>RTMP协议，显示为"rtmp", 默认启用。</p></li><li><p>hulu-pbrpc的协议，显示为"hulu_pbrpc"，默认启动。</p></li><li><p>sofa-pbrpc的协议，显示为”sofa_pbrpc“, 默认启用。</p></li><li><p>百盟的协议，显示为”nova_pbrpc“, 默认不启用，开启方式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;brpc/policy/nova_pbrpc_protocol.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nshead_service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>policy</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>NovaServiceAdaptor</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div></li><li><p>public_pbrpc协议，显示为"public_pbrpc"，默认不启用，开启方式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;brpc/policy/public_pbrpc_protocol.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nshead_service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>policy</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>PublicPbrpcServiceAdaptor</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div></li><li><p>nshead+mcpack协议，显示为"nshead_mcpack"，默认不启用，开启方式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;brpc/policy/nshead_mcpack_protocol.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nshead_service</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>policy</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>NsheadMcpackAdaptor</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>顾名思义，这个协议的数据包由nshead+mcpack构成，mcpack中不包含特殊字段。不同于用户基于NsheadService的实现，这个协议使用了mcpack2pb，使得一份代码可以同时处理mcpack和pb两种格式。由于没有传递ErrorText的字段，当发生错误时server只能关闭连接。</p></li><li><p>和UB相关的协议请阅读<a href=nshead_service.md>实现NsheadService</a>。</p></li></ul><p>如果你有更多的协议需求，可以联系我们。</p><h1 id=fork-without-exec>fork without exec</h1><p>一般来说，<a href=https://linux.die.net/man/3/fork>fork</a>出的子进程应尽快调用<a href=https://linux.die.net/man/3/exec>exec</a>以重置所有状态，中间只应调用满足async-signal-safe的函数。这么使用fork的brpc程序在之前的版本也不会有问题。</p><p>但在一些场景中，用户想直接运行fork出的子进程，而不调用exec。由于fork只复制其调用者的线程，其余线程便随之消失了。对应到brpc中，bvar会依赖一个sampling_thread采样各种信息，在fork后便消失了，现象是很多bvar归零。</p><p>最新版本的brpc会在fork后重建这个线程(如有必要)，从而使bvar在fork后能正常工作，再次fork也可以。已知问题是fork后cpu profiler不正常。然而，这并不意味着用户可随意地fork，不管是brpc还是上层应用都会大量地创建线程，它们在fork后不会被重建，因为：</p><ul><li>大部分fork会紧接exec，浪费了重建</li><li>给代码编写带来很多的麻烦和复杂度</li></ul><p>brpc的策略是按需创建这类线程，同时fork without exec必须发生在所有可能创建这些线程的代码前。具体地说，至少<strong>发生在初始化所有Server/Channel/应用代码前</strong>，越早越好，不遵守这个约定的fork会导致程序不正常。另外，不支持fork without exec的lib相当普遍，最好避免这种用法。</p><h1 id=设置>设置</h1><h2 id=版本>版本</h2><p>Server.set_version(&mldr;)可以为server设置一个名称+版本，可通过/version内置服务访问到。虽然叫做"version“，但设置的值请包含服务名，而不仅仅是一个数字版本。</p><h2 id=关闭闲置连接>关闭闲置连接</h2><p>如果一个连接在ServerOptions.idle_timeout_sec对应的时间内没有读取或写出数据，则被视为”闲置”而被server主动关闭。默认值为-1，代表不开启。</p><p>打开<a href=http://brpc.baidu.com:8765/flags/log_idle_connection_close>-log_idle_connection_close</a>后关闭前会打印一条日志。</p><table><thead><tr><th>Name</th><th>Value</th><th>Description</th><th>Defined At</th></tr></thead><tbody><tr><td>log_idle_connection_close</td><td>false</td><td>Print log when an idle connection is closed</td><td>src/brpc/socket.cpp</td></tr></tbody></table><h2 id=pid_file>pid_file</h2><p>如果设置了此字段，Server启动时会创建一个同名文件，内容为进程号。默认为空。</p><h2 id=在每条日志后打印hostname>在每条日志后打印hostname</h2><p>此功能只对<a href=https://github.com/brpc/brpc/blob/master/src/butil/logging.h>butil/logging.h</a>中的日志宏有效。</p><p>打开<a href=http://brpc.baidu.com:8765/flags/log_hostname>-log_hostname</a>后每条日志后都会带本机名称，如果所有的日志需要汇总到一起进行分析，这个功能可以帮助你了解某条日志来自哪台机器。</p><h2 id=打印fatal日志后退出程序>打印FATAL日志后退出程序</h2><p>此功能只对<a href=https://github.com/brpc/brpc/blob/master/src/butil/logging.h>butil/logging.h</a>中的日志宏有效，glog默认在FATAL日志时crash。</p><p>打开<a href=http://brpc.baidu.com:8765/flags/crash_on_fatal_log>-crash_on_fatal_log</a>后如果程序使用LOG(FATAL)打印了异常日志或违反了CHECK宏中的断言，那么程序会在打印日志后abort，这一般也会产生coredump文件，默认不打开。这个开关可在对程序的压力测试中打开，以确认程序没有进入过严重错误的分支。</p><blockquote><p>一般的惯例是，ERROR表示可容忍的错误，FATAL代表不可逆转的错误。</p></blockquote><h2 id=最低日志级别>最低日志级别</h2><p>此功能由<a href=https://github.com/brpc/brpc/blob/master/src/butil/logging.h>butil/logging.h</a>和glog各自实现，为同名选项。</p><p>只有<strong>不低于</strong>-minloglevel指定的日志级别的日志才会被打印。这个选项可以动态修改。设置值和日志级别的对应关系：0=INFO 1=NOTICE 2=WARNING 3=ERROR 4=FATAL，默认为0。</p><p>未打印日志的开销只是一次if判断，也不会评估参数(比如某个参数调用了函数，日志不打，这个函数就不会被调用）。如果日志最终打印到自定义LogSink，那么还要经过LogSink的过滤。</p><h2 id=归还空闲内存至系统>归还空闲内存至系统</h2><p>选项-free_memory_to_system_interval表示每过这么多秒就尝试向系统归还空闲内存，&lt;= 0表示不开启，默认值为0，若开启建议设为10及以上的值。此功能支持tcmalloc，之前程序中对<code>MallocExtension::instance()->ReleaseFreeMemory()</code>的定期调用可改成设置此选项。</p><h2 id=打印发送给client的错误>打印发送给client的错误</h2><p>server的框架部分一般不针对个别client打印错误日志，因为当大量client出现错误时，可能导致server高频打印日志而严重影响性能。但有时为了调试问题，或就是需要让server打印错误，打开参数<a href=http://brpc.baidu.com:8765/flags/log_error_text>-log_error_text</a>即可。</p><h2 id=定制延时的分位值>定制延时的分位值</h2><p>显示的服务延时分位值<strong>默认</strong>为<strong>80</strong> (曾经为50), 90, 99, 99.9, 99.99，前三项可分别通过-bvar_latency_p1, -bvar_latency_p2, -bvar_latency_p3三个gflags定制。</p><p>以下是正确的设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-bvar_latency_p3<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>97</span>   <span style=color:#8f5902;font-style:italic># p3从默认99修改为97</span>
</span></span><span style=display:flex><span>-bvar_latency_p1<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60</span> -bvar_latency_p2<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>80</span> -bvar_latency_p3<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>95</span>
</span></span></code></pre></div><p>以下是错误的设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>-bvar_latency_p3<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100</span>   <span style=color:#8f5902;font-style:italic># 设置值必须在[1,99]闭区间内，gflags解析会失败</span>
</span></span><span style=display:flex><span>-bvar_latency_p1<span style=color:#ce5c00;font-weight:700>=</span>-1    <span style=color:#8f5902;font-style:italic># 同上</span>
</span></span></code></pre></div><h2 id=设置栈大小>设置栈大小</h2><p>brpc的Server是运行在bthread之上，默认栈大小为1MB，而pthread默认栈大小为10MB，所以在pthread上正常运行的程序，在bthread上可能遇到栈不足。</p><p>可设置如下的gflag以调整栈的大小:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>--stack_size_normal<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10000000</span>    <span style=color:#8f5902;font-style:italic># 表示调整栈大小为10M左右</span>
</span></span><span style=display:flex><span>--tc_stack_normal<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>             <span style=color:#8f5902;font-style:italic># 默认为8，表示每个worker缓存的栈的个数(以加快分配速度)，size越大，缓存数目可以适当调小(以减少内存占用)</span>
</span></span></code></pre></div><p>注意：不是说程序coredump就意味着”栈不够大“，只是因为这个试起来最容易，所以优先排除掉可能性。事实上百度内如此多的应用也很少碰到栈不够大的情况。</p><h2 id=限制最大消息>限制最大消息</h2><p>为了保护server和client，当server收到的request或client收到的response过大时，server或client会拒收并关闭连接。此最大尺寸由<a href=http://brpc.baidu.com:8765/flags/max_body_size>-max_body_size</a>控制，单位为字节。</p><p>超过最大消息时会打印如下错误日志：</p><pre tabindex=0><code>FATAL: 05-10 14:40:05: * 0 src/brpc/input_messenger.cpp:89] A message from 127.0.0.1:35217(protocol=baidu_std) is bigger than 67108864 bytes, the connection will be closed. Set max_body_size to allow bigger messages
</code></pre><p>protobuf中有<a href=https://github.com/google/protobuf/blob/master/src/google/protobuf/io/coded_stream.h#L364>类似的限制</a>，出错时会打印如下日志：</p><pre tabindex=0><code>FATAL: 05-10 13:35:02: * 0 google/protobuf/io/coded_stream.cc:156] A protocol message was rejected because it was too big (more than 67108864 bytes). To increase the limit (or to disable these warnings), see CodedInputStream::SetTotalBytesLimit() in google/protobuf/io/coded_stream.h.
</code></pre><p>brpc移除了protobuf中的限制，全交由此选项控制，只要-max_body_size足够大，用户就不会看到错误日志。此功能对protobuf的版本没有要求。</p><h2 id=压缩>压缩</h2><p>set_response_compress_type()设置response的压缩方式，默认不压缩。</p><p>注意附件不会被压缩。HTTP body的压缩方法见<a href=../serve-httph2/#%E5%8E%8B%E7%BC%A9response-body>这里</a>。</p><p>支持的压缩方法有：</p><ul><li>brpc::CompressTypeSnappy : <a href=http://google.github.io/snappy/>snanpy压缩</a>，压缩和解压显著快于其他压缩方法，但压缩率最低。</li><li>brpc::CompressTypeGzip : <a href=http://en.wikipedia.org/wiki/Gzip>gzip压缩</a>，显著慢于snappy，但压缩率高</li><li>brpc::CompressTypeZlib : <a href=http://en.wikipedia.org/wiki/Zlib>zlib压缩</a>，比gzip快10%~20%，压缩率略好于gzip，但速度仍明显慢于snappy。</li></ul><p>更具体的性能对比见<a href=../../client/basics/#%E5%8E%8B%E7%BC%A9>Client-压缩</a>.</p><h2 id=附件>附件</h2><p>baidu_std和hulu_pbrpc协议支持传递附件，这段数据由用户自定义，不经过protobuf的序列化。站在server的角度，设置在Controller.response_attachment()的附件会被client端收到，Controller.request_attachment()则包含了client端送来的附件。</p><p>附件不会被框架压缩。</p><p>在http协议中，附件对应<a href=http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html>message body</a>，比如要返回的数据就设置在response_attachment()中。</p><h2 id=开启ssl>开启SSL</h2><p>要开启SSL，首先确保代码依赖了最新的openssl库。如果openssl版本很旧，会有严重的安全漏洞，支持的加密算法也少，违背了开启SSL的初衷。然后设置<code>ServerOptions.ssl_options</code>，具体见<a href=https://github.com/brpc/brpc/blob/master/src/brpc/ssl_options.h>ssl_options.h</a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Certificate structure
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>CertInfo</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Certificate in PEM format.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Note that CN and alt subjects will be extracted from the certificate,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// and will be used as hostnames. Requests to this hostname (provided SNI
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// extension supported) will be encrypted using this certifcate.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Supported both file path and raw string
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span> <span style=color:#000>certificate</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Private key in PEM format.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Supported both file path and raw string based on prefix:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span> <span style=color:#000>private_key</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Additional hostnames besides those inside the certificate. Wildcards
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// are supported but it can only appear once at the beginning (i.e. *.xxx.com).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sni_filters</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// SSL options at server side
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ServerSSLOptions</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Default certificate which will be loaded into server. Requests
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// without hostname or whose hostname doesn&#39;t have a corresponding
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// certificate will use this certificate. MUST be set to enable SSL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>CertInfo</span> <span style=color:#000>default_cert</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Additional certificates which will be loaded into server. These
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// provide extra bindings between hostnames and certificates so that
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// we can choose different certificates according to different hostnames.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// See `CertInfo&#39; for detail.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CertInfo</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>certs</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// When set, requests without hostname or whose hostname can&#39;t be found in
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// any of the cerficates above will be dropped. Otherwise, `default_cert&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// will be used.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: false
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>strict_sni</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ... Other options
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><ul><li><p>Server端开启SSL<strong>必须</strong>要设置一张默认证书<code>default_cert</code>（默认SSL连接都用此证书），如果希望server能支持动态选择证书（如根据请求中域名，见<a href=https://en.wikipedia.org/wiki/Server_Name_Indication>SNI</a>机制），则可以将这些证书加载到<code>certs</code>。最后用户还可以在Server运行时，动态增减这些动态证书：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>AddCertificate</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>CertInfo</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>cert</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>RemoveCertificate</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>CertInfo</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>cert</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ResetCertificates</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>vector</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>CertInfo</span><span style=color:#ce5c00;font-weight:700>&gt;&amp;</span> <span style=color:#000>certs</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div></li><li><p>其余选项还包括：密钥套件选择（推荐密钥ECDHE-RSA-AES256-GCM-SHA384，chrome默认第一优先密钥，安全性很高，但比较耗性能）、session复用等。</p></li><li><p>SSL层在协议层之下（作用在Socket层），即开启后，所有协议（如HTTP）都支持用SSL加密后传输到Server，Server端会先进行SSL解密后，再把原始数据送到各个协议中去。</p></li><li><p>SSL开启后，端口仍然支持非SSL的连接访问，Server会自动判断哪些是SSL，哪些不是。如果要屏蔽非SSL访问，用户可通过<code>Controller::is_ssl()</code>判断是否是SSL，同时在<a href=../../builtin-services/connections/>connections</a>内置监控上也可以看到连接的SSL信息。</p></li></ul><h2 id=验证client身份>验证client身份</h2><p>如果server端要开启验证功能，需要实现<code>Authenticator</code>中的接口:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>Authenticator</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Implement this method to verify credential information `auth_str&#39; from
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// `client_addr&#39;. You can fill credential context (result) into `*out_ctx&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// and later fetch this pointer from `Controller&#39;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Returns 0 on success, error code otherwise
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>virtual</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>VerifyCredential</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>auth_str</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                 <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>base</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EndPoint</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>client_addr</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                 <span style=color:#000>AuthContext</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>out_ctx</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>};</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>AuthContext</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>user</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>group</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>roles</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>&amp;</span> <span style=color:#000>starter</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000>is_service</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>server的验证是基于连接的。当server收到连接上的第一个请求时，会尝试解析出其中的身份信息部分（如baidu_std里的auth字段、HTTP协议里的Authorization头），然后附带client地址信息一起调用<code>VerifyCredential</code>。若返回0，表示验证成功，用户可以把验证后的信息填入<code>AuthContext</code>，后续可通过<code>controller->auth_context()</code>获取，用户不需要关心其分配和释放。否则表示验证失败，连接会被直接关闭，client访问失败。</p><p>后续请求默认通过验证么，没有认证开销。</p><p>把实现的<code>Authenticator</code>实例赋值到<code>ServerOptions.auth</code>，即开启验证功能，需要保证该实例在整个server运行周期内都有效，不能被析构。</p><h2 id=worker线程数>worker线程数</h2><p>设置ServerOptions.num_threads即可，默认是cpu core的个数（包含超线程的）。</p><p>注意: ServerOptions.num_threads仅仅是个<strong>提示</strong>。</p><p>你不能认为Server就用了这么多线程，因为进程内的所有Server和Channel会共享线程资源，线程总数是所有ServerOptions.num_threads和-bthread_concurrency中的最大值。比如一个程序内有两个Server，num_threads分别为24和36，bthread_concurrency为16。那么worker线程数为max(24, 36, 16) = 36。这不同于其他RPC实现中往往是加起来。</p><p>Channel没有相应的选项，但可以通过选项-bthread_concurrency调整。</p><p>另外，brpc<strong>不区分IO线程和处理线程</strong>。brpc知道如何编排IO和处理代码，以获得更高的并发度和线程利用率。</p><h2 id=限制最大并发>限制最大并发</h2><p>“并发”可能有两种含义，一种是连接数，一种是同时在处理的请求数。这里提到的是后者。</p><p>在传统的同步server中，最大并发不会超过工作线程数，设定工作线程数量一般也限制了并发。但brpc的请求运行于bthread中，M个bthread会映射至N个worker中（一般M大于N），所以同步server的并发度可能超过worker数量。另一方面，虽然异步server的并发不受线程数控制，但有时也需要根据其他因素控制并发量。</p><p>brpc支持设置server级和method级的最大并发，当server或method同时处理的请求数超过并发度限制时，它会立刻给client回复<strong>brpc::ELIMIT</strong>错误，而不会调用服务回调。看到ELIMIT错误的client应重试另一个server。这个选项可以防止server出现过度排队，或用于限制server占用的资源。</p><p>默认不开启。</p><h3 id=为什么超过最大并发要立刻给client返回错误而不是排队>为什么超过最大并发要立刻给client返回错误而不是排队？</h3><p>当前server达到最大并发并不意味着集群中的其他server也达到最大并发了，立刻让client获知错误，并去尝试另一台server在全局角度是更好的策略。</p><h3 id=为什么不限制qps>为什么不限制QPS?</h3><p>QPS是一个秒级的指标，无法很好地控制瞬间的流量爆发。而最大并发和当前可用的重要资源紧密相关：&ldquo;工作线程&rdquo;，“槽位”等，能更好地抑制排队。</p><p>另外当server的延时较为稳定时，限制并发的效果和限制QPS是等价的。但前者实现起来容易多了：只需加减一个代表并发度的计数器。这也是大部分流控都限制并发而不是QPS的原因，比如TCP中的“窗口"即是一种并发度。</p><h3 id=计算最大并发数>计算最大并发数</h3><p>最大并发度 = 极限QPS * 低负载延时 (<a href=https://en.wikipedia.org/wiki/Little%27s_law>little&rsquo;s law</a>)</p><p>极限QPS指的是server能达到的最大qps，低负载延时指的是server在没有严重积压请求的前提下时的平均延时。一般的服务上线都会有性能压测，把测得的QPS和延时相乘一般就是该服务的最大并发度。</p><h3 id=限制server级别并发度>限制server级别并发度</h3><p>设置ServerOptions.max_concurrency，默认值0代表不限制。访问内置服务不受此选项限制。</p><p>Server.ResetMaxConcurrency()可在server启动后动态修改server级别的max_concurrency。</p><h3 id=限制method级别并发度>限制method级别并发度</h3><p>server.MaxConcurrencyOf("&mldr;") = &mldr;可设置method级别的max_concurrency。也可以通过设置ServerOptions.method_max_concurrency一次性为所有的method设置最大并发。
当ServerOptions.method_max_concurrency和server.MaxConcurrencyOf("&mldr;")=&mldr;同时被设置时，使用server.MaxConcurrencyOf()所设置的值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>ServerOptions</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>method_max_concurrency</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>;</span>                   <span style=color:#8f5902;font-style:italic>// Set the default maximum concurrency for all methods
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxConcurrencyOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;example.EchoService.Echo&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>    <span style=color:#8f5902;font-style:italic>// Give priority to the value set by server.MaxConcurrencyOf()
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxConcurrencyOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;example.EchoService&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Echo&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxConcurrencyOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>service</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Echo&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxConcurrencyOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;example.EchoService.Echo&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;10&#34;</span><span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic>// You can also assign a string value
</span></span></span></code></pre></div><p>此设置一般<strong>发生在AddService后，server启动前</strong>。当设置失败时（比如对应的method不存在），server会启动失败同时提示用户修正MaxConcurrencyOf设置错误。</p><p>当method级别和server级别的max_concurrency都被设置时，先检查server级别的，再检查method级别的。</p><p>注意：没有service级别的max_concurrency。</p><h3 id=使用自适应限流算法>使用自适应限流算法</h3><p>实际生产环境中,最大并发未必一成不变，在每次上线前逐个压测和设置服务的最大并发也很繁琐。这个时候可以使用自适应限流算法。</p><p>自适应限流是method级别的。要使用自适应限流算法，把method的最大并发度设置为"auto"即可:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Set auto concurrency limiter for all methods
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>method_max_concurrency</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;auto&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Set auto concurrency limiter for specific method
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxConcurrencyOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;example.EchoService.Echo&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;auto&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>关于自适应限流的更多细节可以看<a href=../auto-concurrencylimiter/>这里</a></p><h2 id=pthread模式>pthread模式</h2><p>用户代码（客户端的done，服务器端的CallMethod）默认在栈为1MB的bthread中运行。但有些用户代码无法在bthread中运行，比如：</p><ul><li>JNI会检查stack layout而无法在bthread中运行。</li><li>代码中广泛地使用pthread local传递session级别全局数据，在RPC前后均使用了相同的pthread local的数据，且数据有前后依赖性。比如在RPC前往pthread-local保存了一个值，RPC后又读出来希望和之前保存的相等，就会有问题。而像tcmalloc虽然也使用了pthread/LWP local，但每次使用之间没有直接的依赖，是安全的。</li></ul><p>对于这些情况，brpc提供了pthread模式，开启**-usercode_in_pthread**后，用户代码均会在pthread中运行，原先阻塞bthread的函数转而阻塞pthread。</p><p>注意：开启-usercode_in_pthread后，brpc::thread_local_data()不保证能获取到值。</p><p>打开pthread模式后在性能上的注意点：</p><ul><li>同步RPC都会阻塞worker pthread，server端一般需要设置更多的工作线程(ServerOptions.num_threads)，调度效率会略微降低。</li><li>运行用户代码的仍然是bthread，只是很特殊，会直接使用pthread worker的栈。这些特殊bthread的调度方式和其他bthread是一致的，这方面性能差异很小。</li><li>bthread支持一个独特的功能：把当前使用的pthread worker 让给另一个新创建的bthread运行，以消除一次上下文切换。brpc client利用了这点，从而使一次RPC过程中3次上下文切换变为了2次。在高QPS系统中，消除上下文切换可以明显改善性能和延时分布。但pthread模式不具备这个能力，在高QPS系统中性能会有一定下降。</li><li>pthread模式中线程资源是硬限，一旦线程被打满，请求就会迅速拥塞而造成大量超时。一个常见的例子是：下游服务大量超时后，上游服务可能由于线程大都在等待下游也被打满从而影响性能。开启pthread模式后请考虑设置ServerOptions.max_concurrency以控制server的最大并发。而在bthread模式中bthread个数是软限，对此类问题的反应会更加平滑。</li></ul><p>pthread模式可以让一些老代码快速尝试brpc，但我们仍然建议逐渐地把代码改造为使用bthread local或最好不用TLS，从而最终能关闭这个开关。</p><h2 id=安全模式>安全模式</h2><p>如果你的服务流量来自外部（包括经过nginx等转发），你需要注意一些安全因素：</p><h3 id=对外隐藏内置服务>对外隐藏内置服务</h3><p>内置服务很有用，但包含了大量内部信息，不应对外暴露。有多种方式可以对外隐藏内置服务：</p><ul><li><p>设置内部端口。把ServerOptions.internal_port设为一个<strong>仅允许内网访问</strong>的端口。你可通过internal_port访问到内置服务，但通过对外端口(Server.Start时传入的那个)访问内置服务时将看到如下错误：</p><pre tabindex=0><code>[a27eda84bcdeef529a76f22872b78305] Not allowed to access builtin services, try ServerOptions.internal_port=... instead if you&#39;re inside internal network
</code></pre></li><li><p>http proxy指定转发路径。nginx等可配置URL的映射关系，比如下面的配置把访问/MyAPI的外部流量映射到<code>target-server</code>的<code>/ServiceName/MethodName</code>。当外部流量尝试访问内置服务，比如说/status时，将直接被nginx拒绝。</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>location</span> <span style=color:#4e9a06>/MyAPI</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>...</span>
</span></span><span style=display:flex><span>      <span style=color:#4e9a06>proxy_pass</span> <span style=color:#4e9a06>http://&lt;target-server&gt;/ServiceName/MethodName</span><span style=color:#000>$query_string</span>   <span style=color:#8f5902;font-style:italic># $query_string是nginx变量，更多变量请查询http://nginx.org/en/docs/http/ngx_http_core_module.html
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>      <span style=color:#4e9a06>...</span>
</span></span><span style=display:flex><span>  <span style=color:#a40000>}</span>
</span></span></code></pre></div><p><strong>请勿在对外服务上开启</strong>-enable_dir_service和-enable_threads_service两个选项，它们虽然很方便，但会严重泄露服务器上的其他信息。检查对外的rpc服务是否打开了这两个开关：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s -m <span style=color:#0000cf;font-weight:700>1</span> &lt;HOSTNAME&gt;:&lt;PORT&gt;/flags/enable_dir_service,enable_threads_service <span style=color:#000;font-weight:700>|</span> awk <span style=color:#4e9a06>&#39;{if($3==&#34;false&#34;){++falsecnt}else if($3==&#34;Value&#34;){isrpc=1}}END{if(isrpc!=1||falsecnt==2){print &#34;SAFE&#34;}else{print &#34;NOT SAFE&#34;}}&#39;</span>
</span></span></code></pre></div><h3 id=完全禁用内置服务>完全禁用内置服务</h3><p>设置ServerOptions.has_builtin_services = false，可以完全禁用内置服务。</p><h3 id=转义外部可控的url>转义外部可控的URL</h3><p>可调用brpc::WebEscape()对url进行转义，防止恶意URI注入攻击。</p><h3 id=不返回内部server地址>不返回内部server地址</h3><p>可以考虑对server地址做签名。比如在设置ServerOptions.internal_port后，server返回的错误信息中的IP信息是其MD5签名，而不是明文。</p><h2 id=定制health页面>定制/health页面</h2><p>/health页面默认返回"OK"，若需定制/health页面的内容：先继承<a href=https://github.com/brpc/brpc/blob/master/src/brpc/health_reporter.h>HealthReporter</a>，在其中实现生成页面的逻辑（就像实现其他http service那样），然后把实例赋给ServerOptions.health_reporter，这个实例不被server拥有，必须保证在server运行期间有效。用户在定制逻辑中可以根据业务的运行状态返回更多样的状态信息。</p><h2 id=线程私有变量>线程私有变量</h2><p>百度内的检索程序大量地使用了<a href=https://en.wikipedia.org/wiki/Thread-local_storage>thread-local storage</a> (缩写TLS)，有些是为了缓存频繁访问的对象以避免反复创建，有些则是为了在全局函数间隐式地传递状态。你应当尽量避免后者，这样的函数难以测试，不设置thread-local变量甚至无法运行。brpc中有三套机制解决和thread-local相关的问题。</p><h3 id=session-local>session-local</h3><p>session-local data与一次server端RPC绑定: 从进入service回调开始，到调用server端的done结束，不管该service是同步还是异步处理。 session-local data会尽量被重用，在server停止前不会被删除。</p><p>设置ServerOptions.session_local_data_factory后访问Controller.session_local_data()即可获得session-local数据。若没有设置，Controller.session_local_data()总是返回NULL。</p><p>若ServerOptions.reserved_session_local_data大于0，Server会在提供服务前就创建这么多个数据。</p><p><strong>示例用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>MySessionLocalData</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MySessionLocalData</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>123</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EchoServiceImpl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Get the session-local data which is created by ServerOptions.session_local_data_factory
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// and reused between different RPC.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MySessionLocalData</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>sd</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MySessionLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>session_local_data</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>sd</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>SetFailed</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Require ServerOptions.session_local_data_factory to be set with a correctly implemented instance&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ServerOptions</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// The factory to create/destroy data attached to each RPC session.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// If this field is NULL, Controller::session_local_data() is always NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// NOT owned by Server and must be valid when Server is running.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: NULL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>DataFactory</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>session_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Prepare so many session-local data before server starts, so that calls
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// to Controller::session_local_data() get data directly rather than
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// calling session_local_data_factory-&gt;Create() at first time. Useful when
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Create() is slow, otherwise the RPC session may be blocked by the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// creation of data and not served within timeout.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: 0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>size_t</span> <span style=color:#000>reserved_session_local_data</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>session_local_data_factory的类型为<a href=https://github.com/brpc/brpc/blob/master/src/brpc/data_factory.h>DataFactory</a>，你需要实现其中的CreateData和DestroyData。</p><p>注意：CreateData和DestroyData会被多个线程同时调用，必须线程安全。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MySessionLocalDataFactory</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>DataFactory</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>CreateData</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MySessionLocalData</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>DestroyData</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>d</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MySessionLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>  
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>MySessionLocalDataFactory</span> <span style=color:#000>g_session_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>argc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>argv</span><span style=color:#000;font-weight:700>[])</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Server</span> <span style=color:#000>server</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>session_local_data_factory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>g_session_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><h3 id=server-thread-local>server-thread-local</h3><p>server-thread-local与一次service回调绑定，从进service回调开始，到出service回调结束。所有的server-thread-local data会被尽量重用，在server停止前不会被删除。在实现上server-thread-local是一个特殊的bthread-local。</p><p>设置ServerOptions.thread_local_data_factory后访问brpc::thread_local_data()即可获得thread-local数据。若没有设置，brpc::thread_local_data()总是返回NULL。</p><p>若ServerOptions.reserved_thread_local_data大于0，Server会在启动前就创建这么多个数据。</p><p><strong>与session-local的区别</strong></p><p>session-local data得从server端的Controller获得， server-thread-local可以在任意函数中获得，只要这个函数直接或间接地运行在server线程中。</p><p>当service是同步时，session-local和server-thread-local基本没有差别，除了前者需要Controller创建。当service是异步时，且你需要在done->Run()中访问到数据，这时只能用session-local，因为server-thread-local在service回调外已经失效。</p><p><strong>示例用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>MyThreadLocalData</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MyThreadLocalData</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>y</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>y</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EchoServiceImpl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>         
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// Get the thread-local data which is created by ServerOptions.thread_local_data_factory
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// and reused between different threads.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// &#34;tls&#34; is short for &#34;thread local storage&#34;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>thread_local_data</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>SetFailed</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Require ServerOptions.thread_local_data_factory &#34;</span>
</span></span><span style=display:flex><span>                            <span style=color:#4e9a06>&#34;to be set with a correctly implemented instance&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ServerOptions</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// The factory to create/destroy data attached to each searching thread
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// in server.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// If this field is NULL, brpc::thread_local_data() is always NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// NOT owned by Server and must be valid when Server is running.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: NULL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>DataFactory</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>thread_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Prepare so many thread-local data before server starts, so that calls
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// to brpc::thread_local_data() get data directly rather than calling
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// thread_local_data_factory-&gt;Create() at first time. Useful when Create()
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// is slow, otherwise the RPC session may be blocked by the creation
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// of data and not served within timeout.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// Default: 0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>size_t</span> <span style=color:#000>reserved_thread_local_data</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>thread_local_data_factory的类型为<a href=https://github.com/brpc/brpc/blob/master/src/brpc/data_factory.h>DataFactory</a>，你需要实现其中的CreateData和DestroyData。</p><p>注意：CreateData和DestroyData会被多个线程同时调用，必须线程安全。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyThreadLocalDataFactory</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>DataFactory</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>CreateData</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThreadLocalData</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>  
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>DestroyData</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>d</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>  
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#000>MyThreadLocalDataFactory</span> <span style=color:#000>g_thread_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>argc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>char</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>argv</span><span style=color:#000;font-weight:700>[])</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Server</span> <span style=color:#000>server</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ServerOptions</span> <span style=color:#000>options</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>thread_local_data_factory</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>g_thread_local_data_factory</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><h3 id=bthread-local>bthread-local</h3><p>Session-local和server-thread-local对大部分server已经够用。不过在一些情况下，我们需要更通用的thread-local方案。在这种情况下，你可以使用bthread_key_create, bthread_key_destroy, bthread_getspecific, bthread_setspecific等函数，它们的用法类似<a href=http://linux.die.net/man/3/pthread_key_create>pthread中的函数</a>。</p><p>这些函数同时支持bthread和pthread，当它们在bthread中被调用时，获得的是bthread私有变量; 当它们在pthread中被调用时，获得的是pthread私有变量。但注意，这里的“pthread私有变量”不是通过pthread_key_create创建的，使用pthread_key_create创建的pthread-local是无法被bthread_getspecific访问到的，这是两个独立的体系。由gcc的__thread，c++11的thread_local等声明的私有变量也无法被bthread_getspecific访问到。</p><p>由于brpc会为每个请求建立一个bthread，server中的bthread-local行为特殊：一个server创建的bthread在退出时并不删除bthread-local，而是还回server的一个pool中，以被其他bthread复用。这可以避免bthread-local随着bthread的创建和退出而不停地构造和析构。这对于用户是透明的。</p><p><strong>主要接口</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Create a key value identifying a slot in a thread-specific data area.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Each thread maintains a distinct thread-specific data area.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// `destructor&#39;, if non-NULL, is called with the value associated to that key
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// when the key is destroyed. `destructor&#39; is not called if the value
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// associated is NULL when the key is destroyed.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Returns 0 on success, error code otherwise.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>extern</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bthread_key_create</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_t</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>destructor</span><span style=color:#000;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Delete a key previously returned by bthread_key_create().
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// It is the responsibility of the application to free the data related to
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// the deleted key in any running thread. No destructor is invoked by
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// this function. Any destructor that may have been associated with key
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// will no longer be called upon thread exit.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Returns 0 on success, error code otherwise.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>extern</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bthread_key_delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_t</span> <span style=color:#000>key</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Store `data&#39; in the thread-specific slot identified by `key&#39;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// bthread_setspecific() is callable from within destructor. If the application
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// does so, destructors will be repeatedly called for at most
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// PTHREAD_DESTRUCTOR_ITERATIONS times to clear the slots.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// NOTE: If the thread is not created by brpc server and lifetime is
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// very short(doing a little thing and exit), avoid using bthread-local. The
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// reason is that bthread-local always allocate keytable on first call to
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// bthread_setspecific, the overhead is negligible in long-lived threads,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// but noticeable in shortly-lived threads. Threads in brpc server
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// are special since they reuse keytables from a bthread_keytable_pool_t
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in the server.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Returns 0 on success, error code otherwise.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// If the key is invalid or deleted, return EINVAL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>extern</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>bthread_setspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_t</span> <span style=color:#000>key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Return current value of the thread-specific slot identified by `key&#39;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// If bthread_setspecific() had not been called in the thread, return NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// If the key is invalid or deleted, return NULL.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>extern</span> <span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>bthread_getspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_t</span> <span style=color:#000>key</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p><strong>使用方法</strong></p><p>用bthread_key_create创建一个bthread_key_t，它代表一种bthread私有变量。</p><p>用bthread_[get|set]specific查询和设置bthread私有变量。一个线程中第一次访问某个私有变量返回NULL。</p><p>在所有线程都不使用和某个bthread_key_t相关的私有变量后再删除它。如果删除了一个仍在被使用的bthread_key_t，相关的私有变量就泄露了。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>my_data_destructor</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#000>bthread_key_t</span> <span style=color:#000>tls_key</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_key_create</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>tls_key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>my_data_destructor</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ERROR</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Fail to create tls_key&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// in some thread ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_getspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tls_key</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// First call to bthread_getspecific (and before any bthread_setspecific) returns NULL
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>tls</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThreadLocalData</span><span style=color:#000;font-weight:700>;</span>   <span style=color:#8f5902;font-style:italic>// Create thread-local data on demand.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>CHECK_EQ</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bthread_setspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tls_key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>tls</span><span style=color:#000;font-weight:700>));</span>  <span style=color:#8f5902;font-style:italic>// set the data so that next time bthread_getspecific in the thread returns the data.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>示例代码</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>static</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>my_thread_local_data_deleter</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>void</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>d</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>delete</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>  
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EchoServiceImpl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>EchoServiceImpl</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>CHECK_EQ</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bthread_key_create</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>my_thread_local_data_deleter</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>~</span><span style=color:#000>EchoServiceImpl</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>CHECK_EQ</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bthread_key_delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>};</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>private</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bthread_key_t</span> <span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>EchoServiceImpl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>request</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>EchoResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>response</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>              <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// You can create bthread-local data for your own.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// The interfaces are similar with pthread equivalence:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   pthread_key_create  -&gt; bthread_key_create
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   pthread_key_delete  -&gt; bthread_key_delete
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   pthread_getspecific -&gt; bthread_getspecific
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>//   pthread_setspecific -&gt; bthread_setspecific
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>tls2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyThreadLocalData</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bthread_getspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>tls2</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>tls2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyThreadLocalData</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#000>CHECK_EQ</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>bthread_setspecific</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_tls2_key</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>tls2</span><span style=color:#000;font-weight:700>));</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>...</span>
</span></span></code></pre></div><h1 id=faq>FAQ</h1><h3 id=q-fail-to-write-into-fd1865-socketid89051020824543547428230-got-eof是什么意思>Q: Fail to write into fd=1865 <a href="mailto:SocketId=8905@10.208.245.43">SocketId=8905@10.208.245.43</a>:54742@8230: Got EOF是什么意思</h3><p>A: 一般是client端使用了连接池或短连接模式，在RPC超时后会关闭连接，server写回response时发现连接已经关了就报这个错。Got EOF就是指之前已经收到了EOF（对端正常关闭了连接）。client端使用单连接模式server端一般不会报这个。</p><h3 id=q-remote-side-of-fd9-socketid2109466558000-was-closed是什么意思>Q: Remote side of fd=9 <a href="mailto:SocketId=2@10.94.66.55">SocketId=2@10.94.66.55</a>:8000 was closed是什么意思</h3><p>这不是错误，是常见的warning，表示对端关掉连接了（EOF)。这个日志有时对排查问题有帮助。</p><p>默认关闭，把参数-log_connection_close设置为true就打开了（支持<a href=../../builtin-services/flags/#change-gflag-on-the-fly>动态修改</a>）。</p><h3 id=q-为什么server端线程数设了没用>Q: 为什么server端线程数设了没用</h3><p>brpc同一个进程中所有的server<a href=#worker%E7%BA%BF%E7%A8%8B%E6%95%B0>共用线程</a>，如果创建了多个server，最终的工作线程数多半是最大的那个ServerOptions.num_threads。</p><h3 id=q-为什么client端的延时远大于server端的延时>Q: 为什么client端的延时远大于server端的延时</h3><p>可能是server端的工作线程不够用了，出现了排队现象。排查方法请查看<a href=../debug-server-issues/>高效率排查服务卡顿</a>。</p><h3 id=q-fail-to-open-procselfio>Q: Fail to open /proc/self/io</h3><p>有些内核没这个文件，不影响服务正确性，但如下几个bvar会无法更新：</p><pre tabindex=0><code>process_io_read_bytes_second
process_io_write_bytes_second
process_io_read_second
process_io_write_second
</code></pre><h3 id=q-json串123没法直接转为protobuf-message>Q: json串"[1,2,3]&ldquo;没法直接转为protobuf message</h3><p>这不是标准的json。最外层必须是花括号{}包围的json object。</p><h1 id=附server端基本流程>附:Server端基本流程</h1><p><img src=/images/docs/server_side.png alt=img></p><div class=section-index><hr class=panel-line></div><div class="text-muted mt-5 pt-3 border-top">修改于 2023年4月27日: <a href=https://github.com/apache/brpc-website/commit/0cbeccb3242e297455bac447a4d931627c65e20f>Update index.md (0cbeccb)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none" style=display:flex;align-items:center;padding:0!important><div class="container-fluid mx-sm-5"><div class=row style=display:flex;align-items:center><div class="col-12 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/apache/brpc><i class="fab fa-github"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. 保留所有权利</small><div style=font-size:12.8px;color:#757474><a href=https://www.apache.org/ target=_blank rel=noopener>Foundation</a> |
<a href=https://www.apache.org/licenses/ target=_blank rel=noopener>License</a> |
<a href=https://www.apache.org/security/ target=_blank rel=noopener>Security</a> |
<a href=https://www.apache.org/events/current-event target=_blank rel=noopener>Events</a> |
<a href=https://www.apache.org/foundation/sponsorship.html target=_blank rel=noopener>Sponsorship</a> |
<a href=https://privacy.apache.org/policies/privacy-policy-public.html target=_blank rel=noopener>Privacy</a> |
<a href=https://www.apache.org/foundation/thanks.html target=_blank rel=noopener>Thanks</a></div></div></div></div></footer></div><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.17eb741170760e55f21de7c8e3570aa65d5fafd190c4b2798a7322a493948738.js integrity="sha256-F+t0EXB2DlXyHefI41cKpl1fr9GQxLJ5inMipJOUhzg=" crossorigin=anonymous></script></body></html>