<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.105.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=alternate type=application/rss+xml href=https://brpc.apache.org/zh/docs/rpc-in-depth/atomic-instructions/index.xml><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>原子指令 | bRPC</title><meta property="og:title" content="原子指令"><meta property="og:description" content="学习bRPC原子指令。
"><meta property="og:type" content="website"><meta property="og:url" content="https://brpc.apache.org/zh/docs/rpc-in-depth/atomic-instructions/"><meta property="og:site_name" content="bRPC"><meta itemprop=name content="原子指令"><meta itemprop=description content="学习bRPC原子指令。
"><meta name=twitter:card content="summary"><meta name=twitter:title content="原子指令"><meta name=twitter:description content="学习bRPC原子指令。
"><link rel=preload href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css as=style><link href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css rel=stylesheet integrity><script src=/js/jquery-3.3.1.min.js></script><title>原子指令 | bRPC</title></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/zh/><span class=navbar-logo><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/apache/incubator-brpc/ target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/download target=_blank><span>Download</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/docs/><span class=active>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/blogs/><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/community/community/><span>社区</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/faq/><span>FAQ</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/users/><span>用户</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a></li><ul><li class="collapse show" id=zhdocs><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsoverview href=/zh/docs/overview/>简介</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsgetting_started href=/zh/docs/getting_started/>开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsbenchmark href=/zh/docs/benchmark/>性能基准</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvar><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvarbvar></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar c++</a></li><ul><li class=collapse id=zhdocsbvarbvar-c></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/mbvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">mbvar c++</a></li><ul><li class=collapse id=zhdocsbvarmbvar-c></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthread><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthreadbthread></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread-or-not/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread or not</a></li><ul><li class=collapse id=zhdocsbthreadbthread-or-not></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/execution-queue/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Execution Queue</a></li><ul><li class=collapse id=zhdocsbthreadexecution-queue></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/thread-local/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">thread-local</a></li><ul><li class=collapse id=zhdocsbthreadthread-local></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">客户端</a></li><ul><li class=collapse id=zhdocsclient><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsclientbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/error-code/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">错误码</a></li><ul><li class=collapse id=zhdocsclienterror-code></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/combo-channels/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">组合channels</a></li><ul><li class=collapse id=zhdocsclientcombo-channels></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问http:h2</a></li><ul><li class=collapse id=zhdocsclientaccess-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问gRPC</a></li><ul><li class=collapse id=zhdocsclientaccess-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问thrift</a></li><ul><li class=collapse id=zhdocsclientaccess-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-ub/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问UB</a></li><ul><li class=collapse id=zhdocsclientaccess-ub></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-redis/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问redis</a></li><ul><li class=collapse id=zhdocsclientaccess-redis></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-memcached/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问memcached</a></li><ul><li class=collapse id=zhdocsclientaccess-memcached></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/streaming-rpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流式RPC</a></li><ul><li class=collapse id=zhdocsclientstreaming-rpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/backup-request/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Backup request</a></li><ul><li class=collapse id=zhdocsclientbackup-request></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/dummy-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dummy server</a></li><ul><li class=collapse id=zhdocsclientdummy-server></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">服务端</a></li><ul><li class=collapse id=zhdocsserver><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsserverbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建http:h2服务</a></li><ul><li class=collapse id=zhdocsserverserve-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建gRPC服务</a></li><ul><li class=collapse id=zhdocsserverserve-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建thrift服务</a></li><ul><li class=collapse id=zhdocsserverserve-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-nshead/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建Nshead服务</a></li><ul><li class=collapse id=zhdocsserverserve-nshead></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/server-push/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">推送</a></li><ul><li class=collapse id=zhdocsserverserver-push></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/debug-server-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">高效率排查server卡顿</a></li><ul><li class=collapse id=zhdocsserverdebug-server-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/avalanche/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">雪崩</a></li><ul><li class=collapse id=zhdocsserveravalanche></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/auto-concurrencylimiter/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">自适应限流</a></li><ul><li class=collapse id=zhdocsserverauto-concurrencylimiter></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/media-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流媒体服务</a></li><ul><li class=collapse id=zhdocsservermedia-server></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/json2pb/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">json2pb</a></li><ul><li class=collapse id=zhdocsserverjson2pb></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内置服务</a></li><ul><li class=collapse id=zhdocsbuiltin-services><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/buildin_services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">builtin services</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesbuildin_services></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/status/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">status</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesstatus></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/vars/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">vars</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesvars></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/connections/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">connections</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesconnections></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/flags/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">flags</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesflags></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/rpcz/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpcz</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesrpcz></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/cpu_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">cpu profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescpu_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/heap_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">heap profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesheap_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/contention_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">contention profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescontention_profiler></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">工具</a></li><ul><li class=collapse id=zhdocstools><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_press/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_press</a></li><ul><li class=collapse id=zhdocstoolsrpc_press></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_replay/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_replay</a></li><ul><li class=collapse id=zhdocstoolsrpc_replay></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_view/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_view</a></li><ul><li class=collapse id=zhdocstoolsrpc_view></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/benchmark_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">benchmark_http</a></li><ul><li class=collapse id=zhdocstoolsbenchmark_http></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/parallel_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">parallel_http</a></li><ul><li class=collapse id=zhdocstoolsparallel_http></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">C++基础</a></li><ul><li class=collapse id=zhdocsc-base><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/iobuf/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IOBuf</a></li><ul><li class=collapse id=zhdocsc-baseiobuf></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/streaming-log/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming Log</a></li><ul><li class=collapse id=zhdocsc-basestreaming-log></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/flatmap/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FlatMap</a></li><ul><li class=collapse id=zhdocsc-baseflatmap></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/brpc-training-materials/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC培训材料</a></li><ul><li class=collapse id=zhdocsc-basebrpc-training-materials></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">深入RPC</a></li><ul><li class="collapse show" id=zhdocsrpc-in-depth><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/new-protocol/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">支持新协议</a></li><ul><li class=collapse id=zhdocsrpc-in-depthnew-protocol></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/atomic-instructions/ class="align-left pl-0 pr-2 collapsed active td-sidebar-link td-sidebar-link__section">原子指令</a></li><ul><li class=collapse id=zhdocsrpc-in-depthatomic-instructions></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/io/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IO</a></li><ul><li class=collapse id=zhdocsrpc-in-depthio></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/threading-overview/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">线程模型简介</a></li><ul><li class=collapse id=zhdocsrpc-in-depththreading-overview></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/load-balancing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">负载均衡</a></li><ul><li class=collapse id=zhdocsrpc-in-depthload-balancing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/locality-aware/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Locality-aware</a></li><ul><li class=collapse id=zhdocsrpc-in-depthlocality-aware></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/consistent-hashing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">一致性哈希</a></li><ul><li class=collapse id=zhdocsrpc-in-depthconsistent-hashing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/memory-management/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内存管理</a></li><ul><li class=collapse id=zhdocsrpc-in-depthmemory-management></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/timer-keeping/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Timer keeping</a></li><ul><li class=collapse id=zhdocsrpc-in-depthtimer-keeping></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/bthread_id/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread_id</a></li><ul><li class=collapse id=zhdocsrpc-in-depthbthread_id></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC在百度内部的应用</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baidu><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case1/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">百度地图api入口</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case1></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联盟DSP</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case3/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ELF学习框架</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case3></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case4/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云平台代理服务</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case4></li></ul></ul></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsdownloadbrpc href=/zh/docs/downloadbrpc/>下载bRPC</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/community/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">社区</a></li><ul><li class=collapse id=zhdocscommunity><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommunity href=/zh/docs/community/community/>社区</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitymailing_list href=/zh/docs/community/mailing_list/>邮件列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycontributing href=/zh/docs/community/contributing/>Contribute指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitter href=/zh/docs/community/committer/>Committer指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunityrelease href=/zh/docs/community/release/>Release指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitters href=/zh/docs/community/committers/>贡献者列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitysecurity href=/zh/docs/community/security/>安全</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsfaq href=/zh/docs/faq/>FAQ</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsusers href=/zh/docs/users/>用户</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">博客</a></li><ul><li class=collapse id=zhdocsblogs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">版本发布</a></li><ul><li class=collapse id=zhdocsblogsreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases130 href=/zh/docs/blogs/releases/1.3.0/>bRPC 1.3.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases120 href=/zh/docs/blogs/releases/1.2.0/>bRPC 1.2.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases110 href=/zh/docs/blogs/releases/1.1.0/>bRPC 1.1.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases100 href=/zh/docs/blogs/releases/1.0.0/>bRPC 1.0.0</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/shares/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">分享</a></li><ul><li class=collapse id=zhdocsblogsshares><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssharesbrpc-guide-for-beginners href=/zh/docs/blogs/shares/brpc-guide-for-beginners/>brpc初学者指南</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/sourcecodes/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">源码解析</a></li><ul><li class=collapse id=zhdocsblogssourcecodes><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesbthread href=/zh/docs/blogs/sourcecodes/bthread/>bRPC源码解析·bthread机制</a></li></ul></ul></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/incubator-brpc-website/edit/master/content/zh/docs/RPC-In-Depth/Atomic%20instructions/_index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/incubator-brpc-website/issues/new?title=%e5%8e%9f%e5%ad%90%e6%8c%87%e4%bb%a4" target=_blank><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>
<a href=https://github.com/apache/incubator-brpc/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a></div></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/zh/zh/docs/>文档</a></li><li class=breadcrumb-item><a href=/zh/zh/docs/rpc-in-depth/>深入RPC</a></li><li class="breadcrumb-item active" aria-current=page><a href=/zh/zh/docs/rpc-in-depth/atomic-instructions/>原子指令</a></li></ol></nav><div class=td-content><h1>原子指令</h1><div class=lead>学习bRPC原子指令。</div><p>我们都知道多核编程常用锁避免多个线程在修改同一个数据时产生<a href=http://en.wikipedia.org/wiki/Race_condition>race condition</a>。当锁成为性能瓶颈时，我们又总想试着绕开它，而不可避免地接触了原子指令。但在实践中，用原子指令写出正确的代码是一件非常困难的事，琢磨不透的race condition、<a href=https://en.wikipedia.org/wiki/ABA_problem>ABA problem</a>、<a href=https://en.wikipedia.org/wiki/Memory_barrier>memory fence</a>很烧脑，这篇文章试图通过介绍<a href=http://en.wikipedia.org/wiki/Symmetric_multiprocessing>SMP</a>架构下的原子指令帮助大家入门。C++11正式引入了<a href=http://en.cppreference.com/w/cpp/atomic/atomic>原子指令</a>，我们就以其语法描述。</p><p>顾名思义，原子指令是<strong>对软件</strong>不可再分的指令，比如x.fetch_add(n)指原子地给x加上n，这个指令<strong>对软件</strong>要么没做，要么完成，不会观察到中间状态。常见的原子指令有：</p><table><thead><tr><th>原子指令 (x均为std::atomic<int>)</th><th>作用</th></tr></thead><tbody><tr><td>x.load()</td><td>返回x的值。</td></tr><tr><td>x.store(n)</td><td>把x设为n，什么都不返回。</td></tr><tr><td>x.exchange(n)</td><td>把x设为n，返回设定之前的值。</td></tr><tr><td>x.compare_exchange_strong(expected_ref, desired)</td><td>若x等于expected_ref，则设为desired，返回成功；否则把最新值写入expected_ref，返回失败。</td></tr><tr><td>x.compare_exchange_weak(expected_ref, desired)</td><td>相比compare_exchange_strong可能有<a href=http://en.wikipedia.org/wiki/Spurious_wakeup>spurious wakeup</a>。</td></tr><tr><td>x.fetch_add(n), x.fetch_sub(n)</td><td>原子地做x += n, x-= n，返回修改之前的值。</td></tr></tbody></table><p>你已经可以用这些指令做原子计数，比如多个线程同时累加一个原子变量，以统计这些线程对一些资源的操作次数。但是，这可能会有两个问题：</p><ul><li>这个操作没有你想象地快。</li><li>如果你尝试通过看似简单的原子操作控制对一些资源的访问，你的程序有很大几率会crash。</li></ul><h1 id=cacheline>Cacheline</h1><p>没有任何竞争或只被一个线程访问的原子操作是比较快的，“竞争”指的是多个线程同时访问同一个<a href=https://en.wikipedia.org/wiki/CPU_cache#Cache_entries>cacheline</a>。现代CPU为了以低价格获得高性能，大量使用了cache，并把cache分了多级。百度内常见的Intel E5-2620拥有32K的L1 dcache和icache，256K的L2 cache和15M的L3 cache。其中L1和L2 cache为每个核心独有，L3则所有核心共享。一个核心写入自己的L1 cache是极快的(4 cycles, ~2ns)，但当另一个核心读或写同一处内存时，它得确认看到其他核心中对应的cacheline。对于软件来说，这个过程是原子的，不能在中间穿插其他代码，只能等待CPU完成<a href=https://en.wikipedia.org/wiki/Cache_coherence>一致性同步</a>，这个复杂的硬件算法使得原子操作会变得很慢，在E5-2620上竞争激烈时fetch_add会耗费700纳秒左右。访问被多个线程频繁共享的内存往往是比较慢的。比如像一些场景临界区看着很小，但保护它的spinlock性能不佳，因为spinlock使用的exchange, fetch_add等指令必须等待最新的cacheline，看上去只有几条指令，花费若干微秒并不奇怪。</p><p>要提高性能，就要避免让CPU频繁同步cacheline。这不单和原子指令本身的性能有关，还会影响到程序的整体性能。最有效的解决方法很直白：<strong>尽量避免共享</strong>。</p><ul><li>一个依赖全局多生产者多消费者队列(MPMC)的程序难有很好的多核扩展性，因为这个队列的极限吞吐取决于同步cache的延时，而不是核心的个数。最好是用多个SPMC或多个MPSC队列，甚至多个SPSC队列代替，在源头就规避掉竞争。</li><li>另一个例子是计数器，如果所有线程都频繁修改一个计数器，性能就会很差，原因同样在于不同的核心在不停地同步同一个cacheline。如果这个计数器只是用作打打日志之类的，那我们完全可以让每个线程修改thread-local变量，在需要时再合并所有线程中的值，性能可能有<a href=../../bvar/bvar/>几十倍的差别</a>。</li></ul><p>一个相关的编程陷阱是false sharing：对那些不怎么被修改甚至只读变量的访问，由于同一个cacheline中的其他变量被频繁修改，而不得不经常等待cacheline同步而显著变慢了。多线程中的变量尽量按访问规律排列，频繁被其他线程修改的变量要放在独立的cacheline中。要让一个变量或结构体按cacheline对齐，可以include &lt;butil/macros.h>后使用BAIDU_CACHELINE_ALIGNMENT宏，请自行grep brpc的代码了解用法。</p><h1 id=memory-fence>Memory fence</h1><p>仅靠原子技术实现不了对资源的访问控制，即使简单如<a href=https://en.wikipedia.org/wiki/Spinlock>spinlock</a>或<a href=https://en.wikipedia.org/wiki/Reference_counting>引用计数</a>，看上去正确的代码也可能会crash。这里的关键在于<strong>重排指令</strong>导致了读写顺序的变化。只要没有依赖，代码中在后面的指令就可能跑到前面去，<a href=http://preshing.com/20120625/memory-ordering-at-compile-time/>编译器</a>和<a href=https://en.wikipedia.org/wiki/Out-of-order_execution>CPU</a>都会这么做。</p><p>这么做的动机非常自然，CPU要尽量塞满每个cycle，在单位时间内运行尽量多的指令。如上节中提到的，访存指令在等待cacheline同步时要花费数百纳秒，最高效地自然是同时同步多个cacheline，而不是一个个做。一个线程在代码中对多个变量的依次修改，可能会以不同的次序同步到另一个线程所在的核心上。不同线程对数据的需求不同，按需同步也会导致cacheline的读序和写序不同。</p><p>如果其中第一个变量扮演了开关的作用，控制对后续变量的访问。那么当这些变量被一起同步到其他核心时，更新顺序可能变了，第一个变量未必是第一个更新的，然而其他线程还认为它代表着其他变量有效，去访问了实际已被删除的变量，从而导致未定义的行为。比如下面的代码片段：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Thread 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ready was initialized to false
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>init</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>ready</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>true</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Thread2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>ready</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>bar</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>从人的角度，这是对的，因为线程2在ready为true时才会访问p，按线程1的逻辑，此时p应该初始化好了。但对多核机器而言，这段代码可能难以正常运行：</p><ul><li>线程1中的ready = true可能会被编译器或cpu重排到p.init()之前，从而使线程2看到ready为true时，p仍然未初始化。这种情况同样也会在线程2中发生，p.bar()中的一些代码可能被重排到检查ready之前。</li><li>即使没有重排，ready和p的值也会独立地同步到线程2所在核心的cache，线程2仍然可能在看到ready为true时看到未初始化的p。</li></ul><p>注：x86/x64的load带acquire语意，store带release语意，上面的代码刨除编译器和CPU因素可以正确运行。</p><p>通过这个简单例子，你可以窥见原子指令编程的复杂性了吧。为了解决这个问题，CPU和编译器提供了<a href=http://en.wikipedia.org/wiki/Memory_barrier>memory fence</a>，让用户可以声明访存指令间的可见性(visibility)关系，boost和C++11对memory fence做了抽象，总结为如下几种<a href=http://en.cppreference.com/w/cpp/atomic/memory_order>memory order</a>.</p><table><thead><tr><th>memory order</th><th>作用</th></tr></thead><tbody><tr><td>memory_order_relaxed</td><td>没有fencing作用</td></tr><tr><td>memory_order_consume</td><td>后面依赖此原子变量的访存指令勿重排至此条指令之前</td></tr><tr><td>memory_order_acquire</td><td>后面访存指令勿重排至此条指令之前</td></tr><tr><td>memory_order_release</td><td>前面访存指令勿重排至此条指令之后。当此条指令的结果对其他线程可见后，之前的所有指令都可见</td></tr><tr><td>memory_order_acq_rel</td><td>acquire + release语意</td></tr><tr><td>memory_order_seq_cst</td><td>acq_rel语意外加所有使用seq_cst的指令有严格地全序关系</td></tr></tbody></table><p>有了memory order，上面的例子可以这么更正：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Thread1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ready was initialized to false
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>init</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>ready</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>store</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>true</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_release</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Thread2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>ready</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>load</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>memory_order_acquire</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>bar</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>线程2中的acquire和线程1的release配对，确保线程2在看到ready==true时能看到线程1 release之前所有的访存操作。</p><p>注意，memory fence不等于可见性，即使线程2恰好在线程1在把ready设置为true后读取了ready也不意味着它能看到true，因为同步cache是有延时的。memory fence保证的是可见性的顺序：“假如我看到了a的最新值，那么我一定也得看到b的最新值”。</p><p>一个相关问题是：如何知道看到的值是新还是旧？一般分两种情况：</p><ul><li>值是特殊的。比如在上面的例子中，ready=true是个特殊值，只要线程2看到ready为true就意味着更新了。只要设定了特殊值，读到或没有读到特殊值都代表了一种含义。</li><li>总是累加。一些场景下没有特殊值，那我们就用fetch_add之类的指令累加一个变量，只要变量的值域足够大，在很长一段时间内，新值和之前所有的旧值都会不相同，我们就能区分彼此了。</li></ul><p>原子指令的例子可以看boost.atomic的<a href=http://www.boost.org/doc/libs/1_56_0/doc/html/atomic/usage_examples.html>Example</a>，atomic的官方描述可以看<a href=http://en.cppreference.com/w/cpp/atomic/atomic>这里</a>。</p><h1 id=wait-free--lock-free>wait-free & lock-free</h1><p>原子指令能为我们的服务赋予两个重要属性：<a href=http://en.wikipedia.org/wiki/Non-blocking_algorithm#Wait-freedom>wait-free</a>和<a href=http://en.wikipedia.org/wiki/Non-blocking_algorithm#Lock-freedom>lock-free</a>。前者指不管OS如何调度线程，每个线程都始终在做有用的事；后者比前者弱一些，指不管OS如何调度线程，至少有一个线程在做有用的事。如果我们的服务中使用了锁，那么OS可能把一个刚获得锁的线程切换出去，这时候所有依赖这个锁的线程都在等待，而没有做有用的事，所以用了锁就不是lock-free，更不会是wait-free。为了确保一件事情总在确定时间内完成，实时系统的关键代码至少是lock-free的。在百度广泛又多样的在线服务中，对时效性也有着严苛的要求，如果RPC中最关键的部分满足wait-free或lock-free，就可以提供更稳定的服务质量。事实上，brpc中的读写都是wait-free的，具体见<a href=../io>IO</a>。</p><p>值得提醒的是，常见想法是lock-free或wait-free的算法会更快，但事实可能相反，因为：</p><ul><li>lock-free和wait-free必须处理更多更复杂的race condition和ABA problem，完成相同目的的代码比用锁更复杂。代码越多，耗时就越长。</li><li>使用mutex的算法变相带“后退”效果。后退(backoff)指出现竞争时尝试另一个途径以临时避免竞争，mutex出现竞争时会使调用者睡眠，使拿到锁的那个线程可以很快地独占完成一系列流程，总体吞吐可能反而高了。</li></ul><p>mutex导致低性能往往是因为临界区过大（限制了并发度），或竞争过于激烈（上下文切换开销变得突出）。lock-free/wait-free算法的价值在于其保证了一个或所有线程始终在做有用的事，而不是绝对的高性能。但在一种情况下lock-free和wait-free算法的性能多半更高：就是算法本身可以用少量原子指令实现。实现锁也是要用原子指令的，当算法本身用一两条指令就能完成的时候，相比额外用锁肯定是更快了。</p><div class=section-index><hr class=panel-line></div><div class="text-muted mt-5 pt-3 border-top">修改于 2022年11月4日: <a href=https://github.com/apache/incubator-brpc-website/commit/0ef7bfa727ffc4542b9ca55b9e94784ecd901ca7>Update config.toml (0ef7bfa)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none" style=display:flex;align-items:center;padding:0!important><div class="container-fluid mx-sm-5"><div class=row style=display:flex;align-items:center><div class="col-12 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/apache/incubator-brpc><i class="fab fa-github"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. 保留所有权利</small><div style=font-size:12.8px;color:#757474><a href=https://www.apache.org/ target=_blank rel=noopener>Foundation</a> |
<a href=https://www.apache.org/licenses/ target=_blank rel=noopener>License</a> |
<a href=https://www.apache.org/security/ target=_blank rel=noopener>Security</a> |
<a href=https://www.apache.org/events/current-event target=_blank rel=noopener>Events</a> |
<a href=https://www.apache.org/foundation/sponsorship.html target=_blank rel=noopener>Sponsorship</a> |
<a href=https://privacy.apache.org/policies/privacy-policy-public.html target=_blank rel=noopener>Privacy</a> |
<a href=https://www.apache.org/foundation/thanks.html target=_blank rel=noopener>Thanks</a></div></div></div></div></footer></div><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.17eb741170760e55f21de7c8e3570aa65d5fafd190c4b2798a7322a493948738.js integrity="sha256-F+t0EXB2DlXyHefI41cKpl1fr9GQxLJ5inMipJOUhzg=" crossorigin=anonymous></script></body></html>