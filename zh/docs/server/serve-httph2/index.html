<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=alternate type=application/rss+xml href=https://brpc.apache.org/zh/docs/server/serve-httph2/index.xml><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>搭建http:h2服务 | bRPC</title><meta property="og:title" content="搭建http:h2服务"><meta property="og:description" content="学习如何搭建Http2服务。
"><meta property="og:type" content="website"><meta property="og:url" content="https://brpc.apache.org/zh/docs/server/serve-httph2/"><meta property="og:site_name" content="bRPC"><meta itemprop=name content="搭建http:h2服务"><meta itemprop=description content="学习如何搭建Http2服务。
"><meta name=twitter:card content="summary"><meta name=twitter:title content="搭建http:h2服务"><meta name=twitter:description content="学习如何搭建Http2服务。
"><link rel=preload href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css as=style><link href=/scss/main.min.95c551203b5314bb676c6e9f33aafdf7f11abb85b51efe0d28a12274e41d51c2.css rel=stylesheet integrity><script src=/js/jquery-3.3.1.min.js></script><title>搭建http:h2服务 | bRPC</title></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/zh/><span class=navbar-logo><svg width="303" height="259" viewBox="0 0 303 259" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>brpc_logo.svg</title><defs><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-2"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-3"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient><linearGradient x1="50%" y1="0" x2="50%" y2="100%" id="linearGradient-4"><stop stop-color="#b5b5b5" offset="0"/><stop stop-color="#7e7e7e" offset="100%"/></linearGradient></defs><g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="椭圆形" fill="#58b8ff" cx="23.5" cy="62.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="279.5" cy="60.5" r="23.5"/><circle id="椭圆形" fill="#58b8ff" cx="119" cy="26" r="26"/><rect id="矩形" fill="#58b8ff" transform="translate(78.021813, 41.967662) rotate(-22.000000) translate(-78.021813, -41.967662)" x="30.0218125" y="35.9676616" width="96" height="12"/><rect id="矩形" fill="#58b8ff" transform="translate(201.451088, 44.299021) rotate(13.000000) translate(-201.451088, -44.299021)" x="138.951088" y="38.2990214" width="125" height="12"/><g id="brpc-logo" transform="translate(11.000000, 104.000000)" fill-rule="nonzero"><g id="编组" transform="translate(138.000000, 77.419111) scale(-1, 1) rotate(-180.000000) translate(-138.000000, -77.419111) translate(0.000000, 0.000000)"><path d="M18.8 154.3C17.8 154.1 17 153.8 17 153.6 17 153.5 13.2 134.3 8.5 111 3.8 87.7-205355861e-22 68-205355861e-22 67.4-205355861e-22 65.9 2.6 65.3 5.7 65.8 7.3 66.1 8.1 67.2 8.6 69.6 9.3 73.5 10 73.8 11.7 71.1 15 65.9 28.8 63.2 36.4 66.4 48.9 71.6 57.7 89.6 56.8 108.1c-.5 10-2.5 14.5-7.8 17.1C44.5 127.5 36.6 127.5 31.4 125.1 27 123.1 20.8814242 116.827994 20 115.8 19.8268414 115.598047 19.5 115 19 115.2 18.3 115.4 18.3 116.5 19 118.7 19.6 120.4 21.6 129 23.4 137.8l3.3 16L24.6 154.4C22.3 155 21.4 155 18.8 154.3zm24.6146505-36.885789c1.7578246-1.326292 2.0864078-1.825452 2.4530432-2.642066S46.8138702 112.705545 47.1008328 111.513935C48.333925 109.104457 47.0101697 95.2413285 45.0724535 89.7736686 41.197021 79.2090375 34.9434822 73 28.2495534 73c-4.5800565.0-7.4866309 1.5754274-11.5382193 6.1163653-1.6734822 1.8534441-1.598743 2.8514069-2.0391331 4.4738936C14.2318109 85.2127457 15.3810952 94.5991493 17.4068894 98.6767262 18.5085881 100.995054 18.5085881 100.995054 20.3179492 104.427606 20.9381193 105.604136 23.3268821 108.69306 24.5063492 109.790864c1.2349847 1.149478 2.6574201 2.834639 3.7432042 3.921533 1.1506404 1.15181600000001 4.2465085 3.084017 5.3028342 3.701814 1.4321645.837608000000003 2.774919 1.362015 4.0282636 1.573221C40.1349135 119.080104 41.2462694 118.670624 43.4146505 117.414211z" id="形状" fill="url(#linearGradient-1)"/><path d="M248.7 148.9C241 147.8 232.2 143 226.1 136.5c-14.2-15-20-43.1-12.1-58.6C216.6 72.9 223.2 67.5 228.5 66 235.2 64.1 249.3 65.1 255.7 67.9 258.6 69.2 261.4 70.8 262.1 71.6 263.7 73.5 265 79.9 263.9 80.6 263.4 80.9 260 79.6 256.3 77.8 243 71.3 230.4 73.3 225.1 82.9 218.5 94.9 223.7 119.3 235.5 131.5 245.8 142 257.4 142.9 271.3 134.2 273.7 132.7 274.2 132.7 275 134 275.5 134.8 276 137.2 276 139.2 276 142.2 275.5 143.2 272.8 144.8 266.2 148.7 257.7 150.2 248.7 148.9z" id="路径" fill="#fff"/><path d="M87.4 148.1C86.2 147.6 84.9 146.7 84.6 146.1 83.6 144.5 68.1 66.6 68.7 65.8c.599999999999994-1 7.5-1 9 0C78.4 66.3 80.6 74.4 82.5 83.9s3.7 17.6 4 18.2C87.5 103.6 96.3 103.1 99.9 101.2 105.7 98.3 107.2 95.2 110 79.7l2.5-14.2L117.3 65.2C123.5 64.8 123.7 65.7 121.6 78.4c-2.5 14.4-4.5 21.2-7.3 24.2C113 104 112 105.3 112.2 105.5 112.4 105.6 114.3 106.7 116.5 107.8 124.5 111.9 129.8 119.6 130.7 128.5 131.7 138 127.9 143.9 119 146.9 114.5 148.4 90.2 149.3 87.4 148.1zm24.9-9.5C117.8 136.3 119.3 133.8 118.8 127.7 117.9 117 111.3 112.1 96.6 111.2L87.7 110.7 88.3 113.1C88.6 114.4 89.8 120.5 91 126.5 92.1 132.6 93.3 138.1 93.5 138.8 94.1 140.5 108.1 140.4 112.3 138.6z" id="形状" fill="#fff"/><path d="M159.5 148.4C158.4 148.1 157.2 147.5 156.7 147.1c-1-1-16.8-80.2-16.1-81.2C141.2 64.8 148 64.7 149.7 65.8 150.3 66.2 152.2 73.3 153.8 81.5L156.7 96.5 167.8 97.1c17.1 1 25.5 5.7 31.2 17.2C206.2 129.1 202.4 143.6 190.5 146.9 186.1 148.1 162.6 149.2 159.5 148.4zm27.2-11C195 131.2 191.3 114.2 180.5 108.6 177.6 107.1 174.2 106.4 167.8 106.2 162.9 106 159 106.2 159 106.7 159 107.1 160.4 114.9 162.1 123.9L165.3 140.2 174.6 139.8C182.1 139.5 184.5 139 186.7 137.4z" id="形状" fill="#fff"/><path d="M52.3 50.7C49 41.2 49.5 37.5 52.9 46.5c1.2 3.1 1.9876864 5.9098389 2.1 6.3S55.4 54.1 55.9 54.9C56.6 56 58.2 55.2 63.5 50.9 67.2 47.9 70.4 45.6 70.6 45.8 71.7 46.5 70.9 47.4 64.1 53.2 60 56.6 58.2983882 57.6981689 57.4 58.2 56.5016118 58.7018311 56.5016118 58.7018311 55.8 58.2 55 57.49737 54 55.4 52.3 50.7z" id="形状" fill="#7e7e7e"/><path d="M84 34.1C84 30.6 82.8 29 80.4 29 78.9 29 78 28.4 78 27.5 78 26.7 78.9 26 80 26 82.4 26 82.4 25.5 80.5 17 79.7 13.4 79.1 8.4 79 5.8 79 1.6 79.3 1 81.4.4 85.1-.5 89.5.3 89.8 2 90 3.1 89.2 3.5 86.8 3.5 83.9 3.5 83.5 3.8 83.3 6.5 83.1 8.2 83.8 13.1 84.8 17.5c1.7 7.9 1.7 8 5.2 8.6L93.5 26.7C94.2848943 26.7875501 94.751561 26.9875501 94.9 27.3 95 28.6 94.2 29 91.1 29h-4L87.7 32.5C88.2 35.6 88 36 86.1 36 84.7 36 84 35.4 84 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M105 34.1C105 30.6 103.8 29 101.4 29 99.9 29 99 28.4 99 27.5 99 26.7 99.9 26 101 26 103.4 26 103.4 25.5 101.5 17 100.7 13.4 100.1 8.4 1e2 5.8 1e2 1.6 100.3 1 102.4.4 106.1-.5 110.5.3 110.8 2 111 3.1 110.2 3.5 107.8 3.5 104.9 3.5 104.5 3.8 104.3 6.5 104.1 8.2 104.8 13.1 105.8 17.5c1.7 7.9 1.7 8 5.2 8.6L114.5 26.7C115.433333 26.8462934 115.9 27.0462934 115.9 27.3 116 28.6 115.2 29 112.1 29h-4L108.7 32.5C109.2 35.6 109 36 107.1 36 105.7 36 105 35.4 105 34.1z" id="形状" fill="url(#linearGradient-2)"/><path d="M54.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C46.5 1.9 48.6.0 57.2.0 63.6.0 67 1.2 67 3.6 67 4.7 66.6 4.8 65.1 4c-2.7-1.4-10.4-1.3-12.4.3C51.8 4.9 51 6.6 50.9 8 50.4 13.5 50.6 13.7 57.8 14.2 66 14.9 69.5 16.4 71 20 72.3 23.2 71.2 26.3 68 28s-10.2 1.1-13.7-1.1zM67 22.7C67 19 63.6 17 57.3 17 54.4 17 52 17.3 52 17.8c0 1.1 3.1 5.4 5 7C57.9 25.5 60.2 25.9 62.8 25.7 65.1 25.4 67 26.1 67 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M126.3 26.9c-4.5-2.9-7.7-10-7.8-17.2C118.5 1.9 120.6.0 129.2.0 135.6.0 139 1.2 139 3.6 139 4.7 138.6 4.8 137.1 4 134.4 2.6 126.7 2.7 124.7 4.3 123.8 4.9 123 6.6 122.9 8 122.4 13.5 122.6 13.7 129.8 14.2 138 14.9 141.5 16.4 143 20 144.3 23.2 143.2 26.3 140 28s-10.2 1.1-13.7-1.1zM139 22.7C139 19 135.6 17 129.3 17 126.4 17 124 17.3 124 17.8 124 18.9 127.1 23.2 129 24.8 129.9 25.5 132.2 25.9 134.8 25.7 137.1 25.4 139 26.1 139 22.7z" id="形状" fill="url(#linearGradient-3)"/><path d="M153.7 26.8C151.7 18.4 149.2978 2.90464869 149.2978 2.1 149.2978 1.77371339 148.894918.241544332 150.3.1 151.705082-.0415443324 153 .4 153 2.1 153 3.2 153.7 7.2 154.6 11 156.5 19.3 161 25.2 165.5 25.4 167.5 25.5 168.6 26.1 168.8 27.3 169.1 28.6 168.4 29 165.8 29 163.2 29 161.6 28.2 159.4 25.8L156.5 22.5C155.5 19.6333333 155.133333 18.4333333 155.4 18.9 155.9 19.7 156.5 22.2 156.7 24.6 156.9 27.9 156.7 29 155.6 29 154.8 29 154 28 153.7 26.8z" id="形状" fill="url(#linearGradient-4)"/></g></g></g></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/apache/brpc/ target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/downloadbrpc/><span>下载</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/docs/><span class=active>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/community/community/><span>社区</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/asf/><span>ASF</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/blogs/><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/users/><span>用户</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/server/serve-httph2/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label=搜索本站 autocomplete=off>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/server/serve-httph2/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a></li><ul><li class="collapse show" id=zhdocs><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsoverview href=/zh/docs/overview/>简介</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsdownloadbrpc href=/zh/docs/downloadbrpc/>下载</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsgetting_started href=/zh/docs/getting_started/>开始</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsbenchmark href=/zh/docs/benchmark/>性能基准</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvar><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar</a></li><ul><li class=collapse id=zhdocsbvarbvar></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/bvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bvar c++</a></li><ul><li class=collapse id=zhdocsbvarbvar-c></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bvar/mbvar-c++/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">mbvar c++</a></li><ul><li class=collapse id=zhdocsbvarmbvar-c></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthread><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread</a></li><ul><li class=collapse id=zhdocsbthreadbthread></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/bthread-or-not/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread or not</a></li><ul><li class=collapse id=zhdocsbthreadbthread-or-not></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/execution-queue/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Execution Queue</a></li><ul><li class=collapse id=zhdocsbthreadexecution-queue></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/bthread/thread-local/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">thread-local</a></li><ul><li class=collapse id=zhdocsbthreadthread-local></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">C++基础</a></li><ul><li class=collapse id=zhdocsc-base><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/iobuf/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IOBuf</a></li><ul><li class=collapse id=zhdocsc-baseiobuf></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/streaming-log/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Streaming Log</a></li><ul><li class=collapse id=zhdocsc-basestreaming-log></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/flatmap/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FlatMap</a></li><ul><li class=collapse id=zhdocsc-baseflatmap></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/c++-base/brpc-training-materials/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC培训材料</a></li><ul><li class=collapse id=zhdocsc-basebrpc-training-materials></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">客户端</a></li><ul><li class=collapse id=zhdocsclient><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsclientbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/error-code/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">错误码</a></li><ul><li class=collapse id=zhdocsclienterror-code></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/combo-channels/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">组合channels</a></li><ul><li class=collapse id=zhdocsclientcombo-channels></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-httph2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问http:h2</a></li><ul><li class=collapse id=zhdocsclientaccess-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问gRPC</a></li><ul><li class=collapse id=zhdocsclientaccess-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问thrift</a></li><ul><li class=collapse id=zhdocsclientaccess-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-ub/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问UB</a></li><ul><li class=collapse id=zhdocsclientaccess-ub></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-redis/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问redis</a></li><ul><li class=collapse id=zhdocsclientaccess-redis></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/access-memcached/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">访问memcached</a></li><ul><li class=collapse id=zhdocsclientaccess-memcached></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/streaming-rpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流式RPC</a></li><ul><li class=collapse id=zhdocsclientstreaming-rpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/backup-request/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Backup request</a></li><ul><li class=collapse id=zhdocsclientbackup-request></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/client/dummy-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Dummy server</a></li><ul><li class=collapse id=zhdocsclientdummy-server></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">服务端</a></li><ul><li class="collapse show" id=zhdocsserver><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/basics/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">基础功能</a></li><ul><li class=collapse id=zhdocsserverbasics></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-httph2/ class="align-left pl-0 pr-2 collapsed active td-sidebar-link td-sidebar-link__section">搭建http:h2服务</a></li><ul><li class=collapse id=zhdocsserverserve-httph2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-grpc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建gRPC服务</a></li><ul><li class=collapse id=zhdocsserverserve-grpc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-thrift/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建thrift服务</a></li><ul><li class=collapse id=zhdocsserverserve-thrift></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/serve-nshead/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">搭建Nshead服务</a></li><ul><li class=collapse id=zhdocsserverserve-nshead></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/server-push/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">推送</a></li><ul><li class=collapse id=zhdocsserverserver-push></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/debug-server-issues/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">高效率排查server卡顿</a></li><ul><li class=collapse id=zhdocsserverdebug-server-issues></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/avalanche/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">雪崩</a></li><ul><li class=collapse id=zhdocsserveravalanche></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/auto-concurrencylimiter/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">自适应限流</a></li><ul><li class=collapse id=zhdocsserverauto-concurrencylimiter></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/media-server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">流媒体服务</a></li><ul><li class=collapse id=zhdocsservermedia-server></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/server/json2pb/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">json2pb</a></li><ul><li class=collapse id=zhdocsserverjson2pb></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内置服务</a></li><ul><li class=collapse id=zhdocsbuiltin-services><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/buildin_services/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">builtin services</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesbuildin_services></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/status/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">status</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesstatus></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/vars/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">vars</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesvars></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/connections/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">connections</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesconnections></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/flags/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">flags</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesflags></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/rpcz/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpcz</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesrpcz></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/cpu_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">cpu profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescpu_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/heap_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">heap profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicesheap_profiler></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/builtin-services/contention_profiler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">contention profiler</a></li><ul><li class=collapse id=zhdocsbuiltin-servicescontention_profiler></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">工具</a></li><ul><li class=collapse id=zhdocstools><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_press/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_press</a></li><ul><li class=collapse id=zhdocstoolsrpc_press></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_replay/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_replay</a></li><ul><li class=collapse id=zhdocstoolsrpc_replay></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/rpc_view/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">rpc_view</a></li><ul><li class=collapse id=zhdocstoolsrpc_view></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/benchmark_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">benchmark_http</a></li><ul><li class=collapse id=zhdocstoolsbenchmark_http></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/tools/parallel_http/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">parallel_http</a></li><ul><li class=collapse id=zhdocstoolsparallel_http></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">深入RPC</a></li><ul><li class=collapse id=zhdocsrpc-in-depth><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/new-protocol/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">支持新协议</a></li><ul><li class=collapse id=zhdocsrpc-in-depthnew-protocol></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/atomic-instructions/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">原子指令</a></li><ul><li class=collapse id=zhdocsrpc-in-depthatomic-instructions></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/io/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">IO</a></li><ul><li class=collapse id=zhdocsrpc-in-depthio></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/threading-overview/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">线程模型简介</a></li><ul><li class=collapse id=zhdocsrpc-in-depththreading-overview></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/load-balancing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">负载均衡</a></li><ul><li class=collapse id=zhdocsrpc-in-depthload-balancing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/locality-aware/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Locality-aware</a></li><ul><li class=collapse id=zhdocsrpc-in-depthlocality-aware></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/consistent-hashing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">一致性哈希</a></li><ul><li class=collapse id=zhdocsrpc-in-depthconsistent-hashing></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/memory-management/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">内存管理</a></li><ul><li class=collapse id=zhdocsrpc-in-depthmemory-management></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/timer-keeping/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Timer keeping</a></li><ul><li class=collapse id=zhdocsrpc-in-depthtimer-keeping></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/rpc-in-depth/bthread_id/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bthread_id</a></li><ul><li class=collapse id=zhdocsrpc-in-depthbthread_id></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/community/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">社区</a></li><ul><li class=collapse id=zhdocscommunity><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommunity href=/zh/docs/community/community/>社区</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitymailing_list href=/zh/docs/community/mailing_list/>邮件列表</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycontributing href=/zh/docs/community/contributing/>Contribute指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitter href=/zh/docs/community/committer/>Committer指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunityrelease href=/zh/docs/community/release/>Release指南</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitycommitters href=/zh/docs/community/committers/>贡献者列表</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/community/security/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">安全</a></li><ul><li class=collapse id=zhdocscommunitysecurity><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitysecuritycve-2023-31039-bugfix href=/zh/docs/community/security/cve-2023-31039-bugfix/>CVE-2023-31039漏洞修复</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunitymonthly-meeting href=/zh/docs/community/monthly-meeting/>月度会</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocscommunityon-call href=/zh/docs/community/on-call/>值班表</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsasf href=/zh/docs/asf/>ASF</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsusers href=/zh/docs/users/>用户</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">bRPC在百度内部的应用</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baidu><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case1/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">百度地图api入口</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case1></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case2/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联盟DSP</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case2></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case3/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ELF学习框架</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case3></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/use-cases-inside-baidu/use-case4/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云平台代理服务</a></li><ul><li class=collapse id=zhdocsuse-cases-inside-baiduuse-case4></li></ul></ul></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsfaq href=/zh/docs/faq/>FAQ</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">博客</a></li><ul><li class=collapse id=zhdocsblogs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/releases/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">版本发布</a></li><ul><li class=collapse id=zhdocsblogsreleases><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases150 href=/zh/docs/blogs/releases/1.5.0/>bRPC 1.5.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases140 href=/zh/docs/blogs/releases/1.4.0/>bRPC 1.4.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases130 href=/zh/docs/blogs/releases/1.3.0/>bRPC 1.3.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases120 href=/zh/docs/blogs/releases/1.2.0/>bRPC 1.2.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases110 href=/zh/docs/blogs/releases/1.1.0/>bRPC 1.1.0</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogsreleases100 href=/zh/docs/blogs/releases/1.0.0/>bRPC 1.0.0</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/shares/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">分享</a></li><ul><li class=collapse id=zhdocsblogsshares><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssharesbrpc-guide-for-beginners href=/zh/docs/blogs/shares/brpc-guide-for-beginners/>brpc初学者指南</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/zh/docs/blogs/sourcecodes/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">源码解析</a></li><ul><li class=collapse id=zhdocsblogssourcecodes><a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesbthread href=/zh/docs/blogs/sourcecodes/bthread/>bRPC源码解析·bthread机制</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesexecution_queue href=/zh/docs/blogs/sourcecodes/execution_queue/>bRPC源码解析·ExecutionQueue</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesiobuf href=/zh/docs/blogs/sourcecodes/iobuf/>bRPC源码解析·IOBuf</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesbthread_schedule href=/zh/docs/blogs/sourcecodes/bthread_schedule/>bRPC源码解析·bthread调度执行流程</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodeswork_stealing_queue href=/zh/docs/blogs/sourcecodes/work_stealing_queue/>bRPC源码解析·work_stealing_queue</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-zhdocsblogssourcecodesbutex href=/zh/docs/blogs/sourcecodes/butex/>bRPC源码解析·butex机制</a></li></ul></ul></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/apache/brpc-website/edit/master/content/zh/docs/Server/Serve%20http:h2/_index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/apache/brpc-website/issues/new?title=%e6%90%ad%e5%bb%bahttp:h2%e6%9c%8d%e5%8a%a1" target=_blank><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>
<a href=https://github.com/apache/brpc/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a></div><nav id=TableOfContents><ul><li><a href=#前缀为servicenamemethodname>前缀为/ServiceName/MethodName</a></li><li><a href=#前缀为servicename>前缀为/ServiceName</a></li><li><a href=#restful-url>Restful URL</a></li></ul><ul><li><a href=#http-headers>HTTP headers</a></li><li><a href=#content-type>Content-Type</a></li><li><a href=#status-code>Status Code</a></li><li><a href=#query-string>Query String</a></li></ul><ul><li><ul><li><a href=#q-brpc前的nginx报了final-fail>Q: brpc前的nginx报了final fail</a></li><li><a href=#q-brpc支持http-chunked方式传输吗>Q: brpc支持http chunked方式传输吗</a></li><li><a href=#q-http请求的query-string中含有base64编码过的value为什么有时候无法正常解析>Q: HTTP请求的query string中含有BASE64编码过的value，为什么有时候无法正常解析</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/zh/zh/docs/>文档</a></li><li class=breadcrumb-item><a href=/zh/zh/docs/server/>服务端</a></li><li class="breadcrumb-item active" aria-current=page><a href=/zh/zh/docs/server/serve-httph2/>搭建http:h2服务</a></li></ol></nav><div class=td-content><h1>搭建http:h2服务</h1><div class=lead>学习如何搭建Http2服务。</div><p>这里指我们通常说的http/h2服务，而不是可通过http/h2访问的pb服务。</p><p>虽然用不到pb消息，但brpc中的http/h2服务接口也得定义在proto文件中，只是request和response都是空的结构体。这确保了所有的服务声明集中在proto文件中，而不是散列在proto文件、程序、配置等多个地方。</p><p>#示例
<a href=https://github.com/brpc/brpc/blob/master/example/http_c++/http_server.cpp>http_server.cpp</a>。</p><h1 id=关于h2>关于h2</h1><p>brpc把HTTP/2协议统称为"h2"，不论是否加密。然而未开启ssl的HTTP/2连接在/connections中会按官方名称h2c显示，而开启ssl的会显示为h2。</p><p>brpc中http和h2的编程接口基本没有区别。除非特殊说明，所有提到的http特性都同时对h2有效。</p><h1 id=url类型>URL类型</h1><h2 id=前缀为servicenamemethodname>前缀为/ServiceName/MethodName</h2><p>定义一个service名为ServiceName(不包含package名), method名为MethodName的pb服务，且让request和reponse定义为空，则该服务默认在/ServiceName/MethodName上提供http/h2服务。</p><p>request和response可为空是因为数据都在Controller中：</p><ul><li>http/h2 request的header在Controller.http_request()中，body在Controller.request_attachment()中。</li><li>http/h2 response的header在Controller.http_response()中，body在Controller.response_attachment()中。</li></ul><p>实现步骤如下：</p><ol><li>填写proto文件。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>cc_generic_services</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span> <span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>HttpRequest</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000;font-weight:700>};</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>HttpResponse</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000;font-weight:700>};</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span> <span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>HttpService</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>      <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>};</span><span style=color:#a40000>
</span></span></span></code></pre></div><ol start=2><li>实现Service接口。和pb服务一样，也是继承定义在.pb.h中的service基类。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>HttpServiceImpl</span> <span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>HttpService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>virtual</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>Echo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>HttpRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#8f5902;font-style:italic>/*request*/</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#000>HttpResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#8f5902;font-style:italic>/*response*/</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// body是纯文本
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>set_content_type</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;text/plain&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>        <span style=color:#8f5902;font-style:italic>// 把请求的query-string和body打印结果作为回复内容。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>IOBufBuilder</span> <span style=color:#000>os</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>os</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;queries:&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>URI</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>QueryIterator</span> <span style=color:#000>it</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_request</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>uri</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>QueryBegin</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span>                <span style=color:#000>it</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_request</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>uri</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>QueryEnd</span><span style=color:#000;font-weight:700>();</span> <span style=color:#ce5c00;font-weight:700>++</span><span style=color:#000>it</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>os</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#39; &#39;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#39;=&#39;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>it</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>second</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>os</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>\n</span><span style=color:#4e9a06>body: &#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>request_attachment</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#39;\n&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>move_to</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>response_attachment</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><ol start=3><li>把实现好的服务插入Server后可通过如下URL访问，/HttpService/Echo后的部分在 cntl->http_request().unresolved_path()中。</li></ol><table><thead><tr><th>URL</th><th>访问方法</th><th>cntl->http_request().uri().path()</th><th>cntl->http_request().unresolved_path()</th></tr></thead><tbody><tr><td>/HttpService/Echo</td><td>HttpService.Echo</td><td>&ldquo;/HttpService/Echo&rdquo;</td><td>""</td></tr><tr><td>/HttpService/Echo/Foo</td><td>HttpService.Echo</td><td>&ldquo;/HttpService/Echo/Foo&rdquo;</td><td>&ldquo;Foo&rdquo;</td></tr><tr><td>/HttpService/Echo/Foo/Bar</td><td>HttpService.Echo</td><td>&ldquo;/HttpService/Echo/Foo/Bar&rdquo;</td><td>&ldquo;Foo/Bar&rdquo;</td></tr><tr><td>/HttpService//Echo///Foo//</td><td>HttpService.Echo</td><td>&ldquo;/HttpService//Echo///Foo//&rdquo;</td><td>&ldquo;Foo&rdquo;</td></tr><tr><td>/HttpService</td><td>访问错误</td><td></td><td></td></tr></tbody></table><h2 id=前缀为servicename>前缀为/ServiceName</h2><p>资源类的http/h2服务可能需要这样的URL，ServiceName后均为动态内容。比如/FileService/foobar.txt代表./foobar.txt，/FileService/app/data/boot.cfg代表./app/data/boot.cfg。</p><p>实现方法：</p><ol><li>proto文件中应以FileService为服务名，以default_method为方法名。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#204a87;font-weight:700>option</span> <span style=color:#000>cc_generic_services</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>HttpRequest</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000;font-weight:700>};</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>HttpResponse</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000;font-weight:700>};</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>FileService</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>      <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>default_method</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><ol start=2><li>实现Service。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>FileServiceImpl</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>public</span> <span style=color:#000>FileService</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>public</span><span style=color:#ce5c00;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>virtual</span> <span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>default_method</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>RpcController</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>HttpRequest</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#8f5902;font-style:italic>/*request*/</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#000>HttpResponse</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#8f5902;font-style:italic>/*response*/</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Closure</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ClosureGuard</span> <span style=color:#000>done_guard</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>cntl</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>static_cast</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Controller</span><span style=color:#ce5c00;font-weight:700>*&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl_base</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>response_attachment</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Getting file: &#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>        <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>response_attachment</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_request</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>unresolved_path</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><ol start=3><li>实现完毕插入Server后可通过如下URL访问，/FileService之后的路径在cntl->http_request().unresolved_path()中i。</li></ol><table><thead><tr><th>URL</th><th>访问方法</th><th>cntl->http_request().uri().path()</th><th>cntl->http_request().unresolved_path()</th></tr></thead><tbody><tr><td>/FileService</td><td>FileService.default_method</td><td>&ldquo;/FileService&rdquo;</td><td>""</td></tr><tr><td>/FileService/123.txt</td><td>FileService.default_method</td><td>&ldquo;/FileService/123.txt&rdquo;</td><td>&ldquo;123.txt&rdquo;</td></tr><tr><td>/FileService/mydir/123.txt</td><td>FileService.default_method</td><td>&ldquo;/FileService/mydir/123.txt&rdquo;</td><td>&ldquo;mydir/123.txt&rdquo;</td></tr><tr><td>/FileService//mydir///123.txt//</td><td>FileService.default_method</td><td>&ldquo;/FileService//mydir///123.txt//&rdquo;</td><td>&ldquo;mydir/123.txt&rdquo;</td></tr></tbody></table><h2 id=restful-url>Restful URL</h2><p>brpc支持为service中的每个方法指定一个URL。API如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 如果restful_mappings不为空, service中的方法可通过指定的URL被http/h2协议访问，而不是/ServiceName/MethodName.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 映射格式：&#34;PATH1 =&gt; NAME1, PATH2 =&gt; NAME2 ...&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// PATHs是有效的路径, NAMEs是service中的方法名.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>AddService</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Service</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>service</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>               <span style=color:#000>ServiceOwnership</span> <span style=color:#000>ownership</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>               <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>StringPiece</span> <span style=color:#000>restful_mappings</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>下面的QueueService包含多个方法。如果我们像之前那样把它插入server，那么只能通过<code>/QueueService/start, /QueueService/stop</code>等url来访问。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>QueueService</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>start</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>stop</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>get_stats</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>download_data</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>HttpResponse</span><span style=color:#000;font-weight:700>);</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>};</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>而在调用AddService时指定第三个参数(restful_mappings)就能定制URL了，如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddService</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>queue_svc</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SERVER_DOESNT_OWN_SERVICE</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#4e9a06>&#34;/v1/queue/start   =&gt; start,&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#4e9a06>&#34;/v1/queue/stop    =&gt; stop,&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#4e9a06>&#34;/v1/queue/stats/* =&gt; get_stats&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ERROR</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Fail to add queue_svc&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 星号可出现在中间
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddService</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>queue_svc</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>SERVER_DOESNT_OWN_SERVICE</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#4e9a06>&#34;/v1/*/start   =&gt; start,&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#4e9a06>&#34;/v1/*/stop    =&gt; stop,&#34;</span>
</span></span><span style=display:flex><span>                      <span style=color:#4e9a06>&#34;*.data        =&gt; download_data&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ERROR</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Fail to add queue_svc&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>上面代码中AddService的第三个参数分了三行，但实际上是一个字符串。这个字符串包含以逗号(,)分隔的三个映射关系，每个映射告诉brpc：在遇到箭头左侧的URL时调用右侧的方法。"/v1/queue/stats/*&ldquo;中的星号可匹配任意字串。</p><p>关于映射规则：</p><ul><li>多个路径可映射至同一个方法。</li><li>service不要求是纯http/h2，pb service也支持。</li><li>没有出现在映射中的方法仍旧通过/ServiceName/MethodName访问。出现在映射中的方法不再能通过/ServiceName/MethodName访问。</li><li>==> ===> &mldr;都是可以的。开头结尾的空格，额外的斜杠(/)，最后多余的逗号，都不要紧。</li><li>PATH和PATH/*两者可以共存。</li><li>支持后缀匹配: 星号后可以有更多字符。</li><li>一个路径中只能出现一个星号。</li></ul><p><code>cntl.http_request().unresolved_path()</code> 对应星号(*)匹配的部分，保证normalized：开头结尾都不包含斜杠(/)，中间斜杠不重复。比如：</p><p><img src=/images/docs/restful_1.png alt=img></p><p>或</p><p><img src=/images/docs/restful_2.png alt=img></p><p>unresolved_path都是<code>"foo/bar"</code>，左右、中间多余的斜杠被移除了。</p><p>注意：<code>cntl.http_request().uri().path()</code>不保证normalized，这两个例子中分别为<code>"//v1//queue//stats//foo///bar//////"</code>和<code>"//vars///foo////bar/////"</code></p><p>/status页面上的方法名后会加上所有相关的URL，形式是：@URL1 @URL2 &mldr;</p><p><img src=/images/docs/restful_3.png alt=img></p><h1 id=http参数>HTTP参数</h1><h2 id=http-headers>HTTP headers</h2><p>http header是一系列key/value对，有些由HTTP协议规定有特殊含义，其余则由用户自由设定。</p><p>query string也是key/value对，http headers与query string的区别:</p><ul><li>虽然http headers由协议准确定义操作方式，但由于也不易在地址栏中被修改，常用于传递框架或协议层面的参数。</li><li>query string是URL的一部分，<strong>常见</strong>形式是key1=value1&key2=value2&…，易于阅读和修改，常用于传递应用层参数。但query string的具体格式并不是HTTP规范的一部分，只是约定成俗。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 获得header中&#34;User-Agent&#34;的值，大小写不敏感。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>user_agent_str</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_request</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>GetHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;User-Agent&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>user_agent_str</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// has the header
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>TRACE</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;User-Agent is &#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>user_agent_str</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 在header中增加&#34;Accept-encoding: gzip&#34;，大小写不敏感。
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>SetHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Accept-encoding&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;gzip&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 覆盖为&#34;Accept-encoding: deflate&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>SetHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Accept-encoding&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;deflate&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// 增加一个value，逗号分隔，变为&#34;Accept-encoding: deflate,gzip&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>AppendHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Accept-encoding&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;gzip&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><h2 id=content-type>Content-Type</h2><p>Content-type记录body的类型，是一个使用频率较高的header。它在brpc中被特殊处理，需要通过cntl->http_request().content_type()来访问，cntl->GetHeader(&ldquo;Content-Type&rdquo;)是获取不到的。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Get Content-Type
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_request</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>content_type</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;application/json&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Set Content-Type
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>set_content_type</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;text/html&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>如果RPC失败(Controller被SetFailed), Content-Type会框架强制设为text/plain，而response body设为Controller::ErrorText()。</p><h2 id=status-code>Status Code</h2><p>status code是http response特有的字段，标记http请求的完成情况。可能的值定义在<a href=https://github.com/brpc/brpc/blob/master/src/brpc/http_status_code.h>http_status_code.h</a>中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Get Status Code
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>status_code</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>HTTP_STATUS_NOT_FOUND</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>FATAL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;FAILED: &#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>controller</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>reason_phrase</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Set Status code
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>set_status_code</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>HTTP_STATUS_INTERNAL_SERVER_ERROR</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>set_status_code</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>HTTP_STATUS_INTERNAL_SERVER_ERROR</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;My explanation of the error...&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>比如，以下代码以302错误实现重定向：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>set_status_code</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>HTTP_STATUS_FOUND</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_response</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>SetHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Location&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;http://bj.bs.bae.baidu.com/family/image001(4979).jpg&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p><img src=/images/docs/302.png alt=img></p><h2 id=query-string>Query String</h2><p>如上面的<a href=#http-headers>HTTP headers</a>中提到的那样，我们按约定成俗的方式来理解query string，即key1=value1&key2=value2&&mldr;。只有key而没有value也是可以的，仍然会被GetQuery查询到，只是值为空字符串，这常被用做bool型的开关。接口定义在<a href=https://github.com/brpc/brpc/blob/master/src/brpc/uri.h>uri.h</a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>time_value</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_request</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>uri</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>GetQuery</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;time&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>time_value</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87>NULL</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>  <span style=color:#8f5902;font-style:italic>// the query string is present
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>TRACE</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;time = &#34;</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>time_value</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_request</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>uri</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>SetQuery</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;time&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;2015/1/2&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><h1 id=调试>调试</h1><p>打开<a href=http://brpc.baidu.com:8765/flags/http_verbose>-http_verbose</a>即可看到所有的http/h2 request和response，注意这应该只用于线下调试，而不是线上程序。</p><h1 id=压缩response-body>压缩response body</h1><p>http服务常对http body进行压缩，可以有效减少网页的传输时间，加快页面的展现速度。</p><p>设置Controller::set_response_compress_type(brpc::COMPRESS_TYPE_GZIP)后将<strong>尝试</strong>用gzip压缩http body。“尝试“指的是压缩有可能不发生，条件有：</p><ul><li><p>请求中没有设置Accept-encoding或不包含gzip。比如curl不加&ndash;compressed时是不支持压缩的，这时server总是会返回不压缩的结果。</p></li><li><p>body尺寸小于-http_body_compress_threshold指定的字节数，默认是512。gzip并不是一个很快的压缩算法，当body较小时，压缩增加的延时可能比网络传输省下的还多。当包较小时不做压缩可能是个更好的选项。</p><table><thead><tr><th>Name</th><th>Value</th><th>Description</th><th>Defined At</th></tr></thead><tbody><tr><td>http_body_compress_threshold</td><td>512</td><td>Not compress http body when it&rsquo;s less than so many bytes.</td><td>src/brpc/policy/http_rpc_protocol.cpp</td></tr></tbody></table></li></ul><h1 id=解压request-body>解压request body</h1><p>出于通用性考虑且解压代码不复杂，brpc不会自动解压request body，用户可以自己做，方法如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;brpc/policy/gzip_compress.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>std</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>string</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>encoding</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>http_request</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>GetHeader</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Content-Encoding&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>encoding</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87>NULL</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>encoding</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;gzip&#34;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>IOBuf</span> <span style=color:#000>uncompressed</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>policy</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>GzipDecompress</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>request_attachment</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>uncompressed</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>LOG</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ERROR</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#4e9a06>&#34;Fail to un-gzip request body&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>request_attachment</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>swap</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>uncompressed</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// cntl-&gt;request_attachment()中已经是解压后的数据了
</span></span></span></code></pre></div><h1 id=处理https请求>处理https请求</h1><p>https是http over SSL的简称，SSL并不是http特有的，而是对所有协议都有效。开启服务端SSL的一般性方法见<a href=../basics/#%E5%BC%80%E5%90%AFssl>这里</a>。</p><h1 id=性能>性能</h1><p>没有极端性能要求的产品都有使用HTTP协议的倾向，特别是移动产品，所以我们很重视HTTP的实现质量，具体来说：</p><ul><li>使用了node.js的<a href=https://github.com/brpc/brpc/blob/master/src/brpc/details/http_parser.h>http parser</a>解析http消息，这是一个轻量、优秀、被广泛使用的实现。</li><li>使用<a href=https://github.com/miloyip/rapidjson>rapidjson</a>解析json，这是一个主打性能的json库。</li><li>在最差情况下解析http请求的时间复杂度也是O(N)，其中N是请求的字节数。反过来说，如果解析代码要求http请求是完整的，那么它可能会花费O(N^2)的时间。HTTP请求普遍较大，这一点意义还是比较大的。</li><li>来自不同client的http消息是高度并发的，即使相当复杂的http消息也不会影响对其他客户端的响应。其他rpc和<a href=../../rpc-in-depth/threading-overview/#%E5%8D%95%E7%BA%BF%E7%A8%8Breactorhttpenwikipediaorgwikireactor_pattern>基于单线程reactor</a>的各类http server往往难以做到这一点。</li></ul><h1 id=持续发送>持续发送</h1><p>brpc server支持发送超大或无限长的body。方法如下:</p><ol><li>调用Controller::CreateProgressiveAttachment()创建可持续发送的body。返回的ProgressiveAttachment对象需要用intrusive_ptr管理。</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;brpc/progressive_attachment.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000>butil</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>intrusive_ptr</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>brpc</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>ProgressiveAttachment</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pa</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>cntl</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>CreateProgressiveAttachment</span><span style=color:#000;font-weight:700>();</span>
</span></span></code></pre></div><ol start=2><li><p>调用ProgressiveAttachment::Write()发送数据。</p><ul><li>如果写入发生在server-side done调用前，发送的数据将会被缓存直到回调结束后才会开始发送。</li><li>如果写入发生在server-side done调用后，发送的数据将立刻以chunked mode写出。</li></ul></li><li><p>发送完毕后确保所有的<code>butil::intrusive_ptr&lt;brpc::ProgressiveAttachment></code>都析构以释放资源。</p></li></ol><h1 id=持续接收>持续接收</h1><p>目前brpc server不支持在收齐http请求的header部分后就调用服务回调，即brpc server不适合接收超长或无限长的body。</p><h1 id=faq>FAQ</h1><h3 id=q-brpc前的nginx报了final-fail>Q: brpc前的nginx报了final fail</h3><p>这个错误在于brpc server直接关闭了http连接而没有发送任何回复。</p><p>brpc server一个端口支持多种协议，当它无法解析某个http请求时无法说这个请求一定是HTTP。server会对一些基本可确认是HTTP的请求返回HTTP 400错误并关闭连接，但如果是HTTP method错误(在http包开头)或严重的格式错误（可能由HTTP client的bug导致），server仍会直接断开连接，导致nginx的final fail。</p><p>解决方案: 在使用Nginx转发流量时，通过指定$HTTP_method只放行允许的方法或者干脆设置proxy_method为指定方法。</p><h3 id=q-brpc支持http-chunked方式传输吗>Q: brpc支持http chunked方式传输吗</h3><p>支持。</p><h3 id=q-http请求的query-string中含有base64编码过的value为什么有时候无法正常解析>Q: HTTP请求的query string中含有BASE64编码过的value，为什么有时候无法正常解析</h3><p>根据<a href=http://tools.ietf.org/html/rfc3986#section-2.2>HTTP协议</a>中的要求，以下字符应该使用%编码</p><pre tabindex=0><code>       reserved    = gen-delims / sub-delims

       gen-delims  = &#34;:&#34; / &#34;/&#34; / &#34;?&#34; / &#34;#&#34; / &#34;[&#34; / &#34;]&#34; / &#34;@&#34;

       sub-delims  = &#34;!&#34; / &#34;$&#34; / &#34;&amp;&#34; / &#34;&#39;&#34; / &#34;(&#34; / &#34;)&#34;
                   / &#34;*&#34; / &#34;+&#34; / &#34;,&#34; / &#34;;&#34; / &#34;=&#34;
</code></pre><p>但Base64 编码后的字符串中，会以&rdquo;=&ldquo;或者&rdquo;==&ldquo;作为结尾，比如: ?wi=NDgwMDB8dGVzdA==&anothorkey=anothervalue。这个字段可能会被正确解析，也可能不会，取决于具体实现，原则上不应做任何假设.</p><p>一个解决方法是删除末尾的&rdquo;=", 不影响Base64的<a href=http://en.wikipedia.org/wiki/Base64#Padding>正常解码</a>; 第二个方法是在对这个URI做<a href=https://en.wikipedia.org/wiki/Percent-encoding>percent encoding</a>，解码时先做percent decoding再用Base64.</p><div class=section-index><hr class=panel-line></div><div class="text-muted mt-5 pt-3 border-top">修改于 2023年9月19日: <a href=https://github.com/apache/brpc-website/commit/abc46328e9f753f2b19a658833e95b0bdac6144c>add execution queue (#157) (abc4632)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none" style=display:flex;align-items:center;padding:0!important><div class="container-fluid mx-sm-5"><div class=row style=display:flex;align-items:center><div class="col-12 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/apache/brpc><i class="fab fa-github"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation. 保留所有权利</small><div style=font-size:12.8px;color:#757474><a href=https://www.apache.org/ target=_blank rel=noopener>Foundation</a> |
<a href=https://www.apache.org/licenses/ target=_blank rel=noopener>License</a> |
<a href=https://www.apache.org/security/ target=_blank rel=noopener>Security</a> |
<a href=https://www.apache.org/events/current-event target=_blank rel=noopener>Events</a> |
<a href=https://www.apache.org/foundation/sponsorship.html target=_blank rel=noopener>Sponsorship</a> |
<a href=https://privacy.apache.org/policies/privacy-policy-public.html target=_blank rel=noopener>Privacy</a> |
<a href=https://www.apache.org/foundation/thanks.html target=_blank rel=noopener>Thanks</a></div></div></div></div></footer></div><script src=/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=/js/main.min.17eb741170760e55f21de7c8e3570aa65d5fafd190c4b2798a7322a493948738.js integrity="sha256-F+t0EXB2DlXyHefI41cKpl1fr9GQxLJ5inMipJOUhzg=" crossorigin=anonymous></script></body></html>